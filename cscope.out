cscope 15 $HOME/dev/bamboo -q 0000001833 0000258328
	@examples/ajaxexample/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

7 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

8 
’d


10 
loÿl
 
funùiÚ
 
	$ajax_subm™
(
web
, 
»q
)

11 
loÿl
 
·¿ms
 = 
FÜm
:
	$·r£
(
»q
)

12 
	$DEBUG
(
·¿ms
)

14 
web
:
jsÚ
 {

15 
sucûss
 = 
Œue
,

16 
htmls
 = 
	`V›w
('»suÉ.html'){
»suÉs
 = 
·¿ms
},

17 -- 
¶ay
 
Úly


18 
now
 = 
os
.
	`time
()

19 
	}
}

20 
’d


24 
	gURLS
 = { '/',

25 ['/'] = 
šdex
,

26 ['/šdex/'] = 
šdex
,

27 ['/ajax_subm™/'] = 
ajax_subm™
,

	@examples/ajaxexample/settings.lua

1 
	g´ojeù_Çme
 = "ajaxexample"

2 
ho¡
 = 'ajaxexample'

4 
£nd”_id
 = '99edc750-f2bc-1f04-ffc7-cb0301efa240'

5 
io_th»ads
 = 1

6 
v›ws
 = "views/"

7 
cÚfig_fe
 = 'config.lua'

8 
WHICH_DB
 = 15

10 
debug_Ëv–
 = 1

	@examples/apptest/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

5 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

6 
web
:
	`·ge
(
	`V›w
("šdex.html"){
	}
})

7 
’d


9 
URLS
 = { '/',

10 ['/'] = 
šdex
,

11 ['šdex/'] = 
šdex
,

	@examples/apptest/settings.lua

1 
	g´ojeù_Çme
 = "apptest"

2 
ho¡
 = 'apptest'

3 
£nd”_id
 = '99edc750-f2bc-1f04-ffc7-cb0301efa242'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 15

	@examples/formprocess/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

7 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

8 
’d


10 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

11 
loÿl
 
·¿ms
 = 
FÜm
:
	$·r£
(
»q
)

12 
	$DEBUG
(
·¿ms
)

14 
web
:
	`html
("»suÉ.html", {
»suÉs
 = 
·¿ms
})

15 
’d


18 
	gURLS
 = { '/',

19 ['/'] = 
šdex
,

20 ['/šdex/'] = 
šdex
,

21 ['/fÜm_subm™/'] = 
fÜm_subm™
,

	@examples/formprocess/settings.lua

1 
	g´ojeù_Çme
 = "formprocess"

2 
ho¡
 = 'formprocess'

4 
debug_Ëv–
 = 1

5 
£nd”_id
 = '99edc750-f2bc-1f04-ffc7-cb0301efa240'

6 
io_th»ads
 = 1

7 
v›ws
 = "views/"

8 
cÚfig_fe
 = 'config.lua'

9 
WHICH_DB
 = 15

	@examples/pagejump/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

5 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

6 
web
:
	`·ge
(
	`V›w
("šdex.html"){
	}
})

7 
’d


9 
loÿl
 
funùiÚ
 
	$·geb
(
web
, 
»q
)

10 
web
:
	`html
("index2.html")

11 
’d


13 
loÿl
 
funùiÚ
 
	$·gec
(
web
, 
»q
)

14 
web
:
	`html
("šdex3.html", {
	}
})

15 
’d


17 
	gURLS
 = { '/',

18 ['/'] = 
šdex
,

19 ['/šdex/'] = 
šdex
,

20 ['/·geb/'] = 
·geb
,

21 ['/·gec/'] = 
·gec
,

	@examples/pagejump/settings.lua

1 
	g´ojeù_Çme
 = "pagejump"

2 
ho¡
 = 'pagejump'

3 
£nd”_id
 = '99edc750-f2bc-1f04-ffc7-cb0301efa240'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 15

	@examples/workwithdb/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

7 
bamboo
.
	$»gi¡”Mod–
(
MYU£r
)

9 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

10 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

11 
’d


13 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

14 
loÿl
 
·¿ms
 = 
FÜm
:
	$·r£
(
»q
)

15 
	$DEBUG
(
·¿ms
)

17 
loÿl
 
³rsÚ
 = 
	`MYU£r
(
·¿ms
)

18 -- 
§ve
 
³rsÚ
 
objeù
 
to
 
db


19 
³rsÚ
:
	`§ve
()

21 -- 
»Œeive
 
®l
 
³rsÚ
 
š¡ªû
 
äom
 
db


22 
loÿl
 
®l_³rsÚs
 = 
MYU£r
:
	$®l
()

24 
web
:
	`html
("»suÉ.html", {
®l_³rsÚs
 = 
	}
all_persons})

25 
’d


28 
	gURLS
 = { '/',

29 ['/'] = 
šdex
,

30 ['/šdex/'] = 
šdex
,

31 ['/fÜm_subm™/'] = 
fÜm_subm™
,

	@examples/workwithdb/models/myuser.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U£r
 = 
»quœe
 'bamboo.models.user'

5 
loÿl
 
MYU£r
 = 
U£r
:
ex‹nd
 {

6 
__g
 = 'Bamboo.Model.User.MYUser';

7 
__Çme
 = 'MYUser';

8 
__desc
 = 'Generitic MYUser definition';

9 
__šdexfd
 = 'name';

10 
__f›lds
 = {

17 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

18 
nÙ
 
t
 
th’
  
£lf
 
’d


20 
£lf
.
Çme
 = 
t
.name

21 
£lf
.
age
 = 
t
.age

22 
£lf
.
g’d”
 = 
t
.gender

24  
£lf


25 
’d
;

27 
	}
}

29  
	gMYU£r


	@examples/workwithdb/settings.lua

1 
	g´ojeù_Çme
 = "workwithdb"

2 
ho¡
 = 'workwithdb'

4 
debug_Ëv–
 = 1

5 
£nd”_id
 = '99edc750-f2bc-1f04-ffc7-cb0301efa240'

6 
io_th»ads
 = 1

7 
v›ws
 = "views/"

8 
cÚfig_fe
 = 'config.lua'

9 
WHICH_DB
 = 15

	@src/bin/shell.lua

1 #!/
u¤
/
bš
/
lua


2 
	g»quœe
 'bamboo'

4 
loÿl
 
	g»dis
 = 
»quœe
 'bamboo.redis'

5 
loÿl
 
ut
 = 
»quœe
 'bamboo.util'

7 -- 
lßd
 
cÚfigu¿tiÚ


8 
loÿl
 
cÚfig
 = 
ut
.
	$»adS‘tšgs
(
bamboo
.
cÚfig
)

9 
	$±abË
(
cÚfig
)

11 
loÿl
 
DB_HOST
 = 
cÚfig
.DB_HOST 
Ü
 
¬g
[1] or '127.0.0.1'

12 
loÿl
 
DB_PORT
 = 
cÚfig
.DB_PORT 
Ü
 
¬g
[2] or '6379'

13 
loÿl
 
WHICH_DB
 = 
cÚfig
.WHICH_DB 
Ü
 
¬g
[3] or 0

14 
loÿl
 
AUTH
 = 
cÚfig
.AUTH

16 
db
 = 
»dis
.
cÚÃù
 {
ho¡
=
DB_HOST
, 
pÜt
=
DB_PORT
, 
which
 = 
WHICH_DB
, 
auth
=
AUTH
}

17 -- 
make
 
	gmod–
.
lua
 
wÜk


18 
	gBAMBOO_DB
 = 
db


20 -- 
add
 
this
 
´ojeù
's initial„egister worko globalƒvironment

21 
£tãnv
(
as£¹
(
lßdfe
('­p/hªdËr_’Œy.lua'è
Ü
†ßdfe('../­p/hªdËr_’Œy.lua')), 
_G
)()

23 
´št
('Entering bamboo shell.... OK')

24  
	gŒue


	@src/cmd_tmpls/admin/admin.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

4 
loÿl
 
V›w
 = 
»quœe
 'bamboo.view'

5 
loÿl
 
SessiÚ
 = 
»quœe
 'bamboo.session'

6 -- 
loÿl
 
pic
 = 
»quœe
 'lib.pic'

7 
loÿl
 
Image
 = 
»quœe
 'bamboo.models.image'

8 
loÿl
 
U¶ßd
 = 
»quœe
 'bamboo.models.upload'

9 --
loÿl
 
g‘py
 = 
»quœe
 'app.py'

11 
loÿl
 
funùiÚ
 
	$_admš_·¿m_
(
a
, 
e
)

12 
	`´št
('admin checking…arams')

13 
loÿl
 
·¿ms
 = 
FÜm
:
	$·r£
(
»q
)

14 
loÿl
 
qu”y
 = 
FÜm
:
	$·r£Qu”y
(
»q
)

16 
e
 =ƒ 
Ü
 {
	}
}

17 
nÙ
 
	$isF®£
(
exŒa
è
th’


18 
_
, 
v
 
š
 
	$aœs
(
exŒa
) do

19 
nÙ
 
·¿ms
[
v
] 
Ü
…¬ams[v] =ğ'' 
th’


20 
nÙ
 
qu”y
[
v
] 
Ü
 qu”y[v] =ğ'' 
th’


21  
web
:
	`·ge
('è¯·æ­£ç¡®çš„è¾“å…¥å‚æ•°')

22 
’d


23 
’d


24 
’d


25 
’d


27 
k
, 
v
 
š
 
	$·œs
(
·¿ms
) do

28 
e
[
k
] = 
v


29 
’d


31 
k
, 
v
 
š
 
	$·œs
(
qu”y
) do

32 
e
[
k
] = 
v


33 
’d


35  
Œue
, 
e


36 
’d


38 
loÿl
 
funùiÚ
 
	$_admš_logšed_
(
a
, 
e
)

39 
»q
.
u£r
 
th’


40  
Œue
, 
e


42 
web
:
	`html
('../admin/views/login.html')

43  
çl£


44 
’d


45 
’d


48 
bamboo
.
	`»gi¡”F‹r
('_admš_·¿m_', 
_admš_·¿m_
)

49 
bamboo
.
	`»gi¡”F‹r
('_admš_logšed_', 
_admš_logšed_
)

51 
bamboo
.
	`»gi¡”P”missiÚ
(

54 
	$funùiÚ
()

55 
web
:
	`html
('../admin/views/login.html')

56  
çl£


57 
’d
)

59 
loÿl
 
admš_uÆogšed
 = 
»quœe
 'admin.admin_unlogined'

60 
bamboo
.
	$»gi¡”ModuË
(
admš_uÆogšed
)

62 
funùiÚ
 
	$admš_’Œy
(
web
, 
»q
, 
e
)

63 
web
:
	`·ge
(
	`V›w
('../admš/v›ws/šdex.html'){
mod–s
 = 
bamboo
.
MODEL_LIST
, 
u£r
=
»q
.u£r[»q.u£r.
__šdexfd
]
	}
})

64 
’d


66 
loÿl
 
funùiÚ
 
	$g‘In¡ªûs
(
web
, 
»q
, 
e
)

67 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

68 
loÿl
 
š¡ªûs
 = 
m
:
	`®l
()

70 -- 
	$±abË
(
m
)

72  
web
:
	`·ge
(
	`V›w
('../admš/v›ws/š¡ªûs.html'){
š¡ªûs
 = in¡ªûs, 
f›lds
 = 
m
.
__f›lds
, 
__g
 = 
e
.
	}
__tag})

73 
’d


75 
loÿl
 
funùiÚ
 
	$def
(
web
, 
»q
, 
e
)

76  
web
:
	`html
('../admš/medŸ/v›ws/' .. 
»q
.
·th
:
	`sub
(1, -2))

77 
’d


79 
loÿl
 
funùiÚ
 
	$judge
(
cÚd™iÚ
, 
v®_Œue
, 
v®_çl£
)

80 
cÚd™iÚ
 
th’


81  
v®_Œue


82 
’d


83  
v®_çl£


84 
’d


86 
loÿl
 
funùiÚ
 
	$¦iû
(
web
, 
»q
, 
e
)

87 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

88 
loÿl
 
š¡ªûs
 = 
m
:
	`¦iû
((
e
.
·geNum
-1è*ƒ.
numP”Page
 + 1 ,ƒ.pageNum *ƒ.numPerPage)

90 
loÿl
 
tÙ®Pages
 = 
m©h
.
	`û
(
m
:
	`numb”s
()/
e
.
numP”Page
)

92  
web
:
	`·ge
(
	`V›w
('../admin/views/instances.html'){

93 
š¡ªûs
 = instances,

94 
f›lds
 = 
m
.
__f›lds
,

95 
__g
 = 
e
.__tag,

96 
tÙ®CouÁ
 = 
m
:
	`numb”s
(),

97 
cu¼’tPage
 = 
e
.
·geNum
,

98 
numP”Page
 = 
e
.numPerPage,

99 
·geNumShown
 = 
	`judge
(
tÙ®Pages
>10, 10,otalPages)

100 
	}
})

101 
’d


103 
loÿl
 
funùiÚ
 
	$ed™
(
web
, 
»q
, 
e
)

104 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

105 
loÿl
 
š¡ªû
 = 
m
:
	$g‘ById
(
e
.
id
)

107  
web
:
	`·ge
(
	`V›w
('../admin/views/edit.html'){

108 
š¡ªû
 = instance,

109 
f›lds
 = 
m
.
__f›lds
,

110 
__g
 = 
e
.__tag,

111 
š¡ªû_id
 = 
e
.
id
,

112 
	}
})

113 
’d


115 
loÿl
 
funùiÚ
 
	$add
(
web
, 
»q
, 
e
)

116 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

118 
loÿl
 
š¡ªû


119 
m
.
__g
:
	`¡¬tsW™h
('Bamboo.Mod–.U¶ßd'è
th’


120 
š¡ªû
 = 
m
{
·th
 = 
SessiÚ
:
	`g‘Key
('_u¶ßd_fe_'è
Ü
 
n
}

122 
š¡ªû
 = 
m
{}

123 
’d


124 -- 
	$±abË
(
š¡ªû
)

126  
web
:
	`·ge
(
	`V›w
('../admin/views/add.html'){

127 
š¡ªû
 = instance,

128 
f›lds
 = 
m
.
__f›lds
,

129 
__g
 = 
e
.__tag,

130 
id
 = 
e
.id,

131 
	}
})

132 
’d


134 
loÿl
 
funùiÚ
 
	$d–‘eS–eù
(
web
, 
»q
, 
e
)

135 
	$åbË
(
e
)

136 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

137 
e
.
š¡ªûs
 
th’


138 
_
, 
v
 
š
 
	$aœs
(
e
.
š¡ªûs
) do

139 
loÿl
 
š¡ªû
 = 
m
:
	$g‘ById
(
v
)

140 
š¡ªû
 
th’


141 
š¡ªû
:
	$d–
()

142 
’d


143 
’d


144 
’d


145  
web
:
jsÚSucûss
{
	}
}

146 
’d


148 
loÿl
 
funùiÚ
 
	$f‹r
(
web
, 
»q
, 
e
)

149 
loÿl
 
m
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

150 
	`åbË
(
e
)

151 -- 
	`lßd¡ršg
(
e
.
f‹rP¬ams
)()

152 -- 
loÿl
 
f›ld
 = 
e
.
f‹rF›ld


154 
loÿl
 
İ”©Üs
 = {

170 
	}
}

172 
loÿl
 
	gf‹r_·¿m
 = ('_ADMIN_FILTER_PARAMS_={%s%s("%s")}'):
fÜm©
(
e
.
f‹rF›ld
 
Ü
 '',ƒ.
İ”©Ü
 o¸'',ƒ.
v®ue
 or '')

173 
´št
('f‹r_·¿m:', 
f‹r_·¿m
)

174 
	$lßd¡ršg
(
f‹r_·¿m
)()

176 
loÿl
 
š¡ªûs


177 
	$isF®£
(
_ADMIN_FILTER_PARAMS_
è
th’
 
š¡ªûs
 = 
m
:
	$®l
(è
š¡ªûs
 = 
m
:
	$f‹r
(
_ADMIN_FILTER_PARAMS_
è
’d


178 
loÿl
 
tÙ®CouÁ
 = #instances

179 
loÿl
 
tÙ®Pages
 = 
m©h
.
	`û
((
tÙ®CouÁ
)/
e
.
numP”Page
)

181 
š¡ªûs
 = in¡ªûs:
	`¦iû
((
e
.
·geNum
-1è*ƒ.
numP”Page
 + 1 ,ƒ.pageNum *ƒ.numPerPage)

183  
web
:
	`·ge
(
	`V›w
('../admin/views/instances.html'){

184 
š¡ªûs
 = instances,

185 
f›lds
 = 
m
.
__f›lds
,

186 
__g
 = 
e
.__tag,

187 
tÙ®CouÁ
 =otalCount,

188 
tÙ®Page
 = 
tÙ®Pages
,

189 
cu¼’tPage
 = 
e
.
·geNum
,

190 
numP”Page
 = 
e
.numPerPage,

191 
İ”©Üs
 = operators,

192 
f‹rF›ld
 = 
e
.f‹rF›ld 
Ü
 '',

193 
İ”©Ü
 = 
e
.İ”©Ü 
Ü
 '',

194 
v®ue
 = 
e
.v®u
Ü
 '',

195 
·geNumShown
 = 
	`judge
(
tÙ®Pages
>10, 10,otalPages)

196 
	}
})

197 
’d


199 
loÿl
 
funùiÚ
 
	$ü—‹
(
web
, 
»q
, 
e
)

200 
loÿl
 
g
 = 
e
.
__g


201 
e
.
__g
 = 
n


202 
loÿl
 
mod–
 = 
bamboo
.
	$g‘Mod–ByName
(
g
)

203 
e
.
id
 = 
n


204 
e
['_'] = 
n


206 
	$±abË
(
e
)

208 
loÿl
 
»t
, 
”r_msg
 = 
mod–
:
	$v®id©e
(
e
)

209 
nÙ
 
»t
 
th’


210 -- 
_
, 
v
 
š
 
	$aœs
(
”r_msg
) do

211 -- 
	`´št
(
v
)

212 -- 
’d


213 
loÿl
 
d©a
 = {

215 ["mes§ge"] = "ä¿®æ”¹ä¿¡æ¯å‡ºé”™!<br/>" .. 
bË
.
	`cÚÿt
(
”r_msg
, '<br/>'),

216 ["ÇvTabId"] = 
g
,

218 ["ÿÎbackTy³"] = "",--
şo£Cu¼’t
",

220 
	}
}

221  
	gweb
:
	$jsÚ
(
d©a
)

222 
’d


224 
loÿl
 
š¡ªû
 = 
	$mod–
(
e
)

225 
š¡ªû
 
th’


226 
k
, 
v
 
š
 
	$·œs
(
e
) do

227 
	`´št
('_____', 
k
)

228 
mod–
.
__f›lds
[
k
].
fÜeign
 
th’


229 
mod–
.
__f›lds
[
k
].
widg‘_ty³
 =ğ'fÜeign' 
th’


230 
loÿl
 
fÜeign_mod–
 = 
bamboo
.
	`g‘Mod–ByName
(
mod–
.
__f›lds
[
k
].
fÜeign
)

231 -- 
	`´št
('fÜeign', 
k
)

232 
mod–
.
__f›lds
[
k
].
¡
 =ğ'ONE' 
th’


233 -- 
	`´št
('<<<<<')

234 
	`tÚumb”
(
v
è<ğ0 
th’


235 
loÿl
 
fÜeign_š¡ªû
 = 
š¡ªû
:
	$g‘FÜeign
(
k
)

236 
fÜeign_š¡ªû
 
th’


237 
š¡ªû
:
	$d–FÜeign
(
k
, 
fÜeign_š¡ªû
)

238 
’d


240 
š¡ªû
:
	`addFÜeign
(
k
, 
fÜeign_mod–
:
	$g‘ById
(
v
))

241 
’d


242 
–£if
 
mod–
.
__f›lds
[
k
].
¡
 =ğ'MANY' 
th’


243 
	`as£¹
(
	`ty³
(
v
)=='table', '[Error] It is‚ot‡able')

244 
loÿl
 
fÜeign_š¡ªûs
 = 
fÜeign_mod–
:
	`®l
()

245 -- 
	`´št
('>>>>>>>>')

246 -- 
	$åbË
(
fÜeign_š¡ªûs
)

247 
_
, 
fÜeign_š¡ªû
 
š
 
	$aœs
(
fÜeign_š¡ªûs
) do

248 
loÿl
 
eq
 = 
çl£


249 
_
, 
fÜeign_id
 
š
 
	$aœs
(
v
) do

250 
fÜeign_š¡ªû
.
id
 =ğ
fÜeign_id
 
th’


251 
eq
 = 
Œue


252 
’d


253 
’d


254 
eq
 
th’


255 
š¡ªû
:
	$addFÜeign
(
k
, 
fÜeign_š¡ªû
)

257 
š¡ªû
:
	$d–FÜeign
(
k
, 
fÜeign_š¡ªû
)

258 
’d


259 
’d


260 
’d


261 
’d


262 
’d


263 
’d


264 
’d


265 
š¡ªû
:
	$§ve
()

267 
loÿl
 
d©a
 = {

270 ["ÇvTabId"] = 
g
,

274 
	}
}

275  
	gweb
:
	$jsÚ
(
d©a
)

276 
’d


278 
loÿl
 
funùiÚ
 
	`upd©e
(
web
, 
»q
, 
e
)

279 -- 
	$åbË
(
e
)

281 
loÿl
 
g
 = 
e
.
__g


282 
e
.
__g
 = 
n


283 
loÿl
 
id
 = 
e
.id

284 
e
.
id
 = 
n


285 
e
['_'] = 
n


287 
loÿl
 
mod–
 = 
bamboo
.
	$g‘Mod–ByName
(
g
)

288 
loÿl
 
š¡ªû
 = 
mod–
:
	`g‘ById
(
id
)

290 -- 
	`´št
('instance')

291 -- 
	$åbË
(
š¡ªû
)

292 
loÿl
 
»t
, 
”r_msg
 = 
mod–
:
	$v®id©e
(
e
)

293 
nÙ
 
»t
 
th’


294 -- 
_
, 
v
 
š
 
	$aœs
(
”r_msg
) do

295 -- 
	`´št
(
v
)

296 -- 
’d


297 
loÿl
 
d©a
 = {

299 ["mes§ge"] = "ä¿®æ”¹ä¿¡æ¯å‡ºé”™!<br/>" .. 
bË
.
	`cÚÿt
(
”r_msg
, '<br/>'),

300 ["ÇvTabId"] = 
g
,

302 ["ÿÎbackTy³"] = "",--
şo£Cu¼’t
",

304 
	}
}

305  
	gweb
:
	$jsÚ
(
d©a
)

306 
’d


308 
š¡ªû
 
th’


309 
k
, 
v
 
š
 
	$·œs
(
e
) do

310 -- 
	$´št
(
k
)

311 
mod–
.
__f›lds
[
k
].
fÜeign
 
th’


312 
loÿl
 
fÜeign_mod–
 = 
bamboo
.
	`g‘Mod–ByName
(
mod–
.
__f›lds
[
k
].
fÜeign
)

313 -- 
	`´št
('fÜeign', 
k
)

314 
mod–
.
__f›lds
[
k
].
¡
 =ğ'ONE' 
th’


315 -- 
	`´št
('<<<<<')

316 
	`tÚumb”
(
v
è<ğ0 
th’


317 
loÿl
 
fÜeign_š¡ªû
 = 
š¡ªû
:
	$g‘FÜeign
(
k
)

318 
fÜeign_š¡ªû
 
th’


319 
š¡ªû
:
	$d–FÜeign
(
k
, 
fÜeign_š¡ªû
)

320 
’d


322 
š¡ªû
:
	`addFÜeign
(
k
, 
fÜeign_mod–
:
	$g‘ById
(
v
))

323 
’d


324 
–£if
 
mod–
.
__f›lds
[
k
].
¡
 =ğ'MANY' 
th’


325 -- 
	`as£¹
(
	`ty³
(
v
)=='table', '[Error] It is‚ot‡able')

326 
	`ty³
(
v
)=='bË' 
th’


327 
loÿl
 
fÜeign_š¡ªûs
 = 
fÜeign_mod–
:
	`®l
()

328 -- 
	`´št
('>>>>>>>>')

329 -- 
	$åbË
(
fÜeign_š¡ªûs
)

330 
_
, 
fÜeign_š¡ªû
 
š
 
	$aœs
(
fÜeign_š¡ªûs
) do

331 
loÿl
 
eq
 = 
çl£


332 
_
, 
fÜeign_id
 
š
 
	$aœs
(
v
) do

333 
fÜeign_š¡ªû
.
id
 =ğ
fÜeign_id
 
th’


334 
eq
 = 
Œue


335 
’d


336 
’d


337 
eq
 
th’


338 
š¡ªû
:
	$addFÜeign
(
k
, 
fÜeign_š¡ªû
)

340 
š¡ªû
:
	$d–FÜeign
(
k
, 
fÜeign_š¡ªû
)

341 
’d


342 
’d


343 
’d


344 
’d


346 -- 
	`´št
('______', 
k
 ,
v
)

347 
š¡ªû
:
	$upd©e
(
k
, 
v
)

348 
’d


349 
’d


350 
’d


352 
loÿl
 
d©a
 = {

355 ["ÇvTabId"] = 
g
,

359 
	}
}

360  
	gweb
:
	$jsÚ
(
d©a
)

361 
’d


363 
loÿl
 
funùiÚ
 
	$d–‘e
(
web
, 
»q
, 
e
)

364 
loÿl
 
mod–
 = 
bamboo
.
	$g‘Mod–ByName
(
e
.
__g
)

365 
loÿl
 
š¡ªû
 = 
mod–
:
	$g‘ById
(
e
.
id
)

367 
š¡ªû
:
	$d–
()

369 
loÿl
 
d©a
 = {

372 ["ÇvTabId"] = 
g
,

376 
	}
}

377  
	gweb
:
	$jsÚ
(
d©a
)

378 
’d


380 
loÿl
 
funùiÚ
 
	$v®id©e
(
web
, 
»q
, 
e
)

381 
loÿl
 
d©a
 = {

388 
	}
}

389  
	gweb
:
	$jsÚ
(
d©a
)

390 
’d


392 
loÿl
 
funùiÚ
 
	`u¶ßd
(
web
, 
»q
, 
e
)

393 -- 
loÿl
 
Ãwfe
, 
»suÉ_ty³
 = 
Image
:
	`´oûss
(
web
, 
»q
, 
n
,‚,‚, 
	$funùiÚ
(è 
»q
.
£ssiÚ
.
£ssiÚ_id
 .. 
os
.
	$time
(è
’d
)

395 -- 
»suÉ_ty³
 =ğ'sšgË' 
th’


396 -- 
–£if
 
»suÉ_ty³
 =ğ'muÉË' 
th’


397 -- 
’d


399 -- 
nÙ
 
Ãwfe
 
th’


400 --  
web
:
	`jsÚE¼Ü
(200, 'ä¸Šä¼ æ–‡ä»¶å¤±è´¥')

401 -- 
’d


403 -- 
loÿl
 
im_¤c
 = 
pic
.
	`guessPhÙoFÜm©
(
Ãwfe
.
·th
)

404 -- 
loÿl
 
x
, 
y
 = 
im_¤c
:
	`sizeXY
()

405 -- 
Ãwfe
.
width
 = 
x


406 -- 
Ãwfe
.
height
 = 
y


407 -- -- 
Ãwfe
:
	`§ve
()

408 -- 
loÿl
 
ny
 = 
x


409 -- 
loÿl
 
nx
 = 
y


410 -- 
loÿl
 
im_des
 = 
gd
.
	`ü—‹TrueCŞÜ
(
nx
, 
ny
)

412 -- 
im_des
:
	`cİyRe§m¶ed
(
im_¤c
, 0, 0, 0, 0, 
nx
, 
ny
, 
x
, 
y
)

414 -- 
loÿl
 
Ãw·th
 = 
Ãwfe
.
·th


415 -- -- 
loÿl
 
maš
, 
ext
 = 
Ãw·th
:
	`m©ch
('^(.+)(%.%w+)$')

416 -- 
loÿl
 
maš
 = 
Ãw·th


417 -- -- 
maš
 = main + '_middle'

418 -- 
Ãw·th
 = 
maš
 + '.png'

419 -- 
	`´št
(
maš
)

420 -- 
loÿl
 
mašÇme
 = 
maš
:
	`m©ch
('/([^:%(%)/]+)$')

422 -- 
im_des
:
	`²g
(
Ãw·th
)

424 -- 
os
.
	`execu‹
('rm ' .. 
Ãwfe
.
·th
)

426 
loÿl
 
Ãwfe
, 
»suÉ_ty³
 = 
U¶ßd
:
	$´oûss
(
web
, 
»q
)

427 
SessiÚ
:
	`£tKey
('_u¶ßd_fe_', 
Ãwfe
.
·th
)

431 -- 
Ãwfe
 = 
Image
 {

432 -- -- 
Çme
 = 
	`to¡ršg
(
os
.
	`time
()) .. '.png',

433 -- 
Çme
 = 
mašÇme
 .. '.png',

434 -- 
·th
 = 
Ãw·th
,

435 -- 
width
 = 
nx
,

436 -- 
height
 = 
ny


437 -- 
	}
}

438 -- 
±abË
(
Ãwfe
)

439 -- 
	gÃwfe
:
	$§ve
()

441  
web
:
jsÚSucûss
{
	}
}

442 
’d


444 
loÿl
 
funùiÚ
 
	$logout
(
web
, 
»q
, 
e
)

445 
bamboo
.
MAIN_USER
:
	$logout
()

446  
web
:
	`»dœeù
('/admin')

447 
’d


449 
funùiÚ
 
	$š™
()

450 
loÿl
 
æag
 = 
bamboo
.
execu‹F‹rs
{'_admš_logšed_'
	}
} 
ªd
 bamboo.
execu‹P”missiÚCheck
{'_sys_admin_'}

451 -- 
loÿl
 
æag
 = 
Œue


452  
æag


453 
’d


455 
funùiÚ
 
	$fšish
()

456  
Œue


457 
’d


459 
funùiÚ
 
	`‹¡
()

460 -- 
	`´št
(
	`g‘py
('æµ‹è¯•'))

461  
web
:
	`html
('‹¡.html', {
š¡ªû
=
»q
.
u£r
})

462 
’d


464 
	gURLS
 = {

466 
hªdËr
 = 
admš_’Œy
,

469 
hªdËr
 = 
g‘In¡ªûs
,

470 
	gf‹rs
 = {'_admin_param_: __tag'},

473 
hªdËr
 = 
¦iû
,

474 
	gf‹rs
 = {'_admin_param_: __tag status…ageNum‚umPerPage'}

477 
hªdËr
 = 
f‹r
,

478 
	gf‹rs
 = {'_admin_param_: __tag…ageNum‚umPerPage…arams'},

481 
hªdËr
 = 
v®id©e
,

482 
	gf‹rs
 = {},

485 
hªdËr
 = 
ed™
,

486 
	gf‹rs
 = {'_admin_param_: __tag id'},

489 
hªdËr
 = 
upd©e
,

490 
	gf‹rs
 = {'_admin_param_: __tag id'},

493 
hªdËr
 = 
add
,

494 
	gf‹rs
 = {'_admin_param_: __tag'},

497 
hªdËr
 = 
ü—‹
,

498 
	gf‹rs
 = {'_admin_param_: __tag id'},

501 
hªdËr
 = 
d–‘e
,

502 
	gf‹rs
 = {'_admin_param_: __tag id'},

505 
hªdËr
 = 
d–‘eS–eù
,

506 
	gf‹rs
 = {'_admin_param_: __tag instances'}

509 
hªdËr
 = 
u¶ßd
,

512 
hªdËr
 = 
logout
,

514 ['‹¡'] = 
‹¡
,

516 -- 
hªdËr
 = 
def
,

	@src/cmd_tmpls/admin/admin_unlogined.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
funùiÚ
 
	$logš
(
web
, 
»q
, 
e
)

4 
	$±abË
(
e
)

5 
	$±abË
(
MAIN_USER
)

6 
MAIN_USER
:
	$logš
(
e
)

7  
web
:
	`»dœeù
('/admš')--
	`html
('../admin/views/login.html')

8 
’d


10 
URLS
={

12 
hªdËr
 = 
logš
,

13 
f‹rs
 = {'_admin_param_: username…assord'},

14 -- 
³rms
 = {'_sys_admin_'}

16 
	}
}

	@src/cmd_tmpls/createapp/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

5 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

6 
web
:
	`·ge
(
	`V›w
("šdex.html"){
	}
})

7 
’d


9 
URLS
 = {

10 ['/'] = 
šdex
,

11 ['/šdex/'] = 
šdex
,

	@src/cmd_tmpls/createapp/monconfig.lua

1 
	g¡©ic_$PROJECT_NAME$
 = { 
ty³
="dœ", 
	gba£
='s™es/$PROJECT_NAME$/', 
	gšdex_fe
='šdex.html', 
	gdeçuÉ_ùy³
='' }

3 
	ghªdËr_$PROJECT_NAME$
 = { 
ty³
="hªdËr", 
	g£nd_¥ec
='tcp://127.0.0.1:10001',

4 
	g£nd_id’t
='ba06f707-8647-46b9-b7f7-e641d6419909',

5 
	g»cv_¥ec
='tı://127.0.0.1:10002', 
	g»cv_id’t
=''}

7 
	gmaš
 = {

8 
bšd_addr
 = "0.0.0.0",

9 
	guuid
="505417b8-1de4-454f-98b6-07eb9225cca1",

10 
	gacûss_log
="logs/access.log",

11 
	g”rÜ_log
="logs/error.log",

12 
	gchroÙ
="./",

13 
	gpid_fe
="run/mongrel2.pid",

14 
	gdeçuÉ_ho¡
="$PROJECT_NAME$",

15 
	gÇme
="main",

16 
	gpÜt
=6767,

17 
	gho¡s
= {

19 
Çme
="$PROJECT_NAME$",

20 
	gm©chšg
 = "xxxxxx",

21 
	grou‹s
={

22 ['/'] = 
hªdËr_$PROJECT_NAME$
,

23 ['/medŸ/'] = 
¡©ic_$PROJECT_NAME$


30 
	g£‰šgs
 = {

36 
	gmim‘y³s
 = {}

38 
£rv”s
 = { 
maš
 }

	@src/cmd_tmpls/createapp/settings.lua

1 
	g£nd”_id
 = '####'

2 
io_th»ads
 = 1

3 
cÚfig_fe
 = 'config.lua'

4 
WHICH_DB
 = 15

	@src/cmd_tmpls/createcontroller/newcontroller.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
$MODEL
 = 
»quœe
 "models.$CONTROLLER"

5 
loÿl
 
u¾´efix
 = "$CONTROLLER"

7 --  
m‘hods


8 
Ãwv›w
 = 
	$funùiÚ
 (
web
, 
»q
)

10 
’d


12 
ed™v›w
 = 
	$funùiÚ
 (
web
, 
»q
)

14 
’d


16 
d–v›w
 = 
	$funùiÚ
 (
web
, 
»q
)

18 
’d


20 
™em
 = 
	$funùiÚ
 (
web
, 
»q
)

22 
’d


24 
li¡
 = 
	$funùiÚ
 (
web
, 
»q
)

26 
’d


28 
ü—‹
 = 
	$funùiÚ
 (
web
, 
»q
)

30 
’d


32 
upd©e
 = 
	$funùiÚ
 (
web
, 
»q
)

34 
’d


36 
d–‘e
 = 
	$funùiÚ
 (
web
, 
»q
)

38 
’d


40 
URLS
 = {

41 ["/" + 
u¾´efix
 + "/Ãwv›w/"] = 
Ãwv›w
,

42 ["/" + 
u¾´efix
 + "/ed™v›w/"] = 
ed™v›w
,

43 ["/" + 
u¾´efix
 + "/d–v›w/"] = 
d–v›w
,

44 ["/" + 
u¾´efix
 + "/™em/"] = 
™em
,

45 ["/" + 
u¾´efix
 + "/li¡/"] = 
li¡
,

46 ["/" + 
u¾´efix
 + "/ü—‹/"] = 
ü—‹
,

47 ["/" + 
u¾´efix
 + "/upd©e/"] = 
upd©e
,

48 ["/" + 
u¾´efix
 + "/d–‘e/"] = 
d–‘e
,

50 
	}
}

	@src/cmd_tmpls/createmodel/newmodel.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
$MODEL
 = 
Mod–
:
ex‹nd
 {

6 
__g
 = 'Bamboo.Model.$MODEL';

7 
__Çme
 = '$MODEL';

8 
__desc
 = 'Generitic $MODEL definition';

9 
__šdexfd
 = 'name',

10 
__f›lds
 = {

15 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

16 
	`isF®£
(
t
è
th’
  
£lf
 
’d


18 --‡utØ
fl
 
nÚ
-
fÜeign
 
f›lds
 
w™h
 
·¿ms
 
t


19 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


20 
k
, 
v
 
š
 
	`·œs
(
t
) do

21 
f›lds
[
k
] 
ªd
 
nÙ
 f›lds[k].
fÜeign
 
th’


22 
£lf
[
k
] = 
	`to¡ršg
(
v
)

23 
’d


24 
’d


26  
£lf


27 
’d
;

31 
	}
}

33  
	g$MODEL


	@src/cmd_tmpls/createplugin/init.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
V›w
 = 
»quœe
 'bamboo.view'

5 
funùiÚ
 
	$maš
()

6 
loÿl
 
i
 = 0

7 
loÿl
 
¡r
 = ''

8 
i
=1, 100, 10 do

9 
¡r
 = ('% %s'):
	`fÜm©
(¡r, 
	$to¡ršg
(
i
))

10 
’d


12  
	`V›w
('‹¡¶ugš/‹¡¶ugš.html'){ 
Ú‘wo
 = 
¡r
 
	}
}

13 
’d


15 
	gURLS
 = {

16 ['xxxxx/xxxxx/'] = 
maš


	@src/errors.lua

2 
moduË
('bamboo.”rÜs', 
·ckage
.
£—Î
)

4 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

6 -- 
R•Üts
 
”rÜs
 
back
 
to
 
the
 
brow£r
 
so
h
u£r
 
has
 
som‘hšg
Ø
wÜk
 
w™h
.

7 
funùiÚ
 
	$»pÜtE¼Ü
(
cÚn
, 
»que¡
, 
”r
, 
¡©e
)

8 
loÿl
 
Œaû
 = 
debug
.
	$Œaûback
(
¡©e
.
cÚŒŞËr
, 
”r
)

9 
loÿl
 
šfo


10 
loÿl
 
sourû
 = 
n


12 
¡©e
.
¡©eful
 
th’


13 
šfo
 = 
debug
.
	$g‘šfo
(
¡©e
.
cÚŒŞËr
, s‹.
maš
)

15 
šfo
 = 
debug
.
	$g‘šfo
(
¡©e
.
maš
)

16 
’d


18 
šfo
.
sourû
:
	`m©ch
("@.+$"è
th’


19 -- 
code
 
comes
 
äom
 
fe
, 
di¥Ïy
 
the
 cod
lšes
 
”rÜed
 
š
 
th©
 file

20 
sourû
 = 
io
.
	`lßdLšes
(
šfo
.sourû:
	`sub
(2), info.
lšedefšed
, info.
Ï¡lšedefšed
)

22 -- 
code
 
dÛ¢
't come from file, it is‡ string

23 
sourû
 = 
šfo
.source

24 
’d


26 
loÿl
 
”rouut
 = ""

27 
loÿl
 
rg‘
 = 
”r
:
	`m©ch
("%[%w* *\"(%S+)\"%]:")

28 
loÿl
 
”rÜlš’um
 = 
	`tÚumb”
(
¡ršg
.
	`m©ch
(
”r
, ":(%d+):"))

29 
rg‘
 
ªd
 
”rÜlš’um
‡nd 
bamboo
.
comped_v›ws_tm¶s
[rg‘] 
th’


30 
loÿl
 
–šes
 = 
¡ršg
.
	`¥l™
(
bamboo
.
comped_v›ws_tm¶s
[
rg‘
], '\n')

31 
loÿl
 
”rÜlše
 = 
–šes
[
”rÜlš’um
]

32 
”rÜlše
 
th’


33 
”rouut
 = "[E¼Ü]ƒ¼Ü occu»d‡t: " .. (
”rÜlše
:
	`m©ch
("_»suÉ%[%#_»suÉ%+1%] = (.+)$"è
Ü
ƒrrorline)

34 
’d


35 
’d


36 
	$´št
(
”rouut
)

37 
	`´št
("[E¼Ü]", 
”r
)

39 -- 
E¼Ü
 
šfo
 
‹m¶©e


40 
loÿl
 
ERROR_PAGE
 = 
V›w
.
compeV›w
 [[

41 <
html
><
h—d
><
t™Ë
>
Bamboo
 
E¼Ü
</title></head>

42 <
body
>

43 <
p
>
Th”e
 
was
 
ª
 
”rÜ
 
´oûssšg
 
your
 
»que¡
.</p>

44 <
h1
>
Sck
 
T¿û
</h1>

45 <
´e
>

46 {{ 
”rouut
 }
	}
} <
br
/>

47 {{ 
”r
 }}

48 </
´e
>

49 <
h1
>
Sourû
 
Code
</h1>

50 <
´e
>

51 {{ 
sourû
 }}

52 </
´e
>

53 <
h1
>
Reque¡
</h1>

54 <
´e
>

55 {{ 
»que¡
 }}

56 </
´e
>

57 </
body
>

58 </
html
>

61 
loÿl
 
´‘ty_»q
 = "Reque¡\À" + 
£rŸlize
(
»que¡
 
Ü
 {})

62 
loÿl
 
·ge
 = 
ERROR_PAGE
 {
”r
=
Œaû
, 
	gsourû
=
sourû
, 
	g»que¡
=
´‘ty_»q
, 
	g”rouut
 = 
”rouut
}

63 
	gcÚn
:
»¶y_h‰p
(
»que¡
, 
·ge
, 500, "Internal Server Error")

64 
’d


67 
funùiÚ
 
	$basicE¼Ü
(
cÚn
, 
»q
, 
body
, 
code
, 
¡©us
, 
h—d”s
)

68 
h—d”s
 = h—d” 
Ü
 {
	}
}

69 
h—d”s
['content-type'] = 'text/plain'

70 
h—d”s
['server'] = 'Bamboo on Monserver'

72 
cÚn
:
	$»¶y_h‰p
(
»q
, 
body
, 
code
, 
¡©us
, 
h—d”s
)

73 
’d


	@src/form.lua

2 
	$moduË
(..., 
·ckage
.
£—Î
)

4 
loÿl
 
h‰p
 = 
»quœe
 'lglib.http'

5 
loÿl
 
jsÚ
 = 
»quœe
 'json'

8 
loÿl
 
ENCODING_MATCH
 = '^%s-([%w/%-]+);*(.*)$'

9 
loÿl
 
URL_ENCODED_FORM
 = 'application/x-www-form-urlencoded'

10 
loÿl
 
MULTIPART_ENCODED_FORM
 = 'multipart/form-data'

15 --- 
·r£
 
h‰p
 
h—d”s
, 
ŒªsfÜm
 
™
 
to
 
lua
 
bË


16 -- @
·¿m
 
h—d
: 
Üigš®
 
HTTP
 
h—d”
 
¡ršg


17 -- @ 
»suÉ
: 
lua
 
bË


18 
loÿl
 
·r£H—d”s
 = 
	$funùiÚ
 (
h—d
)

19 
loÿl
 
»suÉ
 = {
	}
}

20 
h—d
 = ('%s\r\n'):
	$fÜm©
(
h—d
)

22 
key
, 
v®
 
š
 
h—d
:
	`gm©ch
('%s*(.-):%s*(.-)\r\n') do

23 
»suÉ
[
key
:
	`low”
()] = 
h‰p
.
	`·r£URL
(
v®
, ';')

24 
’d


26  
»suÉ


27 
’d
;

30 --- 
·r£
 
muÉ¬t
 
fÜm
 
¡ršg
 
fÜm©


31 -- 
now
 
™
's very simple,†oad whole file into memory

32 -- @
·¿m
 
body
: 
Üigš®
 
HTTP
 body 
¡ršg


33 -- @
·¿m
 
£p¡r
:

34 -- @ 
»suÉ
:

35 
loÿl
 
exŒaùMuÉ¬ts
 = 
	$funùiÚ
 (
body
, 
£p¡r
)

36 
£p¡r
 = ('%s;'):
	$fÜm©
(
£p¡r
)

37 
loÿl
 
bound¬y
 = ('%%-%%-%s'):
	`fÜm©
(
£p¡r
:
	`m©ch
('^.*bound¬y=(.-);.*$'):
	`gsub
('%-', '%%-'))

38 
loÿl
 
»suÉs
 = {
	}
}

40 -- 
body
 
u£
 
bound¬y
 
to
 
£³¿‹
 
—ch
 
·¹
ï¼Œ
™”©e
 
them


41 
·¹
 
š
 
body
:
gm©ch
(('(.-)%s'):
	$fÜm©
(
bound¬y
)) do

42 -- 
š
 
ev”y
 
·¹
, 
h—d
 
ªd
 
p›û
 
¬e
 
divided
 
by
 
two
 '\r\n'ï¼Œp›û 
has
 
Úe
 '\r\n' 
fŞlowed
 
™


43 
loÿl
 
h—d
, 
p›û
 = 
·¹
:
	`m©ch
('^(.-)\r\n\r\n(.*)\r\n$')

45 
h—d
 
th’


46 
h—d
 = 
	$·r£H—d”s
(
h—d
)

48 
loÿl
 
cdi¥
 = 
h—d
['content-disposition']

49 
cdi¥
 
ªd
 cdi¥.
Çme
‡nd cdi¥[1] =ğ'fÜm-d©a'‡nd 
nÙ
 
h—d
['cÚ‹Á-ty³'] 
th’


50 -- 
¡Üe
 
Çmed
 
v¬ŸbË
 
š
 
fÜm
ï¼Œ
as
 
a
 
diù


51 
»suÉs
[
cdi¥
.
Çme
:
	`m©ch
('"(.-)"')] = 
p›û


53 
h—d
.
body
 = 
p›û


54 -- 
¡Üe
 
nÚe
 
Çmed
 
v¬ŸbË
 
š
 
fÜm
, 
as
 
a
 
li¡


55 
»suÉs
[#»suÉ + 1] = 
h—d


56 
’d


57 
’d


58 
’d


60  
»suÉs


61 
’d
;

64 
loÿl
 
FÜm
 = 
Objeù
:
ex‹nd
 {

65 
__g
 = 'Bamboo.Form';

67 
·r£
 = 
	`funùiÚ
 (
£lf
, 
»q
)

68 
	`I_AM_CLASS
(
£lf
)

69 
loÿl
 
h—d”s
 = 
»q
.headers

70 
loÿl
 
·¿ms
 = {}

72 
h—d”s
.
METHOD
 =ğ'GET' 
th’


73 
h—d”s
.
QUERY
 
th’


74 -- 
·¿ms
 
is
 
the
 
diùÜy
 
of
 
qu”y


75 
·¿ms
 = 
h‰p
.
	`·r£URL
(
h—d”s
.
QUERY
)

76 
’d


77 
–£if
 
h—d”s
.
METHOD
 =ğ'POST' 
th’


78 
loÿl
 
ùy³
 = 
h—d”s
['cÚ‹Á-ty³'] 
Ü
 ""

79 
loÿl
 
’codšg
, 
’ı¬ams
 = 
ùy³
:
	`m©ch
(
ENCODING_MATCH
)

80 
’codšg
 
th’
ƒncodšg =ƒncodšg:
	`low”
(è
’d


82 
’codšg
 =ğ
URL_ENCODED_FORM
 
th’


83 
»q
.
body
 
th’


84 -- 
POST
 
d©a
 
is
 
¶aûd
 
š
 
body


85 
·¿ms
 = 
h‰p
.
	`·r£URL
(
»q
.
body
)

86 
’d


87 
–£if
 
’codšg
 =ğ
MULTIPART_ENCODED_FORM
 
th’


88 
·¿ms
 = 
	`exŒaùMuÉ¬ts
(
»q
.
body
, 
’ı¬ams
)

89 
·¿ms
.
muÉ¬t
 = 
Œue


91 -- 
Ùh”
 
fÜm©
 

92 --
	`´št
(("POST RECEIVED BUT NO CONTENT TYPE WE UNDERSTAND: %s."):
	`fÜm©
(
ùy³
))

93 
’d


94 
’d


96  
·¿ms


97 
’d
;

99 
·r£Qu”y
 = 
	`funùiÚ
 (
£lf
, 
»q
)

100 
	`I_AM_CLASS
(
£lf
)

101 
»q
.
h—d”s
.
QUERY
 
th’


102  
h‰p
.
	`·r£URL
(
»q
.
h—d”s
.
QUERY
)

105 
’d


106 
’d
;

109 
’code
 = 
	`funùiÚ
 (
£lf
, 
d©a
, 
£p
)

110 
	`I_AM_CLASS
(
£lf
)

111 
loÿl
 
»suÉ
 = {}

113 
k
,
v
 
š
 
	`·œs
(
d©a
) do

114 
»suÉ
[#»suÉ + 1] = ('%s=%s'):
	`fÜm©
(
h‰p
.
	`’codeURL
(
	`to¡ršg
(
k
)), h‰p.’codeURLÑo¡ršg(
v
)))

115 
’d


117  
bË
.
	`cÚÿt
(
»suÉ
, 
£p
 
Ü
 '&')

118 
’d
;

120 
	}
}

122  
	gFÜm


	@src/init.lua

2 -- 
Bamboo
 
is
 
a
 
Lua
 
web
 
	gäamewÜk


4 -- 
Bamboo
 
is
 
BSD
 
liûn£d
 
the
 
§me
 
as
 
	gMÚg»l2
.

7 
	g·ckage
.
	g·th
 = 
·ckage
.
·th
 .. './?.lua;./?/init.lua;../?.lua;../?/init.lua;'

8 
»quœe
 'lglib'

10 
moduË
('bamboo', 
·ckage
.
£—Î
)

12 
loÿl
 
	gS‘
 = 
»quœe
 'lglib.set'

13 
loÿl
 
Li¡
 = 
»quœe
 'lglib.list'

14 
loÿl
 
F›ldTy³
 = 
»quœe
 'bamboo.mvm.prototype'

15 
loÿl
 
ut
 = 
»quœe
 'bamboo.util'

17 
cÚfig
 = {}

18 -- 
glob®
 
»nd”šg
 
u§ge


19 
cÚ‹xt
 = {}

20 
u£rd©a
 = {}

21 
¶ugšd©a
 = {}

22 
comped_v›ws_tm¶s
 = {}

23 
comped_v›ws
 = {}

24 
comped_v›ws_loÿls
 = {}

26 
WIDGETS
 = {}

27 
»quœe
 'bamboo.widget'

29 -- 
£ssiÚ
 
liã
 
time


30 
SESSION_LIFE
 = 3600 * 24

31 -- 
ÿche
 
liã
 
time


32 
CACHE_LIFE
 = 1800

33 -- 
ruË
 
šdex
 
liã
 
time


34 
RULE_LIFE
 = 1800

36 -- 
glob®
 
URLS
 
defš™iÚ


37 
URLS
 = {}

38 
URLS_STATES
 = {}

39 
PATTERN_URLS
 = {}

41 
PLUGIN_LIST
 = {}

42 
PLUGIN_CALLBACKS
 = {}

44 
»gi¡”Plugš
 = 
	$funùiÚ
 (
Çme
, 
mdl
)

45 
	`checkTy³
(
Çme
, 
mdl
, 'string', 'table')

46 
	`as£¹
Ğ
Çme
 ~= '', 'Plugin‚ame must‚ot be blank.' )

47 
	`as£¹
Ğ
mdl
.
maš
, 'Plugin must have‡ main function.' )

48 
	`checkTy³
Ğ
mdl
.
maš
, 'function' )

50 
PLUGIN_LIST
[
Çme
] = 
mdl
.
maš


52 -- 
combše
 
URLS
 
š
 
—ch
 
moduË
 
to
 
the
 
glob®
 URLS

53 
mdl
['URLS'] 
th’


54 
bË
.
	$upd©e
(
URLS
, 
mdl
.URLS)

55 
’d


56 
’d


58 
»gi¡”PlugšC®lback
 = 
	$funùiÚ
 (
Çme
, 
ÿÎback
)

59 
	`checkTy³
(
Çme
, 
ÿÎback
, 'string', 'function')

60 
	`as£¹
Ğ
Çme
 ~= '', 'Plugin callback‚ame must‚ot be blank.' )

62 
PLUGIN_CALLBACKS
[
Çme
] 
th’


63 
	`´št
('[W¬nšg] Thi ÿÎback‚ame:"'.. 
Çme
 ..'" has been used')

64 
’d


65 
PLUGIN_CALLBACKS
[
Çme
] = 
ÿÎback


67 
’d


69 
g‘PlugšC®lbackByName
 = 
	$funùiÚ
 (
Çme
)

70 
	`checkTy³
(
Çme
, 'string')

71  
PLUGIN_CALLBACKS
[
Çme
]

72 
’d


76 
loÿl
 
funùiÚ
 
	$·r£F‹rName
Ğ
f‹r_Çme
 )

77 
loÿl
 
Çme_·¹
, 
¬gs_·¹
 = 
f‹r_Çme
:
	$Œim
():
	`m©ch
("^([%w_]+):? *([%w_ /%-%.]*)")

78 
loÿl
 
¬gs_li¡
 = {
	}
}

79 
¬gs_·¹
 
ªd
‡rgs_·¹ ~ğ'' 
th’


80 
¬gs_li¡
 = 
¬gs_·¹
:
	$Œim
():
	`¥l™
(' +')

81 
’d


83 
f‹r
 = 
	$g‘F‹rByName
(
Çme_·¹
)

84  
f‹r
, 
¬gs_li¡


85 
’d


89 
MODULE_LIST
 = {
	}
}

92 
loÿl
 
funùiÚ
 
	$³rmissiÚCheck
(
aùiÚ_³rms
, 
³rms
)

93 #³rm > 0 
th’


94 
loÿl
 
³rm_li¡
 = {
	}
}

95 
_
, 
³rm
 
š
 
	$aœs
(
³rms
) do

96 
³rm_li¡
[#³rm_li¡ + 1] = 
³rm
.
Çme


97 
’d


99 
loÿl
 
³rms_£tA
 = 
	$S‘
(
³rm_li¡
)

100 
loÿl
 
³rms_£tB
 = 
	$S‘
(
aùiÚ_³rms
)

101 
loÿl
 
æag
, 
diff_–em
 = 
³rms_£tB
:
	$isSub
(
³rms_£tA
)

103 
æag
 
th’


104 -- 
aùiÚ
 
³rmissiÚs
 
¬e
 
cÚšed
 
by
 
giv’
…ermissions

105 -- 
execu‹
 
sucûss
 
funùiÚ


106 -- 
TODO


107 
loÿl
 
»t
 = 
n


108 
_
, 
³rm_Çme
 
š
 
	$aœs
(
aùiÚ_³rms
) do

109 
loÿl
 
³rm_do
 = 
	$g‘P”missiÚByName
(
³rm_Çme
)

110 
nÙ
 
³rm_do
 
th’


111 
	`´št
(('[W¬nšg] Thi ³rmissiÚ % i nÙ„egi¡”ed.'):
	$fÜm©
(
³rm_Çme
))

112 
–£if
 
³rm_do
 
ªd
…”m_do.
sucûss_func
 
th’


113 
»t
 = 
³rm_do
.
	`sucûss_func
()

114 -- 
Úû
 
Úe
 
³rmissiÚ
 
sucûss
 
funùiÚ
  
çl£


115 -- 
jump
 
out


116 
nÙ
 
»t
 
th’


117 
	`´št
(('[Prom±]…”missiÚ check chaš wa brok’‡ˆ%s'):
	$fÜm©
(
³rm_Çme
))

118  
çl£


119 
’d


120 
’d


121 
’d


123  
Œue


125 -- 
execu‹
 
çu»
 
funùiÚ


126 
loÿl
 
³rm_nÙ_f™
 = 
	$g‘P”missiÚByName
(
diff_–em
)

127 
³rm_nÙ_f™
 
ªd
…”m_nÙ_f™.
çu»_func
 
th’


128 
	`´št
(('[Prom±]ƒÁ” fau» funùiÚ %s.'):
	$fÜm©
(
diff_–em
))

129 
³rm_nÙ_f™
.
	$çu»_func
()

130 
’d


132  
çl£


133 
’d


135 
	`´št
('[Prompt] No…ermissions inhe given†ist.')

136 
loÿl
 
³rm_nÙ_f™
 = 
	$g‘P”missiÚByName
(
aùiÚ_³rms
[1])

137 
³rm_nÙ_f™
 
ªd
…”m_nÙ_f™.
çu»_func
 
th’


138 
	`´št
(('[Prom±]ƒÁ” fau» funùiÚ %s.'):
	$fÜm©
(
aùiÚ_³rms
[1]))

139 
³rm_nÙ_f™
.
	$çu»_func
()

140 
’d


142  
çl£


143 
’d


144 
’d


146 
loÿl
 
funùiÚ
 
	$aùiÚT¿nsfÜm
(
web
, 
»q
, 
aùiÚ
)

147 
	`ty³
(
aùiÚ
è=ğ'funùiÚ' 
th’


148  
aùiÚ


149 
–£if
 
	`ty³
(
aùiÚ
è=ğ'bË' 
th’


150 
loÿl
 
fun
 = 
aùiÚ
.
hªdËr


151 
	`checkTy³
(
fun
, 'function')

153  
	$funùiÚ
 (
web
, 
»q
, 
š™ed_·¿ms
)

154 
loÿl
 
´İag©ed_·¿ms
 = 
š™ed_·¿ms
 
Ü
 {
	}
}

155 
loÿl
 
f‹r_æag
, 
	g³rmissiÚ_æag
 = 
Œue
, 
	gŒue


157 -- 
check
 
f‹rs


158 
loÿl
 
	gaùiÚ_f‹rs
 = 
aùiÚ
.
f‹rs


159 
aùiÚ_f‹rs
 
ªd
 #aùiÚ_f‹r > 0 
th’


160 
checkTy³
(
aùiÚ_f‹rs
, 'table')

162 
	gf‹r_æag
 = 
Œue


163 -- 
execu‹
 
®l
 
f‹rs
 
bound
 
to
 
this
 
hªdËr


164 
_
, 
f‹r_Çme
 
š
 
	$aœs
(
aùiÚ_f‹rs
) do

165 
loÿl
 
f‹r
, 
¬gs_li¡
 = 
	`·r£F‹rName
(
f‹r_Çme
)

166 -- 
f‹r
 
is
 
šv®id
, 
ignÜe
 
™


167 
f‹r
 
th’


168 
loÿl
 
»t


169 
»t
, 
´İag©ed_·¿ms
 = 
	$f‹r
(
¬gs_li¡
, 
´İag©ed_·¿ms
)

170 
nÙ
 
»t
 
th’


171 
f‹r_æag
 = 
çl£


172 
	`´št
(("[W¬nšg] F‹¸chaš wa brok’‡ˆ%s."):
	$fÜm©
(
f‹r_Çme
))

174 
’d


176 
	`´št
(('[W¬nšg] Thi f‹¸% i nÙ„egi¡”ed.'):
	$fÜm©
(
f‹r_Çme
))

177 
’d


178 
’d


180 
’d


182 -- 
check
 
³rms


183 
aùiÚ
.
³rms
 
ªd
 #aùiÚ.³rm > 0 
th’


184 
	`checkTy³
(
aùiÚ
.
³rms
, 'table')

185 -- 
TODO


187 
loÿl
 
u£r
 = 
»q
.user

188 
u£r
 
th’


189 -- 
check
 
the
 
u£r
's…ermissions

190 
u£r
.
³rms
 
th’


191 
loÿl
 
³rms
 = 
u£r
:
	`g‘FÜeign
('perms')

192 
³rmissiÚ_æag
 = 
	$³rmissiÚCheck
(
aùiÚ
.
³rms
,…erms)

194 
’d


196 -- 
check
 
groups
'…ermissions

197 
u£r
.
groups
 
th’


198 
loÿl
 
groups
 = 
u£r
:
	`g‘FÜeign
('groups')

199 
_
, 
group
 
š
 
	$aœs
(
groups
) do

200 
group
 
th’


201 
group
.
³rms
 
th’


202 
loÿl
 
group_³rms
 = 
group
:
	`g‘FÜeign
('perms')

203 
loÿl
 
»t
 = 
	`³rmissiÚCheck
(
aùiÚ
.
³rms
, 
group_³rms
)

204 -- 
Úû
 
a
 
group
's…ermissions fit‡ction_perms,„eturnrue

205 
»t
 
th’
 
³rmissiÚ_æag
 = 
Œue
;  
’d


206 
’d


207 
’d


208 
’d


209 
’d


210 
’d


211 
’d


213 
nÙ
 
f‹r_æag
 
Ü
‚Ù 
³rmissiÚ_æag
 
th’


214 
	`´št
("[Prompt] user was deniedoƒxecutehis handler.")

215  
çl£


216 
’d


218 -- 
execu‹
 
hªdËr


219 -- 
aá”
 
execu‹
 
f‹rs
 
ªd
 
³rmissiÚs
 
check
, 
·ss
 
h”e
, 
th’
ƒxecu‹ 
this
 
hªdËr


220 
loÿl
 
»t
, 
´İag©ed_·¿ms
 = 
	`fun
(
web
, 
»q
,…ropagated_params)

222 -- 
check
 
po¡
 
f‹rs


223 
loÿl
 
aùiÚ_po¡_f‹rs
 = 
aùiÚ
.
po¡_f‹rs


224 
»t
 
ªd
 
aùiÚ_po¡_f‹rs
‡nd #aùiÚ_po¡_f‹r > 0 
th’


225 
	`checkTy³
(
aùiÚ_po¡_f‹rs
, 'table')

227 
f‹r_æag
 = 
Œue


228 -- 
execu‹
 
®l
 
f‹rs
 
bound
 
to
 
this
 
hªdËr


229 
_
, 
f‹r_Çme
 
š
 
	$aœs
(
aùiÚ_po¡_f‹rs
) do

230 
loÿl
 
f‹r
, 
¬gs_li¡
 = 
	`·r£F‹rName
(
f‹r_Çme
)

231 -- 
f‹r
 
is
 
šv®id
, 
ignÜe
 
™


232 
f‹r
 
th’


233 
»t
, 
´İag©ed_·¿ms
 = 
	$f‹r
(
¬gs_li¡
, 
´İag©ed_·¿ms
)

234 
nÙ
 
»t
 
th’


235 
f‹r_æag
 = 
çl£


236 
	`´št
(("[W¬nšg] Po¡F‹¸chaš wa brok’‡ˆ%s."):
	$fÜm©
(
f‹r_Çme
))

238 
’d


240 
	`´št
(('[W¬nšg] Thi po¡ f‹¸% i nÙ„egi¡”ed.'):
	$fÜm©
(
f‹r_Çme
))

241 
’d


242 
’d


244 
’d


246 --  
äom
 
lua
 
funùiÚ


247  
»t
, 
´İag©ed_·¿ms


248 
’d


250 
	`”rÜ
("Action mush be function orable.", 2)

251 
’d


252 
’d


255 
»gi¡”ModuË
 = 
	$funùiÚ
 (
mdl
, 
exŒa_·¿ms
)

256 
	`checkTy³
(
mdl
, 'table')

258 
mdl
.
URLS
 
th’


259 
	`checkTy³
(
mdl
.
URLS
, 'table')

261 
u¾
, 
aùiÚ
 
š
 
	$·œs
(
mdl
.
URLS
) do

262 
loÿl
 
nu¾
 = ''

263 ià(
u¾
 =ğ'/' 
Ü
 
nÙ
 u¾:
	`¡¬tsW™h
('/')è
ªd
 
mdl
.
_NAME
 
th’


264 -- 
	`´št
(
u¾
)

265 -- 
make
 
the
 
»Ïtive
 
u¾
 
·‰”n
 
to
 
absŞu‹
 url…attern

266 
loÿl
 
moduË_Çme
 = 
mdl
.
_NAME
:
	`m©ch
('%.([%w_]+)$')

267 
nu¾
 = ('/%s/%s'):
	`fÜm©
(
moduË_Çme
, 
u¾
)

268 -- 
	$´št
(
nu¾
)

270 
nu¾
 = 
u¾


271 
’d


273 
	`ty³
(
aùiÚ
è=ğ'bË' 
ªd
‡ùiÚ.
¡©eful
 
th’


275 
URLS_STATES
[
nu¾
] = 
aùiÚ
.
¡©eful


276 
’d


279 
loÿl
 
nfun


280 
loÿl
 
exşude_æag
 = 
çl£


281 
exŒa_·¿ms
 
th’


282 
	`checkTy³
(
exŒa_·¿ms
, 'table')

283 
exŒa_·¿ms
['exşudes'] 
th’


284 -- 
add
 
exû±iÚs
 
to
 
moduË
's init function

285 
_
, 
exşude
 
š
 
	`aœs
(
exŒa_·¿ms
['excludes']) do

286 
exşude
 =ğ
u¾
 
th’


287 
exşude_æag
 = 
Œue


288 
’d


289 
’d


290 
’d


291 
’d


293 
mdl
.
š™
 
ªd
 
	`ty³
(mdl.š™è=ğ'funùiÚ'‡nd 
nÙ
 
exşude_æag
 
th’


294 
nfun
 = 
	$funùiÚ
 (
web
, 
»q
)

295 
loÿl
 
»t
, 
š™ed_·¿ms
 = 
mdl
.
	`š™
(
exŒa_·¿ms
 
Ü
 {
	}
})

296 
loÿl
 
fšished_·¿ms


297 
loÿl
 
Ï¡_·¿ms


298 
»t
 
th’


299 
»t
, 
	gfšished_·¿ms
 = 
	$aùiÚT¿nsfÜm
(
web
, 
»q
, 
aùiÚ
)(web,„eq, 
š™ed_·¿ms
)

300 
’d


302 
»t
 
ªd
 
mdl
.
fšish
‡nd 
	`ty³
(mdl.fšishè=ğ'funùiÚ' 
th’


303 
»t
, 
Ï¡_·¿ms
 = 
mdl
.
	$fšish
(
fšished_·¿ms
)

304 
’d


306 -- 
make
 
no
 
£n£


307  
»t
, 
Ï¡_·¿ms
 
Ü
 
fšished_·¿ms
 o¸
š™ed_·¿ms


308 
’d


309 
–£if
 
mdl
.
fšish
 
ªd
 
	`ty³
(mdl.fšishè=ğ'funùiÚ'‡nd 
nÙ
 
exşude_æag
 
th’


310 
nfun
 = 
	$funùiÚ
 (
web
, 
»q
)

311 
loÿl
 
»t
, 
fšished_·¿ms
 = 
	$aùiÚT¿nsfÜm
(
web
, 
»q
, 
aùiÚ
)(web,„eq)

313 
loÿl
 
Ï¡_·¿ms


314 
»t
 
th’


315 
»t
, 
Ï¡_·¿ms
 = 
mdl
.
	$fšish
(
fšished_·¿ms
)

316 
’d


318 -- 
make
 
no
 
£n£


319  
»t
, 
Ï¡_·¿ms
 
Ü
 
fšished_·¿ms


320 
’d


322 
nfun
 = 
	$aùiÚT¿nsfÜm
(
web
, 
»q
, 
aùiÚ
)

323 
’d


325 
URLS
[
nu¾
] = 
nfun


326 
’d


327 
’d


328 
’d


331 
MODEL_LIST
 = {
	}
}

333 
loÿl
 
funùiÚ
 
	$g‘CÏssName
(
mod–
)

334  
mod–
.
__g
:
	`m©ch
('%.(%w+)$')

335 
’d


337 
»gi¡”Mod–
 = 
	$funùiÚ
 (
mod–
)

338 
	`checkTy³
(
mod–
, 'table')

339 
	`as£¹
Ğ
mod–
.
__g
, 'Registered model __tag must‚ot be missing.' )

340 
loÿl
 
mod–_Çme
 = 
	$g‘CÏssName
(
mod–
)

342 
nÙ
 
MODEL_LIST
[
mod–_Çme
] 
th’


343 
MODEL_LIST
[
mod–_Çme
] = 
mod–


345 -- 
dyÇmic
 
f›lds


346 
mod–
:
	$hasDyÇmicF›ld
(è
th’


347 
mod–
:
	$impÜtDyÇmicF›lds
()

348 
’d


350 -- 
£t
 
m‘©abË
 
—ch
 
f›ld


351 
f›ld
, 
fdt
 
š
 
	$·œs
(
mod–
.
__f›lds
) do

352 
	`£tm‘©abË
(
fdt
, {
__šdex
 = 
F›ldTy³
[fdt.
widg‘_ty³
 
Ü
 '‹xt']
	}
})

353 
	gfdt
:
	$š™
()

354 
’d


356 -- 
check
 
ask
 
f›ld
 
šdex
 
ba£d
 
Ú
 
ruËs


357 
mod–
['__ruË_šdex_f›lds'] = {
	}
}

358 
¿wg‘
(
mod–
, '__u£_ruË_šdex'è=ğ
Œue
 
th’


359 -- 
£t
 
__u£_ruË_šdex
 
mªu®ly
, 
cŞËù
 
®l
 
f›lds


360 
key
 
š
 
	$·œs
(
mod–
.
__f›lds
) do

361 
bË
.
	`š£¹
(
mod–
['__ruË_šdex_f›lds'], 
key
)

362 
’d


364 -- , 
Úly
 
cŞËù
 
f›lds
 
£t
 
šdex
=
Œue
 
æag


365 
key
, 
f›ld_dt
 
š
 
	$·œs
(
mod–
.
__f›lds
) do

366 
f›ld_dt
.
ruË_šdex
 =ğ
Œue
 
th’


367 
mod–
['__u£_ruË_šdex'] = 
Œue


368 
bË
.
	`š£¹
(
mod–
['__ruË_šdex_f›lds'], 
key
)

369 
’d


370 
’d


371 
’d


373 -- 
check
 
ask
 
fuÎ‹xt
 
šdex


374 
mod–
['__fuÎ‹xt_šdex_f›lds'] = {
	}
}

375 
key
, 
f›ld_dt
 
š
 
	$·œs
(
mod–
.
__f›lds
) do

376 
f›ld_dt
.
fuÎ‹xt_šdex
 =ğ
Œue
 
th’


377 
mod–
['__u£_fuÎ‹xt_šdex'] = 
Œue


378 
bË
.
	$š£¹
(
mod–
.
__fuÎ‹xt_šdex_f›lds
, 
key
)

379 
’d


380 
’d


383 -- 
decÜ©Üs


384 
nÙ
 
	$isF®£
(
mod–
.
__decÜ©Üs
è
th’


385 
nÙ
 
	`¿wg‘
(
mod–
, '__decÜ©Üs'è
th’


386 
mod–
.
__decÜ©Üs
={
	}
}

387 
’d


388 
mod–
.
__decÜ©Üs
.
__foÚršt
={}

389 -- 
CouÁ”
 
to
 
avoid
 
’dËss
 
»cursiÚ


390 
loÿl
 
funùiÚ
 
	$foÙ´štfunc
(
func
, 
k
)

392 
	$funùiÚ
(
£lf
, ...)

393 
loÿl
 
å
 = 
mod–
.
__decÜ©Üs
.
__foÚršt


394 
loÿl
 
key
 = 
	`to¡ršg
(
£lf
.
id
 
Ü
 
	`£Ëù
(1, ...)è..o¡ršg(
k
è--
	$to¡ršg
(
func
)

395 
loÿl
 
»t


396 
nÙ
 
å
[
key
] 
th’


397 
å
[
key
] = 
Œue


398 
»t
 = 
	$func
(
£lf
, ...)

399 
’d


400 
å
[
key
] = 
n


401  
»t


402 
’d


403 
’d


405 
loÿl
 
decÜ©ÜS‘
 = 
S‘
{'upd©e', '§ve', 'd–', 'addFÜeign', 'd–FÜeign', 'g‘ById'
	}
}

407 
loÿl
 
p
 = 
mod–


408 
»³©


409 
p
 =….
_·»Á


410 
p
.
__Çme
 ~ğ'Mod–' 
th’


411 
	$»gi¡”Mod–
(
p
)

412 
’d


413 
uÁ
 
p
.
__Çme
 =ğ'Mod–' 
Ü
 
nÙ
…

415 
k
, 
v
 
š
 
	`·œs
(
	`¿wg‘
(
mod–
, '__decÜ©Üs'è
Ü
 {
	}
}) do

416 
	gdecÜ©ÜS‘
:
	$has
(
k
è
th’


417 -- 
add
 
decÜ©Ü
 
w¿µ”
 
funùiÚ
 
to
 
mod–
 
£lf


418 
mod–
[
k
] = 
	`foÙ´štfunc
(
	`v
(model[k]), k)

419 
’d


420 
’d


422 
’d


424 
’d


425 
’d


427 
g‘Mod–ByName
 = 
	$funùiÚ
 (
Çme
)

428 
	`checkTy³
(
Çme
, 'string')

429 
	`as£¹
(
MODEL_LIST
[
Çme
], ('[ERROR] Thi mod– % i nÙ„egi¡”ed!'):
	$fÜm©
(
Çme
))

430  
MODEL_LIST
[
Çme
]

431 
’d


433 
bamboo
.
MAIN_USER
 = 
n


434 
»gi¡”MašU£r
 = 
	$funùiÚ
 (
mdl
, 
exŒa_·¿ms
)

435 
	$»gi¡”Mod–
 (
mdl
, 
exŒa_·¿ms
)

436 
bamboo
.
MAIN_USER
 = 
mdl


437 
’d
;

440 
FILTER_LIST
 = {
	}
}

442 
»gi¡”F‹r
 = 
	$funùiÚ
 ( 
f‹r_Çme
, 
f‹r_func
)

443 
	`checkTy³
(
f‹r_Çme
, 
f‹r_func
, 'string', 'function')

445 
	`as£¹
(
nÙ
 
FILTER_LIST
[
f‹r_Çme
], "[Error] This filter‚ame has been„egisterd.")

447 
FILTER_LIST
[
f‹r_Çme
] = 
f‹r_func


448 
’d


450 
g‘F‹rByName
 = 
	$funùiÚ
 ( 
f‹r_Çme
 )

451 
	`checkTy³
(
f‹r_Çme
, 'string')

453 
loÿl
 
f‹r
 = 
FILTER_LIST
[
f‹r_Çme
]

454 
nÙ
 
f‹r
 
th’


455 
	`´št
(("[W¬nšg] Thi f‹¸% i nÙ„egi¡”ed!"):
	$fÜm©
(
f‹r_Çme
))

456 
’d


458  
f‹r


459 
’d


462 --- 
u£d
 
mašly
 
š
 
’Œy
 
fe
 
ªd
 
—ch
 
moduË
's initial function

463 -- @
f‹rs


464 
execu‹F‹rs
 = 
	$funùiÚ
 ( 
f‹rs
, 
·¿ms
 )

465 
	`checkTy³
(
f‹rs
, 'table')

466 
·¿ms
 =…¬am 
Ü
 {
	}
}

467 
_
, 
f‹r_Çme
 
š
 
	$aœs
(
f‹rs
) do

468 
loÿl
 
f‹r
, 
¬gs_li¡
 = 
	$·r£F‹rName
(
f‹r_Çme
)

469 
f‹r
 
th’


470 -- 
now
 
f‹r
 
has
 
no
 
exŒa
 
·¿m‘”s


471 
loÿl
 
»t
, 
·¿ms
 = 
	$f‹r
(
¬gs_li¡
, 
·¿ms
)

472 
nÙ
 
»t
 
th’


473 
	`´št
(("[W¬nšg] F‹¸chaš wa brok’‡ˆ%s."):
	$fÜm©
(
f‹r_Çme
))

474  
çl£


475 
’d


476 
’d


477 
’d


478  
Œue
, 
·¿ms


479 
’d


481 
»gi¡”F‹rs
 = 
	$funùiÚ
 (
f‹r_bË
)

482 
	`checkTy³
(
f‹r_bË
, 'table')

483 
_
, 
f‹r_defše
 
š
 
	$aœs
(
f‹r_bË
) do

484 -- 1. 
Çme
, 2. 
func


485 
	$»gi¡”F‹r
(
f‹r_defše
[1], filter_define[2])

486 
’d


487 
’d


490 
PERMISSION_LIST
 = {
	}
}

492 
funùiÚ
 
	$execu‹P”missiÚCheck
(
³rms
)

493 
loÿl
 
³rmissiÚ_æag
 = 
Œue


494 
loÿl
 
u£r
 = 
»q
.user

495 
u£r
 
th’


496 -- 
check
 
the
 
u£r
's…ermissions

497 
u£r
.
³rms
 
th’


498 
loÿl
 
u£r_³rms
 = 
u£r
:
	`g‘FÜeign
('perms')

499 
³rmissiÚ_æag
 = 
	$³rmissiÚCheck
(
³rms
, 
u£r_³rms
)

501 
’d


503 -- 
check
 
groups
'…ermissions

504 
u£r
.
groups
 
th’


505 
loÿl
 
groups
 = 
u£r
:
	`g‘FÜeign
('groups')

506 
_
, 
group
 
š
 
	$aœs
(
groups
) do

507 
group
 
th’


508 
group
.
³rms
 
th’


509 
loÿl
 
group_³rms
 = 
group
:
	`g‘FÜeign
('perms')

510 
loÿl
 
»t
 = 
	`³rmissiÚCheck
(
³rms
, 
group_³rms
)

511 -- 
Úû
 
a
 
group
's…ermissions fit‡ction_perms,„eturnrue

512 
»t
 
th’
 
³rmissiÚ_æag
 = 
Œue
;  
’d


513 
’d


514 
’d


515 
’d


516 
’d


518  
³rmissiÚ_æag


519 
’d


520 
’d


523 
»gi¡”P”missiÚ
 = 
	$funùiÚ
 (
Çme
, 
desc
, 
çu»_func
, 
sucûss_func
)

524 
loÿl
 
P”missiÚ
 = 
»quœe
 'bamboo.models.permission'

525 
	`checkTy³
(
Çme
, 'string')

526 
loÿl
 
desc
 = desø
Ü
 ''

527 
çu»_func
 
th’


528 
	`checkTy³
(
çu»_func
, 'function')

529 
’d


531 
sucûss_func
 
th’


532 
	`checkTy³
(
sucûss_func
, 'function')

533 
’d


535 
P”missiÚ
:
	$add
(
Çme
, 
desc
)

536 
PERMISSION_LIST
[
Çme
] = {

537 
Çme
 =‚ame,

538 
desc
 = desc,

539 
çu»_func
 = failure_func,

540 
sucûss_func
 = success_func

541 
	}
}

543 
’d


545 
	g»gi¡”P”missiÚs
 = 
	$funùiÚ
 (
³rm_t
)

546 
	`checkTy³
(
³rm_t
, 'table')

547 
_
, 
³rm_·¿ms
 
š
 
	$aœs
(
³rm_t
) do

548 
	$»gi¡”P”missiÚ
(
³rm_·¿ms
[1],…erm_params[2],

549 
³rm_·¿ms
[3],…erm_params[4])

550 
’d


552 
’d


554 
g‘P”missiÚByName
 = 
	$funùiÚ
 (
Çme
)

555 
	`checkTy³
(
Çme
, 'string')

557  
PERMISSION_LIST
[
Çme
]

558 
’d


	@src/m2.lua

1 
loÿl
 
	gmÚ£rv”
 = 
»quœe
 'monserver'

3 
moduË
('bamboo.m2', 
·ckage
.
£—Î
)

5 
funùiÚ
 
	$fšdHªdËr
(
m2cÚf
, 
rou‹
, 
ho¡_Çme
)

6 
loÿl
 
ho¡_Çme
 = ho¡_Çm
Ü
 
m2cÚf
.
£rv”s
[1].
deçuÉ_ho¡


8 
_
, 
£rv”
 
š
 
	$aœs
(
m2cÚf
.
£rv”s
) do

9 
_
, 
ho¡
 
š
 
	$aœs
(
£rv”
.
ho¡s
) do

10 
ho¡
.
Çme
 =ğ
ho¡_Çme
 
th’


11  
ho¡
.
rou‹s
[
rou‹
]

12 
’d


13 
’d


14 
’d


16  
n


17 
’d


19 --- 
lßd
 
cÚfigu¿tiÚ
 
äom
 
mÚ£rv”
's config.sqlite

22 
funùiÚ
 
	$lßdCÚfig
(
cÚfig
)

23 
loÿl
 
cÚfig_fe
 = 
	`lßdfe
(
cÚfig
.config_file)

24 -- 
»Ëa£
 
the
 
glob®
 
v¬ŸbËs
 
to
 
cÚfig
 
bË


25 
	`£tãnv
(
	`as£¹
(
cÚfig_fe
, "FaedØlßd mÚ£rv” cÚfig fe."), 
cÚfig
)()

26 
	$±abË
(
cÚfig
)

28 
loÿl
 
hªdËr
 = 
	$fšdHªdËr
(
cÚfig
, cÚfig.
rou‹
, cÚfig.
ho¡
)

29 
	`as£¹
(
hªdËr
, "FaedØfšd„ou‹: " .. 
cÚfig
.
rou‹
 ..

32 
cÚfig
.
sub_addr
 = 
hªdËr
.
£nd_¥ec


33 
cÚfig
.
pub_addr
 = 
hªdËr
.
»cv_¥ec


35  
cÚfig


36 
’d


40 --- 
ü—‹
 
a
 
Ãw
 
cÚÃùiÚ
 
b‘w“n
 
bamboo
 
ªd
 
	`mogÄ–2
 (
vŸ
 
z”omq
)

41 -- @ 
cÚn
: 
Ãw
 
ü—‹d
 
cÚÃùiÚ


43 
funùiÚ
 
	$cÚÃù
(
cÚfig
)

44 
loÿl
 
sub_addr
, 
pub_addr
 = 
cÚfig
.sub_addr, config.pub_addr

45 
	`´št
("CONNECTING", 
cÚfig
.
rou‹
, cÚfig.
£nd”_id
, 
sub_addr
, 
pub_addr
)

47 
loÿl
 
ùx
 = 
mÚ£rv”
.
	$Ãw
(
cÚfig
.
io_th»ads
)

48 
loÿl
 
cÚn
 = 
ùx
:
	$Ãw_cÚÃùiÚ
(
cÚfig
.
£nd”_id
, 
sub_addr
, 
pub_addr
)

50 
	`as£¹
(
cÚn
, "Failedo start Monserver connection.")

52  
cÚn


53 
’d


	@src/model.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

2 
loÿl
 
sock‘
 = 
»quœe
 'socket'

4 
loÿl
 
tš£¹
, 
Œemove
 = 
bË
.
š£¹
,abË.
»move


5 
loÿl
 
fÜm©
 = 
¡ršg
.format

7 
loÿl
 
db
 = 
BAMBOO_DB


10 
loÿl
 
Li¡
 = 
»quœe
 'lglib.list'

11 
loÿl
 
rd¡ršg
 = 
»quœe
 'bamboo.redis.string'

12 
loÿl
 
rdli¡
 = 
»quœe
 'bamboo.redis.list'

13 
loÿl
 
rd£t
 = 
»quœe
 'bamboo.redis.set'

14 
loÿl
 
rdz£t
 = 
»quœe
 'bamboo.redis.zset'

15 
loÿl
 
rdfifo
 = 
»quœe
 'bamboo.redis.fifo'

16 
loÿl
 
rdzfifo
 = 
»quœe
 'bamboo.redis.zfifo'

17 
loÿl
 
rdhash
 = 
»quœe
 'bamboo.redis.hash'

20 
loÿl
 
g‘Mod–ByName
 = 
bamboo
.getModelByName

21 
loÿl
 
dcŞËùÜ
= 'DELETED:COLLECTOR'

23 
loÿl
 
Qu”yS‘


24 
loÿl
 
Mod–


27 
loÿl
 
rdaùiÚs
 = {

37 
	}
}

39 
	grdaùiÚs
['¡ršg'].
	g§ve
 = 
rd¡ršg
.
§ve


40 
rdaùiÚs
['¡ršg'].
upd©e
 = 
rd¡ršg
.update

41 
rdaùiÚs
['¡ršg'].
»Œ›ve
 = 
rd¡ršg
.retrieve

42 
rdaùiÚs
['¡ršg'].
»move
 = 
rd¡ršg
.remove

43 
rdaùiÚs
['¡ršg'].
add
 = 
rd¡ršg
.add

44 
rdaùiÚs
['¡ršg'].
has
 = 
rd¡ršg
.has

45 
rdaùiÚs
['¡ršg'].
num
 = 
rd¡ršg
.num

47 
rdaùiÚs
['li¡'].
§ve
 = 
rdli¡
.save

48 
rdaùiÚs
['li¡'].
upd©e
 = 
rdli¡
.update

49 
rdaùiÚs
['li¡'].
»Œ›ve
 = 
rdli¡
.retrieve

50 
rdaùiÚs
['li¡'].
»move
 = 
rdli¡
.remove

51 --
rdaùiÚs
['li¡'].
add
 = 
rdli¡
.add

52 
rdaùiÚs
['li¡'].
add
 = 
rdli¡
.
­³nd


53 
rdaùiÚs
['li¡'].
has
 = 
rdli¡
.has

54 --
rdaùiÚs
['li¡'].
num
 = 
rdli¡
.num

55 
rdaùiÚs
['li¡'].
num
 = 
rdli¡
.
Ën


57 
rdaùiÚs
['£t'].
§ve
 = 
rd£t
.save

58 
rdaùiÚs
['£t'].
upd©e
 = 
rd£t
.update

59 
rdaùiÚs
['£t'].
»Œ›ve
 = 
rd£t
.retrieve

60 
rdaùiÚs
['£t'].
»move
 = 
rd£t
.remove

61 
rdaùiÚs
['£t'].
add
 = 
rd£t
.add

62 
rdaùiÚs
['£t'].
has
 = 
rd£t
.has

63 
rdaùiÚs
['£t'].
num
 = 
rd£t
.num

65 
rdaùiÚs
['z£t'].
§ve
 = 
rdz£t
.save

66 
rdaùiÚs
['z£t'].
upd©e
 = 
rdz£t
.update

67 
rdaùiÚs
['z£t'].
»Œ›ve
 = 
rdz£t
.retrieve

68 
rdaùiÚs
['z£t'].
»move
 = 
rdz£t
.remove

69 
rdaùiÚs
['z£t'].
add
 = 
rdz£t
.add

70 
rdaùiÚs
['z£t'].
has
 = 
rdz£t
.has

71 
rdaùiÚs
['z£t'].
num
 = 
rdz£t
.num

73 
rdaùiÚs
['hash'].
§ve
 = 
rdhash
.save

74 
rdaùiÚs
['hash'].
upd©e
 = 
rdhash
.update

75 
rdaùiÚs
['hash'].
»Œ›ve
 = 
rdhash
.retrieve

76 
rdaùiÚs
['hash'].
»move
 = 
rdhash
.remove

77 
rdaùiÚs
['hash'].
add
 = 
rdhash
.add

78 
rdaùiÚs
['hash'].
has
 = 
rdhash
.has

79 
rdaùiÚs
['hash'].
num
 = 
rdhash
.num

81 
rdaùiÚs
['FIFO'].
§ve
 = 
rdfifo
.save

82 
rdaùiÚs
['FIFO'].
upd©e
 = 
rdfifo
.update

83 
rdaùiÚs
['FIFO'].
»Œ›ve
 = 
rdfifo
.retrieve

84 
rdaùiÚs
['FIFO'].
»move
 = 
rdfifo
.remove

85 
rdaùiÚs
['FIFO'].
add
 = 
rdfifo
.
push


86 
rdaùiÚs
['FIFO'].
has
 = 
rdfifo
.has

87 
rdaùiÚs
['FIFO'].
num
 = 
rdfifo
.
Ën


89 
rdaùiÚs
['ZFIFO'].
§ve
 = 
rdzfifo
.save

90 
rdaùiÚs
['ZFIFO'].
upd©e
 = 
rdzfifo
.update

91 
rdaùiÚs
['ZFIFO'].
»Œ›ve
 = 
rdzfifo
.retrieve

92 
rdaùiÚs
['ZFIFO'].
»move
 = 
rdzfifo
.remove

93 
rdaùiÚs
['ZFIFO'].
add
 = 
rdzfifo
.
push


94 
rdaùiÚs
['ZFIFO'].
has
 = 
rdzfifo
.has

95 
rdaùiÚs
['ZFIFO'].
num
 = 
rdzfifo
.num

97 
rdaùiÚs
['LIST'] =„dactions['list']

98 
rdaùiÚs
['MANY'] =„dactions['zset']

100 
loÿl
 
g‘StÜeModuË
 = 
	$funùiÚ
 (
¡Üe_ty³
)

101 
loÿl
 
¡Üe_moduË
 = 
rdaùiÚs
[
¡Üe_ty³
]

102 
	`as£¹
Ğ
¡Üe_moduË
, "[Error] storeype must be one of 'string', 'list', 'set', 'zset' or 'hash'.")

103  
¡Üe_moduË


104 
’d


109 
loÿl
 
funùiÚ
 
	$g‘CouÁ”Name
(
£lf
)

110  
£lf
.
__Çme
 + ':__counter'

111 
’d


113 --  
a
 
¡ršg


114 
loÿl
 
funùiÚ
 
	$g‘CouÁ”
(
£lf
)

115  
db
:
	`g‘
(
	$g‘CouÁ”Name
(
£lf
)è
Ü
 '0'

116 
’d
;

118 
loÿl
 
funùiÚ
 
	$g‘NameIdP©‹º
(
£lf
)

119  
£lf
.
__Çme
 + ':' + s–f.
id


120 
’d


122 
loÿl
 
funùiÚ
 
	$g‘NameIdP©‹º2
(
£lf
, 
id
)

123  
£lf
.
__Çme
 + ':' + 
	$to¡ršg
(
id
)

124 
’d


126 
loÿl
 
funùiÚ
 
	$g‘F›ldP©‹º
(
£lf
, 
f›ld
)

127  
	`g‘NameIdP©‹º
(
£lf
è+ ':' + 
f›ld


128 
’d


130 
loÿl
 
funùiÚ
 
	$g‘F›ldP©‹º2
(
£lf
, 
id
, 
f›ld
)

131  
	`g‘NameIdP©‹º2
(
£lf
, 
id
è+ ':' + 
f›ld


132 
’d


134 --  
the
 
key
 
of
 
some
 
¡ršg
 
like
 'User'

136 
loÿl
 
funùiÚ
 
	$g‘CÏssName
(
£lf
)

137 
	`ty³
(
£lf
è~ğ'bË' 
th’
  
n
 
’d


138  
£lf
.
__g
:
	`m©ch
('%.(%w+)$')

139 
’d


141 --  
the
 
key
 
of
 
some
 
¡ršg
 
like
 'User:__index'

143 
loÿl
 
funùiÚ
 
	$g‘IndexKey
(
£lf
)

144  
	`g‘CÏssName
(
£lf
) + ':__index'

145 
’d


147 
loÿl
 
funùiÚ
 
	$g‘CÏssIdP©‹º
(
£lf
)

148  
	`g‘CÏssName
(
£lf
è+ s–f.
id


149 
’d


151 
loÿl
 
funùiÚ
 
	$g‘Cu¡omKey
(
£lf
, 
key
)

152  
	`g‘CÏssName
(
£lf
è+ ':cu¡om:' + 
key


153 
’d


155 
loÿl
 
funùiÚ
 
	$g‘Cu¡omIdKey
(
£lf
, 
key
)

156  
	`g‘CÏssName
(
£lf
è+ ':' + s–f.
id
 + ':cu¡om:' + 
key


157 
’d


159 
loÿl
 
funùiÚ
 
	$g‘CacheKey
(
£lf
, 
key
)

160  
	`g‘CÏssName
(
£lf
è+ ':ÿche:' + 
key


161 
’d


163 
loÿl
 
funùiÚ
 
	$g‘Cach‘y³Key
(
£lf
, 
key
)

164  'CACHETYPE:' + 
	$g‘CacheKey
(
£lf
, 
key
)

165 
’d


167 
loÿl
 
funùiÚ
 
	$g‘DyÇmicF›ldKey
(
£lf
, 
key
)

168  
	`g‘CÏssName
(
£lf
è+ ':dyÇmic_f›ld:' + 
key


169 
’d


171 
loÿl
 
funùiÚ
 
	$g‘DyÇmicF›ldIndex
(
£lf
)

172  
	`g‘CÏssName
(
£lf
) + ':dynamic_field:__index'

173 
’d


175 
loÿl
 
funùiÚ
 
	$makeMod–KeyLi¡
(
£lf
, 
ids
)

176 
loÿl
 
key_li¡
 = 
	$Li¡
()

177 
_
, 
v
 
š
 
	$aœs
(
ids
) do

178 
key_li¡
:
	`­³nd
(
	$g‘NameIdP©‹º2
(
£lf
, 
v
))

179 
’d


180  
key_li¡


181 
’d


184 -- 
ÿn
 
be
 
ÿÎed
 
by
 
š¡ªû
 
ªd
 
şass


185 
loÿl
 
isUsšgFuÎ‹xtIndex
 = 
	$funùiÚ
 (
£lf
)

186 
loÿl
 
mod–
 = 
£lf


187 
	$isIn¡ªû
(
£lf
è
th’
 
mod–
 = 
	`g‘Mod–ByName
(£lf:
	$şas¢ame
()è
’d


188 
bamboo
.
cÚfig
.
fuÎ‹xt_šdex_suµÜt
 
ªd
 
	`¿wg‘
(
mod–
, '__u£_fuÎ‹xt_šdex'è
th’


189  
Œue


191  
çl£


192 
’d


193 
’d


195 
loÿl
 
isUsšgRuËIndex
 = 
	$funùiÚ
 (
£lf
)

196 
bamboo
.
cÚfig
.
ruË_šdex_suµÜt
 
ªd
 
£lf
.
__u£_ruË_šdex
‡nd s–f.
__Çme
 
th’


197  
Œue


198 
’d


199  
çl£


200 
’d


202 -- 
š
 
mod–
 
glob®
 
šdex
 
	`ÿche
 (
back’d
 
is
 
z£t
),

203 -- 
check
 
the
 
exi¡ªû
 
of
 
some
 
memb”
 
by
 
™s
 
	`id
 (
scÜe
)

205 
loÿl
 
funùiÚ
 
	$checkExi¡ªûById
(
£lf
, 
id
)

206 
loÿl
 
šdex_key
 = 
	$g‘IndexKey
(
£lf
)

207 
loÿl
 
r
 = 
db
:
	$z¿ngebyscÜe
(
šdex_key
, 
id
, id)

208 #¸=ğ0 
th’


209  
çl£
, ''

211 --  
the
 
fœ¡
 
–em’t
, 
r
 
is
 
a
 
li¡


212  
Œue
, 
r
[1]

213 
’d


214 
’d


216 --  
the
 
mod–
 
·¹
 
ªd
h
id
…art

217 -- 
nÜm®
 , 
g‘
 
the
 
mod–
 
¡ršg
 
ªd
  
™em
 
dœeùly


218 -- 
UNFIXED
 , 
¥l™
 
the
 UNFIXED 
mod–
:
id
 
ªd
 

219 -- 
this
 
funùiÚ
 
dÛ¢
't suite ANYSTRING case

220 
loÿl
 
funùiÚ
 
	$£³¿‹Mod–AndId
(
™em
)

221 
loÿl
 
lšk_mod–
, 
lšked_id


222 
loÿl
 
lšk_mod–_¡r


223 
lšk_mod–_¡r
, 
lšked_id
 = 
™em
:
	`m©ch
('^(%w+):(%d+)$')

224 
	$as£¹
(
lšk_mod–_¡r
)

225 
	$as£¹
(
lšked_id
)

226 
lšk_mod–
 = 
	$g‘Mod–ByName
(
lšk_mod–_¡r
)

227 
	$as£¹
(
lšk_mod–
)

229  
lšk_mod–
, 
lšked_id


230 
’d


232 
loÿl
 
makeObjeù
 = 
	`funùiÚ
 (
£lf
, 
d©a
)

233 -- 
d©a
 
is
 
šv®id
,  
n


234 
nÙ
 
	$isV®idIn¡ªû
(
d©a
è
th’
 
	`´št
("[W¬nšg] @makeObjeù - Objeù i šv®id.");  
n
 
’d


235 -- 
XXX
: 
k“p
 
id
 
as
 
¡ršg
 
cÚv›ÃÁ
, 
beÿu£
 
h‰p
 
ªd
 
d©aba£
 
¬e
 
®l
 string

236 -- 
d©a
.
id
 = 
	$tÚumb”
(
d©a
.
id
è
Ü
 data.id

238 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


239 
k
, 
æd
 
š
 
	$·œs
(
f›lds
) do

240 -- 
’su»
 
the
 
cÜ»ùiÚ
 
of
 
f›ld
 
desütiÚ
 
bË


241 
	`checkTy³
(
æd
, 'table')

242 -- 
cÚv”t
 
the
 
numb”
 
ty³
 
f›ld


244 
æd
.
fÜeign
 
th’


245 
loÿl
 
¡
 = 
æd
.st

246 -- 
š
 
»dis
, 
we
 
dÚ
't save MANY foreign key in db, but we wanto fillhem when

247 -- 
fÜm
 
lua
 
objeù


248 
¡
 =ğ'MANY' 
th’


249 
d©a
[
k
] = 'FOREIGN MANY ' .. 
æd
.
fÜeign


250 
–£if
 
¡
 =ğ'FIFO' 
th’


251 
d©a
[
k
] = 'FOREIGN FIFO ' .. 
æd
.
fÜeign


252 
–£if
 
¡
 =ğ'ZFIFO' 
th’


253 
d©a
[
k
] = 'FOREIGN ZFIFO ' .. 
æd
.
fÜeign


254 
–£if
 
¡
 =ğ'LIST' 
th’


255 
d©a
[
k
] = 'FOREIGN LIST ' .. 
æd
.
fÜeign


256 
’d


258 
æd
.
ty³
 =ğ'numb”' 
th’


259 
d©a
[
k
] = 
	$tÚumb”
(
d©a
[
k
])

260 
’d


261 
’d


263 
’d


265 -- 
g’”©e
 
ª
 
objeù


266 -- 
XXX
: 
maybe
 
ÿn
 
put
 'd©a' 
as
 
·¿m‘”
 
of
 
	$£lf
()

267 
loÿl
 
obj
 = 
	$£lf
()

268 
bË
.
	$upd©e
(
obj
, 
d©a
)

269  
obj


271 
’d


274 
loÿl
 
ş—rFtIndexesOnD–‘iÚ
 = 
	$funùiÚ
 (
š¡ªû
)

275 
loÿl
 
mod–_key
 = 
	$g‘NameIdP©‹º
(
š¡ªû
)

276 
loÿl
 
wÜds
 = 
db
:
	`smemb”s
('_RFT:' + 
mod–_key
)

277 
db
:
	`p–še
(
	$funùiÚ
 (
p
)

278 
_
, 
wÜd
 
š
 
	$aœs
(
wÜds
) do

279 
p
:
	`¤em
(
	`fÜm©
('_FT:%s:%s', 
š¡ªû
.
__Çme
, 
wÜd
), 
mod–_key
)

280 
’d


281 
’d
)

282 -- 
ş—r
 
the
 
»v”£
 
fuÎ‹xt
 
key


283 
db
:
	`d–
('_RFT:' + 
mod–_key
)

284 
’d


289 -- 
this
 
funùiÚ
 
ÿn
 
Úly
 
be
 
ÿÎed
 
by
 
Mod–


290 -- @
·¿m
 
mod–_key
:

292 
loÿl
 
g‘FromRedis
 = 
	`funùiÚ
 (
£lf
, 
mod–_key
)

293 -- 
h”e
, 
the
 
d©a
 
bË
 
cÚš
 
Üdš¬y
 
f›ld
, 
ONE
 
fÜeign
 
key
, 
but
 
nÙ
 
MANY
 foreign key

294 -- 
®l
 
f›lds
 
¬e
 
¡ršgs


295 
loÿl
 
d©a
 = 
db
:
	$hg‘®l
(
mod–_key
)

296  
	$makeObjeù
(
£lf
, 
d©a
)

298 
’d


302 
loÿl
 
g‘FromRedisP–še
 = 
	$funùiÚ
 (
£lf
, 
ids
)

303 
loÿl
 
key_li¡
 = 
	`makeMod–KeyLi¡
(
£lf
, 
ids
)

304 --
	`DEBUG
(
key_li¡
)

306 -- 
®l
 
f›lds
 
¬e
 
¡ršgs


307 
loÿl
 
d©a_li¡
 = 
db
:
	`p–še
(
	$funùiÚ
 (
p
)

308 
_
, 
v
 
š
 
	$aœs
(
key_li¡
) do

309 
p
:
	$hg‘®l
(
v
)

310 
’d


311 
’d
)

313 
loÿl
 
objs
 = 
	$Qu”yS‘
()

314 
loÿl
 
obj


315 
_
, 
v
 
š
 
	$aœs
(
d©a_li¡
) do

316 
obj
 = 
	$makeObjeù
(
£lf
, 
v
)

317 
obj
 
th’
 
objs
:
	$­³nd
(
obj
è
’d


318 
’d


320  
objs


321 
’d


324 
loÿl
 
g‘P¬tŸlFromRedisP–še
 = 
	$funùiÚ
 (
£lf
, 
ids
, 
f›lds
)

325 
loÿl
 
key_li¡
 = 
	`makeMod–KeyLi¡
(
£lf
, 
ids
)

326 -- 
	`DEBUG
('key_li¡', 
key_li¡
, 'f›lds', 
f›lds
)

328 -- 
®l
 
f›lds
 
¬e
 
¡ršgs


329 
loÿl
 
d©a_li¡
 = 
db
:
	`p–še
(
	$funùiÚ
 (
p
)

330 
_
, 
v
 
š
 
	$aœs
(
key_li¡
) do

331 
p
:
	`hmg‘
(
v
, 
	$uÅack
(
f›lds
))

332 
’d


333 
’d
)

334 -- 
ev”y
 
™em
 
is
 
d©a_li¡
 
now
 i 
the
 
v®ues
 
accÜdšg
 
to
 'fields'

335 --
	`DEBUG
('d©a_li¡', 
d©a_li¡
)

337 
loÿl
 
objs
 = {
	}
}

338 
loÿl
 
obj


339 
_
, 
v
 
š
 
	$aœs
(
d©a_li¡
) do

340 
loÿl
 
™em
 = {
	}
}

341 
i
, 
key
 
š
 
	$aœs
(
f›lds
) do

342 -- 
v
[
i
] 
is
 
the
 
v®ue
 
of
 
™h
 
key


343 
™em
[
key
] = 
v
[
i
]

344 
’d


345 
nÙ
 
	$isF®£
(
™em
è
th’
 
	$tš£¹
(
objs
, 
™em
è
’d


346 
’d


348  
objs


349 
’d


351 -- 
u£
 
š
 "U£r:id" 
as
 
—ch
 
™em
 
key


352 
loÿl
 
g‘FromRedisP–še2
 = 
	`funùiÚ
 (
·‰”n_li¡
)

353 -- 'li¡' 
¡Üe
 
mod–
 
ªd
 
id
 
šfo


354 
loÿl
 
mod–_li¡
 = 
	$Li¡
()

355 
_
, 
v
 
š
 
	$aœs
(
·‰”n_li¡
) do

356 
loÿl
 
mod–
, 
id
 = 
	$£³¿‹Mod–AndId
(
v
)

357 
mod–_li¡
:
	$­³nd
(
mod–
)

358 
’d


360 -- 
®l
 
f›lds
 
¬e
 
¡ršgs


361 
loÿl
 
d©a_li¡
 = 
db
:
	`p–še
(
	$funùiÚ
 (
p
)

362 
_
, 
v
 
š
 
	$aœs
(
·‰”n_li¡
) do

363 
p
:
	$hg‘®l
(
v
)

364 
’d


365 
’d
)

367 
loÿl
 
objs
 = 
	$Qu”yS‘
()

368 
loÿl
 
obj


369 
i
, 
mod–
 
š
 
	$aœs
(
mod–_li¡
) do

370 
obj
 = 
	$makeObjeù
(
mod–
, 
d©a_li¡
[
i
])

371 
obj
 
th’
 
objs
:
	$­³nd
(
obj
è
’d


372 
’d


374  
objs


375 
’d


378 -- 
this
 
funùiÚ
 
ÿn
 
be
 
ÿÎed
 
by
 
š¡ªû
 
Ü
 
şass


380 
loÿl
 
d–FromRedis
 = 
	$funùiÚ
 (
£lf
, 
id
)

381 
	`as£¹
(
£lf
.
id
 
Ü
 id, '[Error] @delFromRedis - must specify‡n id of instance.')

382 
loÿl
 
mod–_key
 = 
id
 
ªd
 
	$g‘NameIdP©‹º2
(
£lf
, 
id
è
Ü
 
	$g‘NameIdP©‹º
(
£lf
)

383 
loÿl
 
šdex_key
 = 
	$g‘IndexKey
(
£lf
)

385 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


386 -- 
š
 
»dis
, 
d–‘e
 
the
 
assocŸ‹d
 
fÜeign
 
key
-
v®ue
 
¡Üe


387 
k
, 
v
 
š
 
	$·œs
(
£lf
) do

388 
loÿl
 
æd
 = 
f›lds
[
k
]

389 
æd
 
ªd
 fld.
fÜeign
 
th’


390 
loÿl
 
key
 = 
mod–_key
 + ':' + 
k


391 
db
:
	$d–
(
key
)

392 
’d


393 
’d


395 -- 
d–‘e
 
the
 
key
 
£lf


396 
db
:
	`d–
(
mod–_key
)

397 -- 
d–‘e
 
the
 
šdex
 
š
h
glob®
 
mod–
 index 
z£t


398 
db
:
	`z»m¿ngebyscÜe
(
šdex_key
, 
£lf
.
id
 
Ü
 id, self.id or id)

400 -- 
ş—r
 
fuÎ‹xt
 
šdex
, 
Úly
 
wh’
 
™
 
is
 
š¡ªû


401 
	$isUsšgFuÎ‹xtIndex
(
£lf
è
ªd
 s–f.
id
 
th’


402 
	$ş—rFtIndexesOnD–‘iÚ
(
£lf
)

403 
’d


404 
	$isUsšgRuËIndex
(
£lf
è
ªd
 s–f.
id
 
th’


405 
	`upd©eIndexByRuËs
(
£lf
, 'del')

406 
’d


408 -- 
»Ëa£
 
the
 
lua
 
objeù


409 
£lf
 = 
n


410 
’d


413 -- 
Fake
 
D–‘iÚ


414 -- 
ÿÎed
 
by
 
š¡ªû


415 
loÿl
 
çked–FromRedis
 = 
	$funùiÚ
 (
£lf
, 
id
)

416 
	`as£¹
(
£lf
.
id
 
Ü
 id, '[Error] @fakedelFromRedis - must specify‡n id of instance.')

417 
loÿl
 
mod–_key
 = 
id
 
ªd
 
	$g‘NameIdP©‹º2
(
£lf
, 
id
è
Ü
 
	$g‘NameIdP©‹º
(
£lf
)

418 
loÿl
 
šdex_key
 = 
	$g‘IndexKey
(
£lf
)

420 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


421 -- 
š
 
»dis
, 
d–‘e
 
the
 
assocŸ‹d
 
fÜeign
 
key
-
v®ue
 
¡Üe


422 
k
, 
v
 
š
 
	$·œs
(
£lf
) do

423 
loÿl
 
æd
 = 
f›lds
[
k
]

424 
æd
 
ªd
 fld.
fÜeign
 
th’


425 
loÿl
 
key
 = 
mod–_key
 + ':' + 
k


426 
db
:
	$exi¡s
(
key
è
th’


427 
db
:
	`»Çme
(
key
, 'DELETED:' + key)

428 
’d


429 
’d


430 
’d


432 -- 
»Çme
 
the
 
key
 
£lf


433 
db
:
	`»Çme
(
mod–_key
, 'DELETED:' + model_key)

434 -- 
d–‘e
 
the
 
šdex
 
š
h
glob®
 
mod–
 index 
z£t


435 -- 
wh’
 
d–‘ed
, 
the
 
š¡ªû
's index cache was cleaned.

436 
db
:
	`z»m¿ngebyscÜe
(
šdex_key
, 
£lf
.
id
 
Ü
 id, self.id or id)

437 -- 
add
 
to
 
d–‘ed
 
cŞËùÜ


438 
rdz£t
.
	`add
(
dcŞËùÜ
, 
mod–_key
)

440 -- 
ş—r
 
fuÎ‹xt
 
šdex


441 
	$isUsšgFuÎ‹xtIndex
(
£lf
è
ªd
 s–f.
id
 
th’


442 
	$ş—rFtIndexesOnD–‘iÚ
(
£lf
)

443 
’d


444 
	$isUsšgRuËIndex
(
£lf
è
ªd
 s–f.
id
 
th’


445 
	`upd©eIndexByRuËs
(
£lf
, 'del')

446 
’d


448 -- 
»Ëa£
 
the
 
lua
 
objeù


449 
£lf
 = 
n


450 
’d


453 -- 
Re¡Üe
 
Fake
 
D–‘iÚ


454 -- 
ÿÎed
 
by
 
Some
 
Mod–
: 
£lf
, 
nÙ
 
š¡ªû


455 
loÿl
 
»¡ÜeFakeD–‘edIn¡ªû
 = 
	$funùiÚ
 (
£lf
, 
id
)

456 
	`checkTy³
(
	`tÚumb”
(
id
), 'number')

457 
loÿl
 
mod–_key
 = 
	$g‘NameIdP©‹º2
(
£lf
, 
id
)

458 
loÿl
 
šdex_key
 = 
	$g‘IndexKey
(
£lf
)

460 
loÿl
 
š¡ªû
 = 
	`g‘FromRedis
(
£lf
, 'DELETED:' + 
mod–_key
)

461 
nÙ
 
š¡ªû
 
th’
  
n
 
’d


462 -- 
»Çme
 
the
 
key
 
£lf


463 
db
:
	`»Çme
('DELETED:' + 
mod–_key
, model_key)

464 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


465 -- 
š
 
»dis
, 
»¡Üe
 
the
 
assocŸ‹d
 
fÜeign
 
key
-
v®ue


466 
k
, 
v
 
š
 
	$·œs
(
š¡ªû
) do

467 
loÿl
 
æd
 = 
f›lds
[
k
]

468 
æd
 
ªd
 fld.
fÜeign
 
th’


469 
loÿl
 
key
 = 
mod–_key
 + ':' + 
k


470 
db
:
	`exi¡s
('DELETED:' + 
key
è
th’


471 
db
:
	`»Çme
('DELETED:' + 
key
, key)

472 
’d


473 
’d


474 
’d


476 -- 
wh’
 
»¡Üe
, 
the
 
š¡ªû
's index cache was„estored.

477 
db
:
	`zadd
(
šdex_key
, 
š¡ªû
.
id
, instance.id)

478 -- 
»move
 
äom
 
d–‘ed
 
cŞËùÜ


479 
db
:
	$z»m
(
dcŞËùÜ
, 
mod–_key
)

481  
š¡ªû


482 
’d


485 
loÿl
 
»Œ›veObjeùsByFÜeignTy³
 = 
	$funùiÚ
 (
fÜeign
, 
li¡
)

486 
loÿl
 
obj_li¡


488 
fÜeign
 =ğ'ANYSTRING' 
th’


489 --  
¡ršg
 
li¡
 
dœeùly


490  
	$Qu”yS‘
(
li¡
)

491 
–£if
 
fÜeign
 =ğ'UNFIXED' 
th’


492  
	$g‘FromRedisP–še2
(
li¡
)

494 -- 
fÜeign
 
f›ld
 
¡Ües
 "id, id, id" 
li¡


495 
loÿl
 
mod–
 = 
	$g‘Mod–ByName
(
fÜeign
)

496  
	$g‘FromRedisP–še
(
mod–
, 
li¡
)

497 
’d


499 
’d


503 
bamboo
.
cÚfig
.
fuÎ‹xt_šdex_suµÜt
 
th’
 
»quœe
 'mm£g' 
’d


504 -- 
FuÎ
 
Text
 
S—rch
 
ut™›s


505 -- @
·¿m
 
š¡ªû
 
the
 
objeù
 
to
 
be
 
fuÎ
 
‹xt
 
šdexes


506 
loÿl
 
makeFuÎ‹xtIndexes
 = 
	$funùiÚ
 (
š¡ªû
)

508 
loÿl
 
ášdex_f›lds
 = 
š¡ªû
['__fulltext_index_fields']

509 
	$isF®£
(
ášdex_f›lds
è
th’
  
çl£
 
’d


511 
loÿl
 
wÜds


512 
_
, 
v
 
š
 
	$aœs
(
ášdex_f›lds
) do

513 -- 
·r£
 
the
 
fuÎ‹xt
 
f›ld
 
v®ue


514 
wÜds
 = 
mm£g
.
	$£gm’t
(
š¡ªû
[
v
])

515 
_
, 
wÜd
 
š
 
	$aœs
(
wÜds
) do

516 -- 
Úly
 
šdex
 
wÜd
 
Ëngth
 
Ïrg”
 
thª
 1

517 
¡ršg
.
	`utf8Ën
(
wÜd
è>ğ2 
th’


518 -- 
add
 
this
 
wÜd
 
to
 
glob®
 wÜd 
£t


519 
db
:
	`§dd
(
	`fÜm©
('_fuÎ‹xt_wÜds:%s', 
š¡ªû
.
__Çme
), 
wÜd
)

520 -- 
add
 
»v”£
 
fuÎ‹xt
 
šdex
 
such
 
as
 '_RFT:mod–:id', 
ty³
 
is
 
£t
, 
™em
 is 'word'

521 
db
:
	`§dd
(
	`fÜm©
('_RFT:%s', 
	`g‘NameIdP©‹º
(
š¡ªû
)), 
wÜd
)

522 -- 
add
 
fuÎ‹xt
 
šdex
 
such
 
as
 '_FT:wÜd', 
ty³
 
is
 
£t
, 
™em
 is 'model:id'

523 
db
:
	`§dd
(
	`fÜm©
('_FT:%s:%s', 
š¡ªû
.
__Çme
, 
wÜd
), in¡ªû.
id
)

524 
’d


525 
’d


526 
’d


528  
Œue


529 
’d


531 
loÿl
 
wÜdSegm’tOnFtIndex
 = 
	$funùiÚ
 (
£lf
, 
ask_¡r
)

532 
loÿl
 
£¬ch_gs
 = 
mm£g
.
	$£gm’t
(
ask_¡r
)

533 
loÿl
 
gs
 = 
	$Li¡
()

534 
_
, 
g
 
š
 
	$aœs
(
£¬ch_gs
) do

535 
¡ršg
.
	`utf8Ën
(
g
è>ğ2 
ªd
 
db
:
	`sismemb”
(
	`fÜm©
('_fuÎ‹xt_wÜds:%s', 
£lf
.
__Çme
),agè
th’


536 
gs
:
	$­³nd
(
g
)

537 
’d


538 
’d


539  
gs


540 
’d


543 
loÿl
 
£¬chOnFuÎ‹xtIndexes
 = 
	$funùiÚ
 (
£lf
, 
gs
, 
n
)

544 #g =ğ0 
th’
  
	$Li¡
(è
’d


546 
loÿl
 
¾i¡
 = 
	$Li¡
()

547 
loÿl
 
_tmp_key
 = "__tmp_ftkey"

548 #g =ğ1 
th’


549 
db
:
	`sš‹r¡Üe
(
_tmp_key
, 
	`fÜm©
('_FT:%s:%s', 
£lf
.
__Çme
, 
gs
[1]))

551 
loÿl
 
_¬gs
 = {
	}
}

552 
_
, 
g
 
š
 
	$aœs
(
gs
) do

553 
bË
.
	`š£¹
(
_¬gs
, 
	`fÜm©
('_FT:%s:%s', 
£lf
.
__Çme
, 
g
))

554 
’d


555 -- 
XXX
, 
some
 
aäaid


556 
db
:
	`sš‹r¡Üe
(
_tmp_key
, 
	$uÅack
(
_¬gs
))

557 
’d


559 
loÿl
 
lim™s


560 
n
 
ªd
 
	`ty³
Òè=ğ'numb”'‡nd‚ > 0 
th’


561 
lim™s
 = {0, 
n
}

563 
lim™s
 = 
n


564 
’d


565 -- 
sÜt
 
ªd
 
»Œ›ve


566 
loÿl
 
ids
 = 
db
:
sÜt
(
_tmp_key
, {
lim™
=
lim™s
, sort="desc"})

567 --  
objeùs


568  
	$g‘FromRedisP–še
(
£lf
, 
ids
)

569 
’d


572 -- 
The
 
b–low
 
four
 
as£¹©iÚs
, 
they
 
¬e
 
ÿÎed
 
Úly
 
by
 
şass
, 
š¡ªû
 
Ü
 
qu”y
 
£t


575 -- 
judge
 
™
 
is
 
a
 
şass


577 
_G
['isCÏss'] = 
	$funùiÚ
 (
t
)

578 
t
.
isCÏss
 
th’


579 
	`ty³
(
t
.
isCÏss
è=ğ'funùiÚ' 
th’


580  
t
:
	$isCÏss
()

582  
çl£


583 
’d


585  
çl£


586 
’d


587 
’d


590 -- 
judge
 
™
 
is
 
ª
 
š¡ªû


592 
_G
['isIn¡ªû'] = 
	$funùiÚ
 (
t
)

593 
t
.
isIn¡ªû
 
th’


594 
	`ty³
(
t
.
isIn¡ªû
è=ğ'funùiÚ' 
th’


595  
t
:
	$isIn¡ªû
()

597  
çl£


598 
’d


600  
çl£


601 
’d


602 
’d


605 -- 
judge
 
™
 
is
 
ª
 
em±y
 
objeù
.

606 -- 
the
 
em±y
 
ruËs
 
¬e
 
defšed
 
by
 
our£lves
, 
£e
 
fŞlows
.

608 
_G
['isV®idIn¡ªû'] = 
	$funùiÚ
 (
obj
)

609 
	$isF®£
(
obj
è
th’
  
çl£
 
’d


610 
	`checkTy³
(
obj
, 'table')

612 
k
, 
v
 
š
 
	$·œs
(
obj
) do

613 
	`ty³
(
k
è=ğ'¡ršg' 
th’


614 
k
 ~ğ'id' 
th’


615  
Œue


616 
’d


617 
’d


618 
’d


620  
çl£


621 
’d
;

624 
_G
['isQu”yS‘'] = 
	$funùiÚ
 (
£lf
)

625 
	$isLi¡
(
£lf
)

626 
ªd
 
	`¿wg‘
(
£lf
, '__¥eùy³'è=ğ
n
‡nd s–f.
__¥eùy³
 == 'QuerySet'

627 
ªd
 
£lf
.
__g
 == 'Object.Model'

628 
th’
  
Œue


629  
çl£


630 
’d


631 
’d


635 
_G
['I_AM_QUERY_SET'] = 
	$funùiÚ
 (
£lf
)

636 
	`as£¹
(
	`isQu”yS‘
(
£lf
), "[Error] This caller is‚ot‡ QuerySet.")

637 
’d


639 
_G
['I_AM_CLASS'] = 
	$funùiÚ
 (
£lf
)

640 
	`as£¹
(
£lf
.
isCÏss
, '[Error] The caller is‚ot‡ valid class.')

641 
	`as£¹
(
£lf
:
	`isCÏss
(), '[Error] This function is only‡llowedo be called by class.')

642 
’d


644 
_G
['I_AM_CLASS_OR_QUERY_SET'] = 
	$funùiÚ
 (
£lf
)

645 
	`as£¹
(
£lf
.
isCÏss
, '[Error] The caller is‚ot‡ valid class.')

646 
	`as£¹
(
£lf
:
	$isCÏss
(è
Ü
 
	`isQu”yS‘
(
£lf
), '[Error] This function is only‡llowedo be called by class or query set.')

647 
’d


649 
_G
['I_AM_INSTANCE'] = 
	$funùiÚ
 (
£lf
)

650 
	`as£¹
(
£lf
.
isIn¡ªû
, '[Error] The caller is‚ot‡ valid instance.')

651 
	`as£¹
(
£lf
:
	`isIn¡ªû
(), '[Error] This function is only‡llowedo be called by instance.')

652 
’d


654 
_G
['I_AM_INSTANCE_OR_QUERY_SET'] = 
	$funùiÚ
 (
£lf
)

655 
	`as£¹
(
£lf
.
isIn¡ªû
, '[Error] The caller is‚ot‡ valid instance.')

656 
	`as£¹
(
£lf
:
	$isIn¡ªû
(è
Ü
 
	`isQu”yS‘
(
£lf
), '[Error] This function is only‡llowedo be called by instance or query set.')

657 
’d


659 
_G
['I_AM_CLASS_OR_INSTANCE'] = 
	$funùiÚ
 (
£lf
)

660 
	`as£¹
(
£lf
.
isCÏss
 
Ü
 s–f.
isIn¡ªû
, '[Error] The caller is‚ot‡ valid class or instance.')

661 
	`as£¹
(
£lf
:
	$isCÏss
(è
Ü
 
£lf
:
	`isIn¡ªû
(), '[Error] This function is only‡llowedo be called by class or instance.')

662 
’d


666 -- 
Qu”y
 
FunùiÚ
 
S‘


667 -- 
cÚv›ÃÁ
, 
impÜt
 
them
 
što
 
_G
 
dœeùly


669 
loÿl
 
şosu»_cŞËùÜ
 = {
	}
}

670 
loÿl
 
upv®ue_cŞËùÜ
 = {}

672 
_G
['eq'] = 
	$funùiÚ
 ( 
cmp_obj
 )

673 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

674 
v
 =ğ
cmp_obj
 
th’


675  
Œue


677  
çl£


678 
’d


679 
’d


680 
şosu»_cŞËùÜ
[
t
] = {'eq', 
cmp_obj
}

681  
t


682 
’d


684 
_G
['uÃq'] = 
	$funùiÚ
 ( 
cmp_obj
 )

685 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

686 
v
 ~ğ
cmp_obj
 
th’


687  
Œue


689  
çl£


690 
’d


691 
’d


692 
şosu»_cŞËùÜ
[
t
] = {'uÃq', 
cmp_obj
}

693  
t


694 
’d


696 
_G
['É'] = 
	$funùiÚ
 (
lim™©iÚ
)

697 
lim™©iÚ
 = 
	$tÚumb”
(
lim™©iÚ
è
Ü
†imitation

698 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

699 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

700 
nv
 
ªd
‚v < 
lim™©iÚ
 
th’


701  
Œue


703  
çl£


704 
’d


705 
’d


706 
şosu»_cŞËùÜ
[
t
] = {'É', 
lim™©iÚ
}

707  
t


708 
’d


710 
_G
['gt'] = 
	$funùiÚ
 (
lim™©iÚ
)

711 
lim™©iÚ
 = 
	$tÚumb”
(
lim™©iÚ
è
Ü
†imitation

712 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

713 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

714 
nv
 
ªd
‚v > 
lim™©iÚ
 
th’


715  
Œue


717  
çl£


718 
’d


719 
’d


720 
şosu»_cŞËùÜ
[
t
] = {'gt', 
lim™©iÚ
}

721  
t


722 
’d


725 
_G
['Ë'] = 
	$funùiÚ
 (
lim™©iÚ
)

726 
lim™©iÚ
 = 
	$tÚumb”
(
lim™©iÚ
è
Ü
†imitation

727 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

728 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

729 
nv
 
ªd
‚v <ğ
lim™©iÚ
 
th’


730  
Œue


732  
çl£


733 
’d


734 
’d


735 
şosu»_cŞËùÜ
[
t
] = {'Ë', 
lim™©iÚ
}

736  
t


737 
’d


739 
_G
['ge'] = 
	$funùiÚ
 (
lim™©iÚ
)

740 
lim™©iÚ
 = 
	$tÚumb”
(
lim™©iÚ
è
Ü
†imitation

741 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

742 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

743 
nv
 
ªd
‚v >ğ
lim™©iÚ
 
th’


744  
Œue


746  
çl£


747 
’d


748 
’d


749 
şosu»_cŞËùÜ
[
t
] = {'ge', 
lim™©iÚ
}

750  
t


751 
’d


753 
_G
['bt'] = 
	$funùiÚ
 (
sm®l
, 
big
)

754 
sm®l
 = 
	$tÚumb”
(
sm®l
è
Ü
 small

755 
big
 = 
	$tÚumb”
(
big
è
Ü
 big

756 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

757 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

758 
nv
 
ªd
‚v > 
sm®l
‡nd‚v < 
big
 
th’


759  
Œue


761  
çl£


762 
’d


763 
’d


764 
şosu»_cŞËùÜ
[
t
] = {'bt', 
sm®l
, 
big
}

765  
t


766 
’d


768 
_G
['be'] = 
	$funùiÚ
 (
sm®l
, 
big
)

769 
sm®l
 = 
	$tÚumb”
(
sm®l
è
Ü
 small

770 
big
 = 
	$tÚumb”
(
big
è
Ü
 big

771 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

772 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

773 
nv
 
ªd
‚v >ğ
sm®l
‡nd‚v <ğ
big
 
th’


774  
Œue


776  
çl£


777 
’d


778 
’d


779 
şosu»_cŞËùÜ
[
t
] = {'be', 
sm®l
, 
big
}

780  
t


781 
’d


783 
_G
['outside'] = 
	$funùiÚ
 (
sm®l
, 
big
)

784 
sm®l
 = 
	$tÚumb”
(
sm®l
è
Ü
 small

785 
big
 = 
	$tÚumb”
(
big
è
Ü
 big

786 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

787 
loÿl
 
nv
 = 
	$tÚumb”
(
v
è
Ü
 v

788 
nv
 
ªd
‚v < 
sm®l
‡nd‚v > 
big
 
th’


789  
Œue


791  
çl£


792 
’d


793 
’d


794 
şosu»_cŞËùÜ
[
t
] = {'outside', 
sm®l
, 
big
}

795  
t


796 
’d


798 
_G
['cÚšs'] = 
	$funùiÚ
 (
sub¡r
)

799 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

800 
v
 = 
	$to¡ršg
(
v
)

801 
v
:
	$cÚšs
(
sub¡r
è
th’


802  
Œue


804  
çl£


805 
’d


806 
’d


807 
şosu»_cŞËùÜ
[
t
] = {'cÚšs', 
sub¡r
}

808  
t


809 
’d


811 
_G
['uncÚšs'] = 
	$funùiÚ
 (
sub¡r
)

812 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

813 
v
 = 
	$to¡ršg
(
v
)

814 
nÙ
 
v
:
	$cÚšs
(
sub¡r
è
th’


815  
Œue


817  
çl£


818 
’d


819 
’d


820 
şosu»_cŞËùÜ
[
t
] = {'uncÚšs', 
sub¡r
}

821  
t


822 
’d


825 
_G
['¡¬tsW™h'] = 
	$funùiÚ
 (
sub¡r
)

826 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

827 
v
 = 
	$to¡ršg
(
v
)

828 
v
:
	$¡¬tsW™h
(
sub¡r
è
th’


829  
Œue


831  
çl£


832 
’d


833 
’d


834 
şosu»_cŞËùÜ
[
t
] = {'¡¬tsW™h', 
sub¡r
}

835  
t


836 
’d


838 
_G
['un¡¬tsW™h'] = 
	$funùiÚ
 (
sub¡r
)

839 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

840 
v
 = 
	$to¡ršg
(
v
)

841 
nÙ
 
v
:
	$¡¬tsW™h
(
sub¡r
è
th’


842  
Œue


844  
çl£


845 
’d


846 
’d


847 
şosu»_cŞËùÜ
[
t
] = {'un¡¬tsW™h', 
sub¡r
}

848  
t


849 
’d


852 
_G
['’dsW™h'] = 
	$funùiÚ
 (
sub¡r
)

853 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

854 
v
 = 
	$to¡ršg
(
v
)

855 
v
:
	$’dsW™h
(
sub¡r
è
th’


856  
Œue


858  
çl£


859 
’d


860 
’d


861 
şosu»_cŞËùÜ
[
t
] = {'’dsW™h', 
sub¡r
}

862  
t


863 
’d


865 
_G
['uÃndsW™h'] = 
	$funùiÚ
 (
sub¡r
)

866 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

867 
v
 = 
	$to¡ršg
(
v
)

868 
nÙ
 
v
:
	$’dsW™h
(
sub¡r
è
th’


869  
Œue


871  
çl£


872 
’d


873 
’d


874 
şosu»_cŞËùÜ
[
t
] = {'uÃndsW™h', 
sub¡r
}

875  
t


876 
’d


878 
_G
['š£t'] = 
	$funùiÚ
 (...)

879 
loÿl
 
¬gs
 = {...
	}
}

880 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

881 
v
 = 
	$to¡ršg
(
v
)

882 
_
, 
v®
 
š
 
	$aœs
(
¬gs
) do

883 -- 
Úû
 
m“t
 
Úe
, 
ok


884 
	`to¡ršg
(
v®
è=ğ
v
 
th’


885  
Œue


886 
’d


887 
’d


889  
çl£


890 
’d


891 
şosu»_cŞËùÜ
[
t
] = {'š£t', ...
	}
}

892  
t


893 
’d


895 
_G
['unš£t'] = 
	$funùiÚ
 (...)

896 
loÿl
 
¬gs
 = {...
	}
}

897 
loÿl
 
t
 = 
	$funùiÚ
 (
v
)

898 
v
 = 
	$to¡ršg
(
v
)

899 
_
, 
v®
 
š
 
	$aœs
(
¬gs
) do

900 -- 
Úû
 
m“t
 
Úe
, 
çl£


901 
	`to¡ršg
(
v®
è=ğ
v
 
th’


902  
çl£


903 
’d


904 
’d


906  
Œue


907 
’d


908 
şosu»_cŞËùÜ
[
t
] = {'unš£t', ...
	}
}

909  
t


910 
’d


914 
loÿl
 
cŞËùRuËFunùiÚUpv®ues
 = 
	$funùiÚ
 (
qu”y_¬gs
)

915 
loÿl
 
upv®ues
 = 
upv®ue_cŞËùÜ


916 
i
=1, 
m©h
.
huge
 do

917 
loÿl
 
Çme
, 
v
 = 
debug
.
	$g‘upv®ue
(
qu”y_¬gs
, 
i
)

918 
nÙ
 
Çme
 
th’
  
’d


919 -- 
beÿu£
 
we
 
could
 
nÙ
 
cŞËù
 
the
 
upv®ues
 
who£
 
ty³
 
is
 'bË', 
»pÜt
 
”rÜ
 
ªd
 
abÜt
 
h”e


920 
	`as£¹
(
	`ty³
(
v
è~ğ'bË' 
ªd
ype(v) ~= 'function',

923 
upv®ues
[#upv®ue + 1] = { 
Çme
, 
	`to¡ršg
(
v
), 
	`ty³
(vè
	}
}

924 
’d


925 
’d


928 
loÿl
 
com´essQu”yArgs
 = 
	$funùiÚ
 (
qu”y_¬gs
)

929 
loÿl
 
out
 = {
	}
}

930 
loÿl
 
qty³
 = 
	$ty³
(
qu”y_¬gs
)

931 
qty³
 =ğ'bË' 
th’


933 
qu”y_¬gs
[1] =ğ'Ü' 
th’
 
	`tš£¹
(
out
, 'or')

934 
	`tš£¹
(
out
, 'and')

935 
’d


936 
qu”y_¬gs
[1] = 
n


937 
	`tš£¹
(
out
, '|')

939 
loÿl
 
qu”yfs
 = {
	}
}

940 
kf
 
š
 
	$·œs
(
qu”y_¬gs
) do

941 
	$tš£¹
(
qu”yfs
, 
kf
)

942 
’d


943 
bË
.
	$sÜt
(
qu”yfs
)

945 
_
, 
k
 
š
 
	$aœs
(
qu”yfs
) do

946 
v
 = 
qu”y_¬gs
[
k
]

947 
	$tš£¹
(
out
, 
k
)

948 
	`ty³
(
v
è=ğ'¡ršg' 
th’


949 
	$tš£¹
(
out
, 
v
)

951 
loÿl
 
qu”yt_id’
 = 
şosu»_cŞËùÜ
[
v
]

952 
_
, 
™em
 
š
 
	$aœs
(
qu”yt_id’
) do

953 
	$tš£¹
(
out
, 
™em
)

954 
’d


955 
’d


956 
	`tš£¹
(
out
, '|')

957 
’d


958 -- 
ş—r
 
the
 
şosu»_cŞËùÜ


959 
şosu»_cŞËùÜ
 = {
	}
}

961 -- 
»¡Üe
 
the
 
fœ¡
 
–em’t
, 
avoidšg
 
side
 
efãù


962 
	gqu”y_¬gs
[1] = 
out
[1]

964 
–£if
 
qty³
 =ğ'funùiÚ' 
th’


965 
tš£¹
(
out
, 'function')

966 
tš£¹
(
out
, '|')

967 
tš£¹
(
out
, 
¡ršg
.
	$dump
(
qu”y_¬gs
))

968 
	`tš£¹
(
out
, '|')

969 
_
, 
·œ
 
š
 
	$aœs
(
upv®ue_cŞËùÜ
) do

970 
	`tš£¹
(
out
, 
·œ
[1]è-- 
key


971 
	`tš£¹
(
out
, 
·œ
[2]è-- 
v®ue


972 
	`tš£¹
(
out
, 
·œ
[3]è-- 
v®ue
 
ty³


973 
’d


975 -- 
ş—r
 
the
 
upv®ue_cŞËùÜ


976 
upv®ue_cŞËùÜ
 = {
	}
}

977 
’d


979 -- 
u£
 
a
 
d–em‘”
 
to
 
£³¿‹
 
obviou¦y


980  
bË
.
cÚÿt
(
out
, ' ')

981 
’d


983 
loÿl
 
	gexŒaQu”yArgs
 = 
	$funùiÚ
 (
q¡r
)

984 
loÿl
 
qu”y_¬gs


986 --
	`DEBUG
(
¡ršg
.
	$Ën
(
q¡r
))

987 
q¡r
:
	`¡¬tsW™h
('funùiÚ'è
th’


988 
loÿl
 
¡¬ošt
 = 
q¡r
:
	`fšd
('|'è
Ü
 1

989 
loÿl
 
’dpošt
 = 
q¡r
:
	`rfšd
('|'è
Ü
 -1

990 --
	$DEBUG
(
¡¬ošt
, 
’dpošt
)

991 
å¬t
 = 
q¡r
:
	`sub
(
¡¬ošt
 + 2, 
’dpošt
 - 2è-- :
	$Œim
()

992 
­¬t
 = 
q¡r
:
	`sub
(
’dpošt
 + 2, -1è-- :
	`Œim
()

993 --
	`DEBUG
(
¡ršg
.
	`Ën
(
å¬t
), sŒšg.Ën(
­¬t
))

994 -- 
now
 
å¬t
 
is
 
the
 
funùiÚ
 
bš¬y
 
¡ršg


995 
qu”y_¬gs
 = 
	`lßd¡ršg
(
å¬t
)

996 -- 
now
 
qu”y_¬gs
 
is
 
qu”y
 
funùiÚ


997 --
	$DEBUG
(
å¬t
, 
­¬t
, 
qu”y_¬gs
)

998 
nÙ
 
	$isF®£
(
­¬t
è
th’


999 -- 
™em
 1 
is
 
key
, i‹m 2 i 
v®ue
, i‹m 3 i v®u
ty³
, item 4 is key ....

1000 
loÿl
 
æ©_upv®ues
 = 
­¬t
:
	`¥l™
(' ')

1001 
i
=1, #flat_upvalues / 3 do

1002 
loÿl
 
vty³
 = 
æ©_upv®ues
[3*
i
]

1003 
loÿl
 
key
 = 
æ©_upv®ues
[3*
i
 - 2]

1004 
loÿl
 
v®ue
 = 
æ©_upv®ues
[3*
i
 - 1]

1005 
vty³
 =ğ'¡ršg' 
th’


1006 -- 
nÙhšg
 
to
 do

1007 
–£if
 
vty³
 =ğ'numb”' 
th’


1008 
v®ue
 = 
	$tÚumb”
(
v®ue
)

1009 
–£if
 
vty³
 =ğ'boŞ—n' 
th’


1010 
v®ue
 = 
	`lßd¡ršg
('return ' .. value)()

1011 
–£if
 
vty³
 =ğ'n' 
th’


1012 
v®ue
 = 
n


1013 
’d


1014 --
	`DEBUG
(
vty³
, 
key
, 
v®ue
)

1015 -- 
£t
 
upv®ues


1016 
debug
.
	$£tupv®ue
(
qu”y_¬gs
, 
i
, 
v®ue
)

1017 
’d


1018 
’d


1021 
loÿl
 
’dpošt
 = -1

1022 
q¡r
 = q¡r:
	`sub
(1, 
’dpošt
 - 1)

1023 
loÿl
 
_qq¡r
 = 
q¡r
:
	`¥l™Œim
('|')

1024 --
	`DEBUG
(
q¡r
, 
_qq¡r
)

1025 -- 
logic
 =ğ'ªd' 
Ü
 'or'

1026 
loÿl
 
logic
 = 
_qq¡r
[1]

1027 
qu”y_¬gs
 = {
logic
}

1028 
i
=2, #_qqstr do

1029 
loÿl
 
	g¡r
 = 
_qq¡r
[
i
]

1030 
loÿl
 
kt
 = 
¡r
:
¥l™Œim
(' ')

1031 --
DEBUG
(
kt
)

1032 -- 
kt
[1] 
is
 'key', [2] 
	gis
 'şosu»', [3] .. 
¬e
 
	gşosu»
's…arameters

1033 
loÿl
 
	gkey
 = 
kt
[1]

1034 
loÿl
 
şosu»
 = 
kt
[2]

1035 #kˆ> 2 
th’


1036 
loÿl
 
_¬gs
 = {}

1037 
j
=3, #kt do

1038 
	$tš£¹
(
_¬gs
, 
kt
[
j
])

1039 
’d


1040 --
	`DEBUG
('_¬gs', 
_¬gs
)

1041 --
	`DEBUG
('_G[şosu»]', 
şosu»
, 
_G
[şosu»](
	`uÅack
(
_¬gs
)))

1042 -- 
compu‹
 
şosu»
 
now


1043 
qu”y_¬gs
[
key
] = 
_G
[
şosu»
](
	$uÅack
(
_¬gs
))

1045 -- 
no
 
¬gs
, 
m—ns
 
this
 'şosu»' 
is
 
a
 
¡ršg


1046 
qu”y_¬gs
[
key
] = 
şosu»


1047 
’d


1048 
’d


1049 --
	$DEBUG
(
qu”y_¬gs
)

1050 
’d


1052  
qu”y_¬gs


1053 
’d


1056 
loÿl
 
checkLogicR–©iÚ
 = 
	`funùiÚ
 (
£lf
, 
obj
, 
qu”y_¬gs
, 
logic_choiû
)

1057 -- 
NOTE
: 
qu”y_¬gs
 
ÿn
't contain [1]

1058 -- 
h”e
, 
obj
 
may
 
be
 
objeù
 
Ü
 
¡ršg


1059 -- 
wh’
 
obj
 
is
 
¡ršg
, 
qu”y_¬gs
 
mu¡
 
be
 
funùiÚ
;

1060 -- 
wh’
 
qu”y_¬gs
 
is
 
bË
, 
obj
 
mu¡
 
be
able.

1061 
loÿl
 
æag
 = 
logic_choiû


1062 
	`ty³
(
qu”y_¬gs
è=ğ'bË' 
th’


1063 -- 
nÙ
 
	$isV®idIn¡ªû
(
obj
è
th’
 
	`´št
('[W¬nšg] @checkLogicR–©iÚ - obj should bv®id in¡ªû wh’ qu”y_¬g i bË.'è
’d


1064 
k
, 
v
 
š
 
	$·œs
(
qu”y_¬gs
) do

1065 -- 
to
 
»dundªt
 
qu”y
 
cÚd™iÚ
, 
Úû
 
m“t
, 
jump
 
immedŸ‹ly


1066 
nÙ
 
£lf
.
__f›lds
[
k
] 
th’
 
æag
=
çl£
;  
’d


1068 
	`ty³
(
v
è=ğ'funùiÚ' 
th’


1069 
æag
 = 
	`v
(
obj
[
k
])

1070 --
	`DEBUG
('bË v', 
æag
)

1072 
æag
 = (
obj
[
k
] =ğ
v
)

1073 
’d


1075 -- 
logic_choiû
, 
æag
, 
aùiÚ
, 
­³nd
?

1077 -- 
	$Œue
 (
ªd
è
Œue
 
Ãxt
 
f›ld
 --

1078 -- 
	$Œue
 (
ªd
è
çl£
  
no


1079 -- 
	$çl£
 (
Ü
è
Œue
  
yes


1080 -- 
	$çl£
 (
Ü
è
çl£
 
Ãxt
 
f›ld
 --

1082 
logic_choiû
 ~ğ
æag
 
th’
  
’d


1083 
’d


1085 -- 
ÿÎ
 
this
 
qu”y
 
¬gs
 
funùiÚ


1086 
æag
 = 
	`qu”y_¬gs
(
obj
)

1087 --
	$DEBUG
(
æag
)

1088 
’d


1090  
æag


1091 
’d


1093 
loÿl
 
ÿnIn¡ªûF™Qu”yRuË
 = 
	$funùiÚ
 (
£lf
, 
q¡r
)

1094 
loÿl
 
qu”y_¬gs
 = 
	`exŒaQu”yArgs
(
q¡r
)

1095 --
	$DEBUG
(
qu”y_¬gs
)

1096 
loÿl
 
logic_choiû
 = 
Œue


1097 
	`ty³
(
qu”y_¬gs
è=ğ'bË' 
th’
 
logic_choiû
 = (qu”y_¬gs[1] =ğ'ªd'); qu”y_¬gs[1]=
n
 
’d


1098  
	$checkLogicR–©iÚ
(
£lf
, s–f, 
qu”y_¬gs
, 
logic_choiû
)

1099 
’d


1101 
loÿl
 
addIn¡ªûToIndexOnRuË
 = 
	$funùiÚ
 (
£lf
, 
q¡r
)

1102 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1103 --
	$DEBUG
(
£lf
, 
q¡r
, 
mªag”_key
)

1104 
loÿl
 
scÜe
 = 
db
:
	$zscÜe
(
mªag”_key
, 
q¡r
)

1105 
loÿl
 
™em_key
 = ('_RULE:%s:%s'):
	$fÜm©
(
£lf
.
__Çme
, 
scÜe
)

1106 
nÙ
 
db
:
	$exi¡s
(
™em_key
è
th’


1107 -- 
ş—r
 
the
 
ÿche
 
š
h
šdex
 
mªag”


1108 
db
:
	$z»m
(
mªag”_key
, 
q¡r
)

1109  
n


1110 
’d


1112 
loÿl
 
æag
 = 
	`ÿnIn¡ªûF™Qu”yRuË
(
£lf
, 
q¡r
)

1113 --
	$DEBUG
(
æag
)

1114 
æag
 
th’


1115 
db
:
	$½ush
(
™em_key
, 
£lf
.
id
)

1116 
db
:
	$expœe
(
™em_key
, 
bamboo
.
cÚfig
.
ruË_expœ©iÚ
 
Ü
 bamboo.
RULE_LIFE
)

1117 
’d


1118  
æag


1119 
’d


1121 
loÿl
 
upd©eIn¡ªûToIndexOnRuË
 = 
	$funùiÚ
 (
£lf
, 
q¡r
)

1122 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1123 
loÿl
 
scÜe
 = 
db
:
	$zscÜe
(
mªag”_key
, 
q¡r
)

1124 
loÿl
 
™em_key
 = ('_RULE:%s:%s'):
	$fÜm©
(
£lf
.
__Çme
, 
scÜe
)

1125 
nÙ
 
db
:
	$exi¡s
(
™em_key
è
th’


1126 -- 
ş—r
 
the
 
ÿche
 
š
h
šdex
 
mªag”


1127 
db
:
	$z»m
(
mªag”_key
, 
q¡r
)

1128  
n


1129 
’d


1131 
loÿl
 
æag
 = 
	$ÿnIn¡ªûF™Qu”yRuË
(
£lf
, 
q¡r
)

1132 
db
:
	$Ìem
(
™em_key
, 0, 
£lf
.
id
)

1133 
æag
 
th’


1134 
db
:
	$½ush
(
™em_key
, 
£lf
.
id
)

1135 
’d


1136 
db
:
	$expœe
(
™em_key
, 
bamboo
.
cÚfig
.
ruË_expœ©iÚ
 
Ü
 bamboo.
RULE_LIFE
)

1137  
æag


1138 
’d


1140 
loÿl
 
d–In¡ªûToIndexOnRuË
 = 
	$funùiÚ
 (
£lf
, 
q¡r
)

1141 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1142 
loÿl
 
scÜe
 = 
db
:
	$zscÜe
(
mªag”_key
, 
q¡r
)

1143 
loÿl
 
™em_key
 = ('_RULE:%s:%s'):
	$fÜm©
(
£lf
.
__Çme
, 
scÜe
)

1144 
nÙ
 
db
:
	$exi¡s
(
™em_key
è
th’


1145 -- 
ş—r
 
the
 
ÿche
 
š
h
šdex
 
mªag”


1146 
db
:
	$z»m
(
mªag”_key
, 
q¡r
)

1147  
n


1148 
’d


1150 
loÿl
 
æag
 = 
	$ÿnIn¡ªûF™Qu”yRuË
(
£lf
, 
q¡r
)

1151 
db
:
	$Ìem
(
™em_key
, 0, 
£lf
.
id
)

1152 
db
:
	$expœe
(
™em_key
, 
bamboo
.
cÚfig
.
ruË_expœ©iÚ
 
Ü
 bamboo.
RULE_LIFE
)

1153  
æag


1154 
’d


1156 
loÿl
 
INDEX_ACTIONS
 = {

1157 ['§ve'] = 
addIn¡ªûToIndexOnRuË
,

1158 ['upd©e'] = 
upd©eIn¡ªûToIndexOnRuË
,

1159 ['d–'] = 
d–In¡ªûToIndexOnRuË


1160 
	}
}

1162 
loÿl
 
	gupd©eIndexByRuËs
 = 
	$funùiÚ
 (
£lf
, 
aùiÚ
)

1163 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1164 
loÿl
 
q¡r_li¡
 = 
db
:
	`z¿nge
(
mªag”_key
, 0, -1)

1165 
loÿl
 
aùiÚ_func
 = 
INDEX_ACTIONS
[
aùiÚ
]

1166 
_
, 
q¡r
 
š
 
	$aœs
(
q¡r_li¡
) do

1167 
	$aùiÚ_func
(
£lf
, 
q¡r
)

1168 
’d


1169 
’d


1171 
loÿl
 
addIndexToMªag”
 = 
	$funùiÚ
 (
£lf
, 
qu”y_¡r_id’
, 
obj_li¡
)

1172 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1173 -- 
add
 
to
 
šdex
 
mªag”


1174 -- 
»
 
’‹r
 
this
 
funùiÚ
,hi 
lše
 
wl
  
n


1175 
rdz£t
.
	`add
(
mªag”_key
, 
qu”y_¡r_id’
)

1177 -- 
»
 
’‹r
 
this
 
funùiÚ
,hi 
lše
 
wl
  
the
 
Üigš®
 
scÜe
 
of
hi 
ruË


1178 
loÿl
 
scÜe
 = 
db
:
	$zscÜe
(
mªag”_key
, 
qu”y_¡r_id’
)

1179 
loÿl
 
™em_key
 = ('_RULE:%s:%s'):
	`fÜm©
(
£lf
.
__Çme
, 
scÜe
)

1180 -- 
we
 
have
 
¶’ty
 
»asÚs
 
to
 
d–‘e
 
this
 
ruË
 
key
 
Ãw
 
šdex
 
d©a


1181 
db
:
	`d–
(
™em_key
)

1182 -- 
g’”©e
 
the
 
šdex
 
™em
, 
u£
 
li¡


1183 
db
:
	`½ush
(
™em_key
, 
	`uÅack
(
obj_li¡
))

1184 -- 
£t
 
expœ©iÚ
 
to
 
—ch
 
šdex
 
™em


1185 
db
:
	$expœe
(
™em_key
, 
bamboo
.
cÚfig
.
ruË_expœ©iÚ
 
Ü
 bamboo.
RULE_LIFE
)

1187 
’d


1189 
loÿl
 
g‘IndexFromMªag”
 = 
	$funùiÚ
 (
£lf
, 
qu”y_¡r_id’
, 
g‘num
)

1190 
loÿl
 
mªag”_key
 = "_šdex_mªag”:" .. 
£lf
.
__Çme


1191 
loÿl
 
scÜe
 = 
db
:
	$zscÜe
(
mªag”_key
, 
qu”y_¡r_id’
)

1192 
nÙ
 
scÜe
 
th’


1193  (
nÙ
 
g‘num
è
ªd
 
	$Li¡
(è
Ü
 
n


1194 
’d


1195 -- 
add
 
to
 
šdex
 
mªag”


1196 
loÿl
 
™em_key
 = ('_RULE:%s:%s'):
	$fÜm©
(
£lf
.
__Çme
, 
scÜe
)

1197 
nÙ
 
db
:
	$exi¡s
(
™em_key
è
th’


1198 -- 
ş—r
 
the
 
ÿche
 
š
h
šdex
 
mªag”


1199 
db
:
	$z»m
(
mªag”_key
, 
qu”y_¡r_id’
)

1200  (
nÙ
 
g‘num
è
ªd
 
	$Li¡
(è
Ü
 
n


1201 
’d


1203 -- 
upd©e
 
expœ©iÚ


1204 
db
:
	$expœe
(
™em_key
, 
bamboo
.
cÚfig
.
ruË_expœ©iÚ
 
Ü
 bamboo.
RULE_LIFE
)

1205 
nÙ
 
g‘num
 
th’


1206 --  
a
 
li¡


1207  
	`Li¡
(
db
:
	`Ìªge
(
™em_key
, 0, -1))

1209 --  
the
 
numb”
 
of
 
this
 
li¡


1210  
db
:
	$Î’
(
™em_key
)

1211 
’d


1212 
’d


1214 -- 
ÿÎed
 
by
 
§ve


1215 -- 
£lf
 
is
 
š¡ªû


1216 
loÿl
 
´oûssBefÜeSave
 = 
	$funùiÚ
 (
£lf
, 
·¿ms
)

1217 
loÿl
 
šdexfd
 = 
£lf
.
__šdexfd


1218 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


1219 
loÿl
 
¡Üe_kv
 = {
	}
}

1220 --- 
§ve
 
ª
 
hash
 
objeù


1221 -- 'id' 
¬e
 
es£ÁŸl
 
š
 
ª
 
objeù
 
š¡ªû


1222 
tš£¹
(
¡Üe_kv
, 'id')

1223 
tš£¹
(
¡Üe_kv
, 
£lf
.
id
)

1225 -- 
·¿m‘”s
 
	gexi¡
, 
upd©e
 
™


1226 
·¿ms
 
ªd
 
ty³
Õ¬amsè=ğ'bË' 
th’


1227 
k
, 
v
 
š
 
	$·œs
(
·¿ms
) do

1228 
k
 ~ğ'id' 
ªd
 
f›lds
[k] 
th’


1229 
£lf
[
k
] = 
	$to¡ršg
(
v
)

1230 
’d


1231 
’d


1232 
’d


1234 
	`as£¹
(
nÙ
 
	`isF®£
(
£lf
[
šdexfd
]) ,

1237 
k
, 
v
 
š
 
	$·œs
(
£lf
) do

1238 -- 
wh’
 
§ve
, 
Ãed
 
to
 
check
 
som‘hšg


1239 -- 1. 
Úly
 
§ve
 
f›lds
 
defšed
 
š
 
mod–
 
defš©iÚ


1240 -- 2. 
dÚ
't savehe functional member,‡nd _parent

1241 -- 3. 
dÚ
't savehose fields‚ot defined in model defination

1242 -- 4. 
dÚ
't savehoseƒxcept ONE foreign fields, which‡re defined in model defination

1243 
loÿl
 
f›ld
 = 
f›lds
[
k
]

1244 -- 
v
 
is
 
n
, 
·œs
 
wl
 
nÙ
 
™”©e
 
™
, 
key
 wÈ
ªd
 
should
‚Ù 
be
 'id'

1245 
f›ld
 
th’


1246 
nÙ
 
f›ld
['fÜeign'] 
	`Ü
 ( f›ld['fÜeign'] 
ªd
 f›ld['¡'] =ğ'ONE'è
th’


1247 -- 
§ve


1248 
	$tš£¹
(
¡Üe_kv
, 
k
)

1249 
	$tš£¹
(
¡Üe_kv
, 
v
)

1250 
’d


1251 
’d


1252 
’d


1254  
£lf
, 
¡Üe_kv


1255 
’d


1264 -- 
Mod–
 
Defše


1265 -- 
Mod–
 
is
 
the
 
basic
 
objeù
 
of
 
Bamboo
 
D©aba£
 
Ab¡¿ù
 
Lay”


1269 
Mod–
 = 
Objeù
:
ex‹nd
 {

1270 
__g
 = 'Object.Model';

1271 -- 
ATTEN
: 
__Çme
's value is‚ot‚eccesary beƒqual strictlyohe†ast word of __tag

1272 
__Çme
 = 'Model';

1273 
__desc
 = 'Model ishe base of‡ll models.';

1274 
__f›lds
 = {

1275 -- 
h”e
, 
we
 
dÚ
'ˆpuˆ'
id
'‡s‡ field

1276 ['ü—‹d_time'] = { 
ty³
="number" },

1277 ['Ï¡modif›d_time'] = { 
ty³
="number" },

1280 
__šdexfd
 = "id";

1282 -- 
make
 
ev”y
 
objeù
 
ü—tiÚ
 
äom
 
h”e
:ƒv”y objeù 
has
 
the
 'id', 'ü—‹d_time' 
ªd
 'Ï¡modif›d_time' 
f›lds


1283 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

1284 
loÿl
 
t
 = 
Ü
 {}

1285 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


1287 
f›ld
, 
fdt
 
š
 
	`·œs
(
f›lds
) do

1288 -- 
assign
 
to
  
v®ue
 
exs™s


1289 
loÿl
 
tmp
 = 
t
[
f›ld
] 
Ü
 
fdt
.

1290 
	`ty³
(
tmp
è=ğ'funùiÚ' 
th’


1291 
£lf
[
f›ld
] = 
	`tmp
()

1293 
£lf
[
f›ld
] = 
tmp


1294 
’d


1295 
’d


1297 
£lf
.
ü—‹d_time
 = 
sock‘
.
	`g‘time
()

1298 
£lf
.
Ï¡modif›d_time
 = s–f.
ü—‹d_time


1300  
£lf


1301 
’d
;

1304 
toHtml
 = 
	`funùiÚ
 (
£lf
, 
·¿ms
)

1305 
	`I_AM_INSTANCE
(
£lf
)

1306 
·¿ms
 =…¬am 
Ü
 {}

1308 
·¿ms
.
f›ld
 
ªd
 
	`ty³
Õ¬ams.f›ldè=ğ'¡ršg' 
th’


1309 
k
, 
v
 
š
 
	`·œs
(
·¿ms
.
©ched
) do

1310 
v
 =ğ'html_şass' 
th’


1311 
£lf
.
__f›lds
[
·¿ms
.
f›ld
][
k
] = s–f.__f›lds[·¿ms.f›ld][k] .. ' ' .. 
v


1313 
£lf
.
__f›lds
[
·¿ms
.
f›ld
][
k
] = 
v


1314 
’d


1315 
’d


1317  (
£lf
.
__f›lds
[
·¿ms
.
f›ld
]):
	`toHtml
(£lf,…¬ams.f›ld,…¬ams.
fÜm©
)

1318 
’d


1320 
·¿ms
.
©ched
 =…¬ams.©ched 
Ü
 {}

1322 
loÿl
 
ouut
 = ''

1323 
f›ld
, 
fdt_Şd
 
š
 
	`·œs
(
£lf
.
__f›lds
) do

1324 
loÿl
 
fdt
 = 
bË
.
	`cİy
(
fdt_Şd
)

1325 
	`£tm‘©abË
(
fdt
, 
	`g‘m‘©abË
(
fdt_Şd
))

1326 
k
, 
v
 
š
 
	`·œs
(
·¿ms
.
©ched
) do

1327 
	`ty³
(
v
è=ğ'bË' 
th’


1328 
key
, 
v®
 
š
 
	`·œs
(
v
) do

1329 
fdt
[
k
] = fdt[k] 
Ü
 {}

1330 
fdt
[
k
][
key
] = 
v®


1331 
’d


1333 
fdt
[
k
] = 
v


1334 
’d


1335 
’d


1337 
loÿl
 
æag
 = 
Œue


1338 
·¿ms
.
f‹rs
 =…¬ams.f‹r 
Ü
 {}

1339 
k
, 
v
 
š
 
	`·œs
(
·¿ms
.
f‹rs
) do

1340 -- 
to
 
»dundªt
 
qu”y
 
cÚd™iÚ
, 
Úû
 
m“t
, 
jump
 
immedŸ‹ly


1341 
nÙ
 
fdt
[
k
] 
th’


1342 -- 
k
 =ğ'vl' 
th’
 
£lf
.
__f›lds
[
f›ld
][k] = 0 
’d


1343 
k
 =ğ'vl' 
th’
 
fdt
[k] = 0 
’d


1344 
’d


1346 
	`ty³
(
v
è=ğ'funùiÚ' 
th’


1347 
æag
 = 
	`v
(
fdt
[
k
] 
Ü
 '')

1348 
nÙ
 
æag
 
th’
  
’d


1350 
fdt
[
k
] ~ğ
v
 
th’
 
æag
=
çl£
;  
’d


1351 
’d


1352 
’d


1354 
æag
 
th’


1355 
ouut
 = ouuˆ.. 
fdt
:
	`toHtml
(
£lf
, 
f›ld
, 
·¿ms
.
fÜm©
 
Ü
 
n
)

1356 
’d


1358 
’d


1360  
ouut


1361 
’d
,

1365 -- 
CÏss
 
FunùiÚs
. 
C®Ëd
 
by
 
şass
 
objeù
.

1368 
g‘RªkByIndex
 = 
	`funùiÚ
 (
£lf
, 
Çme
)

1369 
	`I_AM_CLASS
(
£lf
)

1371 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

1372 -- 
id
 
is
 
the
 
scÜe
 
of
 
th©
 
šdex
 
v®ue


1373 
loÿl
 
¿nk
 = 
db
:
	`z¿nk
(
šdex_key
, 
	`to¡ršg
(
Çme
))

1374  
	`tÚumb”
(
¿nk
)

1375 
’d
;

1377 --  
id
 
qu”›d
 
by
 
šdex


1379 
g‘IdByIndex
 = 
	`funùiÚ
 (
£lf
, 
Çme
)

1380 
	`I_AM_CLASS
(
£lf
)

1381 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

1382 -- 
id
 
is
 
the
 
scÜe
 
of
 
th©
 
šdex
 
v®ue


1383 
loÿl
 
id¡r
 = 
db
:
	`zscÜe
(
šdex_key
, 
	`to¡ršg
(
Çme
))

1384  
	`tÚumb”
(
id¡r
)

1385 
’d
;

1387 --  
Çme
 
qu”y
 
by
 
id


1389 
g‘IndexById
 = 
	`funùiÚ
 (
£lf
, 
id
)

1390 
	`I_AM_CLASS
(
£lf
)

1391 
	`ty³
(
	`tÚumb”
(
id
)è~ğ'numb”' 
th’
  
n
 
’d


1393 
loÿl
 
æag
, 
Çme
 = 
	`checkExi¡ªûById
(
£lf
, 
id
)

1394 
	`isF®£
(
æag
è
Ü
 isF®£(
Çme
è
th’
  
n
 
’d


1396  
Çme


1397 
’d
;

1399 --  
š¡ªû
 
objeù
 
by
 
id


1401 
g‘ById
 = 
	`funùiÚ
 (
£lf
, 
id
)

1402 
	`I_AM_CLASS
(
£lf
)

1403 --
	`DEBUG
(
id
)

1404 
	`ty³
(
	`tÚumb”
(
id
)è~ğ'numb”' 
th’
  
n
 
’d


1406 -- 
check
 
the
 
exi¡ªû
 
š
h
šdex
 
ÿche


1407 
nÙ
 
	`checkExi¡ªûById
(
£lf
, 
id
è
th’
  
n
 
’d


1408 -- 
ªd
 
th’
 
check
 
the
 
exi¡ªû
 
š
h
key
 
£t


1409 
loÿl
 
key
 = 
	`g‘NameIdP©‹º2
(
£lf
, 
id
)

1410 
nÙ
 
db
:
	`exi¡s
(
key
è
th’
  
n
 
’d


1411 --
	`DEBUG
(
key
)

1412  
	`g‘FromRedis
(
£lf
, 
key
)

1413 
’d
;

1415 --  
š¡ªû
 
objeù
 
by
 
Çme


1417 
g‘ByIndex
 = 
	`funùiÚ
 (
£lf
, 
Çme
)

1418 
	`I_AM_CLASS
(
£lf
)

1419 
loÿl
 
id
 = 
£lf
:
	`g‘IdByIndex
(
Çme
)

1420 
nÙ
 
id
 
th’
  
n
 
’d


1422  
£lf
:
	`g‘ById
 (
id
)

1423 
’d
;

1425 --  
a
 
li¡
 
cÚššg
 
®l
 
ids
 
of
‡Î 
š¡ªûs
 
b–Úg
 
to
 
this
 
Mod–


1427 
®lIds
 = 
	`funùiÚ
 (
£lf
, 
fšd_»v
)

1428 
	`I_AM_CLASS
(
£lf
)

1429 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

1430 
loÿl
 
®l_ids


1431 
fšd_»v
 =ğ'»v' 
th’


1432 
®l_ids
 = 
db
:
	`z»v¿nge
(
šdex_key
, 0, -1, 'withscores')

1434 
®l_ids
 = 
db
:
	`z¿nge
(
šdex_key
, 0, -1, 'withscores')

1435 
’d


1436 
loÿl
 
ids
 = 
	`Li¡
()

1437 
_
, 
v
 
š
 
	`aœs
(
®l_ids
) do

1438 -- 
v
[1] 
is
 
the
 'index value', v[2] ishe 'id'

1439 
ids
:
	`­³nd
(
v
[2])

1440 
’d


1442  
ids


1443 
’d
;

1445 -- 
¦iû
 
the
 
ids
 
li¡
, 
¡¬t
 
äom
 1, 
suµÜt
 
Ãg©ive
 
	`šdex
 (-1)

1447 
¦iûIds
 = 
	`funùiÚ
 (
£lf
, 
¡¬t
, 
¡İ
, 
is_»v
)

1448 
	`I_AM_CLASS
(
£lf
)

1449 
	`checkTy³
(
¡¬t
, 
¡İ
, 'number', 'number')

1450 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

1451 
loÿl
 
®l_ids
 = 
	`Li¡
(
db
:
	`z¿nge
(
šdex_key
, 0, -1, 'withscores'))

1452 
®l_ids
 =‡Î_ids:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

1453 
loÿl
 
ids
 = 
	`Li¡
()

1454 
_
, 
v
 
š
 
	`aœs
(
®l_ids
) do

1455 -- 
v
[1] 
is
 
the
 'index value', v[2] ishe 'id'

1456 
ids
:
	`­³nd
(
v
[2])

1457 
’d


1459  
ids


1460 
’d
;

1462 --  
®l
 
š¡ªû
 
objeùs
 
b–Úg
 
to
 
this
 
Mod–


1464 
®l
 = 
	`funùiÚ
 (
£lf
, 
fšd_»v
)

1465 
	`I_AM_CLASS
(
£lf
)

1466 
loÿl
 
®l_ids
 = 
£lf
:
	`®lIds
(
fšd_»v
)

1467  
	`g‘FromRedisP–še
(
£lf
, 
®l_ids
)

1468 
’d
;

1470 -- 
¦iû
 
š¡ªû
 
objeù
 
li¡
, 
suµÜt
 
Ãg©ive
 
	`šdex
 (-1)

1472 
¦iû
 = 
	`funùiÚ
 (
£lf
, 
¡¬t
, 
¡İ
, 
is_»v
)

1473 -- !
¦iû
 
m‘hod
 
wÚ
't be openo query set, because List has slice methodoo.

1474 
	`I_AM_CLASS
(
£lf
)

1475 
loÿl
 
ids
 = 
£lf
:
	`¦iûIds
(
¡¬t
, 
¡İ
, 
is_»v
)

1476  
	`g‘FromRedisP–še
(
£lf
, 
ids
)

1477 
’d
;

1479 -- 
this
 
is
 
a
 
magic
 
funùiÚ


1480 --  
®l
 
the
 
keys
 
b–Úg
 
to
 
this
 
	`Mod–
 (
Ü
hi 
mod–
's…arent model)

1481 -- 
®l
 
–em’ts
 
š
 
»tuºšg
 
li¡
 
¬e
 
¡ršg


1483 
®lKeys
 = 
	`funùiÚ
 (
£lf
)

1484 
	`I_AM_CLASS
(
£lf
)

1485  
db
:
	`keys
(
£lf
.
__Çme
 + ':*')

1486 
’d
;

1488 --  
the
 
aùu®
 
numb”
 
of
h
š¡ªûs


1490 
numb”s
 = 
	`funùiÚ
 (
£lf
)

1491 
	`I_AM_CLASS
(
£lf
)

1492  
db
:
	`zÿrd
(
	`g‘IndexKey
(
£lf
))

1493 
’d
;

1495 --  
the
 
fœ¡
 
š¡ªû
 
found
 
by
 
qu”y
 
£t


1497 
g‘
 = 
	`funùiÚ
 (
£lf
, 
qu”y_¬gs
, 
fšd_»v
)

1498 -- 
XXX
: 
may
 
ÿu£
 
efãùive
 
´obËm


1499 -- 
ev”y
 
time
 'g‘' 
wl
 
ÿu£
 
the
 
®l
 
objeùs
'„etrieving

1500 
loÿl
 
obj
 = 
£lf
:
	`f‹r
(
qu”y_¬gs
, 
n
,‚, 
fšd_»v
, 'get')[1]

1501  
obj


1502 
’d
;

1504 --- 
f™Ër
 
some
 
š¡ªûs
 
b–Úg
 
to
 
this
 
mod–


1505 -- @
·¿m
 
qu”y_¬gs
: 
qu”y
 
¬gum’ts
 
š
 
a
 
bË


1506 -- @
·¿m
 
¡¬t
: 
¥ecify
 
which
 
šdex
 
to
 s¹ 
¦iû
, 
nÙe
: 
this
 
is
 
the
 
pos™iÚ
 
aá”
 
f‹ršg


1507 -- @
·¿m
 
¡İ
: 
¥ecify
 
the
 
’d
 
of
 
¦iû


1508 -- @
·¿m
 
is_»v
: 
¥ecify
 
the
 
dœeùiÚ
 
of
h
£¬ch
 
»suÉ
, 'rev'

1509 -- @: 
qu”y_£t
, 
ª
 
objeù
 
	`li¡
 (
qu”y
 
£t
)

1510 -- @
nÙe
: 
this
 
funùiÚ
 
ÿn
 
be
 
ÿÎed
 
by
 
şass
 
objeù
 
ªd
 
qu”y
 
£t


1511 
f‹r
 = 
	`funùiÚ
 (
£lf
, 
qu”y_¬gs
, 
¡¬t
, 
¡İ
, 
is_»v
, 
is_g‘
)

1512 
	`I_AM_CLASS_OR_QUERY_SET
(
£lf
)

1513 
	`as£¹
(
	`ty³
(
qu”y_¬gs
è=ğ'bË' 
Ü
ype(query_args) == 'function', '[Error]he query_args…assedo filter must beable or function.')

1514 
¡¬t
 
th’
 
	`as£¹
(
	`ty³
(¡¬tè=ğ'numb”', '[E¼Ü] @f‹¸- s¹ mu¡ bnumb”.'è
’d


1515 
¡İ
 
th’
 
	`as£¹
(
	`ty³
(¡İè=ğ'numb”', '[E¼Ü] @f‹¸- stİ mu¡ bnumb”.'è
’d


1516 
is_»v
 
th’
 
	`as£¹
(
	`ty³
(is_»vè=ğ'¡ršg', '[E¼Ü] @f‹¸- is_»v mu¡ b¡ršg.'è
’d


1518 
loÿl
 
is_qu”y_£t
 = 
çl£


1519 
	`isQu”yS‘
(
£lf
è
th’
 
is_qu”y_£t
 = 
Œue
 
’d


1520 
loÿl
 
is_qu”y_bË
 = (
	`ty³
(
qu”y_¬gs
) == 'table')

1521 
loÿl
 
logic
 = 'and'

1523 
loÿl
 
qu”y_¡r_id’


1524 
loÿl
 
is_usšg_ruË_šdex
 = 
	`isUsšgRuËIndex
(
£lf
)

1525 
is_usšg_ruË_šdex
 
th’


1526 
	`ty³
(
qu”y_¬gs
è=ğ'funùiÚ' 
th’


1527 
	`cŞËùRuËFunùiÚUpv®ues
(
qu”y_¬gs
)

1529 
’d


1530 -- 
make
 
qu”y
 
id’tifiÿtiÚ
 
¡ršg


1531 
qu”y_¡r_id’
 = 
	`com´essQu”yArgs
(
qu”y_¬gs
)

1533 -- 
check
 
šdex


1534 -- 
XXX
: 
OÆy
 
suµÜt
 
şass
 
now
, 
dÚ
'ˆsuµÜˆqu”y s‘, maybqu”y s‘ dÛ¢'
t
 
Ãed
 
this
 
ã©u»


1535 
loÿl
 
id_li¡
 = 
	`g‘IndexFromMªag”
(
£lf
, 
qu”y_¡r_id’
)

1536 #id_li¡ > 0 
th’


1537 
is_g‘
 =ğ'g‘' 
th’


1538 
id_li¡
 = (
is_»v
 =ğ'»v'è
ªd
 
Li¡
{id_li¡[#id_li¡]} 
Ü
 List{id_list[1]}

1540 -- 
now
 
id_li¡
 
is
 
a
 
li¡
 
cÚššg
 
®l
 
id
 
of
 
š¡ªûs
 
f™
 
to
 
this
 
qu”y_¬gs
 
ruË
, 
so
 
Ãed
Ø
¦iû


1541 
id_li¡
 = id_li¡:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

1542 
’d


1544 -- 
have
 
this
 
li¡
,  
objeùs
 
dœeùly


1545 #id_li¡ > 0 
th’


1546  
	`g‘FromRedisP–še
(
£lf
, 
id_li¡
)

1547 
’d


1548 
’d


1549 -- 
go
 
ah—d


1550 
’d


1552 
is_qu”y_bË
 
th’


1554 
qu”y_¬gs
 
ªd
 qu”y_¬gs['id'] 
th’


1555 -- 
»move
 'id' 
qu”y
 
¬gum’t


1556 
	`´št
("[Warning] Filter doesn't support search by id.")

1557 
qu”y_¬gs
['id'] = 
n


1558 
’d


1560 -- 
qu”y
 
bË
 
is
 
em±y
,  
¦iû
 
š¡ªûs


1561 
	`isF®£
(
qu”y_¬gs
è
th’


1562 
loÿl
 
¡¬t
 = s¹ 
Ü
 1

1563 
loÿl
 
¡İ
 = stİ 
Ü
 -1

1564 
loÿl
 
nums
 = 
£lf
:
	`numb”s
()

1565  
£lf
:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

1566 
’d


1568 -- 
nÜm®ize
 
the
 'ªd' 
ªd
 'Ü' 
logic


1569 
qu”y_¬gs
[1] 
th’


1570 
	`as£¹
(
qu”y_¬gs
[1] =ğ'Ü' 
Ü
 query_args[1] == 'and',

1571 "[E¼Ü] Thlogiøshould b'ªd' o¸'Ü',„©h”hª: " .. 
	`to¡ršg
(
qu”y_¬gs
[1]))

1572 
qu”y_¬gs
[1] =ğ'Ü' 
th’


1573 
logic
 = 'or'

1574 
’d


1575 
qu”y_¬gs
[1] = 
n


1576 
’d


1577 
’d


1579 
loÿl
 
®l_ids


1580 
is_qu”y_£t
 
th’


1581 -- 
£lf
 
is
 
qu”y
 
£t
, 
we
 
thšk
 
of
 
®l_ids
 
as
 
objeù
 
li¡
, 
¿th”
 
thª
 
id
 
¡ršg
†ist

1582 
®l_ids
 = 
£lf


1584 -- 
®l_ids
 
is
 
id
 
¡ršg
 
li¡


1585 
®l_ids
 = 
£lf
:
	`®lIds
()

1586 
’d


1587 -- 
nÙhšg
 
š
 
id
 
li¡
,  
em±y
 
bË


1588 #®l_id =ğ0 
th’
  
	`Li¡
(è
’d


1591 -- 
ü—‹
 
a
 
qu”y
 
£t


1592 
loÿl
 
qu”y_£t
 = 
	`Qu”yS‘
()

1593 
loÿl
 
logic_choiû
 = (
logic
 == 'and')

1594 
loÿl
 
·¹ŸÎy_gÙ
 = 
çl£


1596 -- 
w®kcheck
 
ÿn
 
´oûss
 
fuÎ
 
objeù
 
ªd
 
·¹Ÿl
 object

1597 
loÿl
 
w®kcheck
 = 
	`funùiÚ
 (
objs
)

1598 
i
 = 1, #all_ids do

1599 
loÿl
 
obj
 = 
objs
[
i
]

1600 --
	`DEBUG
(
obj
)

1601 -- 
check
 
the
 
objeù
's†egalery, only‡ct on valid object

1602 --
	`isV®idIn¡ªû
(
obj
è
th’


1603 
loÿl
 
æag
 = 
	`checkLogicR–©iÚ
(
£lf
, 
obj
, 
qu”y_¬gs
, 
logic_choiû
)

1605 -- 
w®k
 
to
 
this
 
lše
, 
m—ns
 
fšd
 
Úe


1606 
æag
 
th’


1607 
	`tš£¹
(
qu”y_£t
, 
obj
)

1608 
’d


1609 --
’d


1610 
’d


1611 
’d


1613 --
	`DEBUG
('®l_ids', 
®l_ids
)

1614 
is_qu”y_£t
 
th’


1615 
loÿl
 
objs
 = 
®l_ids


1616 -- 
objs
 
¬e
 
®»ady
 
š‹g¿‹d
 
š¡ªûs


1617 
	`w®kcheck
(
objs
)

1619 -- 
make
 
·¹ŸÎy
 
g‘
 
v®ue
 
cÚššg
 'id' 

1620 
loÿl
 
qfs
 = {'id'}

1621 
is_qu”y_bË
 
th’


1622 
k
, 
_
 
š
 
	`·œs
(
qu”y_¬gs
) do

1623 
	`tš£¹
(
qfs
, 
k
)

1624 
’d


1626 -- 
u£
 
´ecŞËùed
 
f›lds


1627 -- 
mod–
 
has
 
£t
 '__u£_ruË_šdex' 
mªu®ly
, 
cŞËù
 
®l
 
f›lds
 
to
 
šdex


1628 -- 
nÙ
 
£t
 '__u£_ruË_šdex' 
mªu®ly
, 
cŞËù
 
f›lds
 
w™h
 'šdexñrue' 
š
 
theœ
 
f›ld
 
desütiÚ
 
bË


1629 -- 
nÙ
 
£t
 '__u£_ruË_šdex' 
mªu®ly
, 
ªd
‚Ù s‘ 'šdexñrue' 
š
 
ªy
 
f›ld
, 
cŞËù
 
NOTHING


1630 --
	`DEBUG
('__ruË_šdex_f›lds', 
£lf
.
__ruË_šdex_f›lds
)

1631 
_
, 
k
 
š
 
	`aœs
(
£lf
.
__ruË_šdex_f›lds
) do

1632 
	`tš£¹
(
qfs
, 
k
)

1633 
’d


1634 
’d


1635 
bË
.
	`sÜt
(
qfs
)

1636 
loÿl
 
objs


1637 --
	`DEBUG
(
qfs
)

1638 -- =ğ1, 
m—ns
 
Úly
 
have
 'id', 
cŞËù
 
nÙhšg
 
Ú
 
f›lds


1639 #qf =ğ1 
th’


1640 --
	`DEBUG
('Enter full…ipeline branch')

1641 -- 
cŞËù
 
nÙhšg
, 
u£
 'hg‘®l' 
to
 
»Œ›ve
, 
·¹ŸÎy_gÙ
 
is
 
çl£


1642 
objs
 = 
	`g‘FromRedisP–še
(
£lf
, 
®l_ids
)

1644 --
	`DEBUG
('Enter…artial…ipeline branch')

1645 -- 
u£
 
hmg‘
 
to
 
»Œ›ve
, 
now
 
the
 
objs
 
¬e
 
·¹Ÿl
 
objeùs


1646 
objs
 = 
	`g‘P¬tŸlFromRedisP–še
(
£lf
, 
®l_ids
, 
qfs
)

1647 
·¹ŸÎy_gÙ
 = 
Œue


1648 
’d


1649 
	`w®kcheck
(
objs
)

1650 
’d


1652 -- 
h”e
, 
_t_qu”y_£t
 
is
 
the
 
®l
 
š¡ªû
 
f™
 
to
 
qu”y_¬gs
 
now


1653 
loÿl
 
_t_qu”y_£t
 = 
qu”y_£t


1654 #qu”y_£ˆ=ğ0 
th’
  
qu”y_£t
 
’d


1656 
is_g‘
 =ğ'g‘' 
th’


1657 
qu”y_£t
 = (
is_»v
 =ğ'»v'è
ªd
 
Li¡
 {
_t_qu”y_£t
[#_t_qu”y_£t]} 
Ü
 List {_t_query_set[1]}

1659 -- 
now
 
id_li¡
 
is
 
a
 
li¡
 
cÚššg
 
®l
 
id
 
of
 
š¡ªûs
 
f™
 
to
 
this
 
qu”y_¬gs
 
ruË
, 
so
 
Ãed
Ø
¦iû


1660 
qu”y_£t
 = 
_t_qu”y_£t
:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

1661 
’d


1663 -- 
£lf
 
is
 
qu”y
 
£t
, 
™s
'ƒlement is‡lways integrated

1664 -- 
ÿÎ
 
by
 
şass


1665 
nÙ
 
is_qu”y_£t
 
ªd
 #_t_qu”y_£ˆ> 0 
th’


1666 -- 
»Œ›ve
 
®l
 
objeùs
' id

1667 
loÿl
 
id_li¡
 = {}

1668 
_
, 
v
 
š
 
	`aœs
(
_t_qu”y_£t
) do

1669 
	`tš£¹
(
id_li¡
, 
v
.
id
)

1670 
’d


1671 -- 
add
 
to
 
šdex
, 
h”e
, 
we
 index 
®l
 
š¡ªûs
 
f™
Ø
qu”y_¬gs
, 
¿th”
 
thª
 
»suÉs
 
­¶›d
 
exŒa
 
lim™©iÚ
 
cÚd™iÚs


1672 
is_usšg_ruË_šdex
 
th’


1673 
	`addIndexToMªag”
(
£lf
, 
qu”y_¡r_id’
, 
id_li¡
)

1674 
’d


1676 -- 
·¹ŸÎy
 
gÙ
 
´eviou¦y
, 
Ãed
 
to
 
g‘
 
the
 
š‹g¿‹d
 
objeùs
 
now


1677 
·¹ŸÎy_gÙ
 
th’


1678 
id_li¡
 = {}

1679 -- 
»Œ›ve
 
Ãeded
 
objeùs
' id

1680 
_
, 
v
 
š
 
	`aœs
(
qu”y_£t
) do

1681 
	`tš£¹
(
id_li¡
, 
v
.
id
)

1682 
’d


1683 
qu”y_£t
 = 
	`g‘FromRedisP–še
(
£lf
, 
id_li¡
)

1684 
’d


1685 
’d


1687  
qu”y_£t


1688 
’d
;

1690 -- 
couÁ
 
the
 
numb”
 
of
 
š¡ªû
 
f™
 
to
 
some
 
ruË


1691 
couÁ
 = 
	`funùiÚ
 (
£lf
, 
qu”y_¬gs
)

1692 
	`I_AM_CLASS
(
£lf
)

1693 
loÿl
 
qu”y_¡r_id’
 = 
	`com´essQu”yArgs
(
qu”y_¬gs
)

1694 
loÿl
 
»t
 = 
	`g‘IndexFromMªag”
(
£lf
, 
qu”y_¡r_id’
, 'getnum')

1695 
nÙ
 
»t
 
th’


1696 
»t
 = #£lf:
	`f‹r
(
qu”y_¬gs
)

1697 
’d


1698  
»t


1699 
’d
;

1702 -- 
CUSTOM
 
API


1703 --- 
£v’
 
APIs


1704 -- 1. 
£tCu¡om


1705 -- 2. 
g‘Cu¡om


1706 -- 3. 
d–Cu¡om


1707 -- 4. 
exi¡Cu¡om


1708 -- 5. 
upd©eCu¡om


1709 -- 6. 
addCu¡omMemb”


1710 -- 7. 
»moveCu¡omMemb”


1711 -- 8. 
hasCu¡omMemb”


1712 -- 9. 
numCu¡om


1714 --- 
five
 
¡Üe
 
ty³


1715 -- 1. 
¡ršg


1716 -- 2. 
li¡


1717 -- 3. 
£t


1718 -- 4. 
z£t


1719 -- 5. 
hash


1722 -- 
¡Üe
 
cu¡omize
 
key
-
v®ue
 
·œ
 
to
 
db


1723 -- 
now
: 
™
 
suµÜt
 
¡ršg
, 
li¡
 
ªd
 
so
 
Ú


1724 
£tCu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
, 
¡
, 
scÜes
)

1725 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1726 
	`checkTy³
(
key
, 'string')

1727 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1729 
nÙ
 
¡
 
Ü
 sˆ=ğ'¡ršg' 
th’


1730 
	`as£¹
Ğ
	`ty³
(
v®
è=ğ'¡ršg' 
Ü
ype(val) == 'number',

1732 
rd¡ršg
.
	`§ve
(
cu¡om_key
, 
v®
)

1734 -- 
	`checkTy³
(
v®
, 'table')

1735 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡
)

1736 
¡Üe_moduË
.
	`§ve
(
cu¡om_key
, 
v®
, 
scÜes
)

1737 
’d


1738 
’d
;

1741 
g‘Cu¡omKey
 = 
	`funùiÚ
 (
£lf
, 
key
)

1742 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1743 
	`checkTy³
(
key
, 'string')

1744 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1746  
cu¡om_key
, 
db
:
	`ty³
(custom_key)

1747 
’d
;

1750 
g‘Cu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
, 
©y³
)

1751 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1752 
	`checkTy³
(
key
, 'string')

1753 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1754 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’


1755 
	`´št
(("[W¬nšg] @g‘Cu¡om - Key % dÛ¢'ˆexi¡!"):
	`fÜm©
(
cu¡om_key
))

1756 
nÙ
 
©y³
 
Ü
‡ty³ =ğ'¡ršg' 
th’
  
n


1757 
–£if
 
©y³
 =ğ'li¡' 
th’


1758  
	`Li¡
()

1760 -- 
TODO
: 
Ãed
 
to
 
£³¿‹
 
ev”y
 
ty³


1762 
’d


1763 
’d


1765 -- 
g‘
 
the
 
¡Üe
 
ty³
 
š
 
»dis


1766 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
)

1767 
©y³
 
th’
 
	`as£¹
(
¡Üe_ty³
 =ğ©y³, '[E¼Ü] @g‘Cu¡om - Th¥ecif›dy³ i nÙƒqu®hty³ stÜed iÀdb.'è
’d


1768 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1769  
¡Üe_moduË
.
	`»Œ›ve
(
cu¡om_key
), 
¡Üe_ty³


1770 
’d
;

1772 
d–Cu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
)

1773 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1774 
	`checkTy³
(
key
, 'string')

1775 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1777  
db
:
	`d–
(
cu¡om_key
)

1778 
’d
;

1780 -- 
check
 
wh‘h”
 
exi¡
 
cu¡om
 
key


1781 
exi¡Cu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
)

1782 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1783 
	`checkTy³
(
key
, 'string')

1784 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1786 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’


1787  
çl£


1789  
Œue


1790 
’d


1791 
’d
;

1793 
upd©eCu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
)

1794 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1795 
	`checkTy³
(
key
, 'string')

1796 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1798 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’
 
	`´št
('[W¬nšg] @upd©eCu¡om - Thi cu¡om key dÛ nÙƒxi¡.');  
n
 
’d


1799 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
)

1800 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1801  
¡Üe_moduË
.
	`upd©e
(
cu¡om_key
, 
v®
)

1803 
’d
;

1805 
»moveCu¡omMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
)

1806 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1807 
	`checkTy³
(
key
, 'string')

1808 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1810 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’
 
	`´št
('[W¬nšg] @»moveCu¡omMemb” - Thi cu¡om key dÛ nÙƒxi¡.');  
n
 
’d


1811 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
)

1812 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1813  
¡Üe_moduË
.
	`»move
(
cu¡om_key
, 
v®
)

1815 
’d
;

1817 
addCu¡omMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
, 
¡y³
, 
scÜe
)

1818 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1819 
	`checkTy³
(
key
, 'string')

1820 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1822 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’
 
	`´št
('[W¬nšg] @addCu¡omMemb” - Thi cu¡om key dÛ nÙƒxi¡.'); 
’d


1823 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
è~ğ'nÚe' 
ªd
 db:ty³(cu¡om_keyè
Ü
 
¡y³


1824 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1825  
¡Üe_moduË
.
	`add
(
cu¡om_key
, 
v®
)

1827 
’d
;

1829 
hasCu¡omMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
mem
)

1830 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1831 
	`checkTy³
(
key
, 'string')

1832 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1834 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’
 
	`´št
('[W¬nšg] @hasCu¡omMemb” - Thi cu¡om key dÛ nÙƒxi¡.');  
n
 
’d


1835 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
)

1836 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1837  
¡Üe_moduË
.
	`has
(
cu¡om_key
, 
mem
)

1839 
’d
;

1841 
numCu¡om
 = 
	`funùiÚ
 (
£lf
, 
key
)

1842 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

1843 
	`checkTy³
(
key
, 'string')

1844 
loÿl
 
cu¡om_key
 = 
£lf
:
	`isCÏss
(è
ªd
 
	`g‘Cu¡omKey
(£lf, 
key
è
Ü
 
	`g‘Cu¡omIdKey
(self, key)

1846 
nÙ
 
db
:
	`exi¡s
(
cu¡om_key
è
th’
  0 
’d


1847 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
cu¡om_key
)

1848 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
¡Üe_ty³
)

1849  
¡Üe_moduË
.
	`num
(
cu¡om_key
)

1850 
’d
;

1853 -- 
Cache
 
API


1854 --- 
£v’
 
APIs


1855 -- 1. 
£tCache


1856 -- 2. 
g‘Cache


1857 -- 3. 
d–Cache


1858 -- 4. 
exi¡Cache


1859 -- 5. 
addCacheMemb”


1860 -- 6. 
»moveCacheMemb”


1861 -- 7. 
hasCacheMemb”


1862 -- 8. 
numCache


1863 -- 9. 
liãCache


1865 
£tCache
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®s
, 
Üd”s
)

1866 
	`I_AM_CLASS
(
£lf
)

1867 
	`checkTy³
(
key
, 'string')

1868 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1869 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

1871 
	`ty³
(
v®s
è=ğ'¡ršg' 
Ü
y³(v®sè=ğ'numb”' 
th’


1872 
db
:
	`£t
(
ÿche_key
, 
v®s
)

1874 -- 
	`checkTy³
(
v®s
, 'table')

1875 
loÿl
 
Ãw_v®s
 = {}

1876 -- `
v®s
` 
is
 
a
 
li¡
, 
š£¹
 
™s
 
–em’t
's id into `new_vals`

1877 -- 
ignÜe
 
the
 
uncÜ»Á
 
–em’t


1879 -- 
–em’ts
 
š
 `
v®s
` 
¬e
 
Üd”ed
, 
but
 
ev”y
 
–em’t
 
™£lf
 
is
 
nÙ


1880 -- 
Ãs£§ry
 
cÚššg
 
’ough
 
Üd”
 
šfo
.

1881 -- 
numb”
, 
™
 
cÚšs
 
’ough


1882 -- 
Ùh”s
, 
™
 
dÛ¢
't containƒnough

1883 -- 
so
, 
we
 
u£
 `
Üd”s
` 
to
 
¥ecify
 
the
 
Üd”
 
šfo


1884 #v® >ğ1 
th’


1885 
	`isV®idIn¡ªû
(
v®s
[1]è
th’


1886 -- 
§ve
 
š¡ªûs
' id

1887 
i
, 
v
 
š
 
	`aœs
(
v®s
) do

1888 
bË
.
	`š£¹
(
Ãw_v®s
, 
v
.
id
)

1889 
’d


1891 
db
:
	`£t
(
ÿch‘y³_key
, 'instance')

1893 
Ãw_v®s
 = 
v®s


1894 
db
:
	`£t
(
ÿch‘y³_key
, 'general')

1895 
’d


1896 
’d


1898 
rdz£t
.
	`§ve
(
ÿche_key
, 
Ãw_v®s
, 
Üd”s
)

1899 
’d


1901 -- 
£t
 
expœ©iÚ


1902 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1903 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1905 
’d
;

1908 
g‘Cache
 = 
	`funùiÚ
 (
£lf
, 
key
, 
¡¬t
, 
¡İ
, 
is_»v
)

1909 
	`I_AM_CLASS
(
£lf
)

1910 
	`checkTy³
(
key
, 'string')

1911 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1912 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

1914 
loÿl
 
ÿche_d©a_ty³
 = 
db
:
	`ty³
(
ÿche_key
)

1915 
loÿl
 
ÿche_d©a


1916 
ÿche_d©a_ty³
 =ğ'¡ršg' 
th’


1917 
ÿche_d©a
 = 
db
:
	`g‘
(
ÿche_key
)

1918 
	`isF®£
(
ÿche_d©a
è
th’
  
n
 
’d


1919 
–£if
 
ÿche_d©a_ty³
 =ğ'z£t' 
th’


1920 
ÿche_d©a
 = 
rdz£t
.
	`»Œ›ve
(
ÿche_key
)

1921 
¡¬t
 
Ü
 
¡İ
 
th’


1922 
ÿche_d©a
 = cache_d©a:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

1923 
’d


1924 
	`isF®£
(
ÿche_d©a
è
th’
  
	`Li¡
(è
’d


1925 
’d


1928 
loÿl
 
ÿch‘y³
 = 
db
:
	`g‘
(
ÿch‘y³_key
)

1929 
ÿch‘y³
 
ªd
 cach‘y³ =ğ'š¡ªû' 
th’


1930 -- 
ÿched
 
š¡ªû
,  in¡ªû 
li¡


1931 
loÿl
 
ÿche_objeùs
 = 
	`g‘FromRedisP–še
(
£lf
, 
ÿche_d©a
)

1933  
ÿche_objeùs


1935 --  
–em’t
 
li¡
 
dœeùly


1936  
ÿche_d©a


1937 
’d


1939 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1940 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1942 
’d
;

1944 
d–Cache
 = 
	`funùiÚ
 (
£lf
, 
key
)

1945 
	`I_AM_CLASS
(
£lf
)

1946 
	`checkTy³
(
key
, 'string')

1947 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1948 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

1950 
db
:
	`d–
(
ÿch‘y³_key
)

1951  
db
:
	`d–
(
ÿche_key
)

1953 
’d
;

1955 -- 
check
 
wh‘h”
 
exi¡
 
ÿche
 
key


1956 
exi¡Cache
 = 
	`funùiÚ
 (
£lf
, 
key
)

1957 
	`I_AM_CLASS
(
£lf
)

1958 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1960  
db
:
	`exi¡s
(
ÿche_key
)

1961 
’d
;

1964 
addCacheMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
, 
scÜe
)

1965 
	`I_AM_CLASS
(
£lf
)

1966 
	`checkTy³
(
key
, 'string')

1967 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1968 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

1970 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
ÿche_key
)

1972 
¡Üe_ty³
 =ğ'z£t' 
th’


1973 
ÿch‘y³_key
 =ğ'š¡ªû' 
th’


1974 -- `
v®
` 
is
 
š¡ªû


1975 
	`checkTy³
(
v®
, 'table')

1976 
	`isV®idIn¡ªû
(
v®
è
th’


1977 
rdz£t
.
	`add
(
ÿche_key
, 
v®
.
id
, 
scÜe
)

1978 
’d


1980 -- `
v®
` 
is
 
¡ršg
 
Ü
 
numb”


1981 
rdz£t
.
	`add
(
ÿche_key
, 
	`to¡ršg
(
v®
), 
scÜe
)

1982 
’d


1983 
–£if
 
¡Üe_ty³
 =ğ'¡ršg' 
th’


1984 
db
:
	`£t
(
ÿche_key
, 
v®
)

1985 
’d


1987 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1988 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

1990 
’d
;

1992 
»moveCacheMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®
)

1993 
	`I_AM_CLASS
(
£lf
)

1994 
	`checkTy³
(
key
, 'string')

1995 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

1996 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

1998 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
ÿche_key
)

2000 
¡Üe_ty³
 =ğ'z£t' 
th’


2001 
ÿch‘y³_key
 =ğ'š¡ªû' 
th’


2002 -- `
v®
` 
is
 
š¡ªû


2003 
	`checkTy³
(
v®
, 'table')

2004 
	`isV®idIn¡ªû
(
v®
è
th’


2005 
rdz£t
.
	`»move
(
ÿche_key
, 
v®
.
id
)

2006 
’d


2008 -- `
v®
` 
is
 
¡ršg
 
Ü
 
numb”


2009 
rdz£t
.
	`»move
(
ÿche_key
, 
	`to¡ršg
(
v®
))

2010 
’d


2012 
–£if
 
¡Üe_ty³
 =ğ'¡ršg' 
th’


2013 
db
:
	`£t
(
ÿche_key
, '')

2014 
’d


2016 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2017 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2019 
’d
;

2021 
hasCacheMemb”
 = 
	`funùiÚ
 (
£lf
, 
key
, 
mem
)

2022 
	`I_AM_CLASS
(
£lf
)

2023 
	`checkTy³
(
key
, 'string')

2024 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

2025 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

2027 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
ÿche_key
)

2029 
¡Üe_ty³
 =ğ'z£t' 
th’


2030 
ÿch‘y³_key
 =ğ'š¡ªû' 
th’


2031 -- `
v®
` 
is
 
š¡ªû


2032 
	`checkTy³
(
mem
, 'table')

2033 
	`isV®idIn¡ªû
(
v®
è
th’


2034  
rdz£t
.
	`has
(
ÿche_key
, 
v®
.
id
)

2035 
’d


2037 -- `
v®
` 
is
 
¡ršg
 
Ü
 
numb”


2038  
rdz£t
.
	`has
(
ÿche_key
, 
	`to¡ršg
(
mem
))

2039 
’d


2041 
–£if
 
¡Üe_ty³
 =ğ'¡ršg' 
th’


2042  
db
:
	`g‘
(
ÿche_key
è=ğ
mem


2043 
’d


2045 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2046 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2047 
’d
;

2049 
numCache
 = 
	`funùiÚ
 (
£lf
, 
key
)

2050 
	`I_AM_CLASS
(
£lf
)

2052 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

2053 
loÿl
 
ÿch‘y³_key
 = 
	`g‘Cach‘y³Key
(
£lf
, 
key
)

2055 
db
:
	`expœe
(
ÿche_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2056 
db
:
	`expœe
(
ÿch‘y³_key
, 
bamboo
.
cÚfig
.
ÿche_liã
 
Ü
 bamboo.
CACHE_LIFE
)

2058 
loÿl
 
¡Üe_ty³
 = 
db
:
	`ty³
(
ÿche_key
)

2059 
¡Üe_ty³
 =ğ'z£t' 
th’


2060  
rdz£t
.
	`num
(
ÿche_key
)

2061 
–£if
 
¡Üe_ty³
 =ğ'¡ršg' 
th’


2063 
’d


2064 
’d
;

2066 
liãCache
 = 
	`funùiÚ
 (
£lf
, 
key
)

2067 
	`I_AM_CLASS
(
£lf
)

2068 
	`checkTy³
(
key
, 'string')

2069 
loÿl
 
ÿche_key
 = 
	`g‘CacheKey
(
£lf
, 
key
)

2071  
db
:
	`‰l
(
ÿche_key
)

2072 
’d
;

2074 -- 
d–‘e
 
£lf
 
š¡ªû
 
objeù


2075 -- 
£lf
 
ÿn
 
be
 
š¡ªû
 
Ü
 
qu”y
 
£t


2076 
d–ById
 = 
	`funùiÚ
 (
£lf
, 
ids
)

2077 
	`I_AM_CLASS
(
£lf
)

2078 
bamboo
.
cÚfig
.
u£_çke_d–‘iÚ
 =ğ
Œue
 
th’


2079  
£lf
:
	`çkeD–ById
(
ids
)

2081  
£lf
:
	`ŒueD–ById
(
ids
)

2082 
’d


2083 
’d
;

2085 
çkeD–ById
 = 
	`funùiÚ
 (
£lf
, 
ids
)

2086 
loÿl
 
idty³
 = 
	`ty³
(
ids
)

2087 
idty³
 =ğ'bË' 
th’


2088 
_
, 
v
 
š
 
	`aœs
(
ids
) do

2089 
v
 = 
	`to¡ršg
(v)

2090 
	`çked–FromRedis
(
£lf
, 
v
)

2092 
’d


2094 
	`çked–FromRedis
(
£lf
, 
	`to¡ršg
(
ids
))

2095 
’d


2096 
’d
;

2098 
ŒueD–ById
 = 
	`funùiÚ
 (
£lf
, 
ids
)

2099 
loÿl
 
idty³
 = 
	`ty³
(
ids
)

2100 
idty³
 =ğ'bË' 
th’


2101 
_
, 
v
 
š
 
	`aœs
(
ids
) do

2102 
v
 = 
	`to¡ršg
(v)

2103 
	`d–FromRedis
(
£lf
, 
v
)

2105 
’d


2107 
	`d–FromRedis
(
£lf
, 
	`to¡ršg
(
ids
))

2108 
’d


2109 
’d
;

2114 -- 
v®id©e
 
fÜm
 
·¿m‘”s
 
by
 
mod–
 
defš©iÚ


2115 -- 
usu®ly
, 
·¿ms
 = 
FÜm
:
	`·r£
(
»q
)

2117 
v®id©e
 = 
	`funùiÚ
 (
£lf
, 
·¿ms
)

2118 
	`I_AM_CLASS
(
£lf
)

2119 
	`checkTy³
(
·¿ms
, 'table')

2120 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


2121 
loÿl
 
”r_msgs
 = {}

2122 
loÿl
 
is_v®id
 = 
Œue


2123 
k
, 
v
 
š
 
	`·œs
(
f›lds
) do

2124 
loÿl
 
»t
, 
”r_msg
 = 
v
:
	`v®id©e
(
·¿ms
[
k
], k)

2125 
nÙ
 
»t
 
th’


2126 
is_v®id
 = 
çl£


2127 
_
, 
msg
 
š
 
	`aœs
(
”r_msg
) do

2128 
bË
.
	`š£¹
(
”r_msgs
, 
msg
)

2129 
’d


2130 
’d


2131 
’d


2132  
is_v®id
, 
”r_msgs


2133 
’d
;

2138 -- 
In¡ªû
 
FunùiÚs


2140 -- 
§ve
 
š¡ªû
's‚ormal field

2141 -- 
befÜe
 
§ve
, 
the
 
š¡ªû
 
has
 
no
 
id


2142 
§ve
 = 
	`funùiÚ
 (
£lf
, 
·¿ms
)

2143 
	`I_AM_INSTANCE
(
£lf
)

2145 
loÿl
 
Ãw_ÿ£
 = 
Œue


2146 -- 
h”e
, 
we
 
£·¿‹
 
the
 
Ãw
 
ü—‹
 
ªd
 
upd©e
 

2147 -- 
backw¬ds
 
to
 
Mod–
, 
the
 
__šdexfd
 
is
 'id'

2148 
loÿl
 
šdexfd
 = 
£lf
.
__šdexfd


2149 
	`as£¹
(
	`ty³
(
šdexfd
) == 'string', "[Error]he __indexfd should be string.")

2151 -- 
£lf
 
has
 
id
 
©Œibu‹
, 
™
 
is
 
ª
 
š¡ªû
 
§ved
 
befÜe
. 
u£
 id 
to
 
£·¿‹
 
two
 
ÿ£s


2152 
£lf
.
id
 
th’
 
Ãw_ÿ£
 = 
çl£
 
’d


2154 -- 
upd©e
 
the
 
Ï¡modif›d_time


2155 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2157 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

2158 
loÿl
 
»¶›s


2159 
Ãw_ÿ£
 
th’


2160 
loÿl
 
couÁ”Çme
 = 
	`g‘CouÁ”Name
(
£lf
)

2161 
loÿl
 
İtiÚs
 = { 
w©ch
 = {
couÁ”Çme
, 
šdex_key
}, 
ÿs
 = 
Œue
, 
»Œy
 = 2 }

2162 
»¶›s
 = 
db
:
	`Œª§ùiÚ
(
İtiÚs
, 
	`funùiÚ
(db)

2163 -- 
šü—£
 
the
 
š¡ªû
 
couÁ”


2164 
db
:
	`šü
(
couÁ”Çme
)

2165 
£lf
.
id
 = 
db
:
	`g‘
(
couÁ”Çme
)

2166 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2167 
loÿl
 
£lf
, 
¡Üe_kv
 = 
	`´oûssBefÜeSave
(£lf, 
·¿ms
)

2168 
	`as£¹
(
nÙ
 
db
:
	`zscÜe
(
šdex_key
, 
£lf
[
šdexfd
]), "[Error] save duplicateo‡n unique†imited field,‡borted!")

2170 
db
:
	`zadd
(
šdex_key
, 
£lf
.
id
, s–f[
šdexfd
])

2171 -- 
upd©e
 
objeù
 
hash
 
¡Üe
 
key


2172 
db
:
	`hm£t
(
mod–_key
, 
	`uÅack
(
¡Üe_kv
))

2173 
’d
)

2175 -- 
upd©e
 

2176 
	`as£¹
(
	`tÚumb”
(
	`g‘CouÁ”
(
£lf
)è>ğtÚumb”(£lf.
id
), '[Error] @save - invalid id.')

2177 -- 
š
 
´oûssBefÜeSave
, 
th”e
 
is
 
no
 
»dis
 
aùiÚ


2178 
loÿl
 
£lf
, 
¡Üe_kv
 = 
	`´oûssBefÜeSave
(£lf, 
·¿ms
)

2179 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2181 
loÿl
 
İtiÚs
 = { 
w©ch
 = {
šdex_key
}, 
ÿs
 = 
Œue
, 
»Œy
 = 2 }

2182 
»¶›s
 = 
db
:
	`Œª§ùiÚ
(
İtiÚs
, 
	`funùiÚ
(db)

2183 
loÿl
 
scÜe
 = 
db
:
	`zscÜe
(
šdex_key
, 
£lf
[
šdexfd
])

2184 
	`as£¹
(
scÜe
 =ğ
£lf
.
id
 
Ü
 scÜ=ğ
n
, "[Error] save duplicateo‡n unique†imited field,‡borted!")

2186 -- 
modif›d
 
šdexfd
, 
scÜe
 
wl
 
be
 
n
, 
»move
 
the
 
Şd
 
id
-šdexfd 
·œ
, 
Ï‹r
 
Ãw
 
§ve
 indexfd

2187 
nÙ
 
scÜe
 
th’


2188 
db
:
	`z»m¿ngebyscÜe
(
šdex_key
, 
£lf
.
id
, self.id)

2189 
’d


2190 -- 
upd©e
 
__šdex
 
scÜe
 
ªd
 
memb”


2191 
db
:
	`zadd
(
šdex_key
, 
£lf
.
id
, s–f[
šdexfd
])

2192 -- 
upd©e
 
objeù
 
hash
 
¡Üe
 
key


2193 
db
:
	`hm£t
(
mod–_key
, 
	`uÅack
(
¡Üe_kv
))

2194 
’d
)

2195 
’d


2197 -- 
make
 
fuÎ‹xt
 
šdexes


2198 
	`isUsšgFuÎ‹xtIndex
(
£lf
è
th’


2199 
	`makeFuÎ‹xtIndexes
(
£lf
)

2200 
’d


2201 
	`isUsšgRuËIndex
(
£lf
è
th’


2202 
	`upd©eIndexByRuËs
(
£lf
, 'save')

2203 
’d


2205  
£lf


2206 
’d
;

2208 -- 
·¹ŸÎy
 
upd©e
 
funùiÚ
, 
Úû
 
Úe
 
f›ld


2209 -- 
ÿn
 
Úly
 
­¶y
 
to
 
nÚe
 
fÜeign
 
f›ld


2210 
upd©e
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
Ãw_v®ue
)

2211 
	`I_AM_INSTANCE
(
£lf
)

2212 
	`checkTy³
(
f›ld
, 'string')

2213 
	`as£¹
(
	`ty³
(
Ãw_v®ue
è=ğ'¡ršg' 
Ü
ype(new_value) == 'number' orype(new_value) == 'nil')

2214 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2215 
nÙ
 
æd
 
th’
 
	`´št
(("[W¬nšg] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
));  
n
 
’d


2216 
	`as£¹
Ğ
nÙ
 
æd
.
fÜeign
, ("[E¼Ü] % i ¨fÜeigÀf›ld, shouldn'ˆu£ upd©funùiÚ!"):
	`fÜm©
(
f›ld
))

2217 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2218 
	`as£¹
(
db
:
	`exi¡s
(
mod–_key
), ("[E¼Ü] Key % dÛs'ˆexi¡! Cª'ˆ­¶y upd©e."):
	`fÜm©
(model_key))

2220 
loÿl
 
šdexfd
 = 
£lf
.
__šdexfd


2223 
Ãw_v®ue
 =ğ
n
 
th’


2224 -- 
could
 
nÙ
 
d–‘e
 
šdex
 
f›ld


2225 
f›ld
 ~ğ
šdexfd
 
th’


2226 
db
:
	`hd–
(
mod–_key
, 
f›ld
)

2227 
’d


2229 -- 
­¶y
 
to
 
db


2230 -- 
f›ld
 
is
 
šdexed
, 
Ãed
 
to
 
upd©e
 
the
 
__šdex
 
too


2231 
f›ld
 =ğ
šdexfd
 
th’


2232 
loÿl
 
šdex_key
 = 
	`g‘IndexKey
(
£lf
)

2233 
db
:
	`z»m¿ngebyscÜe
(
šdex_key
, 
£lf
.
id
, self.id)

2234 
db
:
	`zadd
(
šdex_key
, 
£lf
.
id
, 
Ãw_v®ue
)

2235 
’d


2237 
db
:
	`h£t
(
mod–_key
, 
f›ld
, 
Ãw_v®ue
)

2238 
’d


2239 -- 
upd©e
 
the
 
Ï¡modif›d_time


2240 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2241 
db
:
	`h£t
(
mod–_key
, 'Ï¡modif›d_time', 
£lf
.
Ï¡modif›d_time
)

2243 -- 
­¶y
 
to
 
lua
 
objeù


2244 
£lf
[
f›ld
] = 
Ãw_v®ue


2246 -- 
fuÎ‹xt
 
šdex


2247 
æd
.
fuÎ‹xt_šdex
 
ªd
 
	`isUsšgFuÎ‹xtIndex
(
£lf
è
th’


2248 
	`makeFuÎ‹xtIndexes
(
£lf
)

2249 
’d


2250 
	`isUsšgRuËIndex
(
£lf
è
th’


2251 
	`upd©eIndexByRuËs
(
£lf
, 'update')

2252 
’d


2255  
£lf


2256 
’d
;

2258 -- 
g‘
 
the
 
mod–
's instance counter value

2259 -- 
this
 
ÿn
 
be
 
ÿÎ
 
by
 
CÏss
 
ªd
 
In¡ªû


2260 
g‘CouÁ”
 = getCounter;

2262 -- 
d–‘e
 
£lf
 
š¡ªû
 
objeù


2263 -- 
£lf
 
ÿn
 
be
 
š¡ªû
 
Ü
 
qu”y
 
£t


2264 
çkeD–
 = 
	`funùiÚ
 (
£lf
)

2265 -- 
£lf
 
is
 
qu”y
 
£t


2266 
	`isQu”yS‘
(
£lf
è
th’


2267 
_
, 
v
 
š
 
	`aœs
(
£lf
) do

2268 
	`çked–FromRedis
(
v
)

2269 
v
 = 
n


2270 
’d


2272 
	`çked–FromRedis
(
£lf
)

2273 
’d


2275 
£lf
 = 
n


2276 
’d
;

2278 -- 
d–‘e
 
£lf
 
š¡ªû
 
objeù


2279 -- 
£lf
 
ÿn
 
be
 
š¡ªû
 
Ü
 
qu”y
 
£t


2280 
ŒueD–
 = 
	`funùiÚ
 (
£lf
)

2281 -- 
£lf
 
is
 
qu”y
 
£t


2282 
	`isQu”yS‘
(
£lf
è
th’


2283 
_
, 
v
 
š
 
	`aœs
(
£lf
) do

2284 
	`d–FromRedis
(
v
)

2285 
v
 = 
n


2286 
’d


2288 
	`d–FromRedis
(
£lf
)

2289 
’d


2291 
£lf
 = 
n


2292 
’d
;

2295 -- 
d–‘e
 
£lf
 
š¡ªû
 
objeù


2296 -- 
£lf
 
ÿn
 
be
 
š¡ªû
 
Ü
 
qu”y
 
£t


2297 
d–
 = 
	`funùiÚ
 (
£lf
)

2298 
	`I_AM_INSTANCE_OR_QUERY_SET
(
£lf
)

2299 
bamboo
.
cÚfig
.
u£_çke_d–‘iÚ
 =ğ
Œue
 
th’


2300  
£lf
:
	`çkeD–
()

2302  
£lf
:
	`ŒueD–
()

2303 
’d


2304 
’d
;

2306 -- 
u£
 
¡yË
: 
Mod–_Çme
:
	`»¡ÜeD–‘ed
(
id
)

2307 
»¡ÜeD–‘ed
 = 
	`funùiÚ
 (
£lf
, 
id
)

2308 
	`I_AM_CLASS
(
£lf
)

2309  
	`»¡ÜeFakeD–‘edIn¡ªû
(
£lf
, 
id
)

2310 
’d
;

2312 -- 
ş—r
 
®l
 
d–‘ed
 
š¡ªû
 
ªd
 
™s
 
fÜeign
 
»ÏtiÚs


2313 
sw“pD–‘ed
 = 
	`funùiÚ
 (
£lf
)

2314 
loÿl
 
d–‘ed_keys
 = 
db
:
	`keys
('DELETED:*')

2315 
_
, 
v
 
š
 
	`aœs
(
d–‘ed_keys
) do

2316 -- 
cÚššg
 
hash
 
¡ruùu»
 
ªd
 
fÜeign
 
z£t
 structure

2317 
db
:
	`d–
(
v
)

2318 
’d


2319 
db
:
	`d–
(
dcŞËùÜ
)

2320 
’d
;

2323 -- 
FÜeign
 
API


2326 -- 
add
 
a
 
fÜeign
 
objeù
's idohis foreign field

2327 --  
£lf


2328 
addFÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
obj
)

2329 
	`I_AM_INSTANCE
(
£lf
)

2330 
	`checkTy³
(
f›ld
, 'string')

2331 
	`as£¹
(
	`tÚumb”
(
	`g‘CouÁ”
(
£lf
)è>ğtÚumb”(£lf.
id
), '[Error] before doing‡ddForeign, you must savehis instance.')

2332 
	`as£¹
(
	`ty³
(
obj
è=ğ'bË' 
Ü
ype(obj) == 'string', '[Error] "obj" should beable or string.')

2333 
	`ty³
(
obj
è=ğ'bË' 
th’
 
	`checkTy³
(
	`tÚumb”
(obj.
id
), 'numb”'è
’d


2335 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2336 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2337 
	`as£¹
Ğ
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2338 
	`as£¹
Ğ
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2339 
	`as£¹
Ğ
æd
.
fÜeign
 =ğ'ANYSTRING' 
Ü
 
obj
.
id
,

2341 
	`as£¹
Ğ
æd
.
fÜeign
 =ğ'ANYSTRING' 
Ü
 fld.fÜeigÀ=ğ'UNFIXED' o¸æd.fÜeigÀ=ğ
	`g‘CÏssName
(
obj
),

2342 ("[E¼Ü] Thi fÜeigÀf›ld '%s' cª'ˆacû±hš¡ªû oàmod– '%s'."):
	`fÜm©
(

2343 
f›ld
, 
	`g‘CÏssName
(
obj
è
Ü
 
	`to¡ršg
(obj)))

2345 
loÿl
 
Ãw_id


2346 
æd
.
fÜeign
 =ğ'ANYSTRING' 
th’


2347 
	`checkTy³
(
obj
, 'string')

2348 
Ãw_id
 = 
obj


2349 
–£if
 
æd
.
fÜeign
 =ğ'UNFIXED' 
th’


2350 
Ãw_id
 = 
	`g‘NameIdP©‹º
(
obj
)

2352 
Ãw_id
 = 
obj
.
id


2353 
’d


2355 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2356 
æd
.
¡
 =ğ'ONE' 
th’


2357 -- 
»cÜd
 
š
 
db


2358 
db
:
	`h£t
(
mod–_key
, 
f›ld
, 
Ãw_id
)

2359 -- 
ONE
 
fÜeign
 
v®ue
 
ÿn
 
be
 
g‘
 
by
 'g‘' 
£r›s
 
funùiÚs


2360 
£lf
[
f›ld
] = 
Ãw_id


2363 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2364 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2365 
¡Üe_moduË
.
	`add
(
key
, 
Ãw_id
, 
æd
.
fifŞ’
)

2366 -- 
š
 
z£t
, 
the
 
Ãwe¡
 
memb”
 
has
h
high”
 
scÜe


2367 -- 
but
 
u£
 
g‘FÜeign
, 
we
 
»Œ›ve
 
them
 
äom
 
high
 
to
 
low
, 
so
 
Ãwe¡
 
is
 
©
 
Ëá
 
of
 
»suÉ


2368 
’d


2370 -- 
upd©e
 
the
 
Ï¡modif›d_time


2371 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2372 
db
:
	`h£t
(
mod–_key
, 'Ï¡modif›d_time', 
£lf
.
Ï¡modif›d_time
)

2373  
£lf


2374 
’d
;

2379 
g‘FÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
¡¬t
, 
¡İ
, 
is_»v
)

2380 
	`I_AM_INSTANCE
(
£lf
)

2381 
	`checkTy³
(
f›ld
, 'string')

2382 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2383 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2384 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2385 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2387 
æd
.
¡
 =ğ'ONE' 
th’


2388 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
n
 
’d


2390 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2391 
æd
.
fÜeign
 =ğ'ANYSTRING' 
th’


2392 --  
¡ršg
 
dœeùly


2393  
£lf
[
f›ld
]

2395 
loÿl
 
lšk_mod–
, 
lšked_id


2396 
æd
.
fÜeign
 =ğ'UNFIXED' 
th’


2397 
lšk_mod–
, 
lšked_id
 = 
	`£³¿‹Mod–AndId
(
£lf
[
f›ld
])

2399 -- 
nÜm®
 

2400 
lšk_mod–
 = 
	`g‘Mod–ByName
(
æd
.
fÜeign
)

2401 
lšked_id
 = 
£lf
[
f›ld
]

2402 
’d


2404 
loÿl
 
obj
 = 
lšk_mod–
:
	`g‘ById
 (
lšked_id
)

2405 
nÙ
 
	`isV®idIn¡ªû
(
obj
è
th’


2406 
	`´št
('[Warning] invalid ONE foreign id or object.')

2407  
n


2409  
obj


2410 
’d


2411 
’d


2413 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
	`Qu”yS‘
(è
’d


2415 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2417 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2418 
loÿl
 
li¡
 = 
¡Üe_moduË
.
	`»Œ›ve
(
key
)

2420 
li¡
:
	`isEm±y
(è
th’
  
	`Qu”yS‘
(è
’d


2421 
li¡
 =†i¡:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

2422 
li¡
:
	`isEm±y
(è
th’
  
	`Qu”yS‘
(è
’d


2424  
	`»Œ›veObjeùsByFÜeignTy³
(
æd
.
fÜeign
, 
li¡
)

2425 
’d


2426 
’d
;

2428 
g‘FÜeignIds
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
¡¬t
, 
¡İ
, 
is_»v
)

2429 
	`I_AM_INSTANCE
(
£lf
)

2430 
	`checkTy³
(
f›ld
, 'string')

2431 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2432 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2433 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2434 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2436 
æd
.
¡
 =ğ'ONE' 
th’


2437 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
n
 
’d


2439  
£lf
[
f›ld
]

2442 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
	`Li¡
(è
’d


2443 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2444 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2445 
loÿl
 
li¡
 = 
¡Üe_moduË
.
	`»Œ›ve
(
key
)

2446 
li¡
:
	`isEm±y
(è
th’
  
	`Li¡
(è
’d


2448 
li¡
 =†i¡:
	`¦iû
(
¡¬t
, 
¡İ
, 
is_»v
)

2449 
li¡
:
	`isEm±y
(è
th’
  
	`Li¡
(è
’d


2451  
li¡


2452 
’d


2454 
’d
;

2456 -- 
»¬¿nge
 
the
 
fÜeign
 
šdex
 
by
 
šput
 
li¡


2457 
»¬¿ngeFÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
šli¡
)

2458 
	`I_AM_INSTANCE
(
£lf
)

2459 
	`as£¹
(
	`ty³
(
f›ld
è=ğ'¡ršg' 
ªd
y³(
šli¡
) == 'table', '[Error] @„earrangeForeign -…arametersypeƒrror.' )

2460 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2461 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2462 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2463 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2465 
loÿl
 
Ãw_Üd”s
 = {}

2466 
loÿl
 
Üig_Üd”s
 = 
£lf
:
	`g‘FÜeignIds
(
f›ld
)

2467 
loÿl
 
Üig_Ën
 = #orig_orders

2468 
loÿl
 
rÜig_Üd”s
 = {}

2469 -- 
make
 
»v”£
 
hash
 
®l
 
ids


2470 
i
, 
v
 
š
 
	`aœs
(
Üig_Üd”s
) do

2471 
rÜig_Üd”s
[
	`to¡ršg
(
v
)] = 
i


2472 
’d


2473 -- 
»Œ›ve
 
v®id
 
–em’ts
 
š
 
šli¡


2474 
i
, 
–em
 
š
 
	`aœs
(
šli¡
) do

2475 
loÿl
 
pos
 = 
rÜig_Üd”s
[
–em
] -- 
Üig_Üd”s
:
	`fšd
(
	`to¡ršg
(elem))

2476 
pos
 
th’


2477 
	`tš£¹
(
Ãw_Üd”s
, 
–em
)

2478 -- 
»move
 
the
 
Üigš®
 
–em’t


2479 
Üig_Üd”s
[
pos
] = 
n


2480 
’d


2481 
’d


2482 -- 
­³nd
 
the
 
»¡
 
–em’ts
 
š
 
fÜeign
 
to
h
’d
 
of
 
Ãw_Üd”s


2483 
i
 = 1, 
Üig_Ën
 do

2484 
Üig_Üd”s
[
i
] ~ğ
n
 
th’


2485 
	`tš£¹
(
Ãw_Üd”s
, 
v
)

2486 
’d


2487 
’d


2489 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2490 -- 
ov”ride
 
the
 
Üigš®
 
fÜeign
 
z£t
 
v®ue


2491 
rdz£t
.
	`§ve
(
key
, 
Ãw_Üd”s
)

2493  
£lf


2494 
’d
;

2496 -- 
d––‹
 
a
 
fÜeign
 
memb”


2497 -- 
obj
 
ÿn
 
be
 
š¡ªû
 
objeù
, 
®so
 can be object's id,‡lso can be‡nystring.

2498 
d–FÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
obj
)

2499 
	`I_AM_INSTANCE
(
£lf
)

2500 
	`checkTy³
(
f›ld
, 'string')

2501 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2502 
	`as£¹
(
nÙ
 
	`isF®£
(
obj
), "[Error] @delForeign.…aram obj must‚ot be‚il.")

2503 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2504 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2505 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2506 --
	`as£¹
Ğ
æd
.
fÜeign
 =ğ'ANYSTRING' 
Ü
 
obj
.
id
, "[Error] This object doesn't contain id, it's‚ot‡ valid object!")

2507 
	`as£¹
(
æd
.
fÜeign
 == 'ANYSTRING'

2508 
Ü
 
æd
.
fÜeign
 == 'UNFIXED'

2509 
	`Ü
 (
	`ty³
(
obj
è=ğ'bË' 
ªd
 
æd
.
fÜeign
 =ğ
	`g‘CÏssName
(obj)),

2510 ("[E¼Ü] Thi fÜeigÀf›ld '%s' cª'ˆacû±hš¡ªû oàmod– '%s'."):
	`fÜm©
(
f›ld
, 
	`g‘CÏssName
(
obj
è
Ü
 
	`to¡ršg
(obj)))

2512 -- 
£lf
[
f›ld
] 
is
 
n
, 
™
 
mu¡
 
be
 
wrÚg
 
somewh”e


2513 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
n
 
’d


2515 
loÿl
 
Ãw_id


2516 
	`isNumOrSŒ
(
obj
è
th’


2517 -- 
obj
 
is
 
id
 
Ü
 
ªy¡ršg


2518 
Ãw_id
 = 
	`to¡ršg
(
obj
)

2520 
	`checkTy³
(
obj
, 'table')

2521 
æd
.
fÜeign
 =ğ'UNFIXED' 
th’


2522 
Ãw_id
 = 
	`g‘NameIdP©‹º
(
obj
)

2524 
Ãw_id
 = 
	`to¡ršg
(
obj
.
id
)

2525 
’d


2526 
’d


2528 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2529 
æd
.
¡
 =ğ'ONE' 
th’


2530 -- 
we
 
mu¡
 
check
 
the
 
equ®™y
 
of
 
£lf
[
fed
] 
ªd
 
Ãw_id
 
befÜe
 
³rfÜm
 
d–‘e
 
aùiÚ


2531 
£lf
[
f›ld
] =ğ
Ãw_id
 
th’


2532 -- 
maybe
 
h”e
 
is
 
rude


2533 
db
:
	`hd–
(
mod–_key
, 
f›ld
)

2534 
£lf
[
f›ld
] = 
n


2535 
’d


2537 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2538 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2539 
¡Üe_moduË
.
	`»move
(
key
, 
Ãw_id
)

2540 
’d


2542 -- 
upd©e
 
the
 
Ï¡modif›d_time


2543 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2544 
db
:
	`h£t
(
mod–_key
, 'Ï¡modif›d_time', 
£lf
.
Ï¡modif›d_time
)

2545  
£lf


2546 
’d
;

2548 
ş—rFÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
)

2549 
	`I_AM_INSTANCE
(
£lf
)

2550 
	`checkTy³
(
f›ld
, 'string')

2551 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2552 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2553 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2554 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2557 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2558 
æd
.
¡
 =ğ'ONE' 
th’


2559 -- 
maybe
 
h”e
 
is
 
rude


2560 
db
:
	`hd–
(
mod–_key
, 
f›ld
)

2562 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2563 -- 
d–‘e
 
the
 
fÜeign
 
key


2564 
db
:
	`d–
(
key
)

2565 
’d


2567 -- 
upd©e
 
the
 
Ï¡modif›d_time


2568 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2569 
db
:
	`h£t
(
mod–_key
, 'Ï¡modif›d_time', 
£lf
.
Ï¡modif›d_time
)

2570  
£lf


2571 
’d
;

2573 
d“pCË¬FÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
)

2574 
	`I_AM_INSTANCE
(
£lf
)

2575 
	`checkTy³
(
f›ld
, 'string')

2576 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2577 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2578 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2579 
	`as£¹
(
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2581 -- 
d–‘e
 
the
 
fÜeign
 
objeùs
 
fœ¡


2582 
loÿl
 
fobjs
 = 
£lf
:
	`g‘FÜeign
(
f›ld
)

2583 
fobjs
 
th’
 fobjs:
	`d–
(è
’d


2585 
loÿl
 
mod–_key
 = 
	`g‘NameIdP©‹º
(
£lf
)

2586 
æd
.
¡
 =ğ'ONE' 
th’


2587 -- 
maybe
 
h”e
 
is
 
rude


2588 
db
:
	`hd–
(
mod–_key
, 
f›ld
)

2590 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2591 -- 
d–‘e
 
the
 
fÜeign
 
key


2592 
db
:
	`d–
(
key
)

2593 
’d


2595 -- 
upd©e
 
the
 
Ï¡modif›d_time


2596 
£lf
.
Ï¡modif›d_time
 = 
sock‘
.
	`g‘time
()

2597 
db
:
	`h£t
(
mod–_key
, 'Ï¡modif›d_time', 
£lf
.
Ï¡modif›d_time
)

2598  
£lf


2599 
’d
;

2601 -- 
check
 
wh‘h”
 
some
 
obj
 
is
 
®»ady
 
š
 
fÜeign
 
li¡


2602 -- 
š¡ªû
:
	`šFÜeign
('some_f›ld', 
obj
)

2603 
hasFÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
obj
)

2604 
	`I_AM_INSTANCE
(
£lf
)

2605 
	`checkTy³
(
f›ld
, 'string')

2606 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2607 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2608 
	`as£¹
(
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2609 
	`as£¹
Ğ
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2610 
	`as£¹
(
æd
.
fÜeign
 =ğ'ANYSTRING' 
Ü
 
obj
.
id
, "[Error] This object doesn't contain id, it's‚ot‡ valid object!")

2611 
	`as£¹
(
æd
.
fÜeign
 =ğ'ANYSTRING' 
Ü
 fld.fÜeigÀ=ğ'UNFIXED' o¸æd.fÜeigÀ=ğ
	`g‘CÏssName
(
obj
),

2612 ("[E¼Ü] ThfÜeigÀmod– (%sèoàthi f›ld % dÛ¢'ˆequ®hobjeù' mod– %s."):
	`fÜm©
(
æd
.
fÜeign
, 
f›ld
, 
	`g‘CÏssName
(
obj
è
Ü
 ''))

2613 
	`isF®£
(
£lf
[
f›ld
]è
th’
  
n
 
’d


2615 
loÿl
 
Ãw_id


2616 
	`isNumOrSŒ
(
obj
è
th’


2617 -- 
obj
 
is
 
id
 
Ü
 
ªy¡ršg


2618 
Ãw_id
 = 
	`to¡ršg
(
obj
)

2620 
	`checkTy³
(
obj
, 'table')

2621 
æd
.
fÜeign
 =ğ'UNFIXED' 
th’


2622 
Ãw_id
 = 
	`g‘NameIdP©‹º
(
£lf
)

2624 
Ãw_id
 = 
	`to¡ršg
(
obj
.
id
)

2625 
’d


2626 
’d


2628 
æd
.
¡
 =ğ"ONE" 
th’


2629  
£lf
[
f›ld
] =ğ
Ãw_id


2631 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2632 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2633  
¡Üe_moduË
.
	`has
(
key
, 
Ãw_id
)

2634 
’d


2636  
çl£


2637 
’d
;

2639 --  
the
 
numb”
 
of
 
–em’ts
 
š
h
fÜeign
 
li¡


2640 -- @
·¿m
 
f›ld
: f›ld 
of
 
th©
 
fÜeign
 
mod–


2641 
numFÜeign
 = 
	`funùiÚ
 (
£lf
, 
f›ld
)

2642 
	`I_AM_INSTANCE
(
£lf
)

2643 
	`checkTy³
(
f›ld
, 'string')

2644 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2645 
	`as£¹
(
æd
, ("[E¼Ü] F›ld % dÛ¢'ˆbdefšed!"):
	`fÜm©
(
f›ld
))

2646 
	`as£¹
Ğ
æd
.
fÜeign
, ("[E¼Ü] Thi f›ld % i nÙ‡ fÜeigÀf›ld."):
	`fÜm©
(
f›ld
))

2647 
	`as£¹
Ğ
æd
.
¡
, ("[E¼Ü] NØ¡Üty³ s‘tšg fÜhi fÜeigÀf›ld %s."):
	`fÜm©
(
f›ld
))

2648 -- 
fÜeign
 
f›ld
 
lšk
 
is
 
now
 
nuÎ


2649 
	`isF®£
(
£lf
[
f›ld
]è
th’
  0 
’d


2651 
æd
.
¡
 =ğ'ONE' 
th’


2652 -- 
the
 
ONE
 
fÜeign
 
f›ld
 
has
 
Úly
 1 
–em’t


2655 
loÿl
 
key
 = 
	`g‘F›ldP©‹º
(
£lf
, 
f›ld
)

2656 
loÿl
 
¡Üe_moduË
 = 
	`g‘StÜeModuË
(
æd
.
¡
)

2657  
¡Üe_moduË
.
	`num
(
key
)

2658 
’d


2659 
’d
;

2661 -- 
check
 
this
 
şass
/
objeù
 
has
 
a
 
fÜeign
 
key


2662 -- @
·¿m
 
f›ld
: f›ld 
of
 
th©
 
fÜeign
 
mod–


2663 
hasFÜeignKey
 = 
	`funùiÚ
 (
£lf
, 
f›ld
)

2664 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

2665 
	`checkTy³
(
f›ld
, 'string')

2666 
loÿl
 
æd
 = 
£lf
.
__f›lds
[
f›ld
]

2667 
æd
 
ªd
 fld.
fÜeign
 
th’
  
Œue


2668  
çl£


2669 
’d


2671 
’d
;

2673 ---  
the
 
şass
 
Çme
 
of
 
ª
 
š¡ªû


2674 
şas¢ame
 = 
	`funùiÚ
 (
£lf
)

2675  
	`g‘CÏssName
(
£lf
)

2676 
’d
;

2678 -- dØ
sÜt
 
Ú
 
qu”y
 
£t
 
by
 
some
 
f›ld


2679 
sÜtBy
 = 
	`funùiÚ
 (
£lf
, 
f›ld
, 
dœeùiÚ
, 
sÜt_func
, ...)

2680 
	`I_AM_QUERY_SET
(
£lf
)

2681 -- 
	`checkTy³
(
f›ld
, 'string')

2683 
loÿl
 
dœeùiÚ
 = dœeùiÚ 
Ü
 'asc'

2685 
loÿl
 
byf›ld
 = 
f›ld


2686 
loÿl
 
sÜt_func
 = sÜt_funø
Ü
 
	`funùiÚ
 (
a
, 
b
)

2687 
loÿl
 
af
 = 
a
[
byf›ld
]

2688 
loÿl
 
bf
 = 
b
[
byf›ld
]

2689 
af
 
ªd
 
bf
 
th’


2690 
dœeùiÚ
 =ğ'asc' 
th’


2691  
af
 < 
bf


2692 
–£if
 
dœeùiÚ
 =ğ'desc' 
th’


2693  
af
 > 
bf


2695  
n


2696 
’d


2697 
’d


2698 
’d


2700 
bË
.
	`sÜt
(
£lf
, 
sÜt_func
)

2702 -- 
£cÚd¬y
 
sÜt


2703 
loÿl
 
f›ld2
, 
dœ2
, 
sÜt_func2
 = ...

2704 
f›ld2
 
th’


2705 
	`checkTy³
(
f›ld2
, 'string')

2707 -- 
divide
 
to
 
·¹s


2708 
loÿl
 
wÜk_t
 = {{
£lf
[1]}, }

2709 
i
 = 2, #self do

2710 
£lf
[
i
-1][
f›ld
] =ğ£lf[i][f›ld] 
th’


2711 -- 
š£¹
 
to
 
the
 
Ï¡
 
bË
 
–em’t
 
of
h
li¡


2712 
bË
.
	`š£¹
(
wÜk_t
[#wÜk_t], 
£lf
[
i
])

2714 
wÜk_t
[#wÜk_ˆ+ 1] = {
£lf
[
i
]}

2715 
’d


2716 
’d


2718 -- 
sÜt
 
—ch
 
·¹


2719 
loÿl
 
»suÉ
 = {}

2720 
byf›ld
 = 
f›ld2


2721 
dœeùiÚ
 = 
dœ2
 
Ü
 'asc'

2722 
sÜt_func
 = 
sÜt_func2
 
Ü
 sort_func

2723 
i
, 
v®
 
š
 
	`aœs
(
wÜk_t
) do

2724 
bË
.
	`sÜt
(
v®
, 
sÜt_func
)

2725 
bË
.
	`š£¹
(
»suÉ
, 
v®
)

2726 
’d


2728 -- 
æ©‹n
 
to
 
Úe
 
¿nk
 
bË


2729 
loÿl
 
æ©
 = 
	`Qu”yS‘
()

2730 
i
, 
v®
 
š
 
	`aœs
(
»suÉ
) do

2731 
j
, 
v
 
š
 
	`aœs
(
v®
) do

2732 
bË
.
	`š£¹
(
æ©
, 
v
)

2733 
’d


2734 
’d


2736 
£lf
 = 
æ©


2737 
’d


2739  
£lf


2740 
’d
;

2742 
addToCacheAndSÜtBy
 = 
	`funùiÚ
 (
£lf
, 
ÿche_key
, 
f›ld
, 
sÜt_func
)

2743 
	`I_AM_INSTANCE
(
£lf
)

2744 
	`checkTy³
(
ÿche_key
, 
f›ld
, 'string', 'string')

2746 --
	`DEBUG
(
ÿche_key
)

2747 --
	`DEBUG
('entering‡ddToCacheAndSortBy')

2748 
loÿl
 
ÿche_§ved_key
 = 
	`g‘CacheKey
(
£lf
, 
ÿche_key
)

2749 
nÙ
 
db
:
	`exi¡s
(
ÿche_§ved_key
è
th’


2750 
	`´št
('[WARNING] The cache is missing orƒxpired.')

2751  
n


2752 
’d


2754 
loÿl
 
ÿched_ids
 = 
db
:
	`z¿nge
(
ÿche_§ved_key
, 0, -1)

2755 
loÿl
 
h—d
 = 
db
:
	`hg‘
(
	`g‘NameIdP©‹º2
(
£lf
, 
ÿched_ids
[1]), 
f›ld
)

2756 
loÿl
 

 = 
db
:
	`hg‘
(
	`g‘NameIdP©‹º2
(
£lf
, 
ÿched_ids
[#ÿched_ids]), 
f›ld
)

2757 
	`as£¹
(
h—d
 
ªd
 

, "[Error] @addToCacheAndSortBy.he object„eferringo head orail of cache†ist may be deleted,…lease check.")

2758 --
	`DEBUG
(
h—d
, 

)

2759 
loÿl
 
Üd”_ty³
 = 'asc'

2760 
loÿl
 
f›ld_v®ue
, 
¡İ_id


2761 
loÿl
 
š£¹_pos™iÚ
 = 0

2763 
h—d
 > 

 
th’
 
Üd”_ty³
 = 'desc' 
’d


2764 -- 
should
 
®ways
 
k“p
 `
a
` 
ªd
 `
b
` 
have
 
the
 
§me
 
ty³


2765 
loÿl
 
sÜt_func
 = sÜt_funø
Ü
 
	`funùiÚ
 (
a
, 
b
)

2766 
Üd”_ty³
 =ğ'asc' 
th’


2767  
a
 > 
b


2768 
–£if
 
Üd”_ty³
 =ğ'desc' 
th’


2769  
a
 < 
b


2770 
’d


2771 
’d


2773 --
	`DEBUG
(
Üd”_ty³
)

2774 -- 
fšd
 
the
 
š£¹šg
 
pos™iÚ


2775 -- 
FIXME
: 
u£
 2-
·¹
 
£¬chšg
 
m‘hod
 
is
 
b‘‹r


2776 
i
, 
id
 
š
 
	`aœs
(
ÿched_ids
) do

2777 
f›ld_v®ue
 = 
db
:
	`hg‘
(
	`g‘NameIdP©‹º2
(
£lf
, 
id
), 
f›ld
)

2778 
	`sÜt_func
(
f›ld_v®ue
, 
£lf
[
f›ld
]è
th’


2779 
¡İ_id
 = 
db
:
	`hg‘
(
	`g‘NameIdP©‹º2
(
£lf
, 
id
), 'id')

2780 
š£¹_pos™iÚ
 = 
i


2782 
’d


2783 
’d


2784 --
	`DEBUG
(
š£¹_pos™iÚ
)

2786 
loÿl
 
Ãw_scÜe


2787 
š£¹_pos™iÚ
 =ğ0 
th’


2788 -- 
m—ns
 
tl
 
the
 
’d
, 
®l
 
–em’t
 
is
 
sm®Ër
 
thª
 
£lf
.
f›ld


2789 -- 
š£¹_pos™iÚ
 = #cached_ids

2790 -- 
the
 
Ï¡
 
–em’t
's score + 1

2791 
loÿl
 
’d_scÜe
 = 
db
:
	`z¿nge
(
ÿche_§ved_key
, -1, -1, 'withscores')[1][2]

2792 
Ãw_scÜe
 = 
’d_scÜe
 + 1

2794 
–£if
 
š£¹_pos™iÚ
 =ğ1 
th’


2795 -- 
g‘
 
the
 
h®f
 
of
h
fœ¡
 
–em’t


2796 
loÿl
 
¡İ_scÜe
 = 
db
:
	`zscÜe
(
ÿche_§ved_key
, 
¡İ_id
)

2797 
Ãw_scÜe
 = 
	`tÚumb”
(
¡İ_scÜe
) / 2

2798 
–£if
 
š£¹_pos™iÚ
 > 1 
th’


2799 -- 
g‘
 
the
 
middË
 
v®ue
 
of
h
Ëá
 
ªd
 
right
 
Ãighbours


2800 
loÿl
 
¡İ_scÜe
 = 
db
:
	`zscÜe
(
ÿche_§ved_key
, 
¡İ_id
)

2801 
loÿl
 
¡İ´ev_¿nk
 = 
db
:
	`z¿nk
(
ÿche_§ved_key
, 
¡İ_id
) - 1

2802 
loÿl
 
¡İ´ev_scÜe
 = 
db
:
	`z¿nge
(
ÿche_§ved_key
, 
¡İ´ev_¿nk
, stopprev_rank, 'withscores')[1][2]

2803 
Ãw_scÜe
 = 
	`tÚumb”
(
¡İ_scÜe
 + 
¡İ´ev_scÜe
) / 2

2805 
’d


2807 --
	`DEBUG
(
Ãw_scÜe
)

2808 -- 
add
 
Ãw
 
–em’t
 
to
 
ÿche


2809 
db
:
	`zadd
(
ÿche_§ved_key
, 
Ãw_scÜe
, 
£lf
.
id
)

2812  
£lf


2813 
’d
;

2817 -- 
DyÇmic
 
F›ld
 
API


2820 -- 
ÿÎed
 
by
 
mod–


2821 
addDyÇmicF›ld
 = 
	`funùiÚ
 (
£lf
, 
f›ld_Çme
, 
f›ld_dt
)

2822 
	`I_AM_CLASS
(
£lf
)

2823 
	`checkTy³
(
f›ld_Çme
, 
f›ld_dt
, 'string', 'table')

2826 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


2827 
nÙ
 
f›lds
 
th’
 
	`´št
('[W¬nšg] Thi mod– ha nØ__f›lds.');  
n
 
’d


2828 -- 
®»ady
 
exi¡
, 
ÿn
 
nÙ
 
ov”ride
 
™


2829 -- 
’su»
 
the
 
added
 
is
 
Ãw
 
f›ld


2830 
nÙ
 
f›lds
[
f›ld_Çme
] 
th’


2831 
f›lds
[
f›ld_Çme
] = 
f›ld_dt


2832 -- 
»cÜd
 
to
 
db


2833 
loÿl
 
key
 = 
	`g‘DyÇmicF›ldKey
(
£lf
, 
f›ld_Çme
)

2834 
k
, 
v
 
š
 
	`·œs
(
f›ld_dt
) do

2835 
db
:
	`h£t
(
key
, 
k
, 
	`£rŸlize
(
v
))

2836 
’d


2837 -- 
add
 
to
 
dyÇmic
 
f›ld
 
šdex
 
li¡


2838 
db
:
	`½ush
(
	`g‘DyÇmicF›ldIndex
(
£lf
), 
f›ld_Çme
)

2839 
’d


2841 
’d
;

2843 
hasDyÇmicF›ld
 = 
	`funùiÚ
 (
£lf
)

2844 
	`I_AM_CLASS
(
£lf
)

2845 
loÿl
 
dfšdex
 = 
	`g‘DyÇmicF›ldIndex
(
£lf
)

2846 
db
:
	`exi¡s
(
dfšdex
è
ªd
 db:
	`Î’
(dfšdexè> 0 
th’


2847  
Œue


2849  
çl£


2850 
’d


2851 
’d
;

2853 
d–DyÇmicF›ld
 = 
	`funùiÚ
 (
£lf
, 
f›ld_Çme
)

2854 
	`I_AM_CLASS
(
£lf
)

2855 
	`checkTy³
(
f›ld_Çme
, 'string')

2856 
loÿl
 
dfšdex
 = 
	`g‘DyÇmicF›ldIndex
(
£lf
)

2857 
loÿl
 
df›ld
 = 
	`g‘DyÇmicF›ldKey
(
£lf
, 
f›ld_Çme
)

2858 -- 
g‘
 
f›ld
 
desütiÚ
 
bË


2859 
db
:
	`d–
(
df›ld
)

2860 
db
:
	`Ìem
(
dfšdex
, 0, 
f›ld_Çme
)

2861 
£lf
.
__f›lds
[
f›ld_Çme
] = 
n


2863  
£lf


2864 
’d
;

2866 
impÜtDyÇmicF›lds
 = 
	`funùiÚ
 (
£lf
)

2867 
	`I_AM_CLASS
(
£lf
)

2868 
loÿl
 
dfšdex
 = 
	`g‘DyÇmicF›ldIndex
(
£lf
)

2869 
loÿl
 
df›lds_li¡
 = 
db
:
	`Ìªge
(
dfšdex
, 0, -1)

2871 
_
, 
f›ld_Çme
 
š
 
	`aœs
(
df›lds_li¡
) do

2872 
loÿl
 
df›ld
 = 
	`g‘DyÇmicF›ldKey
(
£lf
, 
f›ld_Çme
)

2873 -- 
g‘
 
f›ld
 
desütiÚ
 
bË


2874 
loÿl
 
d©a
 = 
db
:
	`hg‘®l
(
df›ld
)

2875 -- 
add
 
Ãw
 
f›ld
 
to
 
__f›lds


2876 
£lf
.
__f›lds
[
f›ld_Çme
] = 
d©a


2877 
’d


2879  
£lf


2880 
’d
;

2882 
qu”yS‘Ids
 = 
	`funùiÚ
 (
£lf
)

2883 
	`I_AM_QUERY_SET
(
£lf
)

2884 
loÿl
 
ids
 = 
	`Li¡
()

2885 
_
, 
v
 
š
 
	`aœs
(
£lf
) do

2886 
ids
:
	`­³nd
(
v
.
id
)

2887 
’d


2888  
ids


2889 
’d
;

2891 -- 
fuÎ‹xt
 
šdex
 
API


2892 
fuÎ‹xtS—rch
 = 
	`funùiÚ
 (
£lf
, 
ask_¡r
, 
n
)

2893 
	`I_AM_CLASS
(
£lf
)

2894 
loÿl
 
gs
 = 
	`wÜdSegm’tOnFtIndex
(
£lf
, 
ask_¡r
)

2895  
	`£¬chOnFuÎ‹xtIndexes
(
£lf
, 
gs
, 
n
)

2896 
’d
;

2898 -- 
fuÎ‹xt
 
šdex
 
API


2899 
fuÎ‹xtS—rchByWÜd
 = 
	`funùiÚ
 (
£lf
, 
wÜd
, 
n
)

2900 
	`I_AM_CLASS
(
£lf
)

2901  
	`£¬chOnFuÎ‹xtIndexes
(
£lf
, {
wÜd
}, 
n
)

2902 
’d
;

2904 
g‘FDT
 = 
	`funùiÚ
 (
£lf
, 
f›ld
)

2905 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

2906 
	`checkTy³
(
f›ld
, 'string')

2908  
£lf
.
__f›lds
[
f›ld
]

2910 
’d
;

2912 
	}
}

2914 
loÿl
 
	gQu”yS‘M‘a
 = 
£tPrÙo
({
__¥eùy³
='Qu”yS‘'}, 
Mod–
)

2915 
	gQu”yS‘
 = 
	$funùiÚ
 (
li¡
)

2916 
loÿl
 
li¡
 =†i¡ 
Ü
 
	`Li¡
()

2917 -- 
ü—‹
 
a
 
qu”y
 
£t


2918 -- 
add
 
™
 
to
 
f™
 
the
 
check
 
of
 
isCÏss
 
funùiÚ


2919 -- 
nÙ
 
	$g‘m‘©abË
(
Qu”yS‘M‘a
è
th’


2920 -- 
Qu”yS‘M‘a
 = 
	`£tPrÙo
(Qu”yS‘M‘a, 
Mod–
)

2921 -- 
’d


2922 
loÿl
 
qu”y_£t
 = 
	$£tPrÙo
(
li¡
, 
Qu”yS‘M‘a
)

2924  
qu”y_£t


2925 
’d


2926 
_G
['Qu”yS‘'] = 
Qu”yS‘


2928  
Mod–


	@src/models/group.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

2 
loÿl
 
sock‘
 = 
»quœe
 'socket'

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
Group


6 
Group
 = 
Mod–
:
ex‹nd
 {

7 
__g
 = 'Object.Model.Group';

8 
__Çme
 = 'Group';

9 
__desc
 = 'Group ishe basicree†ike model';

10 
__šdexfd
 = "name";

11 
__f›lds
 = {

16 ['³rms'] = { 
fÜeign
="P”missiÚ", 
¡
="MANY" },

17 ['owÃr'] = { 
fÜeign
="U£r", 
¡
="ONE" },

18 ['mªag”s'] = { 
fÜeign
="U£r", 
¡
="MANY" },

21 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

22 
nÙ
 
t
 
th’
  
£lf
 
’d


24 
£lf
.
Çme
 = 
t
.name

25 
£lf
.
desc
 = self.desc

26 
£lf
.
ü—‹d_d©e
 = 
sock‘
.
	`g‘time
()

29  
£lf


30 
’d
;

32 
	}
}

34  
	gGroup


	@src/models/image.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U¶ßd
 = 
»quœe
 'bamboo.models.upload'

4 
loÿl
 
SessiÚ
 = 
»quœe
 'bamboo.session'

6 
loÿl
 
Image
 = 
U¶ßd
:
ex‹nd
 {

7 
__g
 = 'Object.Model.Upload.Image';

8 
__Çme
 = 'Image';

9 
__desc
 = 'Generitic Image definition';

10 
__šdexfd
 = 'path';

11 
__f›lds
 = {

16 ['·th'] = {
widg‘_ty³
="image"},

23 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

24 
nÙ
 
t
 
th’
  
£lf
 
’d


26 
£lf
.
width
 = 
t
.width

27 
£lf
.
height
 = 
t
.height

29  
£lf


30 
’d
;

32 
	}
}

34  
	gImage


	@src/models/menu.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
h‰p
 = 
»quœe
 'lglib.http'

4 
loÿl
 
Node
 = 
»quœe
 'bamboo.models.node'

6 
loÿl
 
±r
 = 0

8 
funùiÚ
 
	$makeM’uRecur
 (
gm’us
, 
m’ubË
, 
¿nk
, 
·»Á
)

10 
i
, 
v
 
š
 
	$aœs
(
m’ubË
) do

11 
±r
 =…tr + 1

13 
loÿl
 
™em
 = { 
Çme
 = 
v
.Çme, 
t™Ë
 = v.t™Ë, 
cÚ‹Á
 = v.cÚ‹Á, 
·»Á
 =…¬’t, 
¿nk
 =„ªk 
	}
}

14 
	gbË
.
	$š£¹
(
gm’us
, 
™em
)

15 
·»Á
 ~ğ0 
th’


16 
nÙ
 
gm’us
[
·»Á
]['chd»n'] 
th’
 gm’us[·»Á]['chd»n'] = {
	}
} 
’d


17 
bË
.
š£¹
(
gm’us
[
·»Á
]['chd»n'], 
±r
)

18 
’d


20 
	gv
.
subm’us
 
th’


21 
makeM’uRecur
 (
gm’us
, 
v
.
subm’us
, 
¿nk
 + 1, 
±r
)

22 
’d


23 
’d


25  
gm’us


26 
’d


28 
loÿl
 
M’u


29 
	gM’u
 = 
Node
:
ex‹nd
 {

30 
__g
 = 'Object.Model.Node.Menu';

31 
	g__Çme
 = 'Menu';

32 
	g__desc
 = 'Menu';

33 
	g__f›lds
 = {

37 ['´om±'] = { 
Ãwf›ld
=
Œue
 },

51 
	gš™
 = 
funùiÚ
 (
£lf
, 
t
)

52 
nÙ
 
t
 
th’
  
£lf
 
’d


54 
	g£lf
.
	gÇme
 = 
t
.
Çme
 
Ü
 
£lf
.name

55 
£lf
.
¿nk
 = 
t
.rank

57 
t
.
chd»n
 
th’


58 
£lf
.
chd»n
 = 
bË
.
cÚÿt
(
t
.children, ' ')

59 
’d


61  
£lf


62 
	g’d
;

64 
	gmakeM’u
 = 
funùiÚ
 (
£lf
, 
m’ubË
)

65 
loÿl
 
	ggm’us
 = {}

66 
±r
 = 0

67 
gm’us
 = 
makeM’uRecur
 (gm’us, 
m’ubË
, 1, 0)

68 
	g£lf
:
ş—rAÎ
 ()

69 
loÿl
 
m’uobjs
 = {}

70 
i
, 
v
 
š
 
aœs
(
gm’us
) do

71 
loÿl
 
	gobj™em
 = 
£lf
(
v
)

72 
nÙ
 
isF®£
(
obj™em
è
th’


73 
bË
.
š£¹
(
m’uobjs
, 
obj™em
)

74 
’d


75 
	gobj™em
:
§ve
()

76 
’d


78  
m’uobjs


79 
’d
;

81 
	gg’”©eM’uV›w
 = 
funùiÚ
 (
m’uobjs
)

82 
loÿl
 
m’u_htmls
 = '<ul class="menu">'

84 #m’uobj > 0 
th’


85 
m’u_htmls
 = m’u_html + ([[<
li
><
a
 
h»f
="%s">%
s
</a>]]):
fÜm©
(
m’uobjs
[1].
cÚ‹Á
, m’uobjs[1].
t™Ë
)

86 
’d


87 
	gi
 = 2

88 
i
 <= #menuobjs do

89 
m’uobjs
[
i
].
¿nk
 =ğm’uobjs[i-1].¿nk 
th’


90 
m’u_htmls
 = m’u_html + ([[</
li
><li><
a
 
h»f
="%s">%
s
</a>]]):
fÜm©
(
m’uobjs
[
i
].
cÚ‹Á
, m’uobjs[i].
t™Ë
)

91 
–£if
 
	gm’uobjs
[
i
].
	g¿nk
 > m’uobjs[i-1].
¿nk
 
th’


92 
	gm’u_htmls
 = 
m’u_htmls
 + ([[<
ul
><
li
><
a
 
h»f
="%s">%
s
</a>]]):
fÜm©
(
m’uobjs
[
i
].
cÚ‹Á
, m’uobjs[i].
t™Ë
)

93 
–£if
 
	gm’uobjs
[
i
].
	g¿nk
 < m’uobjs[i-1].
¿nk
 
th’


94 
	gm’u_htmls
 = 
m’u_htmls
 + '</li>'

95 
d–
 = 
m’uobjs
[
i
-1].
¿nk
 - menuobjs[i].rank

96 
n
 = 1, 
d–
 do

97 
	gm’u_htmls
 = 
m’u_htmls
 + '</ul></li>'

98 
’d


99 
m’u_htmls
 = m’u_html + ([[<
li
><
a
 
h»f
="%s">%
s
</a>]]):
fÜm©
(
m’uobjs
[
i
].
cÚ‹Á
, m’uobjs[i].
t™Ë
)

101 
’d


103 
	gi
 = 
i
 + 1

104 
’d


106 
m’u_htmls
 
th’
 m’u_html ğm’u_html + '</li>' 
’d


107 
m’u_htmls
 = menu_htmls + '</ul>'

109  
m’u_htmls


110 
’d
;

115  
	gM’u


	@src/models/message.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

4 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

6 
loÿl
 
Mes§ge
 = 
Mod–
:
ex‹nd
 {

7 
__g
 = 'Object.Model.Message';

8 
__Çme
 = 'Message';

9 
__desc
 = 'General message definition.';

10 
__f›lds
 = {

11 ['äom'] = { 
fÜeign
='U£r', 
»quœed
=
Œue
 },

12 ['to'] = { 
fÜeign
='User' },

13 ['subjeù'] = { 
fÜeign
='UNFIXED', 
¡
='ONE' },

22 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

23 
nÙ
 
t
 
th’
  
£lf
 
’d


25 
£lf
.
ty³
 = 
t
.type

26 -- 
£lf
.
uuid
 = 
t
.uuid

27 
£lf
.
authÜ
 = 
t
.author

28 
£lf
.
cÚ‹Á
 = 
t
.content

29 
£lf
.
time¡amp
 = 
t
.time¡am°
Ü
 
os
.
	`time
()

31  
£lf


32 
’d
;

34 
	}
}

36  
	gMes§ge


	@src/models/node.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
g‘Mod–ByName
 = 
bamboo
.getModelByName

7 
loÿl
 
Node


8 
Node
 = 
Mod–
:
ex‹nd
 {

9 
__g
 = 'Object.Model.Node';

10 
__Çme
 = 'Node';

11 
__desc
 = 'Node ishe basicree†ike model';

12 
__f›lds
 = {

13 ['Çme'] = { 
Ãwf›ld
=
Œue
},

14 ['¿nk'] = { 
Ãwf›ld
=
Œue
},

15 ['t™Ë'] = { 
»quœed
=
Œue
, 
Ãwf›ld
=true},

16 ['cÚ‹Á'] = { 
»quœed
=
Œue
, 
Ãwf›ld
=true},

17 ['¡©us'] = { 
Ãwf›ld
=
Œue
},

19 ['is_ÿ‹gÜy'] = { 
Ãwf›ld
=
Œue
},

20 ['·»Á'] = { 
¡
='ONE', 
fÜeign
='Node', 
Ãwf›ld
=
Œue
, 
Üd”
=1.1},

21 ['chd»n'] = { 
¡
='MANY', 
fÜeign
='Node', 
Ãwf›ld
=
Œue
},

22 ['groups'] = { 
¡
='MANY', 
fÜeign
='Node', 
Ãwf›ld
=
Œue
},

24 ['comm’ts'] = { 
¡
='MANY', 
fÜeign
='Mes§ge', 
Ãwf›ld
=
Œue
},

25 ['©chm’ts'] = { 
¡
='MANY', 
fÜeign
='U¶ßd', 
Ãwf›ld
=
Œue
},

27 ['ü—‹d_d©e'] = { 
Ãwf›ld
=
Œue
},

28 ['Ï¡modif›d_d©e'] = { 
Ãwf›ld
=
Œue
},

29 ['ü—tÜ'] = { 
¡
='ONE', 
fÜeign
='U£r', 
Ãwf›ld
=
Œue
},

30 ['owÃr'] = { 
¡
='ONE', 
fÜeign
='U£r', 
Ãwf›ld
=
Œue
},

31 ['Ï¡modif›r'] = { 
¡
='ONE', 
fÜeign
='U£r', 
Ãwf›ld
=
Œue
},

34 
__ÿÎbacks
 = {

36 
ÚUpd©e
 = 
	`funùiÚ
 (
¬gs
)

38 
’d
,

40 
ÚD–‘e
 = 
	`funùiÚ
 (
¬gs
)

42 
’d
,

44 
ÚG‘
 = 
	`funùiÚ
 (
¬gs
)

46 
’d
,

48 
ÚAddFÜeign
 = 
	`funùiÚ
 (
¬gs
)

50 
’d
,

51 
ÚAddedAsFÜeign
 = 
	`funùiÚ
 (
¬gs
)

53 
’d
,

55 
ÚD–‘eFÜeign
 = 
	`funùiÚ
 (
¬gs
)

57 
’d
,

58 
ÚD–‘edAsFÜeign
 = 
	`funùiÚ
 (
¬gs
)

60 
’d
,

62 
ÚSave
 = 
	`funùiÚ
 (
¬gs
)

64 
’d
,

68 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

69 
nÙ
 
t
 
th’
  
£lf
 
’d


71 
£lf
.
Çme
 = 
t
.Çm
Ü
 self.name

72 
£lf
.
¿nk
 = 
t
.rank

73 
£lf
.
t™Ë
 = 
t
.title

74 
£lf
.
cÚ‹Á
 = 
t
.content

76 
£lf
.
is_ÿ‹gÜy
 = 
t
.is_category

77 
£lf
.
·»Á
 = 
t
.parent

78 
£lf
.
chd»n
 = 
t
.children

79 
£lf
.
groups
 = 
t
.groups

81 
£lf
.
comm’ts
 = 
t
.comments

82 
£lf
.
©chm’ts
 = 
t
.attachments

84 
£lf
.
ü—‹d_d©e
 = 
os
.
	`time
()

85 
£lf
.
Ï¡modif›d_d©e
 = s–f.
ü—‹d_d©e


87  
£lf


88 
’d
;

91 
g‘Comm’ts
 = 
	`funùiÚ
 (
£lf
)

92  
£lf
:
	`g‘FÜeign
 ('comments')

93 
’d
;

95 
g‘P¬tŸlComm’ts
 = 
	`funùiÚ
 (
£lf
, 
¡¬t
, 
¡İ
)

96  
£lf
:
	`g‘FÜeign
 ('comm’ts', 
¡¬t
, 
¡İ
)

97 
’d
;

100 
g‘A‰achm’ts
 = 
	`funùiÚ
 (
£lf
)

101  
£lf
:
	`g‘FÜeign
 ('attachments')

102 
’d
;

105 
g‘Chd»n
 = 
	`funùiÚ
 (
£lf
)

106 
	`isF®£
(
£lf
.
chd»n
è
th’
  {} 
’d


107  
£lf
:
	`g‘FÜeign
 ('children')

108 
’d
;

111 
g‘P¬’t
 = 
	`funùiÚ
 (
£lf
)

112 
£lf
.
·»Á
 =ğ'' 
th’
  
n
 
’d


113  
£lf
:
	`g‘FÜeign
('parent')

114 
’d
;

116 
	}
}

118  
	gNode


	@src/models/permission.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
P”missiÚ


6 
P”missiÚ
 = 
Mod–
:
ex‹nd
 {

7 
__g
 = 'Object.Model.Permission';

8 
__Çme
 = 'Permission';

9 
__desc
 = 'Permission ishe basicree†ike model';

10 
__šdexfd
 = 'name';

11 
__f›lds
 = {

12 ['Çme'] = {
Ãwf›ld
=
Œue
},

13 ['desc'] = {
Ãwf›ld
=
Œue
},

16 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

17 
nÙ
 
t
 
th’
  
£lf
 
’d


19 
£lf
.
Çme
 = 
t
.name

20 
£lf
.
desc
 = 
t
.desc

22  
£lf


23 
’d
;

25 
add
 = 
	`funùiÚ
 (
£lf
, 
Çme
, 
desc
)

26 
	`I_AM_CLASS
(
£lf
)

27 
	`checkTy³
(
Çme
, 'string')

28 
loÿl
 
desc
 = desø
Ü
 ''

30 
loÿl
 
³rm
 = 
P”missiÚ
:
	`g‘ByIndex
(
Çme
)

31 
nÙ
 
³rm
 
th’


32 
loÿl
 
Ãw_³rm
 = 
P”missiÚ
 {

33 
Çme
 =‚ame,

34 
desc
 = desc

36 
Ãw_³rm
:
	`§ve
()

37 
–£if
 
³rm
.
desc
 ~ğdesø
th’


38 
³rm
:
	`upd©e
('desc', 
desc
)

39 
’d


41 
’d
;

44 
	}
}

46  
	gP”missiÚ


	@src/models/upload.lua

1 --- 
A
 
basic
 
low”
 
u¶ßd
 
	gAPI


3 
	$moduË
(..., 
·ckage
.
£—Î
)

5 
»quœe
 'posix'

6 
loÿl
 
h‰p
 = 
»quœe
 'lglib.http'

7 
loÿl
 
nÜm®izeP©h
 = 
	`»quœe
('lglib.·th').
nÜm®ize


9 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

10 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

12 
loÿl
 
funùiÚ
 
	`ÿlcNewF’ame
(
dœ
, 
ŞdÇme
)

13 -- 
£·¿‹
 
the
 
ba£
 
Çme
 
ªd
 
ex‹n£
‚am
of
 
a
 
f’ame


14 
loÿl
 
maš
, 
ext
 = 
ŞdÇme
:
	`m©ch
('^(.+)(%.%w+)$')

15 
nÙ
 
ext
 
th’


16 
maš
 = 
ŞdÇme


17 
ext
 = ''

18 
’d


19 -- 
check
 
exi¡s
 
the
 
§me
 
Çme
 
fe


20 
loÿl
 
t¡r
 = ''

21 
loÿl
 
i
 = 0

22 
posix
.
	`¡©
Ğ
dœ
 + 
maš
 + 
t¡r
 + 
ext
 ) do

23 
i
 = i + 1

24 
t¡r
 = '_' + 
	$to¡ršg
(
i
)

25 
’d


26 -- 
cÚÿt
 
to
 
Ãw
 
f’ame


27 
loÿl
 
Ãwba£Çme
 = 
maš
 + 
t¡r


29  
Ãwba£Çme
, 
ext


30 
’d


32 --- 
h”e
, 
we
 
‹m´Üy
 
Úly
 
cÚsid”
 
the
 
fe
 
d©a
 
is
 
·s£d
 
whŞly
 
by
 
z”omq


33 -- 
ªd
 
§ve
 
by
 
bamboo


34 -- @
f›ld
 
t
.
»q


35 -- @
f›ld
 
t
.
fe_obj


36 -- @
f›ld
 
t
.
de¡_dœ


37 -- @
f›ld
 
t
.
´efix


38 -- @
f›ld
 
t
.
po¡fix


40 
loÿl
 
funùiÚ
 
	$§vefe
(
t
)

41 
loÿl
 
»q
, 
fe_obj
 = 
t
.req,.file_obj

43 
loÿl
 
de¡_dœ
 = 
t
.de¡_dœ 
	`ªd
 ('medŸ/u¶ßds/' +.de¡_dœ + '/'è
Ü
 'media/uploads/'

44 
de¡_dœ
 = 
	$nÜm®izeP©h
(
de¡_dœ
)

46 
loÿl
 
´efix
 = 
t
.´efix 
Ü
 ''

47 
loÿl
 
po¡fix
 = 
t
.po¡fix 
Ü
 ''

48 
loÿl
 
f’ame
 = ''

49 
loÿl
 
body
 = ''

50 
loÿl
 
»Çme_func
 = 
t
.»Çme_funø
Ü
 
n


52 -- 
u¶ßd
 
š
 
html5
 
way


53 
»q
.
h—d”s
['x-»que¡ed-w™h'] 
th’


54 -- 
wh’
 
html5
 
u¶ßd
, 
we
 
thšk
 
of
 
the
 
Çme
 oà
th©
 
fe
 
was
 
¡Üed
 
š
 
h—d”
 
x
-file-name

55 -- 
this
 
šfo
 
missšg
, 
we
 
may
 
cÚsid”
 
the
 
f’ame
 
was
 
put
 
š
h
qu”y
 
¡ršg


56 
f’ame
 = 
»q
.
h—d”s
['x-fe-Çme'] 
Ü
 
FÜm
:
	`·r£Qu”y
(req)['filename']

57 -- 
TODO
:

58 -- 
»q
.
body
 
cÚšs
 
®l
 
fe
 
bš¬y
 
d©a


59 
body
 = 
»q
.body

61 
	`checkTy³
(
fe_obj
, 'table')

62 -- 
NÙiû
: 
the
 
f’ame
 
š
h
fÜm
 
¡ršg
 
¬e
 
quÙed
 
by
 ""

63 -- 
this
 
·‰”n
 
ruË
 
ÿn
 
d—l
 
w™h
 
the
 
wšdows
 
¡yË
 
dœeùÜy
 
d–im™”


64 -- 
fe_obj
['cÚ‹Á-di¥os™iÚ'] 
cÚšs
 
mªy
 
fe
 
assocŸ‹d
 
šfo


65 
f’ame
 = 
fe_obj
['cÚ‹Á-di¥os™iÚ'].f’ame:
	`sub
(2, -2):
	`m©ch
('\\?([^\\]-%.%w+)$')

67 
body
 = 
fe_obj
.body

68 
’d


69 
	$isF®£
(
f’ame
è
Ü
 
	$isF®£
(
body
è
th’
  
n
,‚ 
’d


70 
nÙ
 
»q
.
ajax
 
th’


71 
f’ame
 = 
h‰p
.
	$’codeURL
(
f’ame
)

72 
’d


74 
nÙ
 
posix
.
	$¡©
(
de¡_dœ
è
th’


75 -- 
why
 
posix
 
have
 
no
 
commªd
 
like
 " mkdir -p "

76 
os
.
	`execu‹
('mkdœ -°' + 
de¡_dœ
)

77 
’d


79 -- 
·s£d
 
š
 
a
 
»Çme
 
funùiÚ
, 
u£
 
™
 
to
 
»¶aû
 
the
 
ÜignŸl
 
f’ame


80 
»Çme_func
 
ªd
 
	`ty³
Ô’ame_funcè=ğ'funùiÚ' 
th’


81 
f’ame
 = 
	$»Çme_func
(
f’ame
)

82 
’d


84 
loÿl
 
Ãwba£Çme
, 
ext
 = 
	$ÿlcNewF’ame
(
de¡_dœ
, 
f’ame
)

85 
loÿl
 
ÃwÇme
 = 
´efix
 + 
Ãwba£Çme
 + 
po¡fix
 + 
ext


87 
loÿl
 
·th
 = 
de¡_dœ
 + 
ÃwÇme


89 -- 
wr™e
 
fe
 
to
 
disk


90 
loÿl
 
fd
 = 
io
.
	`İ’
(
·th
, "wb")

91 
fd
:
	$wr™e
(
body
)

92 
fd
:
	$şo£
()

94  
ÃwÇme
, 
·th


95 
’d


99 
loÿl
 
U¶ßd
 = 
Mod–
:
ex‹nd
 {

100 
__g
 = 'Object.Model.Upload';

101 
__Çme
 = 'Upload';

102 
__desc
 = "User's upload files.";

103 
__šdexfd
 = "path";

104 
__f›lds
 = {

106 ['·th'] = {
unique
=
Œue
},

112 
__decÜ©Üs
 = {

113 
d–
 = 
	`funùiÚ
 (
od–
)

114  
	`funùiÚ
 (
£lf
, ...)

115 
	`I_AM_INSTANCE_OR_QUERY_SET
(
£lf
)

116 -- 
£lf
 
is
 
qu”y
 
£t


117 
	`isQu”yS‘
(
£lf
è
th’


118 
_
, 
v
 
š
 
	`aœs
(
£lf
) do

119 -- 
»move
 
fe
 
äom
 
disk


120 
os
.
	`execu‹
('rm ' + 
v
.
·th
)

121 
’d


123 -- 
»move
 
fe
 
äom
 
disk


124 
os
.
	`execu‹
('rm ' + 
£lf
.
·th
)

125 
’d


127  
	`od–
(
£lf
, ...)

128 
’d


129 
’d


133 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

134 
nÙ
 
t
 
th’
  
£lf
 
’d


136 
£lf
.
Çme
 = 
t
.name

137 
£lf
.
·th
 = 
t
.·th 
Ü
 'media/uploads/default'

138 
£lf
.
size
 = 
posix
.
	`¡©
(£lf.
·th
).size

139 
£lf
.
time¡amp
 = 
os
.
	`time
()

140 -- 
accÜdšg
 
the
 
cu¼’t
 
design
, 
desc
 
f›ld
 
is
 
n


141 
£lf
.
desc
 = 
t
.desø
Ü
 ''

143  
£lf


144 
’d
;

146 --- 
FÜ
 
Œad™iÚ®
 
Html4
 
fÜm
 
u¶ßd


148 
b©ch
 = 
	`funùiÚ
 (
£lf
, 
»q
, 
·¿ms
, 
de¡_dœ
, 
´efix
, 
po¡fix
, 
»Çme_func
)

149 
	`I_AM_CLASS
(
£lf
)

150 
loÿl
 
fe_objs
 = 
	`Li¡
()

151 -- 
fe
 
d©a
 
¬e
 
¡Üed
 
as
 
¬¿›s
 
š
 
·¿ms


152 
i
, 
v
 
š
 
	`aœs
(
·¿ms
) do

153 
loÿl
 
Çme
, 
·th
 = 
§vefe
 { 
»q
 =„eq, 
fe_obj
 = 
v
, 
de¡_dœ
 = de¡_dœ, 
´efix
 =…»fix, 
po¡fix
 =…o¡fix, 
»Çme_func
 =„ename_func }

154 
nÙ
 
·th
 
Ü
‚Ù 
Çme
 
th’
  
n
 
’d


155 -- 
ü—‹
 
fe
 
š¡ªû


156 
loÿl
 
fe_š¡ªû
 = 
£lf
 { 
Çme
 =‚ame, 
·th
 =…ath }

157 
fe_š¡ªû
 
th’


158 -- 
¡Üe
 
to
 
db


159 -- 
fe_š¡ªû
:
	`§ve
()

160 -- 
fix
 
the
 
id
 
£qu’û


161 -- 
fe_š¡ªû
.
id
 = fe_š¡ªû.id + 
i
 - 1

162 
fe_objs
:
	`­³nd
(
fe_š¡ªû
)

163 
’d


164 
’d


166 -- 
a
 
fe
 
objeù
 
li¡


167  
fe_objs


168 
’d
;

170 
´oûss
 = 
	`funùiÚ
 (
£lf
, 
web
, 
»q
, 
de¡_dœ
, 
´efix
, 
po¡fix
, 
»Çme_func
)

171 
	`I_AM_CLASS
(
£lf
)

172 
	`as£¹
(
web
, '[Error] Upload input…arameter: "web" must be‚ot‚il.')

173 
	`as£¹
(
»q
, '[Error] Upload input…arameter: "req" must be‚ot‚il.')

174 -- 
cu¼’t
 
scheme
: 
tho£
 
Ïrg”
 
thª
 
PRESIZE
, 
£nd
 
a
 
ABORT
 
sigÇl
, 
ªd
 
abÜt
 
immedŸ‹ly


175 
»q
.
h—d”s
['x-mÚg»l2-u¶ßd-¡¬t'] 
th’


176 
	`´št
('return blanko‡bort upload.')

177 
web
.
cÚn
:
	`»¶y
(
»q
, '')

178  
n
, 'Uploading file isoo†arge.'

179 
’d


181 -- 
u¶ßd
 
š
 
html5
 
way


182 
»q
.
h—d”s
['x-»que¡ed-w™h'] 
th’


183 -- 
¡Üed
 
to
 
disk


184 
loÿl
 
Çme
, 
·th
 = 
§vefe
 { 
»q
 =„eq, 
de¡_dœ
 = de¡_dœ, 
´efix
 =…»fix, 
po¡fix
 =…o¡fix, 
»Çme_func
 =„ename_func }

185 
nÙ
 
·th
 
Ü
‚Ù 
Çme
 
th’
  
n
, '[E¼Ü]ƒm±y fe.' 
’d


187 
loÿl
 
fe_š¡ªû
 = 
£lf
 { 
Çme
 =‚ame, 
·th
 =…ath }

188 
fe_š¡ªû
 
th’


189 -- 
fe_š¡ªû
:
	`§ve
()

190  
fe_š¡ªû
, 'single'

191 
’d


193 -- 
u¶ßdšg
 
š
 
html4
 
way


194 -- 
h”e
, 
š
 
fÜm®
 
html4
 
fÜm
, 
»q
.
POST
 
®ways
 
has
 
v®ue
 in,

195 
loÿl
 
·¿ms
 = 
»q
.
POST
 -- 
Ü
 
FÜm
:
	`·r£
(req)

196 
	`as£¹
(#params > 0, '[Error] No valid file data contained.')

197 
loÿl
 
fes
 = 
£lf
:
	`b©ch
 ( 
»q
, 
·¿ms
, 
de¡_dœ
, 
´efix
, 
po¡fix
, 
»Çme_func
 )

198 
fes
:
	`isEm±y
(è
th’
  
n
, '[E¼Ü]ƒm±y fe.' 
’d


200 #fe =ğ1 
th’


201 -- 
ev’
 
Úly
 
Úe
 
fe
 
u¶ßd
, 
b©ch
 
funùiÚ
 
wl
  
a
 
li¡


202  
fes
[1], 'single'

204  
fes
, 'multiple'

205 
’d


206 
’d


207 
’d
;

209 
ÿlcNewF’ame
 = 
	`funùiÚ
 (
£lf
, 
de¡_dœ
, 
ŞdÇme
)

210  
	`ÿlcNewF’ame
(
de¡_dœ
, 
ŞdÇme
)

211 
’d
;

213 -- 
this
 
funùiÚ
, 
’cÜage
 
ov”ride
 
by
 
chd
 
mod–
, 
to
 
execu‹
 
theœ
 
own
 
d–‘e
 
aùiÚ


214 -- 
¥ecD–‘e
 = 
	`funùiÚ
 (
£lf
)

215 -- 
	`I_AM_INSTANCE
(
£lf
)

216 -- -- 
»move
 
fe
 
äom
 
disk


217 -- 
os
.
	`execu‹
('rm ' + 
£lf
.
·th
)

218 --  
£lf


219 -- 
’d
;

221 
	}
}

223  
	gU¶ßd


	@src/models/user.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

4 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
SessiÚ
 = 
»quœe
 'bamboo.session'

6 
loÿl
 
md5
 = 
»quœe
 'md5'

7 
loÿl
 
sock‘
 = 
»quœe
 'socket'

8 
loÿl
 
P”m
 = 
»quœe
 'bamboo.models.permission'

10 
loÿl
 
U£r
 = 
Mod–
:
ex‹nd
 {

11 
__g
 = 'Object.Model.User';

12 
__Çme
 = 'User';

13 
__desc
 = 'Basic user definition.';

14 
__šdexfd
 = "username";

15 
__f›lds
 = {

16 ['u£ºame'] = { 
»quœed
=
Œue
, 
unique
=true },

17 ['·sswÜd'] = { 
»quœed
=
Œue
 },

19 ['ema'] = { 
»quœed
=
Œue
 },

21 ['ü—‹d_d©e'] = {
ty³
="number"},

23 ['³rms'] = { 
fÜeign
="P”missiÚ", 
¡
="MANY" },

24 ['groups'] = { 
fÜeign
="Group", 
¡
="MANY" },

28 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

29 
nÙ
 
t
 
th’
  
£lf
 
’d


31 
£lf
.
u£ºame
 = 
t
.username

32 
£lf
.
ema
 = 
t
.email

33 
£lf
.
nickÇme
 = 
t
.nickname

34 
£lf
.
ü—‹d_d©e
 = 
sock‘
.
	`g‘time
()

36 
m©h
.
	`¿ndom£ed
(
os
.
	`time
())

37 
£lf
.
§É
 = 
	`to¡ršg
(
m©h
.
	`¿ndom
(1, 1000000))

39 
£lf
.
’üy±
 
ªd
 
	`ty³
(£lf.’üy±è=ğ'funùiÚ' 
th’


40 
£lf
.
·sswÜd
 = s–f:
	`’üy±
(
t
.password)

41 
’d


43  
£lf


44 
’d
;

46 
’üy±
 = 
	`funùiÚ
(
£lf
, 
·sswÜd
)

47  
md5
.
	`sumhexa
(
·sswÜd
 .. (
£lf
.
§É
 
Ü
 '')):
	`low”
()

48 
’d
;

50 
auth’tiÿ‹
 = 
	`funùiÚ
 (
£lf
, 
·¿ms
)

51 
	`I_AM_CLASS
(
£lf
)

53 
loÿl
 
u£r
 = 
£lf
:
	`g‘ByIndex
(
·¿ms
.
u£ºame
)

54 
nÙ
 
u£r
 
th’
  
çl£
 
’d


56 
£lf
.
’üy±
 
ªd
 
	`ty³
(£lf.’üy±è=ğ'funùiÚ' 
th’


57 
u£r
:
	`’üy±
(
·¿ms
.
·sswÜd
è~ğu£r.·sswÜd 
th’


58  
çl£


59 
’d


61 ià(
·¿ms
.
·sswÜd
):
	`low”
(è~ğ
u£r
.·sswÜd 
th’


62  
çl£


63 
’d


64 
’d


65  
Œue
, 
u£r


66 
’d
;

68 
logš
 = 
	`funùiÚ
 (
£lf
, 
·¿ms
)

69 
	`I_AM_CLASS_OR_INSTANCE
(
£lf
)

70 -- 
make
 
š¡ªû
 
ÿn
 
u£
 
this
 
logš


71 
	`isIn¡ªû
(
£lf
è
th’
 
·¿ms
 = s–à
’d


72 
nÙ
 
·¿ms
['u£ºame'] 
Ü
‚Ù…¬ams['·sswÜd'] 
th’
  
n
 
’d


73 
loÿl
 
authed
, 
u£r
 = 
£lf
:
	`auth’tiÿ‹
(
·¿ms
)

74 
nÙ
 
authed
 
th’
  
n
 
’d


76 
SessiÚ
:
	`£tKey
('u£r_id', 
£lf
:
	`şas¢ame
(è+ ':' + 
u£r
.
id
)

77 
SessiÚ
:
	`u£rHash
(
u£r
, 
»q
.
£ssiÚ_id
)

79 
»q
.
u£r
 = user

80  
u£r


81 
’d
;

83 
logout
 = 
	`funùiÚ
 (
£lf
)

84 -- 
	`I_AM_CLASS
(
£lf
)

85 -- 
CÏss
 
ªd
 
š¡ªû
 
ÿn
 
bÙh
 
ÿÎ
 
this
 
funùiÚ


86 
SessiÚ
:
	`d–U£rHash
(
»q
.
u£r
)

87  
SessiÚ
:
	`d–Key
('user_id')

88 
’d
;

90 ğ
	`funùiÚ
 (
£lf
, 
·¿ms
)

91 
	`I_AM_CLASS
(
£lf
)

92 
nÙ
 
·¿ms
['u£ºame'] 
Ü
‚Ù…¬ams['·sswÜd'] 
th’
  
n
, 101, 'Ës ·¿m‘”s.' 
’d


94 
loÿl
 
u£r_id
 = 
£lf
:
	`g‘IdByIndex
(
·¿ms
.
u£ºame
)

95 
u£r_id
 
th’
  
n
, 103, 'th§mÇmu£¸exi¡s.' 
’d


97 
loÿl
 
u£r
 = 
	`£lf
(
·¿ms
)

98 
u£r
:
	`§ve
()

100  
u£r


101 
’d
;

103 
£t
 = 
	`funùiÚ
 (
£lf
, 
»q
)

104 
	`I_AM_CLASS
(
£lf
)

105 
loÿl
 
u£r_id
 = 
»q
.
£ssiÚ
['user_id']

106 
u£r_id
 
th’


107 
»q
.
u£r
 = 
£lf
:
	`g‘ById
(
u£r_id
)

109 
»q
.
u£r
 = 
n


110 
’d


111  
£lf


112 
’d
;

114 
addP”m
 = 
	`funùiÚ
(
£lf
, ...)

115 
loÿl
 
³rms
 = {...}

116 
_
, 
³rm
 
š
 
	`aœs
(
³rms
) do

117 
loÿl
 
ps
 = 
P”m
:
	`f‹r
(
	`funùiÚ
(
u
è u.
Çme
:
	`¡¬tsW™h
(
³rm
è
’d
)

118 
_
, 
p
 
š
 
	`aœs
(
ps
) do

119 
£lf
:
	`addFÜeign
('³rms', 
p
)

120 
’d


121 
’d


122 
’d
;

124 
hasP”m
 = 
	`funùiÚ
(
£lf
, ...)

125 
loÿl
 
³rms
 = {...}

126 
_
, 
³rm
 
š
 
	`aœs
(
³rms
) do

127 
loÿl
 
ps
 = 
P”m
:
	`f‹r
(
	`funùiÚ
(
u
è u.
Çme
:
	`¡¬tsW™h
(
³rm
è
’d
)

128 
_
, 
p
 
š
 
	`aœs
(
ps
) do

129 
nÙ
 
£lf
:
	`hasFÜeign
('³rms', 
p
è
th’


130  
çl£


131 
’d


132 
’d


133 
’d


134  
Œue


135 
’d
;

137 
logšRequœed
 = 
	`funùiÚ
 (
£lf
, 
u¾
)

138 
loÿl
 
u¾
 = u¾ 
Ü
 '/'

139 
	`isF®£
(
»q
.
u£r
è
th’
 
web
:
	`»dœeù
(
u¾
);  
çl£
 
’d


140  
Œue


141 
’d
;

143 
	}
}

145  
	gU£r


	@src/mvm/init.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

5 
loÿl
 
funùiÚ
 
	$cÚ¡ruùHtmlTabË
(
š¡ªû
, 
f›ld
, 
v®ue
, 
fdt
)

6 
loÿl
 
h
 = {

7 
‹m¶©e
 =[[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
šput
 
ty³
="‹xt" 
şass
="$şass" 
Çme
="$f›ld" 
$©Œ
 
v®ue
="$value" >]],

8 
şass
={},

9 
	}
}

11 
	gdesc
, 
v®
 
š
 
	$·œs
(
fdt
) do

13 
desc
 =ğ'»quœed' 
th’


14 
v®
 =ğ
Œue
 
th’


15 
bË
.
	`š£¹
(
h
.
şass
, 'required')

16 
’d


17 
–£if
 
desc
 =ğ'ed™abË' 
th’


18 
v®
 =ğ
çl£
 
th’


19 
loÿl
 
wty³
 = 
fdt
.
widg‘_ty³


20 
wty³
 =ğ'u¾' 
th’


21 
h
.
‹m¶©e
 = [[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
a
 
h»f
="h‰p://$v®ue" 
rg‘
='bÏnk'>
$v®ue
</a>]]

23 
h
.
‹m¶©e
 = [[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
¥ª
>
$v®ue
</span>]]

24 
’d


26 
loÿl
 
wty³
 = 
fdt
.
widg‘_ty³


27 
wty³
 =ğ'‹xt' 
th’


28 -- 
h
.
‹m¶©e
 = [[<
Ïb–
>
$f›ld
:</Ïb–><
šput
 
ty³
="‹xt" 
şass
="$şass" 
$©Œ
 
v®ue
="$value" >]]

29 
bË
.
	`š£¹
(
h
.
şass
, 'textInput')

30 
–£if
 
wty³
 =ğ'‹x»a' 
th’


31 
h
.
‹m¶©e
 = [[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
‹x»a
 
şass
="$şass" 
Çme
="$f›ld" 
$©Œ
>
$v®ue
</textarea>]]

32 
–£if
 
wty³
 =ğ'’um' 
th’


33 
h
.
‹m¶©e
 = [[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
£Ëù
 
Çme
="$f›ld" 
şass
="$şass">
$’um
</select>]]

34 
loÿl
 
¡r_’um
 = ''

35 
_
, 
v
 
š
 
	$aœs
(
fdt
.) do

36 
v
 =ğ
v®ue
 
th’


37 
¡r_’um
 = sŒ_’um .. '<İtiÚ s–eùed>' .. 
v
 .. '</option>'

39 
¡r_’um
 = sŒ_’um .. '<İtiÚ>' .. 
v
 .. '</option>'

40 
’d


41 
’d


42 
h
.
‹m¶©e
 = h.‹m¶©e:
	`gsub
('$’um', 
¡r_’um
)

43 
–£if
 
wty³
 =ğ'd©e' 
th’


44 
bË
.
	`š£¹
(
h
.
şass
, 'date')

45 
h
.
y—r¡¬t
 = '-100'

46 
h
.
y—»nd
 = '0'

47 
–£if
 
wty³
 =ğ'ema' 
th’


48 
bË
.
	`š£¹
(
h
.
şass
, 'email')

49 
–£if
 
wty³
 =ğ'mob•hÚe' 
th’


50 
bË
.
	`š£¹
(
h
.
şass
, 'digits')

51 
h
.
mšËngth
 = 11

52 
h
.
maxËngth
 = 11

53 
–£if
 
wty³
 =ğ'image' 
th’


54 
h
.
‹m¶©e
 = [==[

55 <
Ïb–
>
$ÿ±iÚ
:</label>

56 <
img
 
¤c
="/$v®ue" /><
br
/><
Ïb–
></label>

57 <
šput
 
ty³
="‹xt" 
v®ue
="$v®ue" 
Çme
="$field" />

58 <
div
 
id
="__upload"></div>

60 <
süt
 
ty³
="‹xt/javasüt" 
¤c
="/media/js/fileuploader.js"></script>

61 <
süt
 
ty³
="text/javascript">

62 
	`$
(
	$funùiÚ
(){

63 
v¬
 
u¶ßd”
 = 
Ãw
 
qq
.
	`FeU¶ßd”
({

64 
–em’t
: 
	`$
('#__upload')[0],

65 
aùiÚ
: '/admin/upload',

66 
debug
: 
çl£
,

67 
sizeLim™
: 500000,

68 
maxCÚÃùiÚs
: 1,

70 
feTem¶©e
: '<div class="qq-uploading hide">' +

77 
‹m¶©e
: '<div class="qq-uploader">' +

82 
mes§ges
: {

83 
ty³E¼Ü
: "{file} æ‰©å±•åä¸åˆè¦æ±‚ã€‚åªæœ‰æ‰©å±•åä¸º {extensions} çš„æ–‡ä»¶è¢«å…è®¸ä¸Šä¼ ã€‚",

84 
sizeE¼Ü
: "{file} æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§é™åˆ¶ä¸º {sizeLimit}ã€‚",

85 
mšSizeE¼Ü
: "{file} æ–‡ä»¶å¤ªå°ï¼Œæœ€å°é™åˆ¶ä¸º {minSizeLimit}ã€‚",

86 
em±yE¼Ü
: "{file} æ–‡ä»¶æ˜¯ç©ºçš„ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶ã€‚",

87 
ÚL—ve
: "æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ï¼Œå¦‚æœæ­¤æ—¶ç¦»å¼€ï¼Œå°†ä¼šåœæ­¢ä¸Šä¼ ã€‚"

89 
ÚCom¶‘e
: 
	`funùiÚ
(){
ÇvTab
.
	`»lßd
('')}

91 
	}
});

92 </
	gsüt
>

96 
h
.
‹m¶©e
 =[[<
Ïb–
>
$ÿ±iÚ
:</Ïb–><
šput
 
ty³
="‹xt" 
şass
="$şass" 
$©Œ
 
v®ue
="$v®ue" 
Çme
="$field"/>]]

97 
’d


98 
’d


99 
–£if
 
desc
 =ğ'fÜeign' 
th’


100 
fdt
.
¡
 =ğ'ONE' 
th’


102 
’d


103 
–£if
 
desc
 =ğ'¡' 
th’


104 
v®
 =ğ'ONE' 
th’


105 
loÿl
 
fÜeign_š¡ªû
 = 
š¡ªû
:
	$g‘FÜeign
(
f›ld
)

107 
loÿl
 
mod–
 = 
bamboo
.
	$g‘Mod–ByName
(
fdt
.
fÜeign
)

108 
loÿl
 
š¡ªûs
 = 
mod–
:
	$®l
()

110 
loÿl
 
¡r_İt
 = ''

111 
loÿl
 
šdexfd
 = 'id'

112 
mod–
.
__šdexfd
 
ªd
 mod–.__šdexfd ~ğ'' 
th’
 
šdexfd
 = mod–.__šdexfd 
’d


114 
_
, 
v
 
š
 
	$aœs
(
š¡ªûs
) do

115 
fÜeign_š¡ªû
 
ªd
 fÜeign_š¡ªû.
id
 =ğ
v
.id 
th’


116 
¡r_İt
 = sŒ_İˆ.. '<İtiÚ s–eùed v®ue="' .. 
v
.
id
 .. '">' .. 
	`to¡ršg
(v[
šdexfd
]) .. '</option>'

118 
¡r_İt
 = sŒ_İˆ.. '<İtiÚ v®ue="' .. 
v
.
id
 .. '">' .. 
	`to¡ršg
(v[
šdexfd
]) .. '</option>'

119 
’d


120 
’d


122 
h
.
‹m¶©e
 = '<Ïb–>$ÿ±iÚ:</Ïb–><£Ëù‚ame="$f›ld"><İtiÚ v®ue="0"></İtiÚ>' .. 
¡r_İt
 .. '</select>'

123 
–£if
 
v®
 =ğ'MANY' 
th’


124 
loÿl
 
fÜeign_š¡ªûs
 = 
š¡ªû
:
	$g‘FÜeign
(
f›ld
)

126 
loÿl
 
mod–
 = 
bamboo
.
	$g‘Mod–ByName
(
fdt
.
fÜeign
)

127 
loÿl
 
š¡ªûs
 = 
mod–
:
	$®l
()

129 
loÿl
 
¡r_İt
 = ''

130 
loÿl
 
šdexfd
 = 'id'

131 
mod–
.
__šdexfd
 
ªd
 mod–.__šdexfd ~ğ'' 
th’
 
šdexfd
 = mod–.__šdexfd 
’d


133 
_
, 
v
 
š
 
	$aœs
(
š¡ªûs
) do

134 
loÿl
 
eq
 = 
çl£


135 
_
, 
fÜeign_š¡ªû
 
š
 
	$aœs
(
fÜeign_š¡ªûs
) do

136 
fÜeign_š¡ªû
.
id
 =ğ
v
.id 
th’


137 
eq
 = 
Œue


138 
’d


139 
’d


140 
eq
 
th’


141 
¡r_İt
 = sŒ_İˆ.. '<Ïb–><špuˆty³="checkbox" checked‚ame="' .. 
f›ld
 .. '[]" v®ue="'.. 
v
.
id
 .. '"/>' ..
	`to¡ršg
(v[
šdexfd
]) .. '</label>'

143 
¡r_İt
 = sŒ_İˆ.. '<Ïb–><špuˆty³="checkbox"‚ame="' .. 
f›ld
 .. '[]" v®ue="'.. 
v
.
id
 .. '"/>' ..
	`to¡ršg
(v[
šdexfd
]) .. '</label>'

144 
’d


145 
’d


147 
h
.
‹m¶©e
 = '<Ïb–>$f›ld:</Ïb–><div styË="ov”æow:auto; width:200px; max-height:200px; bÜd”:1px sŞid bÏck"><špuˆty³="hidd’"‚ame="' .. 
f›ld
 ..'[]" v®ue="0" />' .. 
¡r_İt
 .. '</div>'

148 
’d


149 
–£if
 
desc
 =ğ'w¿p' 
th’


150 
–£if
 
desc
 =ğ'’um' 
th’


151 
–£if
 
desc
 =ğ'ÿ±iÚ' 
th’


152 
–£if
 
desc
 =ğ'widg‘_ty³' 
th’


153 
–£if
 
desc
 =ğ'vl' 
th’


154 
–£if
 
desc
 =ğ'şass' 
th’


155 
–£if
 
desc
 =ğ'Ãw_f›ld' 
th’


156 
–£if
 
desc
 =ğ'‹m¶©e' 
th’


157 
–£if
 
desc
 =ğ'max_Ëngth' 
th’


158 
h
['maxËngth'] = 
v®


159 
–£if
 
desc
 =ğ'mš_Ëngth' 
th’


160 
h
['mšËngth'] = 
v®


162 
h
[
desc
] = 
v®


163 
’d


164 
’d


166  
h


167 
’d


172 
funùiÚ
 
ÿ£1
, 
ÿ£2
)

174 
	$funùiÚ
(
cod‘abË
)

175 
loÿl
 
f
 = 
cod‘abË
.

176 -- 
f
 = 
cod‘abË
[
ÿ£1
][
ÿ£2
] 
Ü
 codetable.

177 
cod‘abË
[
ÿ£1
] 
th’


178 -- 
f
 = 
cod‘abË
[
ÿ£1
]

179 
cod‘abË
[
ÿ£1
][
ÿ£2
] 
th’


180 
f
 = 
cod‘abË
[
ÿ£1
][
ÿ£2
]

181 
’d


182 
cod‘abË
[
ÿ£1
]. 
th’


183 
f
 = 
cod‘abË
[
ÿ£1
].

184 
’d


185 
’d


186 
f
 
th’


187 
	`ty³
(
f
)=="funùiÚ" 
th’


188  
f


190 
	`”rÜ
("ÿ£ "..
	`to¡ršg
(
ÿ£1
).."‚ot‡ function")

191 
’d


192 
’d


193 
’d


194 
’d


196 
funùiÚ
 
	$f›ldToV›wM­pšg
(
š¡ªû
, 
f›ld
, 
v®ue
, 
fdt
, 
f‹rs
, 
©ched
)

197 
loÿl
 
ouut
 = ''

198 
f›ld
 ~ğ'id' 
th’


200 
loÿl
 
html_bË
 = {

201 
‹m¶©e
 =[[<
Ïb–
>
$f›ld
:</Ïb–><
šput
 
ty³
="‹xt" 
şass
="$şass" 
$©Œ
 
v®ue
="$value" >]],

202 
şass
={},

203 
	}
}

205 
loÿl
 
	gf
 = 
fdt


207 
k
, 
v
 
š
 
	$·œs
(
©ched
) do

208 
v
 =ğ'şass' 
th’


209 
f
[
k
] = f[k] .. ' ' .. 
v


211 
f
[
k
] = 
v


212 
’d


213 
’d


215 
loÿl
 
html_bË
 = 
	`cÚ¡ruùHtmlTabË
(
š¡ªû
, 
f›ld
, 
v®ue
, 
f
)

217 -- 
	$åbË
(
html_bË
)

219 
loÿl
 
¡r_şass
, 
¡r_©Œ
 = 
f
.
şass
 
Ü
 '', ''

220 
k
, 
v
 
š
 
	$·œs
(
html_bË
) do

221 
k
 ~ğ'‹m¶©e' 
th’


222 
k
 =ğ'şass' 
th’


223 
_
, 
c
 
š
 
	$aœs
(
v
) do

224 
¡r_şass
 = sŒ_şas .. ' ' .. 
c


225 
’d


227 
¡r_©Œ
 = sŒ_©Œ ..' ' .. 
k
 .. '="' .. 
	`to¡ršg
(
v
) ..'"'

228 
’d


229 
’d


230 
’d


232 
loÿl
 
ÿ±iÚ
 = 
f
.caption

234 
	$åbË
(
html_bË
)

235 
ouut
 = 
html_bË
.
‹m¶©e
:
	`gsub
('$şass', 
¡r_şass
)

236 :
	`gsub
('$©Œ', 
¡r_©Œ
)

237 :
	`gsub
('$v®ue', 
v®ue
 
Ü
 '')

238 :
	`gsub
('$f›ld', 
f›ld
)

239 :
	`gsub
('$ÿ±iÚ', 
ÿ±iÚ
 
Ü
 
f›ld
)

241 -- 
ouut
 = ([[<
Ïb–
>
id
:</Ïb–><
¥ª
 
Çme
="id">
$id
</¥ª>]]):
	`gusb
('$id', 
š¡ªû
.id)

242 
’d


244 
©ched
.
w¿p
 
th’


245 
ouut
 = 
©ched
.
w¿p
:
	$fÜm©
(
ouut
)

246 
’d


248  
ouut


249 
’d


251 
funùiÚ
 
	$mod–ToV›wM­pšg
(
š¡ªû
, 
f‹rs
, 
©ched
)

252 
loÿl
 
ouut
 = ''

254 
loÿl
 
v®ue_ty³
 = 
	$ty³
(
š¡ªû
)

255 
v®ue_ty³
 =ğ'¡ršg' 
Ü
 v®ue_ty³ =ğ'numb”' 
th’


256 
ouut
 = ouuˆ+ ('<¥ª>%s</¥ª>'):
	$fÜm©
(
š¡ªû
)

258 
–£if
 
v®ue_ty³
 =ğ'bË' 
ªd
 
	$isV®idIn¡ªû
(
š¡ªû
è
th’


259 
loÿl
 
f›lds
 = 
š¡ªû
.
__f›lds


260 
f›ld
, 
fdt
 
š
 
	$·œs
(
f›lds
) do

262 
loÿl
 
æag
 = 
Œue


263 
k
, 
v
 
š
 
	`·œs
(
f‹rs
 
Ü
 {
	}
}) do

264 -- 
to
 
»dundªt
 
qu”y
 
	gcÚd™iÚ
, 
Úû
 
	gm“t
, 
jump
 
immedŸ‹ly


265 
nÙ
 
	gfdt
[
k
] 
	gth’


266 -- 
	gæag
=
çl£
;

268 
	gk
 =ğ'vl' 
th’
 
fdt
[
k
] = 0 
’d


269 
’d


271 
ty³
(
v
è=ğ'funùiÚ' 
th’


272 
æag
 = 
v
(
fdt
[
k
] 
Ü
 '')

273 
nÙ
 
æag
 
th’
  
’d


275 
fdt
[
k
] ~ğ
v
 
th’
 
æag
=
çl£
;  
’d


276 
’d


277 
’d


279 
æag
 
th’


280 
	gouut
 = 
ouut
 + 
f›ldToV›wM­pšg
(
š¡ªû
, 
f›ld
, in¡ªû[f›ld] 
Ü
 '', 
fdt
, 
f‹rs
, 
©ched
)

281 
’d


282 
’d


284 
	gouut
 = 
ouut
 + ''

285 
’d


287  
ouut


288 
’d


290 
funùiÚ
 
	$´oûss
Ğ
š¡ªû
, 
»¡code
 )

292 
	`as£¹
(
	`lßd¡ršg
('_ˆğ{' + 
»¡code
 + ' }'), '[Error] wrong syntax in viewag {**}.')()

293 
	`as£¹
(
	`ty³
(
_t
) == 'table')

295 
loÿl
 
f‹rs
 = 
_t
.filters

296 
	`as£¹
(
	`ty³
(
f‹rs
è=ğ'n' 
Ü
ype(filters) == 'table')

297 
loÿl
 
©ched
 = 
_t
.attached

298 
	`as£¹
(
	`ty³
(
©ched
è=ğ'n' 
Ü
ype(attached) == 'table')

299 
©ched
 =‡‰ached 
Ü
 {
	}
}

301  
	$mod–ToV›wM­pšg
(
š¡ªû
, 
f‹rs
, 
©ched
)

303 
’d


	@src/mvm/prototype.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
V®id©Üs
 = 
»quœe
 'bamboo.mvm.validate'

5 
PrÙÙy³
 = 
Objeù
:
ex‹nd
 {

6 -- 
widg‘_şass
 = {},

7 -- 
widg‘_©Œ
 = {},

8 
‹m¶©e
 = {

9 
Ïb–
 = [[<Ïb– ="$id">
$ÿ±iÚ
</label>]],

10 
widg‘
 = '',

11 
h–p
 = [[<
¥ª
 
şass
="$şass">
$h–p
</span>]],

13 
‹m¶©e_uÃd™abË
 = {

14 
Ïb–
 = [[<Ïb–>
$ÿ±iÚ
:</label>]],

15 
widg‘
 = [[<
¥ª
 
şass
="$şass" 
$©Œ
>
$v®ue
</span>]],

16 
h–p
 = [[<
¥ª
 
şass
="$şass">
$h–p
</span>]],

18 
š™
 = 
	`funùiÚ
(
£lf
, 
t
)

19  
£lf


20 
’d
,

21 
toHtml
 = 
	`funùiÚ
(
£lf
, 
š¡
, 
f›ld
, 
fÜm©
)

22  (
fÜm©
 
Ü
 "$label$widget$help")

23 :
	`gsub
('$widg‘', 
£lf
:
	`toWidg‘
(
š¡
, 
f›ld
))

24 :
	`gsub
('$Ïb–', 
£lf
:
	`toLab–
(
š¡
, 
f›ld
))

25 :
	`gsub
('$h–p', 
£lf
:
	`toH–p
(
š¡
, 
f›ld
))

26 
’d
,

27 
toLab–
 = 
	`funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

28 
£lf
.
ed™abË
 =ğ
çl£
 
th’


29  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e_uÃd™abË
.
Ïb–
 
Ü
 ''), 
š¡
, 
f›ld
)

31  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e
.
Ïb–
 
Ü
 ''), 
š¡
, 
f›ld
)

32 
’d


33 
’d
,

34 
toWidg‘
 = 
	`funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

35 
£lf
.
widg‘_şass
 = s–f.widg‘_şas 
Ü
 {}

36 
£lf
.
widg‘_©Œ
 = s–f.widg‘_©Œ 
Ü
 {}

37 
£lf
.
ruËs
 
th’
 s–f.
widg‘_©Œ
.
v®id©e
 = 
jsÚ
.
	`’code
(£lf.ruËs):
	`gsub
('"', "'"è
’d


38 
loÿl
 
¡r_şass
 = ''

39 
_
, 
c
 
š
 
	`aœs
(
£lf
.
widg‘_şass
) do

40 
¡r_şass
 = sŒ_şas .. ' ' .. 
c


41 
’d


42 
loÿl
 
¡r_©Œ
 = ''

43 
k
, 
v
 
š
 
	`·œs
(
£lf
.
widg‘_©Œ
) do

44 
¡r_©Œ
 = sŒ_©Œ .. ' ' .. 
k
 .. '="' .. 
	`to¡ršg
(
v
) ..'"'

45 
’d


46 
£lf
.
ed™abË
 =ğ
çl£
 
th’


47  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e_uÃd™abË
.
widg‘
 
Ü
 '')

48 :
	`gsub
('$şass', 
¡r_şass
)

49 :
	`gsub
('$©Œ', 
¡r_©Œ
)

50 , 
š¡
, 
f›ld
)

52  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e
.
widg‘
 
Ü
 '')

53 :
	`gsub
('$şass', 
¡r_şass
)

54 :
	`gsub
('$©Œ', 
¡r_©Œ
)

55 , 
š¡
, 
f›ld
)

56 
’d


57 
’d
,

58 
toH–p
 = 
	`funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

59 
£lf
.
h–p_şass
 = s–f.h–p_şas 
Ü
 {}

60 
£lf
.
h–p_©Œ
 = s–f.h–p_©Œ 
Ü
 {}

61 
loÿl
 
¡r_şass
 = ''

62 
_
, 
c
 
š
 
	`aœs
(
£lf
.
h–p_şass
) do

63 
¡r_şass
 = sŒ_şas .. ' ' .. 
c


64 
’d


65 
loÿl
 
¡r_©Œ
 = ''

66 
k
, 
v
 
š
 
	`·œs
(
£lf
.
h–p_©Œ
) do

67 
¡r_©Œ
 = sŒ_©Œ .. ' ' .. 
k
 .. '="' .. 
	`to¡ršg
(
v
) ..'"'

68 
’d


69 
£lf
.
ed™abË
 =ğ
çl£
 
th’


70  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e_uÃd™abË
.
h–p
 
Ü
 '')

71 :
	`gsub
('$şass', 
¡r_şass
)

72 :
	`gsub
('$©Œ', 
¡r_©Œ
)

73 , 
š¡
, 
f›ld
)

75  
£lf
:
	`¡rGSub
((£lf.
‹m¶©e
.
h–p
 
Ü
 '')

76 :
	`gsub
('$şass', 
¡r_şass
)

77 :
	`gsub
('$©Œ', 
¡r_©Œ
)

78 , 
š¡
, 
f›ld
)

79 
’d


80 
’d
,

81 
¡rGSub
 = 
	`funùiÚ
(
£lf
, 
¡ršg
, 
š¡
, 
f›ld
)

82 
loÿl
 
»t
 = 
¡ršg


83 :
	`gsub
('$v®ue', 
š¡
[
f›ld
] 
Ü
 '')

84 :
	`gsub
('$ÿ±iÚ', 
£lf
.
ÿ±iÚ
 
Ü
 
f›ld
)

85 :
	`gsub
('$f›ld', 
f›ld
)

86 :
	`gsub
('$h–p', 
£lf
.
h–p
 
Ü
 '')

87 :
	`gsub
('$id', 
£lf
.
id
 
Ü
 'id_' .. 
f›ld
)

88  
»t


89 
’d
,

90 
v®id©e
 = 
	`funùiÚ
(
£lf
, 
v®
, 
f›ld
)

91 
loÿl
 
is_v®id
 = 
Œue


92 
loÿl
 
”r_msg
 = {}

93 
k
, 
v
 
š
 
	`·œs
(
£lf
.
ruËs
 
Ü
 {}) do

94 -- 
	`´št
(
k
, 
v®
, 
f›ld
, 
v
)

95 
loÿl
 
»t
, 
msg
 = 
V®id©Üs
[
k
](
v®
, 
f›ld
, 
v
)

96 
nÙ
 
»t
 
th’


97 
bË
.
	`š£¹
(
”r_msg
, 
msg
)

98 
is_v®id
 = 
çl£


99 
’d


100 
’d


101  
is_v®id
, 
”r_msg


102 
’d
,

103 
	}
}

105 
	gText
 = 
PrÙÙy³
:
ex‹nd
 {

106 
š™
 = 
funùiÚ
(
£lf
)

107 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

108 
£lf
.
‹m¶©e
.
widg‘
 = [[<
šput
 
ty³
="‹xt" 
id
="$id" 
şass
="$şass" 
Çme
="$f›ld" 
$©Œ
 
v®ue
="$value"/>]]

109  
£lf


110 
’d
,

113 
	gEma
 = 
Text
:
ex‹nd
 {

114 
š™
 = 
funùiÚ
(
£lf
)

115 
£lf
.
ruËs
 = s–f.ruË 
Ü
 {}

116 
£lf
.
ruËs
.
ema
 = 
Œue


117  
£lf
.
_·»Á
.
š™
(self)

118 
’d
,

121 
	gU¾
 = 
Text
:
ex‹nd
 {

125 
Tex»a
 = 
Text
:
ex‹nd
 {

126 
š™
 = 
funùiÚ
(
£lf
)

127 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

128 
£lf
.
‹m¶©e
.
widg‘
 = [[<
‹x»a
 
id
="$id" 
şass
="$şass" 
Çme
="$f›ld" 
$©Œ
>
$v®ue
</textarea>]]

129  
£lf


130 
’d
,

133 
	gD©e
 = 
Text
:
ex‹nd
 {

134 
š™
 = 
funùiÚ
(
£lf
)

135 
£lf
.
ruËs
 = s–f.ruË 
Ü
 {}

136 
£lf
.
ruËs
.
d©eISO
 = 
Œue


137  
£lf
.
_·»Á
.
š™
(self)

138 
’d
,

141 
	gEnum
 = 
PrÙÙy³
:
ex‹nd
 {

142 
š™
 = 
funùiÚ
(
£lf
)

143 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

144 
£lf
.
‹m¶©e
.
widg‘
 = [[<
£Ëù
 
id
="$id" 
Çme
="$f›ld" 
şass
="$şass" 
$©Œ
>
$’um
</select>]]

145  
£lf


146 
’d
,

147 
	gtoWidg‘
 = 
funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

148 
loÿl
 
	g¡r_’um
 = ''

149 
_
, 
v
 
š
 
aœs
(
£lf
.) do

150 
	gv
 =ğ
š¡
[
f›ld
] 
th’


151 
¡r_’um
 = sŒ_’um .. ('<İtiÚ s–eùed v®ue="%s">%s</İtiÚ>'):
fÜm©
(
v
[1], v[2])

153 
	g¡r_’um
 = 
¡r_’um
 .. ('<İtiÚ v®ue="%s">%s</İtiÚ>'):
fÜm©
(
v
[1], v[2])

154 
’d


155 
’d


156 
	g£lf
.
	g‹m¶©e
.
	gwidg‘
 = 
£lf
.
‹m¶©e
.
widg‘
:
gsub
('$’um', 
¡r_’um
)

157  
	g£lf
.
	g_·»Á
.
toWidg‘
(
£lf
, 
š¡
, 
f›ld
)

158 
	g’d
,

161 
	gFÜeign
 = 
PrÙÙy³
:
ex‹nd
 {

162 
š™
 = 
funùiÚ
(
£lf
)

163 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

164 
£lf
.
¡
 =ğ'ONE' 
th’


165 
£lf
.
‹m¶©e
.
widg‘
 = [[<
£Ëù
 
Çme
="$f›ld" 
şass
="$şass" 
$©Œ
><
İtiÚ
 
v®ue
="0"></İtiÚ>
$İtiÚ
</select>]]

166 
–£if
 
£lf
.
¡
 =ğ'MANY' 
th’


167 -- 
£lf
.
‹m¶©e
.
widg‘
 = [[

168 -- <
div
 
¡yË
="overflow:auto; width:200px; max-height:200px; border:1px solid black">]]

169 
£lf
.
‹m¶©e
.
widg‘
 = [[

170 <
div
 
şass
="$class">

171 <
šput
 
ty³
="hidd’" 
Çme
="$f›ld[]" 
v®ue
="0" />
$İtiÚ


172 </
div
>

174 
’d


175  
£lf


176 
’d
,

178 
	gtoWidg‘
 = 
funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

179 
	g£lf
.
	g¡
 =ğ'ONE' 
th’


180 
loÿl
 
fÜeign_š¡
 = 
š¡
:
g‘FÜeign
(
f›ld
)

181 
loÿl
 
mod–
 = 
bamboo
.
g‘Mod–ByName
(
£lf
.
fÜeign
)

182 
loÿl
 
š¡s
 = 
mod–
:
®l
(è
Ü
 {}

184 
loÿl
 
¡r_İt
 = ''

185 
loÿl
 
šdexfd
 = 'id'

186 
mod–
.
__šdexfd
 
ªd
 mod–.__šdexfd ~ğ'' 
th’
 
šdexfd
 = mod–.__šdexfd 
’d


187 
_
, 
v
 
š
 
aœs
(
š¡s
) do

188 
fÜeign_š¡
 
ªd
 
	gfÜeign_š¡
.
	gid
 =ğ
v
.
id
 
th’


189 
¡r_İt
 = sŒ_İˆ.. '<İtiÚ s–eùed v®ue="' .. 
v
.
id
 .. '">' .. 
to¡ršg
(v[
šdexfd
]) .. '</option>'

191 
¡r_İt
 = sŒ_İˆ.. '<İtiÚ v®ue="' .. 
v
.
id
 .. '">' .. 
to¡ršg
(v[
šdexfd
]) .. '</option>'

192 
’d


193 
’d


194 
£lf
.
‹m¶©e
.
widg‘
 = [[<
£Ëù
 
Çme
="$f›ld" 
şass
="$şass" 
$©Œ
><
İtiÚ
 
v®ue
="0"></İtiÚ>]] .. 
¡r_İt
 .. [[</select>]]

196  
£lf
.
_·»Á
.
toWidg‘
(£lf, 
š¡
, 
f›ld
)

197 
–£if
 
	g£lf
.
	g¡
 =ğ'MANY' 
th’


198 
loÿl
 
fÜeign_š¡s
 = 
š¡
:
g‘FÜeign
(
f›ld
è
Ü
 {}

199 
loÿl
 
mod–
 = 
bamboo
.
g‘Mod–ByName
(
£lf
.
fÜeign
)

200 
loÿl
 
š¡s
 = 
mod–
:
®l
(è
Ü
 {}

201 
loÿl
 
¡r_İt
 = ''

202 
loÿl
 
šdexfd
 = 'id'

203 
mod–
.
__šdexfd
 
ªd
 mod–.__šdexfd ~ğ'' 
th’
 
šdexfd
 = mod–.__šdexfd 
’d


204 
_
, 
v
 
š
 
aœs
(
š¡s
) do

205 
loÿl
 
	geq
 = 
çl£


206 
_
, 
fÜeign_š¡
 
š
 
aœs
(
fÜeign_š¡s
) do

207 
	gfÜeign_š¡
.
	gid
 =ğ
v
.
id
 
th’


208 
eq
 = 
Œue


209 
’d


210 
’d


211 
eq
 
th’


212 
¡r_İt
 = sŒ_İˆ.. '<Ïb–><špuˆty³="checkbox" checked‚ame="' .. 
f›ld
 .. '[]" v®ue="'.. 
v
.
id
 .. '"/>' ..
to¡ršg
(v[
šdexfd
]) .. '</label>'

214 
¡r_İt
 = sŒ_İˆ.. '<Ïb–><špuˆty³="checkbox"‚ame="' .. 
f›ld
 .. '[]" v®ue="'.. 
v
.
id
 .. '"/>' ..
to¡ršg
(v[
šdexfd
]) .. '</label>'

215 
’d


216 
’d


217 
£lf
.
‹m¶©e
.
widg‘
 = [[<
div
 
şass
="$şass"><
šput
 
ty³
="hidd’" 
Çme
="$f›ld[]" 
v®ue
="0" />]] .. 
¡r_İt
 .. [[</div>]]

218  
£lf
.
_·»Á
.
toWidg‘
(£lf, 
š¡
, 
f›ld
)

219 
’d


220 
	g’d
,

223 
	gFÜeignImage
 = 
PrÙÙy³
:
ex‹nd
 {

224 
š™
 = 
funùiÚ
(
£lf
)

225 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

226 
£lf
.
‹m¶©e_uÃd™abË
 = 
bË
.
cİy
(self.template_uneditable)

227 
£lf
.
‹m¶©e
.
widg‘
 = [[<
img
 
id
="$id" 
Çme
="$f›ld" 
şass
="$şass" 
¤c
="/$src"/>]]

228 
£lf
.
‹m¶©e_uÃd™abË
.
widg‘
 = [[<
img
 
id
="$id" 
Çme
="$f›ld" 
şass
="$şass" 
¤c
="/$src"/>]]

229  
£lf


230 
’d
,

231 
	gtoWidg‘
 = 
funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

232 
loÿl
 
	gfÜeign_š¡
 = 
š¡
:
g‘FÜeign
(
f›ld
)

233 
£lf
.
‹m¶©e
.
widg‘
 = s–f.‹m¶©e.widg‘:
gsub
('$¤c', 
fÜeign_š¡
.
·th
)

234 
	g£lf
.
	g‹m¶©e_uÃd™abË
.
	gwidg‘
 = 
£lf
.
‹m¶©e
.
widg‘
:
gsub
('$¤c', 
fÜeign_š¡
.
·th
)

235  
	g£lf
.
	g_·»Á
.
toWidg‘
(
£lf
, 
š¡
, 
f›ld
)

236 
	g’d
,

239 
	gFÜeignText
 = 
PrÙÙy³
:
ex‹nd
 {

240 
š™
 = 
funùiÚ
(
£lf
)

241 
£lf
.
‹m¶©e
 = 
bË
.
cİy
(self.template)

242 
£lf
.
‹m¶©e_uÃd™abË
 = 
bË
.
cİy
(self.template_uneditable)

243 
£lf
.
‹m¶©e
.
widg‘
 = [[<
šput
 
ty³
="‹xt" 
id
="$id" 
şass
="$şass" 
Çme
="$f›ld" 
$©Œ
 
v®ue
="$text"]]

244 
£lf
.
‹m¶©e_uÃd™abË
.
widg‘
 = [[<
¥ª
 
şass
="$şass" 
$©Œ
>
$‹xt
</span>]]

245  
£lf


246 
’d
,

247 
	gtoWidg‘
 = 
funùiÚ
(
£lf
, 
š¡
, 
f›ld
)

248 
loÿl
 
	gfÜeign_š¡
 = 
š¡
:
g‘FÜeign
(
f›ld
)

249 
loÿl
 
mod–
 = 
bamboo
.
g‘Mod–ByName
(
£lf
.
fÜeign
)

250 
£lf
.
‹m¶©e
.
widg‘
 = s–f.‹m¶©e.widg‘:
gsub
('$‹xt', 
fÜeign_š¡
[
mod–
.
__šdexfd
])

251 
	g£lf
.
	g‹m¶©e_uÃd™abË
.
	gwidg‘
 = 
£lf
.
‹m¶©e_uÃd™abË
.
widg‘
:
gsub
('$‹xt', 
fÜeign_š¡
[
mod–
.
__šdexfd
])

252  
	g£lf
.
	g_·»Á
.
toWidg‘
(
£lf
, 
š¡
, 
f›ld
)

253 
	g’d
,

256 
	gf›ldTy³
 = {

257 ['‹xt'] = 
Text
,

258 ['ema'] = 
Ema
,

259 ['’um'] = 
Enum
,

260 ['u¾'] = 
U¾
,

261 ['‹x»a'] = 
Tex»a
,

262 ['d©e'] = 
D©e
,

263 ['image'] = 
Text
,

264 ['fÜeign'] = 
FÜeign
,

265 ['fÜeign_img'] = 
FÜeignImage
,

266 ['fÜeign_‹xt'] = 
FÜeignText
,

267 -- ['fÜeign_Úe'] = 
FÜeignOÃ
,

270  
	gf›ldTy³
;

	@src/mvm/validate.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	$v®id©eMax
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

4 
loÿl
 
num
 = 
	$tÚumb”
(
v®ue
)

5 
num
 
ªd
‚um > 
lim™_v®ue
 
th’


6  
çl£
, ('Thmax iÅuˆoà$f›ld i $lim™_v®ue'):
	`gsub
('$f›ld', 
f›ld
):gsub('$lim™_v®ue', 
lim™_v®ue
)

7 
’d


8  
Œue


9 
’d


11 
funùiÚ
 
	$v®id©eMš
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

12 
loÿl
 
num
 = 
	$tÚumb”
(
v®ue
)

13 
num
 
ªd
‚um < 
lim™_v®ue
 
th’


14  
çl£
, ('Thmš iÅuˆoà$f›ld i $lim™_v®ue'):
	`gsub
('$f›ld', 
f›ld
):gsub('$lim™_v®ue', 
lim™_v®ue
)

15 
’d


16  
Œue


17 
’d


19 
funùiÚ
 
	$v®id©eMšL’gth
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

20 #v®u< 
lim™_v®ue
 
th’


21  
çl£
, ('ThmšËngth oà$f›ld i $lim™_v®ue'):
	`gsub
('$f›ld', 
f›ld
):gsub('$lim™_v®ue', 
lim™_v®ue
)

22 
’d


23  
Œue


24 
’d


26 
funùiÚ
 
	$v®id©eMaxL’gth
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

27 #v®u> 
lim™_v®ue
 
th’


28  
çl£
, ('ThmaxËngth oà$f›ld i $lim™_v®ue'):
	`gsub
('$f›ld', 
f›ld
):gsub('$lim™_v®ue', 
lim™_v®ue
)

29 
’d


30  
Œue


31 
’d


33 
funùiÚ
 
	$v®id©eRªge
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

34 
loÿl
 
mš
, 
max
 = 
	$uÅack
(
lim™_v®ue
)

35 
	$v®id©eMš
(
v®ue
, 
f›ld
, 
mš
è
ªd
 
	$v®id©eMax
(
v®ue
, 
f›ld
, 
max
è
th’


36  
Œue


38  
çl£
, ('Thv®uoà$f›ld should bšh¿ngoà$mšØ$max'):
	`gsub
('$max', 
max
):gsub('$mš', 
mš
):gsub('$f›ld', 
f›ld
)

39 
’d


40 
’d


42 
funùiÚ
 
	$v®id©eRªgeL’gth
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

43 
loÿl
 
mš
, 
max
 = 
	$uÅack
(
lim™_v®ue
)

44 
	$v®id©eMšL’gth
(
v®ue
, 
f›ld
, 
mš
è
ªd
 
	$v®id©eMaxL’gth
(
v®ue
, 
f›ld
, 
max
è
th’


45  
Œue


47  
çl£
, ('ThËngth oà$f›ld should bšh¿ngoà$mšØ$max'):
	`gsub
('$max', 
max
):gsub('$mš', 
mš
):gsub('$f›ld', 
f›ld
)

48 
’d


49 
’d


51 
funùiÚ
 
	$v®id©eRequœed
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

52 
lim™_v®ue
 
th’


53 
	$isF®£
(
v®ue
è
th’


54  
çl£
, ('F›ld $f›ld i »quœed'):
	`gsub
('$f›ld', 
f›ld
)

55 
’d


56 
’d


57  
Œue


58 
’d


60 
funùiÚ
 
	$v®id©eEma
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

61 
lim™_v®ue
 =ğ
Œue
 
ªd
 
v®ue
‡nd v®u~ğ'' 
th’


62 
loÿl
 
»gxp
 = '[%w_%.]+@%w+%.%w+'

63 
nÙ
 
v®ue
:
	$fšd
(
»gxp
è
th’


64  
çl£
, ('PËa£ iÅuˆª Ema‡dd»s tØ$f›ld'):
	`gsub
('$f›ld', 
f›ld
)

65 
’d


66 
’d


67  
Œue


68 
’d


70 
funùiÚ
 
	$v®id©eD©eISO
(
v®ue
, 
f›ld
, 
lim™_v®ue
)

71 
lim™_v®ue
 =ğ
Œue
 
ªd
 
v®ue
‡nd v®u~ğ'' 
th’


72 
loÿl
 
»gxp1
 = '%d%d%d%d/%d%d/%d%d'

73 
loÿl
 
»gxp2
 = '%d%d%d%d%-%d%d%-%d%d'

74 -- 
	$´št
(
v®ue
)

75 
nÙ
 
v®ue
:
	$fšd
(
»gxp1
è
ªd
 
nÙ
 
v®ue
:
	$fšd
(
»gxp2
è
th’


76  
çl£
, ('PËa£ iÅuˆ¨d©tØ$f›ld,hfÜm© i yyyy/mm/dd o¸yyyy-mm-dd'):
	`gsub
('$f›ld', 
f›ld
)

77 
’d


78 
’d


79  
Œue


80 
’d


82 
v®id©Üs
 = {

83 
max
 = 
v®id©eMax
,

84 
mš
 = 
v®id©eMš
,

85 
¿nge
 = 
v®id©eRªge
,

86 
mšËngth
 = 
v®id©eMšL’gth
,

87 
maxËngth
 = 
v®id©eMaxL’gth
,

88 
¿ng–’gth
 = 
v®id©eRªgeL’gth
,

89 
»quœed
 = 
v®id©eRequœed
,

90 
ema
 = 
v®id©eEma
,

91 
d©eISO
 = 
v®id©eD©eISO
,

92 
	}
}

94  
	gv®id©Üs


	@src/mysql.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
»quœe
 'luasql.mysql'

5 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

7 
loÿl
 
Mysql
 = 
Mod–
:
ex‹nd
 {

8 
__g
 = 'Bamboo.Model.Mysql';

9 
__Çme
 = 'Mysql';

10 
__desc
 = 'Abstract mysql definition';

12 
__f›lds
 = {

23 
š™
 = 
	`funùiÚ
(
£lf
,
t
)

24 
£lf
.
id
 = s–f:
	`g‘CouÁ”
() + 1;

26 
£lf
.
ho¡
 = 
t
.ho¡ 
Ü
 '127.0.0.1';

27 
£lf
.
pÜt
 = 
t
.pÜˆ
Ü
 3306;

28 
£lf
.
d©aba£
 = 
t
.database;

29 
£lf
.
u£r
 = 
t
.user;

30 
£lf
.
·sswÜd
 = 
t
.password;

32 
t
.
cÚn
 ~ğ
n
 
th’


33 
£lf
:
	`cÚÃù
();

34 
’d


36  
£lf
;

37 
’d
;

39 
cÚÃù
 = 
	`funùiÚ
(
£lf
,
·sswÜd
)

40 
loÿl
 
mysql_’v
 = 
luasql
.
	`mysql
();

41 
·sswÜd
 =ğ
n
 
th’


42 
£lf
.
cÚn
,
”r
 = 
mysql_’v
:
	`cÚÃù
Ğ£lf.
d©aba£
,

43 
£lf
.
u£r
,

44 
£lf
.
·sswÜd
,

45 
£lf
.
ho¡
,

46 
£lf
.
pÜt
);

48 
£lf
.
cÚn
,
”r
 = 
mysql_’v
:
	`cÚÃù
Ğ£lf.
d©aba£
,

49 
£lf
.
u£r
,

50 
·sswÜd
,

51 
£lf
.
ho¡
,

52 
£lf
.
pÜt
);

54 
’d


56  
”r
 
Ü
 "connected";

57 
’d
;

59 
»Œ›ve
 = 
	`funùiÚ
(
£lf
, 
sql¡r
)

60 
loÿl
 
cur
 = 
£lf
.
cÚn
:
	`execu‹
(
sql¡r
);

62 
	`ty³
(
cur
è=ğ'numb”' 
th’


63  
cur
;

64 
’d


66 
loÿl
 
»cÜds
 = 
	`Li¡
();

67 
loÿl
 
numrows
 = 
cur
:
	`numrows
();

68 
loÿl
 
cŞÇmes
 = 
cur
:
	`g‘cŞÇmes
();

69 
i
=1,
numrows
,1 do

70 
loÿl
 
»cÜd
 = {};

71 
loÿl
 
‹mp
 = {};

72 
cur
:
	`ãtch
(
‹mp
);

73 --
	`´št
("temp");

74 
k
,
v
 
š
 
	`aœs
(
cŞÇmes
) do

75 -- 
	`´št
(
k
,
v
);

76 
»cÜd
[
v
] = 
‹mp
[
k
];

77 
’d


79 
»cÜds
:
	`­³nd
(
»cÜd
);

80 
’d


82 
cur
:
	`şo£
();

84  
»cÜds
;

85 
’d
;

87 
şo£
 = 
	`funùiÚ
(
£lf
)

88 
£lf
.
cÚn
:
	`şo£
();

89 
’d
;

91 
	}
}

93  
	gMysql
;

	@src/plugin.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
¶uto
 = 
»quœe
 'pluto'

5 
loÿl
 
PLUGIN_ARGS_DBKEY
 = "_plugin_args"

7 
funùiÚ
 
	$d“pCİyW™hMod–Name
(
£lf
, 
£’
)

8 
loÿl
 
»s
 = {
	}
}

9 
£’
 = s“À
Ü
 {}

10 
£’
[
£lf
] = 
»s


12 
£lf
.
__¥eùy³
 
th’


13 
»s
.
__¥eùy³
 = 
£lf
.__spectype

15 
£lf
.
şas¢ame
 
th’


16 
»s
.
__Çme
 = 
£lf
:
	$şas¢ame
()

18 
£lf
.
__ty³Çme
 
th’


19 
»s
.
__ty³Çme
 = 
£lf
.__typename

20 
’d


21 
’d


22 
’d


24 
k
, 
v
 
š
 
	$·œs
(
£lf
) do

25 "bË" =ğ
	$ty³
(
v
è
th’


26 
£’
[
v
] 
th’


27 
»s
[
k
] = 
£’
[
v
]

29 
»s
[
k
] = 
	$d“pCİyW™hMod–Name
(
v
, 
£’
)

30 
’d


32 
»s
[
k
] = 
v


33 
’d


34 
’d


35 
£’
[
£lf
] = 
n


37  
»s


38 
’d


40 
funùiÚ
 
	$bË2mod–
(
tbl
)

41 
tbl
.
__Çme
 
th’


42 
loÿl
 
mod–
 = 
bamboo
.
	`g‘Mod–ByName
(
tbl
.
__Çme
)

43 --
	`±abË
(
	$g‘m‘©abË
(
med–
))

44 
tbl
.
__Çme
 = 
n


45 --
tbl
 = 
	$mod–
(
tbl
)

46 
	`£tm‘©abË
(
tbl
, {
__šdex
=
mod–
})

47 
’d


48 
	gtbl
.
__ty³Çme
 
th’


49 
	gtbl
.
	g__ty³Çme
 = 
n


50 
tbl
 = 
	$Li¡
(
tbl
)

51 
’d


52 
tbl
.
__¥eùy³
 
th’


53 
tbl
.
__¥eùy³
 = 
n


54 
tbl
 = 
	$Qu”yS‘
(
tbl
)

55 
’d


56 
k
,
v
 
š
 
	$·œs
(
tbl
) do

57 
	`ty³
(
v
è=ğ'bË' 
th’


58 
tbl
[
k
] = 
	$bË2mod–
(
v
)

59 
’d


60 
’d


61  
tbl


62 
’d


64 
funùiÚ
 
	$³rsi¡
(
¶ugš_Çme
, 
¬gs
)

65 
	`as£¹
(
¶ugš_Çme
, "[Error] @…lugin…ersist - missing…lugin_name.")

66 
	`as£¹
(
	`ty³
(
¬gs
) == 'table', "[Error] @plugin…ersist - #2‡rgs should beable.")

67 
	`as£¹
(
	`ty³
(
¬gs
.
_g
) == 'string', "[Error] @plugin…ersist -‡rgs._tag should be string.")

69 -- 
u£
 
¶uto
 
to
 
³rsi¡


70 -- 
h”e
, 
mu¡
 
u£
 
d“pCİy
 
to
 
»move
 
®l
 
the
 
m‘©abËs
 
š
 
¬gs


71 -- 
¶uto
 
now
 
ÿn
 
nÙ
 
´oûss
 
tho£
 
m‘©abËs
 
cÜ»ùly
, 
wl
 
»pÜt
 "[Error] Attempto…ersist‡ C function."

72 
loÿl
 
buf
 = 
¶uto
.
	`³rsi¡
({
	}
}, 
d“pCİyW™hMod–Name
(
¬gs
))

74 -- 
¡Üe
 
to
 
db


75 
loÿl
 
	gdb
 = 
BAMBOO_DB


76 
db
:
h£t
(
PLUGIN_ARGS_DBKEY
, 
fÜm©
("%s:%s", 
¶ugš_Çme
, 
¬gs
.
_g
), 
buf
)

78 
’d


80 
funùiÚ
 
	$uÅ”si¡
(
¶ugš_Çme
, 
_g
)

81 
	`as£¹
(
¶ugš_Çme
, "[Error] @…lugin unpersist - missing…lugin_name.")

82 
	`as£¹
(
	`ty³
(
_g
) == 'string', "[Error] @plugin unpersist - #2 _tag should be string.")

84 
loÿl
 
db
 = 
BAMBOO_DB


85 
loÿl
 
buf
 = 
db
:
	`hg‘
(
PLUGIN_ARGS_DBKEY
, 
	`fÜm©
("%s:%s", 
¶ugš_Çme
, 
_g
))

86 
loÿl
 
tbl
 = 
¶uto
.
	`uÅ”si¡
({
	}
}, 
	gbuf
)

87 
as£¹
(
ty³
(
tbl
) == 'table', "[Error] @plugin unpersist - unpersisted„esult should beable.")

88 
	gtbl
 = 
	$bË2mod–
(
tbl
)

89  
tbl


90 
’d


	@src/redis.lua

1 
moduË
('bamboo.»dis', 
·ckage
.
£—Î
)

3 
loÿl
 
	g»dis
 = 
»quœe
 'redis'

5 
funùiÚ
 
	$cÚÃù
(
cÚfig_t
)

6 
loÿl
 
·¿ms
 = {

7 
ho¡
 = 
cÚfig_t
.ho¡ 
Ü
 '127.0.0.1',

8 
pÜt
 = 
cÚfig_t
.pÜˆ
Ü
 6379,

9 
	}
}

10 
loÿl
 
	gwhich
 = 
cÚfig_t
.
which
 
Ü
 0

12 
loÿl
 
»dis_db
 = 
»dis
.
	$cÚÃù
(
·¿ms
)

13 
cÚfig_t
.
auth
 
th’


14 
»dis_db
:
	$auth
(
cÚfig_t
.
auth
)

15 
’d


16 
»dis_db
:
	$£Ëù
(
which
)

18  
»dis_db


19 
’d


	@src/redis/fifo.lua

2 -- 
	gFIFO
, 
we
 
push
 
–em’t
 
äom
 
	gËá
, 
pİ
 from 
	gright
,

3 -- 
Ãw
 
–em’t
 
is
 
©
 
	gËá
, 
Şd
ƒËm’ˆi © 
	gright


4 -- 
beÿu£
 
»dis
 
has
 
no
 
»v”£ly
 
»Œ›ve
 
m‘hod
 
Ú
 
li¡


5 
	$moduË
(..., 
·ckage
.
£—Î
)

7 
loÿl
 
Li¡
 = 
»quœe
 'lglib.list'

8 
loÿl
 
rdli¡
 = 
»quœe
 'bamboo.redis.list'

9 
loÿl
 
db
 = 
BAMBOO_DB


11 
funùiÚ
 
	$§ve
 (
key
, 
tbl
, 
Ëngth
)

13 
’d


15 
funùiÚ
 
	$upd©e
 (
key
, 
tbl
, 
Ëngth
)

17 
’d


19 
funùiÚ
 
	$push
 (
key
, 
v®
, 
Ëngth
)

20 
loÿl
 
Ën
 = 
db
:
	$Î’
(
key
)

22 
Ën
 < 
Ëngth
 
th’


23 
db
:
	$Íush
(
key
, 
v®
)

25 -- 
FIFO
 
is
 
fuÎ
, 
push
 
this
 
–em’t
 
äom
 
Ëá
, 
pİ
 
Úe
 
Şd
 from 
right


26 
db
:
	$½İ
(
key
)

27 
db
:
	$Íush
(
key
, 
v®
)

28 
’d


30 
’d


32 
funùiÚ
 
	$pİ
Ğ
key
 )

34  
rdli¡
.
	$pİ
(
key
)

35 
’d


37 
funùiÚ
 
	$»move
Ğ
key
, 
v®
 )

39  
rdli¡
.
	$»move
(
key
, 
v®
)

40 
’d


42 
funùiÚ
 
	$»Œ›ve
Ğ
key
 )

44  
rdli¡
.
	$»Œ›ve
(
key
)

45 
’d


47 
funùiÚ
 
	$Ën
Ğ
key
 )

49  
rdli¡
.
	$Ën
(
key
)

50 
’d


52 
funùiÚ
 
	$d–
Ğ
key
 )

54  
rdli¡
.
	$d–
(
key
)

55 
’d


57 
funùiÚ
 
	$çked–
(
key
)

58  
db
:
	`»Çme
(
key
, 'DELETED:' + key)

59 
’d


61 
funùiÚ
 
	$has
(
key
, 
obj
)

62  
rdli¡
.
	$have
(
key
, 
obj
)

63 
’d


	@src/redis/hash.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
db
 = 
BAMBOO_DB


5 --- 
ü—‹
 
a
 
li¡


7 
funùiÚ
 
	`§ve
Ğ
key
, 
tbl
 )

8 -- 
exi¡
, 
»move
 
™
 
fœ¡


9 
db
:
	$exi¡s
(
key
è
th’


10 
db
:
	$d–
(
key
)

11 
’d


13 -- 
push
 
®l
 
–em’ts
 
š
 
tbl
 
to
 
»dis
 
hash


14 
k
, 
v
 
š
 
	$·œs
(
tbl
) do

15 
db
:
	`h£t
(
key
, 
k
, 
	$to¡ršg
(
v
))

16 
’d


17 
’d


19 --- 
upd©e
 
a
 
li¡


21 
funùiÚ
 
	$upd©e
Ğ
key
, 
tbl
 )

22 
k
, 
v
 
š
 
	$·œs
(
tbl
) do

23 
db
:
	`h£t
(
key
, 
k
, 
	$to¡ršg
(
v
))

24 
’d


25 
’d


27 
funùiÚ
 
	$»Œ›ve
Ğ
key
 )

28  
db
:
	$hg‘®l
(
key
)

29 
’d


31 -- 
š
 
hash
 
¡Üe
, 
·s£d
 
što
 
add
 
funùiÚ
 
should
 
be
 
a
 
bË


32 -- 
such
 
as
 { 
good
 = 
Œue
 
	}
}

33 
funùiÚ
 
	$add
Ğ
key
, 
tbl
 )

34 
	$upd©e
(
key
, 
tbl
)

35 
’d


37 -- 
š
 
hash
 
¡Üe
, 
·s£d
 
što
 
»move
 
funùiÚ
 
should
 
be
 
a
 
bË


38 -- 
»move
 
aùiÚ
 
wl
 
check
 
the
 
key
 
ªd
 
v®ue
'sƒquality before„eal deletion

39 
funùiÚ
 
	$»move
(
key
, 
tbl
)

40 
k
, 
v
 
š
 
	$·œs
(
tbl
) do

41 
db
:
	`hg‘
(
key
, 
k
è=ğ
	$to¡ršg
(
v
è
th’


42 
db
:
	$hd–
(
key
, 
k
)

43 
’d


44 
’d


45 
’d


47 
funùiÚ
 
	$has
(
key
, 
keytocheck
)

48 
db
:
	$hg‘
(
key
, 
keytocheck
è
th’


49  
Œue


51  
çl£


52 
’d


53 
’d


55 
funùiÚ
 
	$num
(
key
)

56  
db
:
	$hËn
(
key
)

57 
’d


	@src/redis/list.lua

1 -- 
w­³r
 
to
 
»dis
 
li¡
 
	g¡ruùu»


2 -- 
Ãw
 
is
 
©
 
	gright
, 
Şd
 i © 
Ëá


3 
	$moduË
(..., 
·ckage
.
£—Î
)

5 
loÿl
 
db
 = 
BAMBOO_DB


6 
loÿl
 
Li¡
 = 
»quœe
 'lglib.list'

8 --- 
ü—‹
 
a
 
li¡


10 
funùiÚ
 
	`§ve
Ğ
key
, 
tbl
 )

11 -- 
exi¡
, 
»move
 
™
 
fœ¡


12 
db
:
	$exi¡s
(
key
è
th’


13 
db
:
	$d–
(
key
)

14 
’d


16 -- 
push
 
®l
 
–em’ts
 
š
 
tbl
 
to
 
»dis
 
li¡


17 
_
, 
v
 
š
 
	$aœs
(
tbl
) do

18 
db
:
	`½ush
(
key
, 
	$to¡ršg
(
v
))

19 
’d


21 
’d


23 --- 
upd©e
 
a
 
li¡


25 
funùiÚ
 
	$upd©e
Ğ
key
, 
tbl
 )

27 
loÿl
 
li¡
 = 
db
:
	`Ìªge
(
key
, 0, -1)

29 #li¡ =ğ0 
th’
 
	$§ve
(
key
, 
tbl
è
’d


31 #li¡ >ğ#tbÈ
th’


32 
i
, 
v
 
š
 
	$aœs
(
tbl
) do

33 
li¡
[
i
] ~ğ
v
 
th’


34 -- 
upd©e
 
difã»Á
 
–em’ts


35 
db
:
	`l£t
(
key
, 
i
 - 1, 
	$to¡ršg
(
v
))

36 
’d


37 
’d


38 -- 
»move
 
»¡
 
–em’ts


39 
loÿl
 
d–
 = #list - #tbl

40 
i
 = 1, 
d–
 do

41 
db
:
	$½İ
(
key
)

42 
’d


44 
i
, 
v
 
š
 
	$aœs
(
li¡
) do

45 
tbl
[
i
] ~ğ
v
 
th’


46 
db
:
	`l£t
(
key
, 
i
 - 1, 
	$to¡ršg
(
tbl
[
i
]))

47 
’d


48 
’d


50 -- 
push
 
mÜe
 
–em’ts


51 
loÿl
 
d–
 = #tbl - #list

52 
i
 = 1, 
d–
 do

53 
db
:
	`½ush
(
key
, 
	`to¡ršg
(
tbl
[#li¡ + 
i
]))

54 
’d


55 
’d


56 
’d


58 
funùiÚ
 
	`»Œ›ve
Ğ
key
 )

59 -- 
no
 
–em’t
 
exi¡s
,  
em±y
 
li¡


60  
	`Li¡
(
db
:
	`Ìªge
(
key
, 0, -1))

61 
’d


63 
funùiÚ
 
	`­³nd
Ğ
key
, 
v®
 )

64 -- 
have
 
no
, 
ü—‹
 
Úe


65 -- 
have
, 
­³nd
 
to
 
™


66  
db
:
	`½ush
(
key
, 
	$to¡ršg
(
v®
))

67 
’d


69 
funùiÚ
 
	$´•’d
Ğ
key
, 
v®
 )

70  
db
:
	`Íush
(
key
, 
	$to¡ršg
(
v®
))

71 
’d


73 
funùiÚ
 
	$pİ
Ğ
key
 )

74  
db
:
	$½İ
(
key
)

75 
’d


77 
funùiÚ
 
	$»move
Ğ
key
, 
v®
 )

79  
db
:
	$Ìem
(
key
, 0, 
v®
)

80 
’d


82 
funùiÚ
 
	$»moveByIndex
Ğ
key
, 
šdex
 )

83 
loÿl
 
–em
 = 
db
:
	$lšdex
(
key
, 
šdex
)

84 
–em
 
th’


85  
db
:
	$Ìem
(
key
, 0, 
–em
)

86 
’d


88  
n


89 
’d


91 
funùiÚ
 
	$Ën
Ğ
key
 )

93  
db
:
	$Î’
(
key
)

94 
’d


96 
funùiÚ
 
	$d–
Ğ
key
 )

98  
db
:
	$d–
(
key
)

99 
’d


101 
funùiÚ
 
	$has
(
key
, 
obj
)

102 
loÿl
 
Ën
 = 
db
:
	$Î’
(
key
)

103 
i
 = 0, 
Ën
-1 do

104 
loÿl
 
–em
 = 
db
:
	$lšdex
(
i
)

105 
obj
 =ğ
–em
 
th’


106  
Œue


107 
’d


108 
’d


110  
çl£


111 
’d


	@src/redis/set.lua

1 
loÿl
 
	gLi¡
 = 
»quœe
 'lglib.list'

3 
	$moduË
(..., 
·ckage
.
£—Î
)

6 
loÿl
 
db
 = 
BAMBOO_DB


8 -- @
·¿m
 
tbl
: 
a
 
memb”
 
li¡


9 
funùiÚ
 
	$§ve
(
key
, 
tbl
)

10 
_
, 
v
 
š
 
	$aœs
(
tbl
) do

11 
db
:
	`§dd
(
key
, 
	$to¡ršg
(
v
))

12 
’d


13 
’d


15 
funùiÚ
 
	$upd©e
(
key
, 
tbl
)

16 
	$§ve
(
key
, 
tbl
)

17 
’d


20 
funùiÚ
 
	$add
Ğ
key
, 
v®
 )

22  
db
:
	$§dd
(
key
, 
v®
)

23 
’d


26 
funùiÚ
 
	$»Œ›ve
Ğ
key
 )

28  
	`Li¡
(
db
:
	$smemb”s
(
key
))

29 
’d


31 
funùiÚ
 
	$»move
Ğ
key
, 
v®
 )

33  
db
:
	$¤em
(
key
, 
v®
)

34 
’d


36 
funùiÚ
 
	$num
Ğ
key
 )

38  
db
:
	$sÿrd
(
key
)

39 
’d


41 
funùiÚ
 
	$d–
Ğ
key
 )

43  
db
:
	$d–
(
key
)

44 
’d


46 
funùiÚ
 
	$has
(
key
, 
obj
)

48  
db
:
	`sismemb”
(
key
, 
	$to¡ršg
(
obj
))

49 
’d


	@src/redis/string.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

4 
loÿl
 
db
 = 
BAMBOO_DB


6 -- @
·¿m
 
tbl
: 
a
 
memb”
 
li¡


7 
funùiÚ
 
	$§ve
(
key
, 
v®
)

8 
db
:
	$£t
(
key
, 
v®
)

9 
’d


11 
upd©e
 = 
§ve


12 
add
 = 
§ve


14 
funùiÚ
 
	$»Œ›ve
(
key
)

15  
db
:
	$g‘
(
key
)

16 
’d


18 
funùiÚ
 
	$»move
(
key
, 
v®
)

19  
db
:
	`£t
(
key
, '')

20 
’d


22 
funùiÚ
 
	$num
Ğ
key
 )

24 
’d


26 
funùiÚ
 
	$d–
Ğ
key
 )

27  
db
:
	$d–
(
key
)

28 
’d


30 
funùiÚ
 
	$has
(
key
, 
obj
)

31  
db
:
	`g‘
(
key
è=ğ
obj


32 
’d


	@src/redis/zfifo.lua

3 
	$moduË
(..., 
·ckage
.
£—Î
)

5 
loÿl
 
Li¡
 = 
»quœe
 'lglib.list'

6 
loÿl
 
rdz£t
 = 
»quœe
 'bamboo.redis.zset'

7 
loÿl
 
db
 = 
BAMBOO_DB


9 
funùiÚ
 
	$§ve
()

10 
’d


12 
funùiÚ
 
	$upd©e
()

13 
’d


16 
funùiÚ
 
	$push
Ğ
key
, 
v®
, 
Ëngth
 )

18 
loÿl
 
n
 = 
db
:
	$zÿrd
(
key
)

19 
n
 < 
Ëngth
 
th’


20 
n
 =ğ0 
th’


21 
db
:
	$zadd
(
key
, 1, 
v®
)

23 
loÿl
 
Ï¡scÜe
 = 
db
:
	`z¿nge
(
key
, -1, -1, 'withscores')[1][2]

24 
db
:
	`zadd
(
key
, 
Ï¡scÜe
 + 1, 
v®
)

25 
’d


27 -- 
g‘
 
the
 
Ï¡
 
	`–em’t
 ([1]) 's score ([2])

28 
loÿl
 
Ï¡scÜe
 = 
db
:
	`z¿nge
(
key
, -1, -1, 'withscores')[1][2]

30 -- 
»move
 
the
 
Şde¡
 
Úe


31 
db
:
	`z»m¿ngeby¿nk
(
key
, 0, 0)

32 -- 
add
 
the
 
Ãw
 
Úe


33 
db
:
	`zadd
(
key
, 
Ï¡scÜe
 + 1, 
v®
)

34 
’d


36 
’d


38 
funùiÚ
 
	$pİ
Ğ
key
 )

39 
loÿl
 
n
 = 
db
:
	$zÿrd
(
key
)

41 
n
 >ğ1 
th’


43 
loÿl
 
™
 = 
db
:
	`z¿nge
(
key
, 0, 0, 'withscores')[1]

44 
loÿl
 
scÜe
 = 
™
[2]

45 
db
:
	$z»m¿ngeby¿nk
(
key
, 0, 0)

46  
scÜe


48  
n


49 
’d


50 
’d


52 
funùiÚ
 
	$»move
Ğ
key
, 
v®
 )

53  
rdz£t
.
	$»move
(
key
, 
v®
)

54 
’d


56 
funùiÚ
 
	$»moveByScÜe
(
key
, 
scÜe
)

57  
rdz£t
.
	$»moveByScÜe
(
key
, 
scÜe
)

58 
’d


61 
funùiÚ
 
	`»Œ›ve
Ğ
key
 )

62 -- 
»v”£
 
g‘


64  
	`Li¡
(
db
:
	`z»v¿nge
(
key
, 0, -1))

65 
’d


67 
funùiÚ
 
	`»Œ›veW™hScÜes
(
key
)

68 -- 
ev”y
 
–em’t
, [1] 
is
 
v®
, [2] i 
scÜe


69  
	`Li¡
(
db
:
	`z»v¿nge
(
key
, 0, -1, 'withscores'))

70 
’d


72 
funùiÚ
 
	$num
Ğ
key
 )

74  
rdz£t
.
	$num
(
key
)

75 
’d


77 
funùiÚ
 
	$d–
Ğ
key
 )

79  
rdz£t
.
	$d–
(
key
)

80 
’d


82 
funùiÚ
 
	$çked–
(
key
)

83  
db
:
	`»Çme
(
key
, 'DELETED:' + key)

84 
’d


86 
funùiÚ
 
	$has
(
key
, 
obj
)

88  
rdz£t
.
	$have
(
key
, 
obj
)

89 
’d


	@src/redis/zset.lua

1 
loÿl
 
	gLi¡
 = 
»quœe
 'lglib.list'

3 
	$moduË
(..., 
·ckage
.
£—Î
)

6 
loÿl
 
db
 = 
BAMBOO_DB


8 
funùiÚ
 
	$§ve
(
key
, 
tbl
, 
scÜes
)

9 
db
:
	$d–
(
key
)

10 
nÙ
 
scÜes
 
th’


11 
loÿl
 
n
 = 0

12 
_
, 
v
 
š
 
	$aœs
(
tbl
) do

13 
db
:
	`zadd
(
key
, 
n
 + 1, 
	$to¡ršg
(
v
))

14 
n
 =‚ + 1

15 
’d


17 
	`checkTy³
(
scÜes
, 'table')

18 
	`as£¹
(#val == #scores, '[Error]he†engths of val‡nd scores‡re‚otƒqual.')

20 
i
, 
v
 
š
 
	$aœs
(
tbl
) do

21 
loÿl
 
scÜe
 = 
scÜes
[
i
]

22 
	`as£¹
(
	`ty³
(
	`tÚumb”
(
scÜe
)) == 'number', '[Error] Some score in score†ist is‚ot‚umber.')

23 
db
:
	`zadd
(
key
, 
scÜe
, 
	$to¡ršg
(
v
))

24 
’d


25 
’d


26 
’d


28 
funùiÚ
 
	$upd©e
(
key
, 
tbl
)

29 
loÿl
 
n
 = 
db
:
	$zÿrd
(
key
)

31 
_
, 
v
 
š
 
	$aœs
(
tbl
) do

32 
db
:
	`zadd
(
key
, 
n
 + 1, 
	$to¡ršg
(
v
))

33 
n
 =‚ + 1

34 
’d


35 
’d


39 
funùiÚ
 
	$add
Ğ
key
, 
v®
, 
scÜe
 )

40 
loÿl
 
oscÜe
 = 
db
:
	`zscÜe
(
key
, 
v®
)

41 -- 
is
 
exi¡
, dØ
nÙhšg
, 
»dis
 
wl
 
upd©e
 
the
 
scÜe
 
of
 
v®


42 
oscÜe
 
th’
  
n
 
’d


44 
nÙ
 
scÜe
 
th’


45 -- 
g‘
 
the
 
cu¼’t
 
–em’t
 
š
 
z£t


46 
loÿl
 
n
 = 
db
:
	$zÿrd
(
key
)

47 
n
 =ğ0 
th’


48 
db
:
	$zadd
(
key
, 1, 
v®
)

50 
loÿl
 
Ï¡scÜe
 = 
db
:
	`z¿nge
(
key
, -1, -1, 'withscores')[1][2]

51 -- 
give
 
the
 
Ãw
 
added
 
–em’t
 
scÜe
 
n
+1

52 
db
:
	`zadd
(
key
, 
Ï¡scÜe
 + 1, 
v®
)

53 
’d


55 
	`checkTy³
(
scÜe
, 'number')

56 
db
:
	$zadd
(
key
, 
scÜe
, 
v®
)

57 
’d


59 --  
the
 
scÜe


60  
db
:
	$zscÜe
(
key
, 
v®
)

61 
’d


64 
funùiÚ
 
	`»Œ›ve
Ğ
key
 )

66 -- 
Úly
 
have
 
memb”s
, 
no
 
scÜes


67  
	`Li¡
(
db
:
	`z¿nge
(
key
, 0, -1))

68 
’d


70 
funùiÚ
 
	$»Œ›veRev”£ly
Ğ
key
 )

71  
	`Li¡
(
db
:
	`z»v¿nge
(
key
, 0, -1))

72 
’d


74 
funùiÚ
 
	`»Œ›veW™hScÜes
Ğ
key
 )

75 -- [1] 
is
 
memb”
, [2] i 
scÜe


76  
	`Li¡
(
db
:
	`z¿nge
(
key
, 0, -1, 'withscores'))

77 
’d


79 
funùiÚ
 
	`»Œ›veRev”£lyW™hScÜes
Ğ
key
 )

80 -- [1] 
is
 
memb”
, [2] i 
scÜe


81  
	`Li¡
(
db
:
	`z»v¿nge
(
key
, 0, -1, 'withscores'))

82 
’d


84 
funùiÚ
 
	$»move
Ğ
key
, 
v®
 )

85  
db
:
	$z»m
(
key
, 
v®
)

86 
’d


88 
funùiÚ
 
	$»moveByScÜe
(
key
, 
scÜe
)

89  
db
:
	$z»m¿ngebyscÜe
(
key
, 
scÜe
, score)

90 
’d


92 
funùiÚ
 
	$num
Ğ
key
 )

94  
db
:
	$zÿrd
(
key
)

95 
’d


97 
funùiÚ
 
	$d–
Ğ
key
 )

99  
db
:
	$d–
(
key
)

100 
’d


102 
funùiÚ
 
	$çked–
(
key
)

103  
db
:
	`»Çme
(
key
, 'DELETED:' + key)

104 
’d


106 
funùiÚ
 
	$has
(
key
, 
obj
)

108 
loÿl
 
scÜe
 = 
db
:
	`zscÜe
(
key
, 
	$to¡ršg
(
obj
))

110  (
scÜe
 ~ğ
n
)

111 
’d


	@src/session.lua

2 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
»quœe
 'md5'

4 
»quœe
 'posix'

6 
loÿl
 
UUID_TYPE
 = 'random'

7 
loÿl
 
PID
 = 
	`tÚumb”
(
posix
.
	`g‘pid
().
pid
)

8 
loÿl
 
HOSTID
 = 
posix
.
	$ho¡id
()

9 
loÿl
 
RNG_BYTES
 = 8 -- 64 
b™s
 
of
 
¿ndomÃss
 
should
 
be
 
good


10 
loÿl
 
RNG_DEVICE
 = '/dev/urandom'

12 
loÿl
 
rdli¡
 = 
»quœe
 'bamboo.redis.list'

13 
loÿl
 
rd£t
 = 
»quœe
 'bamboo.redis.set'

14 
loÿl
 
rdz£t
 = 
»quœe
 'bamboo.redis.zset'

15 
loÿl
 
rdfifo
 = 
»quœe
 'bamboo.redis.fifo'

16 
loÿl
 
rdzfifo
 = 
»quœe
 'bamboo.redis.zfifo'

17 
loÿl
 
rdhash
 = 
»quœe
 'bamboo.redis.hash'

19 
loÿl
 
db
 = 
BAMBOO_DB


20 -- 
Thouge
 
SessiÚ
 
is
 
nÙ
 
a
 
mod–
, 
but
 
we
 
u£
 mod– 
way
 
to
 
´oûss
 
™


21 
loÿl
 
PREFIX
 = 'Session:'

25 
loÿl
 
makeRNG
 = 
	$funùiÚ
 ()

26 
posix
.
	$acûss
(
RNG_DEVICE
è
th’


27 
loÿl
 
u¿ndom
 = 
	`as£¹
(
io
.
	$İ’
(
RNG_DEVICE
))

29  
	$funùiÚ
()

30  
md5
.
	`sumhexa
(('%s%s%s%s'):
	`fÜm©
(
u¿ndom
:
	`»ad
(
RNG_BYTES
), 
os
.
	`time
(), 
PID
, 
HOSTID
))

31 
’d


33 
	`´št
(("WARNING! YOU DO NOT HAVE %s.\ÀYou¸£ssiÚ key ¬’'ˆv”y secu»."):
	$fÜm©
(
RNG_DEVICE
))

34 
m©h
.
	`¿ndom£ed
(
os
.
	`time
(è+ 
PID
 + 
HOSTID
)

36  
	$funùiÚ
()

37  
md5
.
	`sumhexa
(('%s%s%s%s'):
	`fÜm©
(
	`to¡ršg
(
m©h
.
	`¿ndom
()), 
os
.
	`time
(), 
PID
, 
HOSTID
))

38 
’d


39 
’d


40 
’d


42 
loÿl
 
RNG
 = 
	$makeRNG
()

44 
loÿl
 
makeSessiÚId
 = 
	$funùiÚ
 ()

45  ('%s%s'):
	`fÜm©
('APP-', 
	$RNG
())

46 
’d


49 
loÿl
 
makeExpœes
 = 
	$funùiÚ
 (
£cÚds
)

50  
os
.
	`d©e
("%a, %d-%b-%Y %X GMT", os.
	`time
(è+ 
£cÚds
)

51 
’d


54 
loÿl
 
makeSessiÚCook›
 = 
	$funùiÚ
 (
id’t
, 
£cÚds
)

55  ('£ssiÚ=%s; v”siÚ=1;…©h=/;ƒxpœes=%s'):
	`fÜm©
(

56 (
id’t
 
Ü
 
	`makeSessiÚId
()), 
£cÚds
 
ªd
 
	$makeExpœes
(
£cÚds
è
Ü
 ''è--
	$makeExpœes
(
£cÚds
)

57 
’d


59 
loÿl
 
funùiÚ
 
	$·r£SessiÚId
 (
cook›
)

60 
nÙ
 
cook›
 
th’
  
n
 
’d


62  
cook›
:
	`m©ch
('session=(APP%-[a-z0-9%-]+);?.*$')

63 
’d


66 --- 
to
 
jsÚ
 
fÜm©
 
»que¡


67 -- @: 
£ssiÚ
 
id’tif›r


69 
loÿl
 
mªuSessiÚIdJsÚ
 = 
	$funùiÚ
 (
»q
)

70 
loÿl
 
id’t
 = 
»q
.
d©a
.
£ssiÚ_id


72 
nÙ
 
id’t
 
th’


73 
id’t
 = 
	$makeSessiÚId
()

74 
»q
.
d©a
.
£ssiÚ_id
 = 
id’t


75 
’d


77 
»q
.
£ssiÚ_id
 = 
id’t


78  
id’t


79 
’d


82 --- 
to
 
h‰p
 
fÜm©
 
»que¡


83 -- @: 
£ssiÚ
 
id’tif›r


85 
loÿl
 
mªuSessiÚIdH‰p
 = 
	$funùiÚ
 (
»q
)

86 
loÿl
 
id’t
 = 
	`·r£SessiÚId
(
»q
.
h—d”s
['cookie'])

88 
nÙ
 
id’t
 
th’


89 
id’t
 = 
	$makeSessiÚId
()

90 
loÿl
 
cook›
 = 
	$makeSessiÚCook›
(
id’t
, 
bamboo
.
cÚfig
.
expœ©iÚ
)

92 
»q
.
h—d”s
['£t-cook›'] = 
cook›


93 
»q
.
h—d”s
['cook›'] = 
cook›


96 
bamboo
.
cÚfig
.
expœ©iÚ
 
th’


97 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + 
id’t


98 
loÿl
 
cu¡om_expœ©iÚ
 = 
n


99 
bamboo
.
cÚfig
.
İ’_cu¡om_expœ©iÚ
 
th’


100 
cu¡om_expœ©iÚ
 = 
db
:
	`hg‘
(
£ssiÚ_key
, 'expiration')

101 
’d


103 
bamboo
.
cÚfig
.
»Ïtive_expœ©iÚ
 
th’


104 -- 
»Ïtive
 
expœ©iÚ
, 
we
 
Ãed
 
k“p
 
the
ƒxpœ©iÚ 
f›ld
 
š
 
£ssiÚ
, 
have


105 -- 
upd©e
 
the
 
§me
 
cook›
 
ªd
 
£ssiÚ
 
ev”y
 
vis™


106 
loÿl
 
cook›
 = 
	$makeSessiÚCook›
(
id’t
, 
cu¡om_expœ©iÚ
 
Ü
 
bamboo
.
cÚfig
.
expœ©iÚ
)

107 
»q
.
h—d”s
['£t-cook›'] = 
cook›


108 
»q
.
h—d”s
['cook›'] = 
cook›


111 -- 
absŞu‹
 
expœ©iÚ


112 
cu¡om_expœ©iÚ
 
th’


113 
loÿl
 
cook›
 = 
	$makeSessiÚCook›
(
id’t
, 
cu¡om_expœ©iÚ
)

114 
»q
.
h—d”s
['£t-cook›'] = 
cook›


115 
»q
.
h—d”s
['cook›'] = 
cook›


116 -- 
ş—r
 
the
 
cu¡om
 
expœ©iÚ
 
æag
, 
absŞu‹
ƒxpœ©iÚ, 
we
 
Úly
 
Ãed
 
™
 
Úû


117 
db
:
	`hd–
(
£ssiÚ_key
, 'expiration')

118 
’d


119 
’d


120 
’d


121 
’d


123 
»q
.
£ssiÚ_id
 = 
id’t


124  
id’t


125 
’d


127 
loÿl
 
£tSŒuùu»
 = 
	$funùiÚ
 (
£ssiÚ_key
, 
k
, 
v
, 
¡
)

128 
loÿl
 
ext_key
 = ("%s:%s:%s"):
	$fÜm©
(
£ssiÚ_key
, 
k
, 
¡
)

130 
¡
 =ğ'li¡' 
th’


131 
rdli¡
.
	$§ve
(
ext_key
, 
v
)

132 
db
:
	`h£t
(
£ssiÚ_key
, 
k
, "__list__")

133 
–£if
 
¡
 =ğ'£t' 
th’


134 
rd£t
.
	$§ve
(
ext_key
, 
v
)

135 
db
:
	`h£t
(
£ssiÚ_key
, 
k
, "__set__")

136 
–£if
 
¡
 =ğ'z£t' 
th’


137 
rdz£t
.
	$§ve
(
ext_key
, 
v
)

138 
db
:
	`h£t
(
£ssiÚ_key
, 
k
, "__zset__")

140 
	`”rÜ
("[Error] @Session:setKey - st must be one of 'string', 'list', 'set' or 'zset'")

141 
’d


143 
’d


145 -- 
g‘
 
the
 
¡ruùu»
 
v®ue
 
accÜdšg
 
to
 
¡ršg
 
ag’t


146 
loÿl
 
g‘SŒuùu»
 = 
	$funùiÚ
 (
£ssiÚ_key
, 
k
, 
v
)

147 
loÿl
 
ext_key


148 
loÿl
 
ext_v®
 = 
v


149 
v
 =ğ"__li¡__" 
th’


150 
ext_key
 = ("%s:%s:li¡"):
	$fÜm©
(
£ssiÚ_key
, 
k
)

151 
ext_v®
 = 
rdli¡
.
	$»Œ›ve
(
ext_key
)

152 
–£if
 
v
 =ğ"__£t__" 
th’


153 
ext_key
 = ("%s:%s:£t"):
	$fÜm©
(
£ssiÚ_key
, 
k
)

154 
ext_v®
 = 
rd£t
.
	$»Œ›ve
(
ext_key
)

155 
–£if
 
v
 =ğ"__z£t__" 
th’


156 
ext_key
 = ("%s:%s:z£t"):
	$fÜm©
(
£ssiÚ_key
, 
k
)

157 
ext_v®
 = 
rdz£t
.
	$»Œ›ve
(
ext_key
)

158 
’d


160  
ext_v®


161 
’d


164 
loÿl
 
SessiÚ


165 
SessiÚ
 = 
Objeù
:
ex‹nd
 {

166 
__g
 = 'Object.Session';

167 --
__Çme
 = 'Session';

168 -- 
nÙhšg
 
to
 do

169 
š™
 = 
	`funùiÚ
 (
£lf
è s–à
’d
;

171 
£t
 = 
	`funùiÚ
 (
£lf
)

172 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + 
»q
.
£ssiÚ_id


173 
nÙ
 
db
:
	`hexi¡s
(
£ssiÚ_key
, '£ssiÚ_id'è
th’


174 
db
:
	`h£t
(
£ssiÚ_key
, '£ssiÚ_id', 
»q
.
£ssiÚ_id
)

175 
’d


177 
loÿl
 
£ssiÚ
 = 
db
:
	`hg‘®l
(
£ssiÚ_key
)

178 
k
, 
v
 
š
 
	`·œs
(
£ssiÚ
) do

179 
£ssiÚ
[
k
] = 
	`g‘SŒuùu»
(
£ssiÚ_key
, k, 
v
)

180 
’d


181 -- 
š
 
£ssiÚ
, 
we
 
could
 
nÙ
 
u£
 
U£r
 
mod–
 
to
 
»cÜd
 
som‘hšg
,

182 -- 
beÿu£
 
£ssiÚ
 
is
 
low”
 
­i
, 
ªd
 
shouldn
't be†imited‡s User model

183 
£ssiÚ
['u£r_id'] 
th’


184 
loÿl
 
u£r_id
 = 
£ssiÚ
['user_id']

185 
loÿl
 
mod–_Çme
, 
id
 = 
u£r_id
:
	`m©ch
('^(%w+):(%d+)$')

186 
	`as£¹
(
mod–_Çme
 
ªd
 
id
, "[ERROR] Session user_id format is‚ot„ight.")

187 
loÿl
 
mod–
 = 
bamboo
.
	`g‘Mod–ByName
(
mod–_Çme
)

188 
	`as£¹
(
mod–
, "[ERROR] This user model doesn't„egisterd.")

189 -- 
g‘
 
the
 
»®
 
u£r
 
š¡ªû
, 
assign
 
™
 
to
 
»q
.user

190 
»q
['u£r'] = 
mod–
:
	`g‘ById
(
id
)

192 
’d


194 
loÿl
 
expœ©iÚ
 = 
£ssiÚ
.expœ©iÚ 
Ü
 
bamboo
.
cÚfig
.expœ©iÚ o¸bamboo.
SESSION_LIFE


195 
db
:
	`expœe
(
£ssiÚ_key
, 
expœ©iÚ
)

196 
»q
['£ssiÚ'] = 
£ssiÚ


198  
Œue


199 
’d
;

201 
g‘
 = 
	`funùiÚ
 (
£lf
, 
£ssiÚ_id
)

202 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

203 
loÿl
 
£ssiÚ_t
 = 
db
:
	`hg‘®l
(
£ssiÚ_key
)

205 
k
, 
v
 
š
 
	`·œs
(
£ssiÚ_t
) do

206 
£ssiÚ_t
[
k
] = 
	`g‘SŒuùu»
(
£ssiÚ_key
, k, 
v
)

207 
’d


209 
bamboo
.
cÚfig
.
»Ïtive_expœ©iÚ
 
th’


210 
db
:
	`expœe
(
£ssiÚ_key
, 
£ssiÚ_t
.
expœ©iÚ
 
Ü
 
bamboo
.
cÚfig
.expœ©iÚ o¸bamboo.
SESSION_LIFE
)

211 
’d


212  
£ssiÚ_t


213 
’d
;

215 
u£rHash
 = 
	`funùiÚ
 (
£lf
, 
u£r
, 
£ssiÚ_id
)

216 
loÿl
 
u£r_id
 = 
	`fÜm©
("%s:%s", 
u£r
:
	`şas¢ame
(), u£r.
id
)

217 -- 
İ’
 
u£r
 
sšgË
 
logš
 
lim™©iÚ


218 
bamboo
.
cÚfig
.
u£r_sšgË_logš
 
th’


219 
loÿl
 
sid
 = 
db
:
	`hg‘
('_u£rs_£ssiÚs', 
u£r_id
)

220 -- 
logšed
 
befÜe
, 
fÜû
 
to
 
logout
 
™


221 
sid
 
ªd
 sid ~ğ
£ssiÚ_id
 
th’


222 
SessiÚ
:
	`d–
(
sid
)

223 
’d


224 
’d


226 
db
:
	`h£t
('_u£rs_£ssiÚs', 
u£r_id
, 
£ssiÚ_id
)

227 
’d
;

229 
g‘U£rHash
 = 
	`funùiÚ
 (
£lf
, 
u£r
)

230 
loÿl
 
u£r
 = u£¸
Ü
 
»q
.
ue¤


231 
	`as£¹
(
u£r
, '[Error] @Session getUserHash - user is‚il.')

232 
loÿl
 
u£r_id
 = 
	`fÜm©
("%s:%s", 
u£r
:
	`şas¢ame
(), u£r.
id
)

233  
db
:
	`hg‘
('_u£rs_£ssiÚs', 
u£r_id
)

234 
’d
;

236 
d–U£rHash
ğ
	`funùiÚ
 (
£lf
, 
u£r
)

237 
loÿl
 
u£r_id
 = 
	`fÜm©
("%s:%s", 
u£r
:
	`şas¢ame
(), u£r.
id
)

238 
db
:
	`hd–
('_u£rs_£ssiÚs', 
u£r_id
)

239 
’d
;

241 
£tKey
 = 
	`funùiÚ
 (
£lf
, 
key
, 
v®ue
, 
¡
, 
£ssiÚ_id
)

242 
	`checkTy³
(
key
, 'string')

243 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

244 
loÿl
 
¡
 = sˆ
Ü
 'string'

246 
¡
 =ğ'¡ršg' 
th’


247 
	`as£¹
Ğ
	`isNumOrSŒ
(
v®ue
),

249 
db
:
	`h£t
(
£ssiÚ_key
, 
key
, 
v®ue
)

251 
	`£tSŒuùu»
(
£ssiÚ_key
, 
key
, 
v®ue
, 
¡
)

252 
’d


254 
bamboo
.
cÚfig
.
»Ïtive_expœ©iÚ
 
th’


255 
loÿl
 
expœ©iÚ
 = 
db
:
	`hg‘
(
£ssiÚ_key
, 'expœ©iÚ'è
Ü
 
bamboo
.
cÚfig
.expœ©iÚ o¸bamboo.
SESSION_LIFE


256 
db
:
	`expœe
(
£ssiÚ_key
, 
expœ©iÚ
)

257 
’d


259  
Œue


260 
’d
;

262 
g‘Key
 = 
	`funùiÚ
 (
£lf
, 
key
, 
£ssiÚ_id
)

263 
	`checkTy³
(
key
, 'string')

264 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

266 
loÿl
 
ov®ue
 = 
db
:
	`hg‘
(
£ssiÚ_key
, 
key
)

267 
loÿl
 
nv®ue
 = 
	`g‘SŒuùu»
(
£ssiÚ_key
, 
key
, 
ov®ue
)

269 
bamboo
.
cÚfig
.
»Ïtive_expœ©iÚ
 
th’


270 
loÿl
 
expœ©iÚ
 = 
db
:
	`hg‘
(
£ssiÚ_key
, 'expœ©iÚ'è
Ü
 
bamboo
.
cÚfig
.expœ©iÚ o¸bamboo.
SESSION_LIFE


271 
db
:
	`expœe
(
£ssiÚ_key
, 
expœ©iÚ
)

272 
’d


274  
nv®ue


275 
’d
;

277 
d–Key
 = 
	`funùiÚ
 (
£lf
, 
key
, 
£ssiÚ_id
)

278 
	`checkTy³
(
key
, 'string')

279 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

280 
»q
.
£ssiÚ
[
key
] = 
n


282 
bamboo
.
cÚfig
.
»Ïtive_expœ©iÚ
 
th’


283 
loÿl
 
expœ©iÚ
 = 
db
:
	`hg‘
(
£ssiÚ_key
, 'expœ©iÚ'è
Ü
 
bamboo
.
cÚfig
.expœ©iÚ o¸bamboo.
SESSION_LIFE


284 
db
:
	`expœe
(
£ssiÚ_key
, 
expœ©iÚ
)

285 
’d


286  
db
:
	`hd–
(
£ssiÚ_key
, 
key
)

287 
’d
;

289 
d–
 = 
	`funùiÚ
 (
£lf
, 
£ssiÚ_id
)

290 
	`checkTy³
(
£ssiÚ_id
, 'string')

291 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

293  
db
:
	`d–
(
£ssiÚ_key
)

294 
’d
;

296 --- 
ÿlcuÏ‹
 
the
 
£ssiÚ
 
id
 
of
 
a
 
comšg
 
»que¡


297 -- @: 
£ssiÚ
 
id


298 
id’tReque¡
 = 
	`funùiÚ
 (
»q
)

299 
»q
.
h—d”s
.
METHOD
 =ğ"JSON" 
th’


300  
	`mªuSessiÚIdJsÚ
(
»q
)

302  
	`mªuSessiÚIdH‰p
(
»q
)

303 
’d


304 
’d
;

306 
·r£SessiÚId
 =…arseSessionId;

308 -- 
»defše
 
glob®
 
expœ©iÚ
 
·¿m‘”


309 
£tGlob®Expœ©iÚ
 = 
	`funùiÚ
 (
£lf
, 
£cÚds
)

310 
	`checkTy³
(
£cÚds
, 'number')

311 
bamboo
.
cÚfig
.
expœ©iÚ
 = 
£cÚds


312 
’d
;

314 -- 
£t
 
expœ©iÚ
 
—ch
 
£ssiÚ


315 
£tExpœ©iÚ
 = 
	`funùiÚ
 (
£lf
, 
£cÚds
, 
£ssiÚ_id
)

316 
	`as£¹
(
bamboo
.
cÚfig
.
İ’_cu¡om_expœ©iÚ
,

318 
	`as£¹
(
£cÚds
, "[Error] missing…arams seconds.")

319 
loÿl
 
£ssiÚ_key
 = 
PREFIX
 + (
£ssiÚ_id
 
Ü
 
»q
.session_id)

321 
db
:
	`h£t
(
£ssiÚ_key
, 'expœ©iÚ', 
£cÚds
)

322 
db
:
	`expœe
(
£ssiÚ_key
, 
£cÚds
)

323 
’d
;

324 
	}
}

327  
	gSessiÚ


	@src/task.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
IO_THREADS
 = 1

4 
loÿl
 
zmq
 = 
»quœe
 'zmq'

6 -- 
sk
 
´oûss
 
maš
 
loİ


7 
funùiÚ
 
	$¡¬t
(
cÚfig
)

8 
	`as£¹
(
cÚfig
.
¥ec
, "You‚eedo‡t†east set spec =o your 0MQ socket spec.")

9 
	`as£¹
(
cÚfig
.
maš
, "You must set‡ main function.")

11 
loÿl
 
ùx
 = 
	`as£¹
(
zmq
.
	$š™
(
cÚfig
.
io_th»ads
 
Ü
 
IO_THREADS
))

12 
loÿl
 
cÚn
 = 
	`as£¹
(
ùx
:
	$sock‘
(
cÚfig
.
sock‘_ty³
 
Ü
 
zmq
.
SUB
))

13 
loÿl
 
maš
 = 
cÚfig
.main

14 
cÚn
:
	`£tİt
(
zmq
.
SUBSCRIBE
, 
cÚfig
.
subsüibe
 
Ü
 '')

15 
cÚn
:
	$bšd
(
cÚfig
.
¥ec
)

17 
cÚfig
.
»cv_id’t
 
th’


18 
cÚn
:
	$£tİt
(
zmq
.
IDENTITY
, 
cÚfig
.
»cv_id’t
)

19 
’d


21 
	`´št
("BACKGROUND TASK " .. 
cÚfig
.
¥ec
 .. " STARTED.")

23 
nÙ
 
cÚfig
.
cu¡om_mašloİ
 
th’


24 
Œue
 do

25 -- 
»ûive
 
d©a
 
äom
 
ş›Á


26 
loÿl
 
d©a
 = 
	`as£¹
(
cÚn
:
	$»cv
())

27 
	$maš
(
cÚn
, 
d©a
)

28 
’d


30 
	$maš
(
cÚn
)

31 
’d


33 
	`´št
('Task main†ooperminated!')

34 
’d


36 -- 
u£d
 
by
 
ş›Á
 
to
 
cÚÃù
 
the
 
sk
 
£rv”


37 
funùiÚ
 
	$cÚÃù
(
cÚfig
)

38 
	`as£¹
(
cÚfig
.
¥ec
, "You‚eedo‡t†east set spec =o your 0MQ socket spec.")

40 
loÿl
 
ùx
 = 
	`as£¹
(
zmq
.
	$š™
(
cÚfig
.
io_th»ads
 
Ü
 
IO_THREADS
))

41 
loÿl
 
cÚn
 = 
	`as£¹
(
ùx
:
	$sock‘
(
cÚfig
.
sock‘_ty³
 
Ü
 
zmq
.
PUB
))

42 
cÚn
:
	$cÚÃù
(
cÚfig
.
¥ec
)

44 
cÚfig
.
£nd_id’t
 
th’


45 
cÚn
:
	$£tİt
(
zmq
.
IDENTITY
, 
cÚfig
.
£nd_id’t
)

46 
’d


48 
loÿl
 
TaskCÚn
 = {

49 
ùx
 = ctx,

50 
cÚn
 = conn,

51 
cÚfig
 = config

52 
	}
}

54 
funùiÚ
 
	gTaskCÚn
:
	$£nd
(
d©a
)

55 
£lf
.
cÚn
:
	$£nd
(
d©a
, 
zmq
.
NOBLOCK
)

56 
’d


58 -- 
cÚn_di¥©ch”
 
is
 
the
  
bamboo
 
cÚÃciÚ
 
di¥©ch”


59 
funùiÚ
 
TaskCÚn
:
	$wa™
()

60 
bamboo
.
pŞËr
:
	`add
(
cÚn
, 
zmq
.
POLLIN
, bamboo.
cÚn_di¥©ch”
)

61 -- 
y›ld
  
d©a
 
äom
 
sk
 
´oûss


62  
cÜoutše
.
	$y›ld
()

63 
’d


65 -- 
	$ÿÎback
(
cÚn
, 
»v’ts
)

66 
funùiÚ
 
TaskCÚn
:
	$£nd_ªd_wa™
(
d©a
, 
ÿÎback
)

67 
£lf
.
cÚn
:
	$£nd
(
d©a
, 
zmq
.
NOBLOCK
)

68 
bamboo
.
pŞËr
:
	$add
(
cÚn
, 
zmq
.
POLLIN
, 
ÿÎback
)

69 
’d


72 
funùiÚ
 
TaskCÚn
:
	$‹rm
()

73 
bamboo
.
SUSPENDED_TASKS
[
cÚn
] = 
n


74 
bamboo
.
pŞËr
:
	$»move
(
cÚn
)

76 
£lf
.
cÚn
:
	$şo£
()

77 
£lf
.
ùx
:
	$‹rm
()

78 
’d


80 -- 
h”e
, 
u£
 
glob®
 
v¬ŸbË
 
web


81 
bamboo
.
SUSPENDED_TASKS
[
cÚn
] = 
web


82  
TaskCÚn


83 
’d


	@src/testing.lua

1 -- 
execu‹
 
the
 
boÙup
 
fe


2 
dofe
('/usr/local/bin/bamboo_handler')

4 
	$moduË
(..., 
·ckage
.
£—Î
)

6 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

7 
loÿl
 
bÜrowed
 = 
bamboo
.
EXPORT_FOR_TESTING


9 
loÿl
 
CONFIG_FILE
 = "settings.lua"

10 
loÿl
 
TEMPLATES
 = "views/"

12 -- 
The£
 
glob®s
 
¬e
 
u£d
 
to
 
im¶em’t
 
çke
 
¡©e
 
»que¡s
.

13 
loÿl
 
SENDER_ID
 = "3ddfbc58-a249-45c9-9446-00b73de18f7c"

14 
loÿl
 
SESSION_ID
 = "d257873dfdc254ff6ff930a1c44aa6a9"

16 
loÿl
 
CONN_ID
 = 1

18 
loÿl
 
RUNNERS
 = {
	}
}

20 
loÿl
 
RESPONSES
 = {}

22 
loÿl
 
DEFAULT_UAGENT
 = "curl/7.19.7 (i486-pc-linux-gnu)†ibcurl/7.19.7 OpenSSL/0.9.8k zlib/1.2.3.3†ibidn/1.15"

24 -- 
This
 
cÚ¡ruùs
 
a
 
çke
 
mÚg»l2
 
cÚÃùiÚ
 
th©
 
®lows
 
ruÂšg


25 -- 
a
 
hªdËr
 
but
 
y›lds
 
to
 
»ûive
‡ 
»que¡
 
ªd
 
¡uffs
 
®l
 
the
 
»¥Ú£s


26 -- 
što
 
RESPONSES
 
Ï‹r
 
š¥eùiÚ
.

27 
loÿl
 
funùiÚ
 
	$makeFakeCÚÃù
(
cÚfig
)

28 
loÿl
 
cÚn
 = {
cÚfig
 = 
	}
config}

30 
funùiÚ
 
	gcÚn
:
	$»cv
()

31 
loÿl
 
»q
 = 
cÜoutše
.
	$y›ld
()

32 
	`as£¹
(
»q
.
h—d”s
.
PATH
:
	`m©ch
(
£lf
.
cÚfig
.
rou‹
), ("[ERROR] Inv®id„eque¡ %q s’ˆtØhªdËr: %q"):
	$fÜm©
(
»q
.
h—d”s
.
PATH
, 
£lf
.
cÚfig
.
rou‹
))

33  
»q


34 
’d


36 
funùiÚ
 
cÚn
:
	$£nd
(
uuid
, 
cÚn_id
, 
msg
)

37 
RESPONSES
[#RESPONSES + 1] = {

38 
ty³
 = "send",

39 
cÚn_id
 = conn_id,

40 
msg
 = msg

41 
	}
}

42 
’d


44 
funùiÚ
 
	gcÚn
:
	$»¶y
(
»q
, 
msg
)

45 
RESPONSES
[#RESPONSES + 1] = {

46 
ty³
 = "reply",

47 
»q
 =„eq,

48 
msg
 = msg

49 
	}
}

50 
’d


52 
funùiÚ
 
	gcÚn
:
	$»¶y_jsÚ
(
»q
, 
d©a
)

53 
RESPONSES
[#RESPONSES + 1] = {

54 
ty³
 = "reply_json",

55 
»q
 =„eq,

56 
d©a
 = data

57 
	}
}

58 
’d


60 
funùiÚ
 
	gcÚn
:
	$»¶y_h‰p
(
»q
, 
body
, 
code
, 
¡©us
, 
h—d”s
)

61 
RESPONSES
[#RESPONSES + 1] = {

62 
ty³
 = "reply_http",

63 
»q
 =„eq,

64 
body
 = body,

65 
code
 = cod
Ü
 200,

66 
¡©us
 = stu 
Ü
 'OK',

67 
h—d”s
 = h—d” 
Ü
 {}

68 
	}
}

69 
’d


71 
funùiÚ
 
	gcÚn
:
	$d–iv”
(
uuid
, 
id’ts
, 
d©a
)

72 
RESPONSES
[#RESPONSES + 1] = {

73 
ty³
 = "deliver",

74 
id’ts
 = idents,

75 
d©a
 = data

76 
	}
}

77 
’d


79 
funùiÚ
 
	gcÚn
:
	$d–iv”_jsÚ
(
uuid
, 
id’ts
, 
d©a
)

80 
RESPONSES
[#RESPONSES + 1] = {

81 
ty³
 = "deliver_json",

82 
id’ts
 = idents,

83 
d©a
 = data

84 
	}
}

85 
’d


87 
funùiÚ
 
	gcÚn
:
	$d–iv”_h‰p
(
uuid
, 
id’ts
, 
body
, 
code
, 
¡©us
, 
h—d”s
)

88 
RESPONSES
[#RESPONSES + 1] = {

89 
ty³
 = "deliver_http",

90 
id’ts
 = idents,

91 
body
 = body,

92 
code
 = cod
Ü
 200,

93 
¡©us
 = stu 
Ü
 'OK',

94 
h—d”s
 = headers

95 
	}
}

96 
’d


98 
funùiÚ
 
	gcÚn
:
	$d–iv”_şo£
(
uuid
, 
id’ts
)

99 
RESPONSES
[#RESPONSES + 1] = {

100 
ty³
 = "deliver_close",

101 
id’ts
 = idents

102 
	}
}

103 
’d


105 
funùiÚ
 
	gcÚn
:
	$şo£
()

106 
CONN_ID
 = CONN_ID + 1

107 
’d


109  
cÚn


110 
’d


112 -- 
R•Ïûs
 
the
 
ba£
 
¡¬t
 
w™h
 
Úe
 
th©
 
ü—‹s
 
a
 
çke
 
m2
 
cÚÃùiÚ
.

113 
loÿl
 
¡¬t
 = 
	$funùiÚ
(
cÚfig
)

114 
loÿl
 
cÚfig
 = cÚfig 
Ü
 
bÜrowed
.
	$upd©eCÚfig
(
cÚfig
, 
CONFIG_FILE
)

116 
cÚfig
.
m‘hods
 = cÚfig.m‘hod 
Ü
 
bÜrowed
.
DEFAULT_ALLOWED_METHODS


118 
cÚfig
.
id’t
 = cÚfig.id’ˆ
Ü
 
bÜrowed
.
deçuÉ_id’t


120 
loÿl
 
cÚn
 = 
	$makeFakeCÚÃù
(
cÚfig
)

122 
loÿl
 
ruÂ”
 = 
cÜoutše
.
	$w¿p
(
bÜrowed
.
run
)

123 
	`ruÂ”
(
cÚn
, 
cÚfig
)

125 -- 
This
 
ruÂ”
 
is
 
u£d
 
Ï‹r
 
to
 
ãed
 
çke
 
»que¡s
Ø
the
 
run
 
loİ
.

126 
RUNNERS
[
cÚfig
.
rou‹
] = 
ruÂ”


127 
’d


129 -- 
Makes
 
çke
 
»que¡s
 
w™h
 
®l
 
the
 
right
 
¡uff
 
š
 
them
.

130 
funùiÚ
 
	$makeFakeReque¡
(
£ssiÚ
, 
m‘hod
, 
·th
, 
qu”y
, 
body
, 
h—d”s
, 
d©a
)

131 
loÿl
 
»q
 = {

132 
cÚn_id
 = 
CONN_ID
,

133 
£nd”
 = 
SENDER_ID
,

134 
·th
 =…ath,

135 
body
 = body 
Ü
 "",

136 
d©a
 = d©¨
Ü
 {},

137 
	}
}

139 
	gm‘hod
 =ğ"JSON" 
th’


140 
»q
.
d©a
.
£ssiÚ_id
 = 
£ssiÚ
.
SESSION_ID


141 
’d


143 
»q
.
h—d”s
 = {

144 
PATTERN
 = 
·th
,

145 
	gMETHOD
 = 
m‘hod
,

146 
	gQUERY
 = 
qu”y
,

147 
	gVERSION
 = "HTTP/1.1",

149 
	gho¡
 = "localhost:6767",

150 
	gPATH
 = 
·th
,

151 ['u£r-ag’t'] = 
DEFAULT_UAGENT
,

152 
	gcook›
 = 
£ssiÚ
.
COOKIE
,

153 
	gURI
 = 
qu”y
 
ªd
 (
·th
 .. '?' .. qu”yè
Ü
…ath,

156 
	gbË
.
upd©e
(
»q
.
h—d”s
, h—d” 
Ü
 {})

158  
»q


159 
’d


162 
funùiÚ
 
	$rou‹Reque¡
(
»q
)

163 
·‰”n
, 
ruÂ”
 
š
 
	$·œs
(
RUNNERS
) do

164 
»q
.
h—d”s
.
PATH
:
	$m©ch
(
·‰”n
è
th’


165  
	$ruÂ”
(
»q
)

166 
’d


167 
’d


169 
	`as£¹
(
çl£
, ("[ERROR] Reque¡ fÜ %q…©h didn'ˆm©ch‡ny†ßded hªdËrs."):
	$fÜm©
(
»q
.
h—d”s
.
PATH
))

170 
’d


173 -- 
S‘s
 
up
 
a
 
çke
 "brow£r" 
th©
 
is
 
u£d
 
š
 
‹¡s
 
to
 
´‘’d
Ø
£nd


174 -- 
ªd
 
»ûive
 
»que¡s
‡nd 
th’
 
ª®yze
 
the
 
»suÉs
. 
It
 
assumes
 
a


175 -- 
¡ršg
 
»que¡
/
»¥Ú£
 
mode
 
of
 
İ”©iÚ
 
ªd
 
wl
 
throw
 
”rÜs
 

176 -- 
th©
's‚ot followed.

177 
funùiÚ
 
	$brow£r
(
Çme
, 
£ssiÚ_id
, 
cÚn_id
)

178 
CONN_ID
 = CONN_ID + 1

180 
loÿl
 
Brow£r
 = {

181 
RESPONSES
 = {},

182 
COOKIE
 = ('£ssiÚ="APP-%s"'):
	`fÜm©
(
£ssiÚ_id
 
Ü
 
SESSION_ID
),

183 
SESSION_ID
 = 
£ssiÚ_id
 
Ü
 SESSION_ID,

184 
Çme
 =‚ame,

185 
	}
}

187 
funùiÚ
 
	gBrow£r
:
	$£nd
(
m‘hod
, 
·th
, 
qu”y
, 
body
, 
h—d”s
, 
d©a
)

188 
	`rou‹Reque¡
(
	$makeFakeReque¡
(
£lf
, 
m‘hod
, 
·th
, 
qu”y
, 
body
, 
h—d”s
, 
d©a
))

190 
loÿl
 
»¥_couÁ
 = #RESPONSES

193 
loÿl
 
»¥
 = 
bË
.
	$»move
(
RESPONSES
)

194 
»¥
.
»q
 
th’


195 
£lf
:
	$exŒaù_cook›
(
»¥
.
»q
.
h—d”s
)

196 
’d


197 
£lf
.
RESPONSES
[#£lf.RESPONSES] = 
»¥


198 
’d


200 
	`as£¹
(
»¥_couÁ
 > 0, ("[ERROR] You¸­¶iÿtiÚ did‚Ù s’d‡„e¥Ú£Ø%q,h©'Î cau£ you¸brow£¸tØ¡®l."):
	$fÜm©
(
·th
))

202 
	`as£¹
(
»¥_couÁ
 =ğ1, ("[ERROR] A„eque¡ fÜ %q s’ˆ%d„e¥Ú£s,h©'Î makthbrow£¸dØ»®ly weœdhšgs."):
	$fÜm©
(
·th
, 
»¥_couÁ
))

204 
’d


206 
funùiÚ
 
Brow£r
:
	$ex³ù
(
Ãeded
)

207 
loÿl
 
Ï¡
 = 
£lf
.
RESPONSES
[#self.RESPONSES]

209 
k
,
v
 
š
 
	$·œs
(
Ï¡
) do

210 
loÿl
 
·‰”n
 = 
Ãeded
[
k
]

212 
·‰”n
 
th’


213 
nÙ
 
	$to¡ršg
(
v
):
	`m©ch
(
	$to¡ršg
(
·‰”n
)è
th’


214 
	`”rÜ
(("[ERROR] [%s] Failedƒxpect: %q did‚ot match %q but was %q:%q"

215 ):
	$fÜm©
(
£lf
.
Çme
, 
k
, 
·‰”n
, 
v
, 
Ï¡
.
body
))

216 
’d


217 
’d


218 
’d


220  
Ï¡


221 
’d


224 
funùiÚ
 
Brow£r
:
	$ex™ed
()

225  
£lf
.
SESSION_ID
 -- 
ªd
 
nÙ
 .
	$g‘_¡©e
(
£lf
.
SESSION_ID
)

226 
’d


228 
funùiÚ
 
Brow£r
:
	$exŒaù_cook›
(
h—d”s
)

229 
loÿl
 
cook›
 = 
h—d”s
['set-cookie']

231 
cook›
 
ªd
 cook› ~ğ
£lf
.
COOKIE
 
th’


232 
£lf
.
COOKIE
 = 
cook›


233 
£lf
.
SESSION_ID
 = 
bÜrowed
.
	$·r£SessiÚId
(
cook›
)

234 
’d


235 
’d


237 
funùiÚ
 
Brow£r
:
	$şick
(
·th
, 
ex³ù
)

238 
£lf
:
	`£nd
("GET", 
·th
)

239  
£lf
:
	`ex³ù
(
ex³ù
 
Ü
 { 
code
 = 200 
	}
})

240 
’d


242 -- 
®Ÿs


243 
Brow£r
.
g‘
 = Brow£r.
şick


245 
funùiÚ
 
Brow£r
:
	$subm™
(
·th
, 
fÜm
, 
ex³ù
, 
h—d”s
)

246 
loÿl
 
fÜm
 = fÜm 
Ü
 {
	}
}

247 
loÿl
 
body
 = 
FÜm
:
	$’code
(
fÜm
)

248 
h—d”s
 = h—d” 
Ü
 {
	}
}

250 
ex³ù
 =ƒx³ù 
Ü
 {
code
 = 200}

251 
nÙ
 
ex³ù
.
code
 
th’
ƒx³ù.codğ200 
’d


253 
h—d”s
['content-type'] = "application/x-www-form-urlencoded"

254 
h—d”s
['content-length'] = #body

256 
£lf
:
£nd
("POST", 
·th
, 
n
, 
body
, 
h—d”s
)

258  
	g£lf
:
	$ex³ù
(
ex³ù
)

259 
’d


261 
Brow£r
.
po¡
 = Brow£r.
subm™


263 
funùiÚ
 
Brow£r
:
	$xhr
(
·th
, 
fÜm
, 
ex³ù
)

264 
loÿl
 
h—d”s
 = {['x-»que¡ed-w™h'] = "XMLH‰pReque¡"
	}
}

265 
	g£lf
:
	$subm™
(
·th
, 
fÜm
, 
h—d”s
)

266  
£lf
:
	`ex³ù
(
ex³ù
 
Ü
 { 
code
 = 200 
	}
})

267 
’d


269 
funùiÚ
 
Brow£r
:
	$qu”y
(
·th
, 
·¿ms
, 
ex³ù
, 
h—d”s
)

270 
loÿl
 
·¿ms
 =…¬am 
Ü
 {
	}
}

271 
loÿl
 
qu”y
 = 
FÜm
:
	$’code
(
·¿ms
)

272 
£lf
:
	`£nd
("GET", 
·th
, 
qu”y
, 
n
, 
h—d”s
)

273  
£lf
:
	`ex³ù
(
ex³ù
 
Ü
 { 
code
 = 200 
	}
})

274 
’d


276 
funùiÚ
 
Brow£r
:
	$ajaxG‘
(
·th
, 
·¿ms
, 
ex³ù
, 
h—d”s
)

277 
loÿl
 
h—d”s
 = {['x-»que¡ed-w™h'] = "XMLH‰pReque¡"
	}
}

278 
loÿl
 
	g»¥
 = 
£lf
:
	$qu”y
(
·th
, 
·¿ms
, 
ex³ù
, 
h—d”s
)

279 
loÿl
 
»s
 = 
jsÚ
.
	$decode
(
»¥
.
body
)

280 
	`checkTy³
(
»s
, 'table')

281  
»s


282 
’d


284 
funùiÚ
 
Brow£r
:
	$ajaxPo¡
(
·th
, 
fÜm
, 
ex³ù
, 
h—d”s
)

285 
loÿl
 
h—d”s
 = {['x-»que¡ed-w™h'] = "XMLH‰pReque¡"
	}
}

286 
loÿl
 
	g»¥
 = 
£lf
:
	$subm™
(
·th
, 
fÜm
, 
ex³ù
, 
h—d”s
)

287 
loÿl
 
»s
 = 
jsÚ
.
	$decode
(
»¥
.
body
)

288 
	`checkTy³
(
»s
, 'table')

289  
»s


290 
’d


293  
Brow£r


294 
’d


297 -- 
h”e
, 
boÙ
 
the
 
‹¡šg
 
£rv”


298 
	`¡¬t
(
bÜrowed
.
cÚfig
)

	@src/util.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	$sim¶eR’d”
(
tm¶_fe
, 
·¿ms
)

4  
	$funùiÚ
 (
web
, 
»q
)

5 
web
:
	$html
(
tm¶_fe
, 
·¿ms
)

6 
’d


7 
’d


9 
funùiÚ
 
	$sim¶eRedœeù
(
ru¾
)

10 
loÿl
 
ruÌ
 = 
ru¾
 
Ü
 '/'

11  
	$funùiÚ
 (
web
, 
»q
)

12 
web
:
	$»dœeù
(
ru¾
)

13 
’d


14 
’d


17 -- 
DEBUG
 
Ëv–
:

18 -- 0, 
nÚe
;

19 -- 1, 
v”bo£
;

20 -- 2, 
d‘aed
;

21 
_G
['DEBUG'] = 
	$funùiÚ
 (...)

23 
loÿl
 
´štout
 = 
	$funùiÚ
 (
Ëv–
, ...)

24 
i
 = 1, 
	`£Ëù
('#', ...) do

25 
loÿl
 
¬g
 = 
	$£Ëù
 (
i
, ...)

26 
	`ty³
(
¬g
è=ğ'bË' 
th’


27 
Ëv–
 >ğ2 
th’


28 
	`´št
(
bË
.
	$Œ“
(
¬g
))

30 
k
, 
v
 
š
 
	$·œs
(
¬g
) do

31 
	$´št
(
k
, 
v
)

32 
’d


33 
’d


35 
	$´št
(
¬g
)

36 
’d


37 
	`´št
('')

38 
’d


39 
’d


41 
loÿl
 
šfo
 = 
debug
.
	`g‘šfo
(2, "nS")

42 
loÿl
 
debug_Ëv–
 = 
bamboo
.
cÚfig
.debug_level

43 
nÙ
 
	$isF®£
(
debug_Ëv–
è
th’


44 
	`´št
('')

45 
	`´št
('-----------------------------------------------')

46 
	`´št
(('DEBUG @%s, @%s, @%s'):
	`fÜm©
(
	`to¡ršg
(
šfo
.
shÜt_¤c
),o¡ršg(šfo.
lšedefšed
), 
	$to¡ršg
(
šfo
.
Çme
)))

47 
	`´št
('...............................................')

49 
loÿl
 
™s_ty³
 = 
	$ty³
(
debug_Ëv–
)

50 
™s_ty³
 =ğ'boŞ—n' 
th’


51 
	$´štout
(2, ...)

52 
–£if
 
™s_ty³
 =ğ'numb”' 
th’


53 
	$´štout
(
debug_Ëv–
, ...)

54 
’d


55 
	`´št
('^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^')

56 
’d


57 
’d


60 
funùiÚ
 
	$»adS‘tšgs
(
cÚfig
)

61 
loÿl
 
cÚfig
 = cÚfig 
Ü
 {
	}
}

62 -- 
Úly
 
suµÜt
 
boÙ
 
š
 
­p
 
dœeùÜy


63 
loÿl
 
home
 = 
os
.
g‘’v
("HOME")

64 
loÿl
 
glob®_cÚfigfe
 = 
lßdfe
(
home
 + '/.bambooconfig')

65 
glob®_cÚfigfe
 
th’


66 
£tãnv
(
as£¹
(
glob®_cÚfigfe
), 
cÚfig
)()

68 
	g´št
 [[

69 [
E¼Ü
] 
You
 
should
 
make
 
su»
 
the
 
exi¡ªû
 
	gof
 ~/.
bamboocÚfig


71 
You
 
ÿn
 
	gu£
:

72 
bamboo
 
cÚfig
 -
mÚ£rv”_dœ
 
your_mÚ£rv”_dœ


73 
bamboo
 
cÚfig
 -
bamboo_dœ
 
your_bamboo_dœ


75 
to
 
ü—‹
 
this
 
cÚfig
 
fe
. 
Good
 
Luck
.

77 
os
.
	$ex™
()

78 
’d


80 -- 
Œy
 
to
 
lßd
 
£‰šgs
.
lua


81 
loÿl
 
£‰šg_fe
 = 
	`lßdfe
('£‰šgs.lua'è
Ü
†oadfile('../settings.lua')

82 
£‰šg_fe
 
th’


83 
	`£tãnv
(
	`as£¹
(
£‰šg_fe
), 
cÚfig
)()

84 
’d


85 
cÚfig
.
bamboo_dœ
 = cÚfig.bamboo_dœ 
Ü
 '/usr/local/share/lua/5.1/bamboo/'

87 -- 
check
 
wh‘h”
 
have
 
a
 
glob®
 
´oduùiÚ
 
£‰šg


88 
loÿl
 
´oduùiÚ
 = 
	`lßdfe
('/etc/bamboo_production')

89 
´oduùiÚ
 
th’


90 
cÚfig
.
PRODUCTION
 = 
Œue


91 
’d


93  
cÚfig


94 
’d


	@src/view.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

2 
loÿl
 
lg¡ršg
 = 
»quœe
 "lgstring"

5 
loÿl
 
funùiÚ
 
	$g‘loÿls
(
cÚ‹xt
, 
d•th
)

6 
loÿl
 
i
 = 1

7 
Œue
 do

8 
loÿl
 
Çme
, 
v®ue
 = 
debug
.
	$g‘loÿl
(
d•th
, 
i
)

9 
nÙ
 
Çme
 
th’
  
’d


10 
cÚ‹xt
[
Çme
] = 
v®ue


11 
i
 = i + 1

12 
’d


13  
cÚ‹xt


14 
’d


17 
loÿl
 
funùiÚ
 
	`fšdTem¶Dœ
Ğ
Çme
 )

18 -- 
£cÚd
, 
fšd
 'project_dir/views/'

19 
posix
.
	`acûss
Ğ"v›ws/" + 
Çme
è
th’


22 
	`”rÜ
("Tem¶©" + 
Çme
 + " does‚otƒxist or wrong…ermissions.")

23 
’d


24 
’d


26 -- 
‹m¶©e
 
»nd”šg
 
dœeùives


27 
loÿl
 
VIEW_ACTIONS
 = {

28 -- 
embedšg
 
lua
 
£Áªûs


29 ['{%'] = 
	`funùiÚ
(
code
)

30  
code


31 
’d
,

32 -- 
embedšg
 
lua
 
v¬ŸbËs


33 ['{{'] = 
	`funùiÚ
(
code
)

34  ('_»suÉ[#_»suÉ+1] = %s'):
	`fÜm©
(
code
)

35 
’d
,

36 -- 
cÚššg
 
chd
 
‹m¶©e


37 ['{('] = 
	`funùiÚ
(
code
)

39 
nÙ
 
_chd»n
[%
s
] 
th’


40 
_chd»n
[%
s
] = 
	`V›w
(%s)

41 
’d


42 
_»suÉ
[#_»suÉ+1] = 
_chd»n
[%
s
](
	`g‘ãnv
())

43 ]]):
	`fÜm©
(
code
, code, code, code)

44 
’d
,

46 -- 
esÿ³
 
g
, 
to
 
make
 
£cur™y


47 ['{*'] = 
	`funùiÚ
(
code
)

48  ('loÿÈh‰°ğ»quœe("lglib.h‰p"); _»suÉ[#_»suÉ+1] = h‰p.esÿ³HTML(%s)'):
	`fÜm©
(
code
)

49 
’d
,

51 ['{['] = 
	`funùiÚ
(
code
)

52 -- 
nÙhšg
 
now


53  
Œue


54 
’d
,

55 -- 
‹m¶©e
 
šh”™©iÚ
 
syÁax


56 -- @
·¿m
 
code
: 
the
 
ba£
 
fe
's‚ame

57 -- @
·¿m
 
this_·ge
: 
the
 
ma¡”
 
fe
 
»nd”ed


58 ['{:'] = 
	`funùiÚ
(
code
, 
this_·ge
)

59 
loÿl
 
Çme
 = 
	`de£rŸlize
(
code
)

60 
loÿl
 
tm¶_dœ
 = 
	`fšdTem¶Dœ
(
Çme
)

61 
loÿl
 
ba£_·ge
 = 
io
.
	`lßdFe
(
tm¶_dœ
, 
Çme
)

62 
loÿl
 
¡¬ti
 = 1

63 
loÿl
 
oi
, 
oj
 = 1, 0

64 
loÿl
 
i
, 
j
 = 1, 0

65 
loÿl
 
block
, 
m©ched
, 
block_cÚ‹Á


66 
loÿl
 
·¹


67 
loÿl
 
·¹s
 = {}

68 
Œue
 do

69 
oi
, 
oj
, 
block
 = 
ba£_·ge
:
	`fšd
("({%[[%s_%w%.%-\'\"]+%]})", oj + 1)

70 
oi
 =ğ
n
 
th’
  
’d


71 
block_cÚ‹Á
 = 
block
:
	`sub
(3, -3):
	`Œim
()

72 
Œue
 do

73 
i
, 
j
, 
m©ched
 = 
this_·ge
:
	`fšd
("(%b{})", j + 1)

75 
i
 =ğ
n
 
th’
  
’d


76 
·¹
 = 
m©ched
:
	`m©ch
('^{%[%s*======*%s*' + 
block_cÚ‹Á
 +

78 
·¹
 
th’


79 
bË
.
	`š£¹
(
·¹s
, 
ba£_·ge
:
	`sub
(
¡¬ti
, 
oi
-1))

80 
bË
.
	`š£¹
(
·¹s
, 
·¹
)

81 
¡¬ti
 = 
oj
 + 1

83 
’d


84 
’d


85 
’d


86 
bË
.
	`š£¹
(
·¹s
, 
ba£_·ge
:
	`sub
(
¡¬ti
, -1))

88  
bË
.
	`cÚÿt
(
·¹s
)

89 
’d
,

91 -- 
š£¹
 
¶ugš


92 ['{^'] = 
	`funùiÚ
 (
code
)

93 
loÿl
 
code
 = code:
	`Œim
()

94 
	`as£¹
Ğ
code
 ~= '', 'Plugin‚ame must‚ot be blank.')

95 
loÿl
 
divid”_loc
 = 
code
:
	`fšd
('%s')

96 
loÿl
 
¶ugš_Çme
 = 
n


97 
loÿl
 
·¿m_¡r
 = 
n


99 
divid”_loc
 
th’


100 
¶ugš_Çme
 = 
code
:
	`sub
(1, 
divid”_loc
 - 1)

101 
·¿m_¡r
 = '{' .. 
code
:
	`sub
(
divid”_loc
 + 1) .. '}'

103 -- 
divid”_loc
 
is
 
n
, 
m—ns
 
this
 
¶ugš
 
has
 
no
 
¬gum’ts


104 
¶ugš_Çme
 = 
code


105 
·¿m_¡r
 = "{}"

106 
’d


107 
	`as£¹
(
bamboo
.
PLUGIN_LIST
[
¶ugš_Çme
], ('[E¼Ü]…lugš % wa nÙ„egi¡”ed.'):
	`fÜm©
(plugin_name))

108  ("_»suÉ[#_»suÉ+1] = bamboo.PLUGIN_LIST['%s'](%s, g‘ãnv())"):
	`fÜm©
(
¶ugš_Çme
, 
·¿m_¡r
)

110 
’d
,

112 ['{-'] = 
	`funùiÚ
 (
code
)

114 
’d
,

116 ['{<'] = 
	`funùiÚ
 (
code
)

117 
loÿl
 
code
 = code:
	`Œim
()

118 
	`as£¹
Ğ
code
 ~= '', 'Widget‚ame must‚ot be blank.')

119 
loÿl
 
divid”_loc
 = 
code
:
	`fšd
(' ')

120 
loÿl
 
widg‘_Çme
 = 
n


121 
loÿl
 
·¿m_¡r
 = 
n


123 
divid”_loc
 
th’


124 
widg‘_Çme
 = 
code
:
	`sub
(1, 
divid”_loc
 - 1)

125 
·¿m_¡r
 = '{' .. 
code
:
	`sub
(
divid”_loc
 + 1) .. '}'

127 -- 
divid”_loc
 
is
 
n
, 
m—ns
 
this
 
¶ugš
 
has
 
no
 
¬gum’ts


128 
widg‘_Çme
 = 
code


129 
·¿m_¡r
 = "{}"

130 
’d


131 
	`as£¹
(
bamboo
.
WIDGETS
[
widg‘_Çme
], ('[E¼Ü] widg‘ % wa nÙ im¶em’‹d.'):
	`fÜm©
(widget_name))

132  ("_»suÉ[#_»suÉ+1] = bamboo.WIDGETS['%s'](%s)"):
	`fÜm©
(
widg‘_Çme
, 
·¿m_¡r
)

134 
’d
,

137 
	}
}

139 
loÿl
 
funùiÚ
 
šh”™©e
(
tm¶
)

140 -- 
th”e
 
is
 
šh”™ed
 
g
 
š
 
	g·ge
, 
th©
ag 
mu¡
 
be
 
put
 iÀ
the
 
äÚt
 
of
 
this
 
fe


141 
loÿl
 
	gblock
 = 
tm¶
:
m©ch
("(%b{})")

142 -- 
loÿl
 
h—dtwo
 = 
block
:
	$sub
(1,2)

143 
loÿl
 
block_cÚ‹Á
 = 
block
:
	`sub
(3, -3)

144 -- 
	`as£¹
(
h—dtwo
 == '{:', 'The inheriateag must be…ut in front ofhe…age.')

146 
loÿl
 
aù
 = 
VIEW_ACTIONS
['{:']

147  
	$aù
(
block_cÚ‹Á
, 
tm¶
)

148 
’d


150 -- 
NOTE
: 
the
 
š¡ªû
 
of
 
this
 
şass
 
is
 
a
 
funùiÚ


151 
loÿl
 
V›w
 = 
Objeù
:
ex‹nd
 {

152 
__g
 = "Object.View";

153 
__Çme
 = 'View';

156 -- 
cÚfig
.
PRODUCTION
 
is
 
Œue
, 
m—ns
 
™
 i 
š
 
´oduùiÚ
 
mode
, iˆ
wl
 
Úly
 
be
 
comped
 
Úû
 
ev”y
 
ÿÎ
 
	`V›w
()

157 -- , 
™
 
is
 
š
 
dev–İ
 
mode
, iˆ
wl
 
be
 
comped
 
ev”y
 
»que¡
 
comšg
 in, iÀ
compe
 
¡age
 
ªd
 
·¿m‘”
 
fl
 stage.

158 -- @
·¿m
 
Çme
: 
the
‚am
of
h
‹m¶©e
 
fe


159 -- @: 
a
 
funùiÚ
, 
this
 funùiÚ 
ÿn
 
»ûive
‡ 
bË
 
to
 
fšish
 
the
 
»nd”šg
 
´oûdu»


161 
š™
 = 
	`funùiÚ
 (
£lf
, 
Çme
, 
is_šlše
)

162 
loÿl
 
tm¶


163 -- 
loÿl
 
tm¶_dœ
 = 
	`fšdTem¶Dœ
(
Çme
)

164 -- 
	`´št
('Tem¶©fdœ:', 
tm¶_dœ
, 
Çme
)

166 
bamboo
.
cÚfig
.
PRODUCTION
 
th’


167 -- 
ÿched


168 -- 
NOTE
: 
h”e
, 5 
is
 
ª
 
empœic
 
v®ue


169 
bamboo
.
comped_v›ws_loÿls
[
Çme
] = 
	`g‘loÿls
({}, 5)

171 
loÿl
 
v›w
 = 
bamboo
.
comped_v›ws
[
Çme
]

172 
v›w
 
ªd
 
	`ty³
(v›wè=ğ'funùiÚ' 
th’


173  
v›w


174 
’d


176 -- 
·ssšg
 
tm¶
 
dœeùly


177 
is_šlše
 =ğ'šlše' 
th’


178 -- 
h”e
, 
Çme
 
is
 
the
 
cÚ‹Á
 
of
 
html
 
äagm’t


179 
tm¶
 = 
Çme


181 -- 
lßd
 
fe


182 
loÿl
 
tm¶_dœ
 = 
	`fšdTem¶Dœ
(
Çme
)

183 
tm¶
 = 
io
.
	`lßdFe
(
tm¶_dœ
, 
Çme
)

184 
’d


185 
tm¶
 = 
£lf
.
	`´•roûss
(tmpl)

186 
v›w
 = 
£lf
.
	`compeV›w
(
tm¶
, 
Çme
)

187 -- 
add
 
to
 
ÿche


188 
bamboo
.
comped_v›ws
[
Çme
] = 
v›w


189  
v›w


191  
	`funùiÚ
 (
·¿ms
)

192 -- 
·ssšg
 
tm¶
 
dœeùly


193 
is_šlše
 =ğ'šlše' 
th’


194 -- 
h”e
, 
Çme
 
is
 
the
 
cÚ‹Á
 
of
 
html
 
äagm’t


195 
tm¶
 = 
Çme


197 
loÿl
 
tm¶_dœ
 = 
	`fšdTem¶Dœ
(
Çme
)

198 
tm¶
 = 
io
.
	`lßdFe
(
tm¶_dœ
, 
Çme
)

199 
	`as£¹
(
tm¶
, "Tem¶©" + 
tm¶_dœ
 + 
Çme
 + " does‚otƒxist.")

200 
’d


202 
tm¶
 = 
£lf
.
	`´•roûss
(tmpl)

203  
£lf
.
	`compeV›w
(
tm¶
, 
Çme
)(
·¿ms
)

204 
’d


205 
’d


207 
’d
;

209 -- 
´•roûss
 
cour£


210 
´•roûss
 = 
	`funùiÚ
(
tm¶
)

212 -- 
»¡riù
 
the
 {: :} 
©
h
h—d
 
of
 
‹m¶©e
 
fe
, 
äom
h
fœ¡
 

213 
tm¶
:
	`m©ch
('^{:.-:}%s*\n') do

214 
tm¶
 = 
	`šh”™©e
(tmpl)

215 
’d


217  
tm¶


218 
’d
;

221 -- 
compe
 
‹m¶©e
 
¡ršg
 
to
 
a
 
middË
 
funùiÚ


222 -- 
u£
 
this
 
funùiÚ
 
to
 
»ûive
 
a
 
bË
Ø
fšish
 
»nd”šg
Ø
html


224 -- 
this
 
¢³t
 
is
 
v”y
 
cÚci£
 
ªd
 
pow”ful
!

225 -- @
·¿m
 
tm¶
: 
‹m¶©e
 
¡ršg
 
»ad
 
äom
 
fe


226 -- @
·¿m
 
Çme
: 
‹m¶©e
 
fe
‚ame

227 -- @: 
middË
 
»nd”šg
 
funùiÚ


229 
compeV›w
 = 
	`funùiÚ
 (
tm¶
, 
Çme
)

230 
loÿl
 
tm¶
 = ('%s{{""}}'):
	`fÜm©
(tmpl)

231 
loÿl
 
code
 = {'local _result, _children = {}, {}\n'}

233 -- 
»nd”
 
the
 
»¡


234 
loÿl
 
‹xt
, 
block
, 
_»t


235 
‹xt
, 
block
 
š
 
lg¡ršg
.
	`m©chg£t
(
tm¶
) do

236 
loÿl
 
aù
 = 
VIEW_ACTIONS
[
block
:
	`sub
(1,2)]

238 
aù
 
th’


239 
code
[#code+1] = '_»suÉ[#_»suÉ+1] = [==[' + 
‹xt
 + ']==]'

240 
_»t
 = 
	`aù
(
block
:
	`sub
(3,-3))

241 
	`as£¹
(
	`ty³
(
_»t
è=ğ'¡ršg', ("[E¼Ü]h»tuºed v®uty³ by v›w„’d”šgag '%s' i nÙ sŒšg."):
	`fÜm©
(
block
:
	`sub
(1,2)))

242 
code
[#code+1] = 
_»t


243 
–£if
 #block > 2 
th’


244 
code
[#code+1] = '_»suÉ[#_»suÉ+1] = [==[' + 
‹xt
 + 
block
 + ']==]'

246 
code
[#code+1] = '_»suÉ[#_»suÉ+1] = [==[' + 
‹xt
 + ']==]'

247 
’d


248 
’d


250 
code
[#code+1] = 'returnable.concat(_result)'

251 
code
 = 
bË
.
	`cÚÿt
(code, '\n')

252 -- 
	`´št
('-----', 
code
)

253 -- 
»code
 
—ch
 
middË
 
v›w
 
code
 
to
 
»que¡


254 
	`ty³
(
Çme
è=ğ'¡ršg' 
th’


255 
bamboo
.
comped_v›ws_tm¶s
[
Çme
] = 
code


256 
’d


258 -- 
compe
 
the
 
whŞe
 
¡ršg
 
code


259 
loÿl
 
func
, 
”r
 = 
	`lßd¡ršg
(
code
, 
Çme
)

261 
”r
 
th’


262 
	`as£¹
(
func
, 
”r
)

263 
’d


265  
	`funùiÚ
(
cÚ‹xt
)

266 
	`as£¹
(
	`ty³
(
cÚ‹xt
) == 'table', "You must‡lways…ass in‡able for context.")

267 -- 
cŞËù
 
loÿls


268 
cÚ‹xt
[1] =ğ'loÿls' 
th’


269 
cÚ‹xt
[1] = 
n


270 
bamboo
.
cÚfig
.
PRODUCTION
 
th’


271 
loÿl
 
loÿls
 = 
bamboo
.
comped_v›ws_loÿls
[
Çme
]

272 
loÿls
 
th’


273 
k
, 
v
 
š
 
	`·œs
(
loÿls
) do

274 
nÙ
 
cÚ‹xt
[
k
] 
th’
 cÚ‹xt[k] = 
v
 
’d


275 
’d


276 
’d


278 -- 
NOTE
: 
h”e
, 4 
is
 
empœic
 
v®ue


279 
cÚ‹xt
 = 
	`g‘loÿls
(context, 4)

280 
’d


281 
’d


283 -- 
glob®
 
cÚ‹xt
 
»nd”šg


284 
k
, 
v
 
š
 
	`·œs
(
bamboo
.
cÚ‹xt
) do

285 
nÙ
 
cÚ‹xt
[
k
] 
th’


286 
cÚ‹xt
[
k
] = 
v


287 
’d


288 
’d


290 
	`£tm‘©abË
(
cÚ‹xt
, {
__šdex
=
_G
})

291 
	`£tãnv
(
func
, 
cÚ‹xt
)

292  
	`func
()

293 
’d


294 
’d
;

295 
	}
}

297  
	gV›w


	@src/web.lua

2 
	$moduË
(..., 
·ckage
.
£—Î
)

4 
loÿl
 
SessiÚ
 = 
»quœe
 'bamboo.session'

5 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
V›w
 = 
»quœe
 'bamboo.view'

8 
loÿl
 
Web
 = 
Objeù
:
ex‹nd
 {

9 
__g
 = 'Bamboo.Web';

10 
__Çme
 = 'Web';

11 
š™
 = 
	`funùiÚ
 (
£lf
, 
cÚn
, 
maš
, 
»q
, 
¡©eful
)

12 
loÿl
 
cÚŒŞËr


13 
£lf
.
cÚn
 = conn

14 
£lf
.
»q
 =„eq

15 
£lf
.
maš
 = main

16 
£lf
.
¡©eful
 = stateful

17 
¡©eful
 
th’


18 -- 
¡©e
 
´og¿mmšg


19 
cÚŒŞËr
 = 
cÜoutše
.
	`ü—‹
(
maš
)

21 
cÚŒŞËr
 = 
maš


22 
’d


23 
£lf
.
cÚŒŞËr
 = controller

24  
£lf


25 
’d
;

27 
·th
 = 
	`funùiÚ
 (
£lf
)

28  
£lf
.
»q
.
h—d”s
.
PATH


29 
’d
;

31 
m‘hod
 = 
	`funùiÚ
 (
£lf
)

32  
£lf
.
»q
.
h—d”s
.
METHOD


33 
’d
;

35 
isReque¡JsÚ
 = 
	`funùiÚ
 (
£lf
)

36  
£lf
.
»q
.
h—d”s
.
METHOD
 =ğ"JSON" 
Ü


37 
£lf
.
»q
.
h—d”s
['content-type'] == 'application/json'

38 
’d
;

40 
isAjax
 = 
	`funùiÚ
 (
£lf
)

41  
£lf
.
»q
.
h—d”s
['x-requested-with'] == "XMLHttpRequest"

42 
’d
;

44 
z­SessiÚ
 = 
	`funùiÚ
 (
£lf
)

45 -- 
to
 
z­
 
the
 
£ssiÚ
 
we
 
ju¡
 
£t
 
a
 
Ãw
 
¿ndom
 
cook›
 
š¡—d


46 
£lf
:
	`£tCook›
(
SessiÚ
.
	`makeSessiÚCook›
())

47 
’d
;

49 
£tCook›
 = 
	`funùiÚ
 (
£lf
, 
cook›
)

50 
£lf
.
»q
.
h—d”s
['£t-cook›'] = 
cook›


51 
’d
;

53 
g‘Cook›
 = 
	`funùiÚ
 (
£lf
)

54  
£lf
.
»q
.
h—d”s
['cookie']

55 
’d
;

57 
£ssiÚ
 = 
	`funùiÚ
 (
£lf
)

58  
£lf
.
»q
.
£ssiÚ_id


59 
’d
;

61 
şo£
 = 
	`funùiÚ
 (
£lf
)

62 
£lf
.
cÚn
:
	`şo£
(£lf.
»q
)

63 
’d
;

65 
£nd
 = 
	`funùiÚ
 (
£lf
, 
d©a
)

66  
£lf
.
cÚn
:
	`»¶y_jsÚ
(£lf.
»q
, 
d©a
)

67 
’d
;

69 
jsÚ
 = 
	`funùiÚ
 (
£lf
, 
d©a
, 
ùy³
)

70 
£lf
:
	`·ge
(
jsÚ
.
	`’code
(
d©a
), 200, "OK", {['cÚ‹Á-ty³'] = 
ùy³
 
Ü
 'application/json'})

71 
’d
;

73 
jsÚE¼Ü
 = 
	`funùiÚ
 (
£lf
, 
”r_code
, 
”r_desc
)

74 
£lf
:
jsÚ
 { 
sucûss
 = 
çl£
, 
”r_code
 =ƒ¼_code, 
”r_desc
 =ƒrr_desc }

75 
’d
;

77 
jsÚSucûss
 = 
	`funùiÚ
 (
£lf
, 
tbl
)

78 
loÿl
 
tbl
 =bÈ
Ü
 {}

79 
tbl
['sucûss'] = 
Œue


80 
£lf
:
	`jsÚ
(
tbl
)

81 
’d
;

83 
»dœeù
 = 
	`funùiÚ
 (
£lf
, 
u¾
)

84 
£lf
:
	`·ge
("", 303, "S“ Oth”", {
LoÿtiÚ
=
u¾
, ['cÚ‹Á-ty³'] = 
çl£
})

85  
Œue


86 
’d
;

88 
”rÜ
 = 
	`funùiÚ
 (
£lf
, 
d©a
, 
code
, 
¡©us
, 
h—d”s
)

89 
£lf
:
	`·ge
(
d©a
, 
code
, 
¡©us
, 
h—d”s
 
Ü
 {['cÚ‹Á-ty³'] = 
çl£
})

90 
£lf
:
	`şo£
()

91  
çl£


92 
’d
;

94 
nÙFound
 = 
	`funùiÚ
 (
£lf
, 
msg
è s–f:
	`”rÜ
(msg 
Ü
 'NÙ Found', 404, 'NÙ Found'è
’d
;

95 
uÇuthÜized
 = 
	`funùiÚ
 (
£lf
, 
msg
è s–f:
	`”rÜ
(msg 
Ü
 'UÇuthÜized', 401, 'UÇuthÜized'è
’d
;

96 
fÜbidd’
 = 
	`funùiÚ
 (
£lf
, 
msg
è s–f:
	`”rÜ
(msg 
Ü
 'FÜbidd’', 403, 'FÜbidd’'è
’d
;

97 
badReque¡
 = 
	`funùiÚ
 (
£lf
, 
msg
è s–f:
	`”rÜ
(msg 
Ü
 'Bad Reque¡', 400, 'Bad Reque¡'è
’d
;

100 
·ge
 = 
	`funùiÚ
 (
£lf
, 
d©a
, 
code
, 
¡©us
, 
h—d”s
)

101 
h—d”s
 = h—d” 
Ü
 {}

103 
£lf
.
»q
.
h—d”s
['£t-cook›'] 
th’


104 
h—d”s
['£t-cook›'] = 
£lf
.
»q
.headers['set-cookie']

105 
’d


107 
h—d”s
['server'] = 'Bamboo on Monserver'

108 
loÿl
 
ùy³
 = 
h—d”s
['content-type']

110 
ùy³
 =ğ
n
 
th’


111 
h—d”s
['content-type'] = 'text/html'

112 
–£if
 
ùy³
 =ğ
çl£
 
th’


113 
h—d”s
['cÚ‹Á-ty³'] = 
n


114 
’d


116 
£lf
.
cÚn
:
	`»¶y_h‰p
(£lf.
»q
, 
d©a
, 
code
, 
¡©us
, 
h—d”s
)

117  
çl£


118 
’d
;

120 
html
 = 
	`funùiÚ
 (
£lf
, 
html_tm¶
, 
tbl
)

121 
loÿl
 
tbl
 =bÈ
Ü
 {}

122 
£lf
:
	`·ge
(
	`V›w
(
html_tm¶
)(
tbl
))

123  
çl£


124 
’d
;

126 
ok
 = 
	`funùiÚ
 (
£lf
, 
msg
è£lf:
	`·ge
(msg 
Ü
 'OK', 200, 'OK'è
’d
;

129 -- 
S‹
 
Prog¿mmšg


132 
»cv
 = 
	`funùiÚ
 (
£lf
)

133 
nÙ
 
£lf
.
¡©eful
 
th’
 
	`”rÜ
("Thi i ¨¡©–es hªdËr, cª'ˆÿÎ„ecv."è
’d


134 
£lf
.
»q
 = 
cÜoutše
.
	`y›ld
()

135  
£lf
.
»q


136 
’d
;

138 
şick
 = 
	`funùiÚ
 (
£lf
)

139 
nÙ
 
£lf
.
¡©eful
 
th’
 
	`”rÜ
("Thi i ¨¡©–es hªdËr, cª'ˆÿÎ click."è
’d


140 
loÿl
 
»q
 = 
£lf
:
	`»cv
()

141  
»q
.
h—d”s
.
PATH


142 
’d
;

144 
ex³ù
 = 
	`funùiÚ
 (
£lf
, 
·‰”n
, 
d©a
, 
code
, 
¡©us
, 
h—d”s
)

145 
nÙ
 
£lf
.
¡©eful
 
th’
 
	`”rÜ
("Thi i ¨¡©–es hªdËr, cª'ˆÿÎƒx³ù."è
’d


146 
£lf
:
	`·ge
(
d©a
, 
code
, 
¡©us
, 
h—d”s
)

147 
loÿl
 
·th
 = 
£lf
:
	`şick
()

149 
·th
:
	`m©ch
(
·‰”n
è
th’


150  
·th
, 
n


152 
£lf
:
	`”rÜ
("Not found", 404, "Not Found")

153  
n
, "Not Found"

154 
’d


155 
’d
;

157 
´om±
 = 
	`funùiÚ
 (
£lf
, 
d©a
, 
code
, 
¡©us
, 
h—d”s
)

158 
nÙ
 
£lf
.
¡©eful
 
th’
 
	`”rÜ
("Thi i ¨¡©–es hªdËr, cª'ˆÿÎ…rom±."è
’d


159 
£lf
:
	`·ge
(
d©a
, 
code
, 
¡©us
, 
h—d”s
)

160  
£lf
:
	`šput
()

161 
’d
;

163 
šput
 = 
	`funùiÚ
 (
£lf
)

164 
nÙ
 
£lf
.
¡©eful
 
th’
 
	`”rÜ
("Thi i ¨¡©–es hªdËr, cª'ˆÿÎ iÅut."è
’d


165 
loÿl
 
»q
 = 
£lf
:
	`»cv
()

166  
FÜm
:
	`·r£
(
»q
),„eq

167 
’d
;

169 
	}
}

172  
	gWeb


	@src/widget.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

5 
loÿl
 
TEXT_TMPL
 = [[<
šput
 
ty³
="‹xt" 
Çme
="${Çme}" 
v®ue
="${v®ue}" 
şass
="${şass}" 
$
{
id
} /> ]]

6 
‹xt
 = 
	$funùiÚ
 (
¬gs
)

7 
loÿl
 
Çme
 = 
¬gs
.Çm
Ü
 'text'

8 
loÿl
 
şass
 = 
¬gs
.şas 
Ü
 
Çme


9 
loÿl
 
v®ue
 = 
¬gs
.v®u
Ü
 ''

10 
loÿl
 
id
 = 
¬gs
.id

12 
loÿl
 
htmls
 = (
TEXT_TMPL
 % {

13 
Çme
 =‚ame,

14 
v®ue
 = value,

15 
şass
 = class,

16 
id
 = id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 ''

17 
	}
})

19  
htmls


20 
’d


25 
loÿl
 
	gCHECKBOX_TMPL
 = [[<
šput
 
ty³
="checkbox" 
Çme
="${Çme}" 
v®ue
="${v®ue}" 
$
{
checked
} 
şass
="${şass}" ${
id
} />${
ÿ±iÚ
} ]]

26 
checkbox
 = 
	$funùiÚ
 (
¬gs
)

27 
loÿl
 
htmls
 = {
	}
}

28 
loÿl
 
Çme
 = 
¬gs
.Çm
Ü
 'checkbox'

29 
loÿl
 
şass
 = 
¬gs
.şas 
Ü
 
Çme


30 
loÿl
 
v®ue
 = 
¬gs
.v®u
Ü
 {}

31 
loÿl
 
v®ue_f›ld
 = 
¬gs
.value_field

32 
loÿl
 
ÿ±iÚ_f›ld
 = 
¬gs
.caption_field

33 
loÿl
 
id
 = 
¬gs
.id

35 
loÿl
 
checked
 = 
¬gs
.checked 
Ü
 {}

36 
loÿl
 
checked_£t
, 
	gæag
 = 
çl£


37 
ty³
(
checked
è=ğ'bË' 
th’


38 
checked_£t
 = 
	$S‘
(
checked
)

39 
’d


41 
v®ue_f›ld
 
ªd
 
ÿ±iÚ_f›ld
 
th’


42 -- 
h”e
, 
v®ue
 
is
 
d©asourû


43 
_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

44 
	`ty³
(
checked
è=ğ'¡ršg' 
th’


45 
æag
 = 
checked
 =ğ
™em
[
v®ue_f›ld
]

47 
æag
 = 
checked_£t
:
	$has
(
™em
[
v®ue_f›ld
])

48 
’d


50 
bË
.
	`š£¹
(
htmls
, (
CHECKBOX_TMPL
 % {

51 
id
 = id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 '',

52 
şass
 = class,

53 
Çme
 =‚ame,

54 
v®ue
 = 
™em
[
v®ue_f›ld
],

55 
ÿ±iÚ
 = 
™em
[
ÿ±iÚ_f›ld
] 
Ü
 '',

56 
checked
 = 
æag
 
ªd
 'checked="checked"' 
Ü
 ''

57 
	}
}))

58 
’d


60 
	g_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

62 
	`ty³
(
checked
è=ğ'¡ršg' 
th’


63 
æag
 = 
checked
 =ğ
™em
[1]

65 
æag
 = 
checked_£t
:
	$has
(
™em
[1])

66 
’d


67 
bË
.
	`š£¹
(
htmls
, (
CHECKBOX_TMPL
 % {

68 
id
 = id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 '',

69 
Çme
 =‚ame,

70 
v®ue
 = 
™em
[1],

71 
şass
 = class,

72 
ÿ±iÚ
 = 
™em
[2] 
Ü
 item[1] or '',

73 
checked
 = 
æag
 
ªd
 'checked="checked"' 
Ü
 ''

74 
	}
}))

75 
’d


76 
’d


78  
	gbË
.
	$cÚÿt
(
htmls
)

79 
’d


81 
loÿl
 
RADIO_TMPL
 = [[<
šput
 
ty³
="¿dio" 
Çme
="${Çme}" 
v®ue
="${v®ue}" 
$
{
checked
} cÏss="${şass}" ${id}/>${ÿ±iÚ} ${Ïyout}]]

82 
¿dio
 = 
	$funùiÚ
 (
¬gs
)

83 
loÿl
 
htmls
 = {
	}
}

84 
loÿl
 
Çme
 = 
¬gs
.Çm
Ü
 'radio'

85 
loÿl
 
şass
 = 
¬gs
.şas 
Ü
 
Çme


86 
loÿl
 
v®ue
 = 
¬gs
.v®u
Ü
 {}

87 
loÿl
 
checked
 = 
¬gs
.checked 
Ü
 ''

88 
loÿl
 
v®ue_f›ld
 = 
¬gs
.value_field

89 
loÿl
 
ÿ±iÚ_f›ld
 = 
¬gs
.caption_field

90 
loÿl
 
Ïyout
 = 
¬gs
.Ïyouˆ
Ü
 ''

91 
Ïyout
 =ğ'v”tiÿl' 
th’


92 
Ïyout
="<br/>"

93 
’d


95 
v®ue_f›ld
 
ªd
 
ÿ±iÚ_f›ld
 
th’


96 
_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

97 
bË
.
	`š£¹
(
htmls
, (
RADIO_TMPL
 % {

98 
id
 = id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 '',

99 
şass
 = class,

100 
Çme
 =‚ame,

101 
v®ue
 = 
™em
[
v®ue_f›ld
],

102 
ÿ±iÚ
 = 
™em
[
ÿ±iÚ_f›ld
] 
Ü
 '',

103 
checked
 = (checked =ğ
™em
[
v®ue_f›ld
]è
ªd
 'checked="checked"' 
Ü
 '',

104 
Ïyout
 =†ayout,

105 
	}
}))

106 
’d


108 
	g_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

109 
bË
.
	`š£¹
(
htmls
, (
RADIO_TMPL
 % {

110 
id
 = id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 '',

111 
Çme
 =‚ame,

112 
v®ue
 = 
™em
[1],

113 
şass
 = class,

114 
ÿ±iÚ
 = 
™em
[2] 
Ü
 item[1] or'',

115 
checked
 = (checked =ğ
™em
[1]è
ªd
 'checked="checked"' 
Ü
 '',

116 
Ïyout
 =†ayout,

117 
	}
}))

118 
’d


119 
’d


121  
	gbË
.
	$cÚÿt
(
htmls
)

122 
’d


126 
loÿl
 
SELECT_TMPL0
 = [[<
£Ëù
 
şass
="${şass}" 
Çme
="${Çme}" 
$
{
id
}>]]

127 
loÿl
 
SELECT_TMPL1
 = [[<
İtiÚ
 
v®ue
="${v®ue}" 
$
{
£Ëùed
}>${
ÿ±iÚ
}</option>]]

128 
loÿl
 
SELECT_TMPL2
 = [[</
£Ëù
>]]

129 
£Ëù
 = 
	$funùiÚ
 (
¬gs
)

130 
loÿl
 
htmls
 = {
	}
}

131 
loÿl
 
Çme
 = 
¬gs
.Çm
Ü
 'select'

132 
loÿl
 
şass
 = 
¬gs
.şas 
Ü
 
Çme


133 
loÿl
 
v®ue
 = 
¬gs
.v®u
Ü
 {}

134 
loÿl
 
£Ëùed
 = 
¬gs
.£Ëùed 
Ü
 {}

136 
loÿl
 
v®ue_f›ld
 = 
¬gs
.value_field

137 
loÿl
 
ÿ±iÚ_f›ld
 = 
¬gs
.caption_field

139 
loÿl
 
£Ëùed_£t


140 
loÿl
 
æag
 = 
çl£


141 
ty³
(
£Ëùed
è=ğ'bË' 
th’


142 
£Ëùed_£t
 = 
	$S‘
(
£Ëùed
)

143 
’d


145 
bË
.
	`š£¹
(
htmls
, 
SELECT_TMPL0
 % {
şass
=şass, 
Çme
òame, 
id
=id 
ªd
 
	`fÜm©
('id="%s"', idè
Ü
 ''
	}
})

146 
loÿl
 
	gšv®
, 
	gšÿp


148 -- 
¥ecify
 
v®ue
 
f›ld
 
ªd
 
ÿ±iÚ
 field

149 
v®ue_f›ld
 
ªd
 
ÿ±iÚ_f›ld
 
	gth’


150 -- 
	gh”e
, 
v®ue
 
is
 
d©asourû


151 
	g_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

152 
	`ty³
(
£Ëùed
è=ğ'¡ršg' 
th’


153 
æag
 = 
£Ëùed
 =ğ
™em
[
v®ue_f›ld
]

155 
æag
 = 
£Ëùed_£t
:
	$has
(
™em
[
v®ue_f›ld
])

156 
’d


158 
bË
.
	`š£¹
(
htmls
, (
SELECT_TMPL1
 % {

159 
v®ue
 = 
™em
[
v®ue_f›ld
],

160 
ÿ±iÚ
 = 
™em
[
ÿ±iÚ_f›ld
] 
Ü
 '',

161 
£Ëùed
 = 
æag
 
ªd
 '£Ëùed="£Ëùed"' 
Ü
 ''

162 
	}
}))

163 
’d


165 -- 
nÙ
 
¥ecify
 
v®ue
 
f›ld
 
ªd
 
ÿ±iÚ
 field

166 
	g_
, 
™em
 
š
 
	$aœs
(
v®ue
) do

167 
	`ty³
(
™em
è=ğ'¡ršg' 
th’


168 
šv®
 = 
™em


169 
šÿp
 = 
™em


171 
šv®
 = 
™em
[1]

172 
šÿp
 = 
™em
[2] 
Ü
 
šv®


173 
’d


175 
	`ty³
(
£Ëùed
è=ğ'¡ršg' 
th’


176 
æag
 = 
£Ëùed
 =ğ
šv®


178 
æag
 = 
£Ëùed_£t
:
	$has
(
šv®
)

179 
’d


180 
bË
.
	`š£¹
(
htmls
, (
SELECT_TMPL1
 % {

181 
v®ue
 = 
šv®
,

182 
ÿ±iÚ
 = 
šÿp
,

183 
£Ëùed
 = 
æag
 
ªd
 '£Ëùed="£Ëùed"' 
Ü
 ''

184 
	}
}))

185 
’d


186 
’d


187 
	gbË
.
	$š£¹
(
htmls
, 
SELECT_TMPL2
)

189  
bË
.
	$cÚÿt
(
htmls
)

190 
’d


194 
bamboo
.
WIDGETS
['‹xt'] = 
‹xt


195 
bamboo
.
WIDGETS
['checkbox'] = 
checkbox


196 
bamboo
.
WIDGETS
['¿dio'] = 
¿dio


197 
bamboo
.
WIDGETS
['£Ëù'] = 
£Ëù


	@tests/ajaxpaginator_test/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

7 
bamboo
.
	$»gi¡”Mod–
(
MYU£r
)

8 
loÿl
 
¶ugš_·gš©Ü
 = 
»quœe
 "plugins.ajaxpaginator"

9 
bamboo
.
	`»gi¡”Plugš
('·gš©Ü', 
¶ugš_·gš©Ü
)

13 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

14 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

15 
’d


18 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

19 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


20 
	$DEBUG
(
·¿ms
)

22 
loÿl
 
³rsÚ
 = 
	`MYU£r
(
·¿ms
)

23 -- 
§ve
 
³rsÚ
 
objeù
 
to
 
db


24 
³rsÚ
:
	$§ve
()

27 
web
:
	`»dœeù
("/page/getInstance/")

28 
’d


30 
loÿl
 
funùiÚ
 
	$show
(
web
, 
»q
)

32  
web
:
	`·ge
(
	`V›w
("»suÉ.html"){
	}
})

33 
’d


35 
loÿl
 
funùiÚ
 
	$fÜm_subm™2
(
web
, 
»q
, 
¡¬ti
, 
’di
)

37 
loÿl
 
®l_³rsÚs


38 
nÙ
 
MYU£r
:
	`exi¡Cache
('³rsÚs_li¡'è
th’


39 -- 
»Œeive
 
®l
 
³rsÚ
 
š¡ªû
 
äom
 
db


40 
®l_³rsÚs
 = 
MYU£r
:
	$®l
():
	`sÜtBy
('name')

41 
MYU£r
:
	`£tCache
('³rsÚs_li¡', 
®l_³rsÚs
)

42 
®l_³rsÚs
 =‡Î_³rsÚs:
	$¦iû
(
¡¬ti
, 
’di
)

44 -- 
	`DEBUG
('entering cache block.')

45 
®l_³rsÚs
 = 
MYU£r
:
	`g‘Cache
('³rsÚs_li¡', 
¡¬ti
, 
’di
)

47 
’d


48 -- 
	$åbË
(
®l_³rsÚs
)

49 
loÿl
 
tÙ®
 = 
MYU£r
:
	`numCache
('persons_list')

51  
	`V›w
("™em.html"){
®l_³rsÚs
 = 
	}
®l_³rsÚs}, 
tÙ®


52 
’d


54 
	gbamboo
.
»gi¡”PlugšC®lback
('·ge_ÿÎback', 
fÜm_subm™2
)

56 
funùiÚ
 
	$‹¡
 (
web
, 
»q
)

57 
loÿl
 
x
, 
y
, 
z
 = 10, 100, 1000

59  
web
:
	`·ge
(
	`V›w
("‹¡.html"){"loÿls"
	}
})

60 
’d


63 
URLS
 = { '/',

64 ['/'] = 
šdex
,

65 ['/šdex/'] = 
šdex
,

66 ['/fÜm_subm™/'] = 
fÜm_subm™
,

67 ['/·ge/g‘In¡ªû/'] = 
show
,

68 ['/·ge/g‘In¡ªûs/'] = 
¶ugš_·gš©Ü
.
jsÚs
,

69 ['/‹¡/'] = 
‹¡


	@tests/ajaxpaginator_test/cachecall/callbacks.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	`ÚSave
(
£lf
)

4 -- 
h”e
, 
we
 
Ãed
 
to
 
add
 
Ãw
 
š¡ªû
's ido cache

5 
	`DEBUG
('readyo‡dd‚ew membero cache.')

6 
£lf
:
	`addToCacheAndSÜtBy
('persons_list', 'name')

8  
£lf


	@tests/ajaxpaginator_test/models/mymodel.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
Mymod–
 = 
Mod–
:
ex‹nd
 {

6 
__g
 = 'Bamboo.Model.Mymodel';

7 
__Çme
 = 'Mymodel';

8 
__desc
 = 'Generitic Mymodel definition';

9 
__šdexfd
 = 'name',

10 
__f›lds
 = {

15 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

16 
	`isF®£
(
t
è
th’
  
£lf
 
’d


18 --‡utØ
fl
 
nÚ
-
fÜeign
 
f›lds
 
w™h
 
·¿ms
 
t


19 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


20 
k
, 
v
 
š
 
	`·œs
(
t
) do

21 
f›lds
[
k
] 
ªd
 
nÙ
 f›lds[k].
fÜeign
 
th’


22 
£lf
[
k
] = 
	`to¡ršg
(
v
)

23 
’d


24 
’d


26  
£lf


27 
’d
;

31 
	}
}

33  
	gMymod–


	@tests/ajaxpaginator_test/models/myuser.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U£r
 = 
»quœe
 'bamboo.models.user'

5 
loÿl
 
ÿche_ÿÎbacks
 = 
»quœe
 'cachecall.callbacks'

7 
loÿl
 
MYU£r
 = 
U£r
:
ex‹nd
 {

8 
__g
 = 'Bamboo.Model.User.MYUser';

9 
__Çme
 = 'MYUser';

10 
__desc
 = 'Generitic MYUser definition';

11 
__šdexfd
 = 'name';

12 
__f›lds
 = {

18 
__decÜ©Üs
 = {

19 
§ve
 = 
	`funùiÚ
(
o§ve
)

20  
	`funùiÚ
(
£lf
, ...)

21 
£lf
 = 
	`o§ve
(self, ...)

22 
nÙ
 
£lf
 
th’
  
n
 
’d


24 
£lf
 = 
ÿche_ÿÎbacks
.
	`ÚSave
(self)

26  
£lf


27 
’d


28 
’d
;

32 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

33 
nÙ
 
t
 
th’
  
£lf
 
’d


35 
£lf
.
Çme
 = 
t
.name

36 
£lf
.
age
 = 
t
.age

37 
£lf
.
g’d”
 = 
t
.gender

39  
£lf


40 
’d
;

42 
	}
}

44  
	gMYU£r


	@tests/ajaxpaginator_test/monconfig.lua

1 
	g¡©ic_ajax·gš©Ü_‹¡
 = { 
ty³
="dœ", 
	gba£
='s™es/ajax·gš©Ü_‹¡/', 
	gšdex_fe
='šdex.html', 
	gdeçuÉ_ùy³
='text/plain' }

3 
	ghªdËr_ajax·gš©Ü_‹¡
 = { 
ty³
="hªdËr", 
	g£nd_¥ec
='tcp://127.0.0.1:10001',

4 
	g£nd_id’t
='ba06f707-8647-46b9-b7f7-e641d6419909',

5 
	g»cv_¥ec
='tı://127.0.0.1:10002', 
	g»cv_id’t
=''}

7 
	gmaš
 = {

8 
bšd_addr
 = "0.0.0.0",

9 
	guuid
="505417b8-1de4-454f-98b6-07eb9225cca1",

10 
	gacûss_log
="logs/access.log",

11 
	g”rÜ_log
="logs/error.log",

12 
	gchroÙ
="./",

13 
	gpid_fe
="run/mongrel2.pid",

14 
	gdeçuÉ_ho¡
="ajaxpaginator_test",

15 
	gÇme
="main",

16 
	gpÜt
=6767,

17 
	gho¡s
= {

19 
Çme
="ajaxpaginator_test",

20 
	gm©chšg
 = "xxxxxx",

21 
	grou‹s
={

22 ['/'] = 
hªdËr_ajax·gš©Ü_‹¡
,

23 ['/medŸ/'] = 
¡©ic_ajax·gš©Ü_‹¡


30 
	g£‰šgs
 = {

36 
	gmim‘y³s
 = {}

38 
£rv”s
 = { 
maš
 }

	@tests/ajaxpaginator_test/plugins/ajaxpaginator/init.lua

1 
	$moduË
 (..., 
·ckage
.
£—Î
)

3 
loÿl
 
_¬gs
 = {
	}
}

5 
funùiÚ
 
	$h–³r
()

6 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


8 
loÿl
 
th•age
 = 
	$tÚumb”
(
·¿ms
.
th•age
è
Ü
 1

9 
th•age
 < 1 
th’
h•agğ1 
’d


10 
loÿl
 
tÙ®·ges
 = 
	$tÚumb”
(
·¿ms
.
tÙ®·ges
è
Ü
 1

11 
tÙ®·ges
 
ªd
 
th•age
 >Ù®·ge 
th’
h•agğtÙ®·ge 
’d


12 
loÿl
 
Åp
 = 
	$tÚumb”
(
·¿ms
.
Åp
è
Ü
 
	$tÚumb”
(
_¬gs
.
Åp
è
Ü
 5

13 
loÿl
 
¡¬ti
 = (
th•age
-1è* 
Åp
 + 1

14 
loÿl
 
’di
 = 
th•age
 * 
Åp


15 
loÿl
 
·geu¾
 = 
·¿ms
.·geu¾ 
Ü
 
_¬gs
.pageurl

16 
loÿl
 
ÿÎback
 = 
_¬gs
.callback

18 -- 
the
 
ÿÎback
 
should
  2 
v®ues
: 
html
 
äagm’t
 
ªd
 
tÙ®num


19 
loÿl
 
htmlcÚ‹Á
, 
tÙ®num
 = 
bamboo
.
	$g‘PlugšC®lbackByName
(
ÿÎback
)(
web
, 
»q
, 
¡¬ti
, 
’di
)

21 
tÙ®num
 
th’


22 
tÙ®·ges
 = 
m©h
.
	`û
(
tÙ®num
/
Åp
)

23 
th•age
 > 
tÙ®·ges
 
th’
h•agğtÙ®·ge 
’d


24 
’d


26 
loÿl
 
´ev·ge
 = 
th•age
 - 1

27 
´ev·ge
 < 1 
th’
…»v·gğ1 
’d


28 
loÿl
 
Ãxage
 = 
th•age
 + 1

29 
	$´št
(
Ãxage
, 
tÙ®·ges
)

30 
Ãxage
 > 
tÙ®·ges
 
th’
‚exagğtÙ®·ge 
’d


33 ['htmlcÚ‹Á'] = 
htmlcÚ‹Á
,

34 ['tÙ®·ges'] = 
tÙ®·ges
,

35 ['Åp'] = 
Åp
,

36 ['·geu¾'] = 
·geu¾
,

37 ['th•age'] = 
th•age
,

38 ['´ev·ge'] = 
´ev·ge
,

39 ['Ãxage'] = 
Ãxage


40 
	}
}

41 
’d


44 
funùiÚ
 
	$maš
(
¬gs
)

46 
	`as£¹
(
	`ty³
(
¬gs
.
·geu¾
) == 'string', '[Error]…ageurl missing in…lugin…aginator.')

47 
	`as£¹
(
	`ty³
(
¬gs
.
ÿÎback
è=ğ'¡ršg' 
ªd
y³(
bamboo
.
	`g‘PlugšC®lbackByName
(args.callback)) == 'function', '[Error] callback missing in…lugin…aginator.')

48 
_¬gs
 = 
¬gs


50  
	`V›w
('../¶ugšs/ajax·gš©Ü/ajax·gš©Ü.html'è(
	$h–³r
())

52 
’d


54 
funùiÚ
 
	`jsÚs
(
web
, 
»q
)

55 -- 
	$åbË
(
»q
.
PARAMS
)

56  
web
:
	`jsÚSucûss
(
	$h–³r
())

57 
’d


	@tests/ajaxpaginator_test/settings.lua

1 
	g´ojeù_Çme
 = "ajaxpaginator_test"

2 
ho¡
 = "ajaxpaginator_test"

3 
£nd”_id
 = 'c62c1bda-0816-2205-eef9-811c8e055fd1'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 15

8 
debug_Ëv–
 = 1

	@tests/ajaxpaginator_test/tests/viewbench_tests.lua

1 
loÿl
 
	g‹¡šg
 = 
»quœe
 "bamboo.testing"

2 
loÿl
 
jsÚ
 = 
»quœe
 'json'

3 
loÿl
 
sock‘
 = 
»quœe
 "socket"

5 
cÚ‹xt
("V›w…”fÜmªû b’chm¬k", 
	$funùiÚ
 ()

6 
	`cÚ‹xt
("‹¡1", 
	$funùiÚ
 ()

7 
loÿl
 
‹¡”
 = 
‹¡šg
.
	`brow£r
("tester")

8 
loÿl
 
t1
 = 
sock‘
.
	$g‘time
()

9 
loÿl
 
»t


10 
i
=1, 10000 do

11 
»t
 = 
‹¡”
:
	`şick
("/test")

12 
’d


13 
loÿl
 
t2
 = 
sock‘
.
	$g‘time
()

14 
	`´št
(
t2
 - 
t1
)

15 
’d
)

16 
’d
)

	@tests/cache_test/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

7 
bamboo
.
	$»gi¡”Mod–
(
MYU£r
)

9 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

10 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

11 
’d


13 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

14 
loÿl
 
·¿ms
 = 
FÜm
:
	$·r£
(
»q
)

15 
	$DEBUG
(
·¿ms
)

17 
loÿl
 
³rsÚ
 = 
	`MYU£r
(
·¿ms
)

18 -- 
§ve
 
³rsÚ
 
objeù
 
to
 
db


19 
³rsÚ
:
	$§ve
()

21 
loÿl
 
®l_³rsÚs


22 
nÙ
 
MYU£r
:
	`exi¡Cache
('¯³rsÚs_li¡'è
th’


23 -- 
»Œeive
 
®l
 
³rsÚ
 
š¡ªû
 
äom
 
db


24 
®l_³rsÚs
 = 
MYU£r
:
	$®l
():
	`sÜtBy
('name')

25 
MYU£r
:
	`£tCache
('¯³rsÚs_li¡', 
®l_³rsÚs
)

26 
	`DEBUG
('-----vvvv---------')

28 
	`DEBUG
('entering cache block.')

29 
®l_³rsÚs
 = 
MYU£r
:
	`g‘Cache
('aapersons_list')

31 
’d


33 
web
:
	`html
("»suÉ.html", {
®l_³rsÚs
 =‡Î_³rsÚ 
Ü
 {} 
	}
})

34 
’d


37 
	gURLS
 = { '/',

38 ['/'] = 
šdex
,

39 ['/šdex/'] = 
šdex
,

40 ['/fÜm_subm™/'] = 
fÜm_subm™
,

	@tests/cache_test/cachecall/callbacks.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	`ÚSave
(
£lf
)

4 -- 
h”e
, 
we
 
Ãed
 
to
 
add
 
Ãw
 
š¡ªû
's ido cache

5 
	`DEBUG
('readyo‡dd‚ew membero cache.')

6 
£lf
:
	`addToCacheAndSÜtBy
('persons_list', 'name')

8  
£lf


	@tests/cache_test/models/myuser.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U£r
 = 
»quœe
 'bamboo.models.user'

5 
loÿl
 
ÿche_ÿÎbacks
 = 
»quœe
 'cachecall.callbacks'

7 
loÿl
 
MYU£r
 = 
U£r
:
ex‹nd
 {

8 
__g
 = 'Bamboo.Model.User.MYUser';

9 
__Çme
 = 'MYUser';

10 
__desc
 = 'Generitic MYUser definition';

11 
__šdexfd
 = 'name';

12 
__f›lds
 = {

18 
__decÜ©Üs
 = {

19 
§ve
 = 
	`funùiÚ
(
o§ve
)

20  
	`funùiÚ
(
£lf
, ...)

21 
£lf
 = 
	`o§ve
(self, ...)

22 
nÙ
 
£lf
 
th’
  
n
 
’d


24 
£lf
 = 
ÿche_ÿÎbacks
.
	`ÚSave
(self)

26  
£lf


27 
’d


28 
’d
;

32 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

33 
nÙ
 
t
 
th’
  
£lf
 
’d


35 
£lf
.
Çme
 = 
t
.name

36 
£lf
.
age
 = 
t
.age

37 
£lf
.
g’d”
 = 
t
.gender

39  
£lf


40 
’d
;

42 
	}
}

44  
	gMYU£r


	@tests/cache_test/settings.lua

1 
	g´ojeù_Çme
 = "cache_test"

2 
ho¡
 = "cache_test"

3 
£nd”_id
 = 'c62c1bda-0816-2205-eef9-811c8e055fd1'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 15

9 
debug_Ëv–
 = 1

	@tests/core_test/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

7 
bamboo
.
	$»gi¡”Mod–
(
MYU£r
)

8 
loÿl
 
¶ugš_·gš©Ü
 = 
»quœe
 "plugins.ajaxpaginator"

9 
bamboo
.
	`»gi¡”Plugš
('·gš©Ü', 
¶ugš_·gš©Ü
)

13 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

14 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

15 
’d


18 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

19 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


20 
	$DEBUG
(
·¿ms
)

22 
loÿl
 
³rsÚ
 = 
	`MYU£r
(
·¿ms
)

23 -- 
§ve
 
³rsÚ
 
objeù
 
to
 
db


24 
³rsÚ
:
	$§ve
()

27 
web
:
	`»dœeù
("/page/getInstance/")

28 
’d


30 
loÿl
 
funùiÚ
 
	$show
(
web
, 
»q
)

32  
web
:
	`·ge
(
	`V›w
("»suÉ.html"){
	}
})

33 
’d


35 
loÿl
 
funùiÚ
 
	$fÜm_subm™2
(
web
, 
»q
, 
¡¬ti
, 
’di
)

37 
loÿl
 
®l_³rsÚs


38 
nÙ
 
MYU£r
:
	`exi¡Cache
('³rsÚs_li¡'è
th’


39 -- 
»Œeive
 
®l
 
³rsÚ
 
š¡ªû
 
äom
 
db


40 
®l_³rsÚs
 = 
MYU£r
:
	$®l
():
	`sÜtBy
('name')

41 
MYU£r
:
	`£tCache
('³rsÚs_li¡', 
®l_³rsÚs
)

42 
®l_³rsÚs
 =‡Î_³rsÚs:
	$¦iû
(
¡¬ti
, 
’di
)

44 -- 
	`DEBUG
('entering cache block.')

45 
®l_³rsÚs
 = 
MYU£r
:
	`g‘Cache
('³rsÚs_li¡', 
¡¬ti
, 
’di
)

47 
’d


48 -- 
	$åbË
(
®l_³rsÚs
)

49 
loÿl
 
tÙ®
 = 
MYU£r
:
	`numCache
('persons_list')

51  
	`V›w
("™em.html"){
®l_³rsÚs
 = 
	}
®l_³rsÚs}, 
tÙ®


52 
’d


54 
	gbamboo
.
»gi¡”PlugšC®lback
('·ge_ÿÎback', 
fÜm_subm™2
)

56 
funùiÚ
 
	$‹¡
 (
web
, 
»q
)

57 
loÿl
 
x
, 
y
, 
z
 = 10, 100, 1000

59  
web
:
	`·ge
(
	`V›w
("‹¡.html"){"loÿls"
	}
})

60 
’d


62 
funùiÚ
 
	$i_am_qu”y_£t
(
web
, 
»q
)

63 
loÿl
 
qu”y_£t
 = 
MYU£r
:
	$®l
()

65  
	$isQu”yS‘
(
qu”y_£t
)

66 
’d


69 
URLS
 = { '/',

70 ['/'] = 
šdex
,

71 ['/šdex/'] = 
šdex
,

72 ['/fÜm_subm™/'] = 
fÜm_subm™
,

73 ['/·ge/g‘In¡ªû/'] = 
show
,

74 ['/·ge/g‘In¡ªûs/'] = 
¶ugš_·gš©Ü
.
jsÚs
,

76 -- 
b–ow
 autØ
‹¡


77 ['/‹¡/'] = 
‹¡
,

78 ['/‹¡/i_am_qu”y_£t/'] = 
i_am_qu”y_£t
,

80 
	}
}

	@tests/core_test/cachecall/callbacks.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	`ÚSave
(
£lf
)

4 -- 
h”e
, 
we
 
Ãed
 
to
 
add
 
Ãw
 
š¡ªû
's ido cache

5 
	`DEBUG
('readyo‡dd‚ew membero cache.')

6 
£lf
:
	`addToCacheAndSÜtBy
('persons_list', 'name')

8  
£lf


	@tests/core_test/models/mymodel.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
Mod–
 = 
»quœe
 'bamboo.model'

5 
loÿl
 
Mymod–
 = 
Mod–
:
ex‹nd
 {

6 
__g
 = 'Bamboo.Model.Mymodel';

7 
__Çme
 = 'Mymodel';

8 
__desc
 = 'Generitic Mymodel definition';

9 
__šdexfd
 = 'name',

10 
__f›lds
 = {

15 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

16 
	`isF®£
(
t
è
th’
  
£lf
 
’d


18 --‡utØ
fl
 
nÚ
-
fÜeign
 
f›lds
 
w™h
 
·¿ms
 
t


19 
loÿl
 
f›lds
 = 
£lf
.
__f›lds


20 
k
, 
v
 
š
 
	`·œs
(
t
) do

21 
f›lds
[
k
] 
ªd
 
nÙ
 f›lds[k].
fÜeign
 
th’


22 
£lf
[
k
] = 
	`to¡ršg
(
v
)

23 
’d


24 
’d


26  
£lf


27 
’d
;

31 
	}
}

33  
	gMymod–


	@tests/core_test/models/myuser.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U£r
 = 
»quœe
 'bamboo.models.user'

5 
loÿl
 
ÿche_ÿÎbacks
 = 
»quœe
 'cachecall.callbacks'

7 
loÿl
 
MYU£r
 = 
U£r
:
ex‹nd
 {

8 
__g
 = 'Bamboo.Model.User.MYUser';

9 
__Çme
 = 'MYUser';

10 
__desc
 = 'Generitic MYUser definition';

11 
__šdexfd
 = 'name';

12 
__f›lds
 = {

18 
__decÜ©Üs
 = {

19 
§ve
 = 
	`funùiÚ
(
o§ve
)

20  
	`funùiÚ
(
£lf
, ...)

21 
£lf
 = 
	`o§ve
(self, ...)

22 
nÙ
 
£lf
 
th’
  
n
 
’d


24 
£lf
 = 
ÿche_ÿÎbacks
.
	`ÚSave
(self)

26  
£lf


27 
’d


28 
’d
;

32 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

33 
nÙ
 
t
 
th’
  
£lf
 
’d


35 
£lf
.
Çme
 = 
t
.name

36 
£lf
.
age
 = 
t
.age

37 
£lf
.
g’d”
 = 
t
.gender

39  
£lf


40 
’d
;

42 
	}
}

44  
	gMYU£r


	@tests/core_test/monconfig.lua

1 
	g¡©ic_cÜe_‹¡
 = { 
ty³
="dœ", 
	gba£
='s™es/cÜe_‹¡/', 
	gšdex_fe
='šdex.html', 
	gdeçuÉ_ùy³
='text/plain' }

3 
	ghªdËr_cÜe_‹¡
 = { 
ty³
="hªdËr", 
	g£nd_¥ec
='tcp://127.0.0.1:10001',

4 
	g£nd_id’t
='ba06f707-8647-46b9-b7f7-e641d6419909',

5 
	g»cv_¥ec
='tı://127.0.0.1:10002', 
	g»cv_id’t
=''}

7 
	gmaš
 = {

8 
bšd_addr
 = "127.0.0.1",

9 
	guuid
="505417b8-1de4-454f-98b6-07eb9225cca1",

10 
	gacûss_log
="logs/access.log",

11 
	g”rÜ_log
="logs/error.log",

12 
	gchroÙ
="./",

13 
	gpid_fe
="run/mongrel2.pid",

14 
	gdeçuÉ_ho¡
="core_test",

15 
	gÇme
="main",

16 
	gpÜt
=6767,

17 
	gho¡s
= {

19 
Çme
="core_test",

20 
	gm©chšg
 = "xxxxxx",

21 
	grou‹s
={

22 ['/'] = 
hªdËr_cÜe_‹¡
,

23 ['/medŸ/'] = 
¡©ic_cÜe_‹¡


30 
	g£‰šgs
 = {

36 
	gmim‘y³s
 = {}

38 
£rv”s
 = { 
maš
 }

	@tests/core_test/plugins/ajaxpaginator/init.lua

1 
	$moduË
 (..., 
·ckage
.
£—Î
)

3 
loÿl
 
_¬gs
 = {
	}
}

5 
funùiÚ
 
	$h–³r
()

6 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


8 
loÿl
 
th•age
 = 
	$tÚumb”
(
·¿ms
.
th•age
è
Ü
 1

9 
th•age
 < 1 
th’
h•agğ1 
’d


10 
loÿl
 
tÙ®·ges
 = 
	$tÚumb”
(
·¿ms
.
tÙ®·ges
)

11 
tÙ®·ges
 
ªd
 
th•age
 >Ù®·ge 
th’
h•agğtÙ®·ge 
’d


12 
loÿl
 
Åp
 = 
	$tÚumb”
(
·¿ms
.
Åp
è
Ü
 
	$tÚumb”
(
_¬gs
.
Åp
è
Ü
 5

13 
loÿl
 
¡¬ti
 = (
th•age
-1è* 
Åp
 + 1

14 
loÿl
 
’di
 = 
th•age
 * 
Åp


15 
loÿl
 
·geu¾
 = 
·¿ms
.·geu¾ 
Ü
 
_¬gs
.pageurl

16 
loÿl
 
ÿÎback
 = 
_¬gs
.callback

18 -- 
the
 
ÿÎback
 
should
  2 
v®ues
: 
html
 
äagm’t
 
ªd
 
tÙ®num


19 
loÿl
 
htmlcÚ‹Á
, 
tÙ®num
 = 
bamboo
.
	$g‘PlugšC®lbackByName
(
ÿÎback
)(
web
, 
»q
, 
¡¬ti
, 
’di
)

21 
tÙ®num
 
th’


22 
tÙ®·ges
 = 
m©h
.
	`û
(
tÙ®num
/
Åp
)

23 
th•age
 > 
tÙ®·ges
 
th’
h•agğtÙ®·ge 
’d


24 
’d


26 
loÿl
 
´ev·ge
 = 
th•age
 - 1

27 
´ev·ge
 < 1 
th’
…»v·gğ1 
’d


28 
loÿl
 
Ãxage
 = 
th•age
 + 1

29 
Ãxage
 > 
tÙ®·ges
 
th’
‚exagğtÙ®·ge 
’d


32 ['htmlcÚ‹Á'] = 
htmlcÚ‹Á
,

33 ['tÙ®·ges'] = 
tÙ®·ges
,

34 ['Åp'] = 
Åp
,

35 ['·geu¾'] = 
·geu¾
,

36 ['th•age'] = 
th•age
,

37 ['´ev·ge'] = 
´ev·ge
,

38 ['Ãxage'] = 
Ãxage


39 
	}
}

40 
’d


43 
funùiÚ
 
	$maš
(
¬gs
)

45 
	`as£¹
(
	`ty³
(
¬gs
.
·geu¾
) == 'string', '[Error]…ageurl missing in…lugin…aginator.')

46 
	`as£¹
(
	`ty³
(
¬gs
.
ÿÎback
è=ğ'¡ršg' 
ªd
y³(
bamboo
.
	`g‘PlugšC®lbackByName
(args.callback)) == 'function', '[Error] callback missing in…lugin…aginator.')

47 
_¬gs
 = 
¬gs


49  
	`V›w
('../¶ugšs/ajax·gš©Ü/ajax·gš©Ü.html'è(
	$h–³r
())

51 
’d


53 
funùiÚ
 
	`jsÚs
(
web
, 
»q
)

54 -- 
	$åbË
(
»q
.
PARAMS
)

55  
web
:
	`jsÚSucûss
(
	$h–³r
())

56 
’d


	@tests/core_test/settings.lua

1 
	g´ojeù_Çme
 = "core_test"

2 
ho¡
 = "core_test"

3 
£nd”_id
 = 'c62c1bda-0816-2205-eef9-811c8e055fd1'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 15

9 
debug_Ëv–
 = 1

	@tests/core_test/tests/core_tests.lua

1 
loÿl
 
	g‹¡šg
 = 
»quœe
 "bamboo.testing"

2 
loÿl
 
sock‘
 = 
»quœe
 "socket"

4 
cÚ‹xt
("BamboØCÜFunùiÚ Te¡šg", 
	$funùiÚ
 ()

6 
	`cÚ‹xt
("SessiÚ - sessiÚ.lua", 
	$funùiÚ
 ()

8 
’d
)

10 
	`cÚ‹xt
("Web & Reque¡ - web.lua", 
	$funùiÚ
 ()

12 
’d
)

14 
	`cÚ‹xt
("FÜm - fÜm.lua", 
	$funùiÚ
 ()

16 
’d
)

19 
	`cÚ‹xt
("Mod– - mod–.lua", 
	$funùiÚ
 ()

21 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

23 
	`cÚ‹xt
("Glob® FunùiÚ Defšed iÀmod–.lua", 
	$funùiÚ
 ()

24 
	`‹¡
("isCÏss()", 
	$funùiÚ
 ()

25 
	`as£¹_equ®
(
	`isCÏss
(
MYU£r
), 
Œue
)

26 
	`as£¹_equ®
(
	`isCÏss
({
	}
}), 
çl£
)

27 
loÿl
 
š¡ªû
 = 
MYU£r
:
g‘
{ 
id
 = 1}

28 
as£¹_equ®
(
isCÏss
(
š¡ªû
), 
çl£
)

29 
’d
)

30 
‹¡
("isIn¡ªû()", 
	$funùiÚ
 ()

31 
loÿl
 
š¡ªû
 = 
MYU£r
:
g‘
{ 
id
 = 1
	}
}

32 
as£¹_equ®
(
isIn¡ªû
(
š¡ªû
), 
Œue
)

33 
’d
)

34 
‹¡
("isQu”yS‘()", 
	$funùiÚ
 ()

35 
loÿl
 
qu”y_£t
 = 
MYU£r
:
	$®l
()

36 
	`as£¹_equ®
(
	`isQu”yS‘
(
qu”y_£t
), 
Œue
)

37 
’d
)

41 
loÿl
 
‹¡”
 = 
‹¡šg
.
	`brow£r
("tester")

42 
loÿl
 
t1
 = 
sock‘
.
	$g‘time
()

43 
loÿl
 
»t


44 
i
=1, 10000 do

45 
»t
 = 
‹¡”
:
	`şick
("/test")

46 
’d


47 
loÿl
 
t2
 = 
sock‘
.
	$g‘time
()

48 
	`´št
(
t2
 - 
t1
)

50 
’d
)

52 
	`cÚ‹xt
("As£¹iÚs", 
	$funùiÚ
 ()

53 
	`‹¡
("I_AM_CLASS()", 
	$funùiÚ
 ()

54 
loÿl
 
»t
, 
”r
 = 
	$pÿÎ
(
I_AM_CLASS
, 
MYU£r
)

55 
	$as£¹_equ®
(
»t
, 
Œue
)

56 
’d
)

57 
	`‹¡
("I_AM_INSTANCE()", 
	$funùiÚ
 ()

58 
loÿl
 
š¡ªû
 = 
MYU£r
:
g‘
{ 
id
 = 1 
	}
}

59 
loÿl
 
»t
, 
”r
 = 
	$pÿÎ
(
I_AM_INSTANCE
, 
š¡ªû
)

60 
	$as£¹_equ®
(
»t
, 
Œue
)

61 
’d
)

62 
	`‹¡
("I_AM_QUERY_SET()", 
	$funùiÚ
 ()

63 
loÿl
 
qu”y_£t
 = 
MYU£r
:
	$®l
()

64 
loÿl
 
»t
, 
”r
 = 
	$pÿÎ
(
I_AM_QUERY_SET
, 
qu”y_£t
)

65 
	$as£¹_equ®
(
»t
, 
Œue
)

66 
’d
)

68 
’d
)

70 
	`cÚ‹xt
("BasiøAPI", 
	$funùiÚ
 ()

72 
’d
)

74 
	`cÚ‹xt
("Cu¡om API", 
	$funùiÚ
 ()

76 
’d
)

78 
	`cÚ‹xt
("CachAPI", 
	$funùiÚ
 ()

80 
’d
)

82 
	`cÚ‹xt
("FÜeigÀAPI", 
	$funùiÚ
 ()

84 
’d
)

86 
	`cÚ‹xt
("DyÇmiøF›ld API", 
	$funùiÚ
 ()

88 
’d
)

90 
’d
)

92 
	`cÚ‹xt
("V›w - v›w.lua", 
	$funùiÚ
 ()

94 
’d
)

96 
	`cÚ‹xt
("Ut - ut.lua", 
	$funùiÚ
 ()

98 
’d
)

100 
	`cÚ‹xt
("Redi W¿µ” -„edis.lu¨ªd„edis/*", 
	$funùiÚ
 ()

102 
’d
)

104 
	`cÚ‹xt
("MySQL Driv” - mysql.lua", 
	$funùiÚ
 ()

106 
’d
)

109 
’d
)

	@tests/paginator_test/app/handler_entry.lua

1 
	g»quœe
 'bamboo'

3 
loÿl
 
	gV›w
 = 
»quœe
 'bamboo.view'

4 
loÿl
 
FÜm
 = 
»quœe
 'bamboo.form'

6 
loÿl
 
MYU£r
 = 
»quœe
 'models.myuser'

7 
bamboo
.
	$»gi¡”Mod–
(
MYU£r
)

9 
bamboo
.
	`»gi¡”Plugš
('·gš©Ü', 
»quœe
 "plugins.paginator")

13 
loÿl
 
funùiÚ
 
	$šdex
(
web
, 
»q
)

14 
web
:
	`·ge
(
	`V›w
("fÜm.html"){
	}
})

15 
’d


17 
funùiÚ
 
	$·gš©Ü
(
li¡
, 
Åp
)

19 
loÿl
 
Ëngth
 = #list

20 
loÿl
 
·ges
 = 
m©h
.
	`û
(
Ëngth
/
Åp
)

22  
Åp
, 
·ges


24 
’d


26 
loÿl
 
funùiÚ
 
	$fÜm_subm™
(
web
, 
»q
)

27 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


28 
	$DEBUG
(
·¿ms
)

30 
loÿl
 
³rsÚ
 = 
	`MYU£r
(
·¿ms
)

31 -- 
§ve
 
³rsÚ
 
objeù
 
to
 
db


32 
³rsÚ
:
	$§ve
()

34 
web
:
	`»dœeù
('/result/')

35 
’d


37 
loÿl
 
funùiÚ
 
	$show
(
web
, 
»q
)

38 
web
:
	`·ge
(
	`V›w
('»suÉ.html'){
	}
})

39 
’d


41 
loÿl
 
funùiÚ
 
	$·gš©Ü_ÿÎback
(
web
, 
»q
, 
¡¬ti
, 
’di
)

43 
loÿl
 
®l_³rsÚs


44 
nÙ
 
MYU£r
:
	`exi¡Cache
('¯_³rsÚs_li¡'è
th’


45 -- 
»Œeive
 
®l
 
³rsÚ
 
š¡ªû
 
äom
 
db


46 
®l_³rsÚs
 = 
MYU£r
:
	$®l
():
	`sÜtBy
('name')

47 
MYU£r
:
	`£tCache
('¯_³rsÚs_li¡', 
®l_³rsÚs
)

48 
®l_³rsÚs
 =‡Î_³rsÚs:
	$¦iû
(
¡¬ti
, 
’di
)

50 
	`DEBUG
('entering cache block.')

51 
®l_³rsÚs
 = 
MYU£r
:
	`g‘Cache
('¯_³rsÚs_li¡', 
¡¬ti
, 
’di
)

53 
’d


54 
	$åbË
(
®l_³rsÚs
)

55 
loÿl
 
tÙ®
 = 
MYU£r
:
	`numCache
('aa_persons_list')

57  
	`V›w
("™em.html"){
®l_³rsÚs
 = 
	}
®l_³rsÚs}, 
tÙ®


58 
’d


60 
	gbamboo
.
»gi¡”PlugšC®lback
('·ge_ÿÎback', 
·gš©Ü_ÿÎback
)

62 
	gURLS
 = { '/',

63 ['/'] = 
šdex
,

64 ['/šdex/'] = 
šdex
,

65 ['/»suÉ/'] = 
show
,

66 ['/fÜm_subm™/'] = 
fÜm_subm™
,

	@tests/paginator_test/cachecall/callbacks.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	`ÚSave
(
£lf
)

4 -- 
h”e
, 
we
 
Ãed
 
to
 
add
 
Ãw
 
š¡ªû
's ido cache

5 
	`DEBUG
('readyo‡dd‚ew membero cache.')

6 
£lf
:
	`addToCacheAndSÜtBy
('aa_persons_list', 'name')

8  
£lf


9 
’d


	@tests/paginator_test/models/myuser.lua

1 
	$moduË
(..., 
·ckage
.
£—Î
)

3 
loÿl
 
U£r
 = 
»quœe
 'bamboo.models.user'

5 
loÿl
 
ÿche_ÿÎbacks
 = 
»quœe
 'cachecall.callbacks'

7 
loÿl
 
MYU£r
 = 
U£r
:
ex‹nd
 {

8 
__g
 = 'Bamboo.Model.User.MYUser';

9 
__Çme
 = 'MYUser';

10 
__desc
 = 'Generitic MYUser definition';

11 
__šdexfd
 = 'name';

12 
__f›lds
 = {

18 
__decÜ©Üs
 = {

19 
§ve
 = 
	`funùiÚ
(
o§ve
)

20  
	`funùiÚ
(
£lf
, ...)

21 
£lf
 = 
	`o§ve
(self, ...)

22 
nÙ
 
£lf
 
th’
  
n
 
’d


24 
£lf
 = 
ÿche_ÿÎbacks
.
	`ÚSave
(self)

26  
£lf


27 
’d


28 
’d
;

32 
š™
 = 
	`funùiÚ
 (
£lf
, 
t
)

33 
nÙ
 
t
 
th’
  
£lf
 
’d


35 
£lf
.
Çme
 = 
t
.name

36 
£lf
.
age
 = 
t
.age

37 
£lf
.
g’d”
 = 
t
.gender

39  
£lf


40 
’d
;

42 
	}
}

44  
	gMYU£r


	@tests/paginator_test/monconfig.lua

1 
	g¡©ic_·gš©Ü_‹¡
 = { 
ty³
="dœ", 
	gba£
='s™es/·gš©Ü_‹¡/', 
	gšdex_fe
='šdex.html', 
	gdeçuÉ_ùy³
='text/plain' }

3 
	ghªdËr_·gš©Ü_‹¡
 = { 
ty³
="hªdËr", 
	g£nd_¥ec
='tcp://127.0.0.1:10001',

4 
	g£nd_id’t
='ba06f707-8647-46b9-b7f7-e641d6419909',

5 
	g»cv_¥ec
='tı://127.0.0.1:10002', 
	g»cv_id’t
=''}

7 
	gmaš
 = {

8 
bšd_addr
 = "127.0.0.1",

9 
	guuid
="505417b8-1de4-454f-98b6-07eb9225cca1",

10 
	gacûss_log
="logs/access.log",

11 
	g”rÜ_log
="logs/error.log",

12 
	gchroÙ
="./",

13 
	gpid_fe
="run/mongrel2.pid",

14 
	gdeçuÉ_ho¡
="paginator_test",

15 
	gÇme
="main",

16 
	gpÜt
=6767,

17 
	gho¡s
= {

19 
Çme
="paginator_test",

20 
	gm©chšg
 = "xxxxxx",

21 
	grou‹s
={

22 ['/'] = 
hªdËr_·gš©Ü_‹¡
,

23 ['/medŸ/'] = 
¡©ic_·gš©Ü_‹¡


30 
	g£‰šgs
 = {

36 
	gmim‘y³s
 = {}

38 
£rv”s
 = { 
maš
 }

	@tests/paginator_test/plugins/paginator/init.lua

1 
	$moduË
 (..., 
·ckage
.
£—Î
)

3 
funùiÚ
 
	$maš
(
¬gs
)

5 
	`as£¹
(
	`ty³
(
¬gs
.
·geu¾
) == 'string', '[Error]…ageurl missing in…lugin…aginator.')

6 
	`as£¹
(
	`ty³
(
¬gs
.
ÿÎback
è=ğ'¡ršg' 
ªd
y³(
bamboo
.
	`g‘PlugšC®lbackByName
(args.callback)) == 'function', '[Error] callback missing in…lugin…aginator.')

8 
loÿl
 
·¿ms
 = 
»q
.
PARAMS


10 
loÿl
 
th•age
 = 
	$tÚumb”
(
·¿ms
.
th•age
è
Ü
 1

11 
th•age
 < 1 
th’
h•agğ1 
’d


12 
loÿl
 
tÙ®·ges
 = 
	$tÚumb”
(
·¿ms
.
tÙ®·ges
)

13 
tÙ®·ges
 
ªd
 
th•age
 >Ù®·ge 
th’
h•agğtÙ®·ge 
’d


14 
loÿl
 
Åp
 = 
	$tÚumb”
(
·¿ms
.
Åp
è
Ü
 
	$tÚumb”
(
¬gs
.
Åp
è
Ü
 5

15 
loÿl
 
¡¬ti
 = (
th•age
-1è* 
Åp
 + 1

16 
loÿl
 
’di
 = 
th•age
 * 
Åp


17 
loÿl
 
·geu¾
 = 
¬gs
.pageurl

18 
loÿl
 
ÿÎback
 = 
¬gs
.callback

20 -- 
the
 
ÿÎback
 
should
  2 
v®ues
: 
html
 
äagm’t
 
ªd
 
tÙ®num


21 
loÿl
 
htmlcÚ‹Á
, 
tÙ®num
 = 
bamboo
.
	$g‘PlugšC®lbackByName
(
ÿÎback
)(
web
, 
»q
, 
¡¬ti
, 
’di
)

23 
tÙ®num
 
th’


24 
tÙ®·ges
 = 
m©h
.
	`û
(
tÙ®num
/
Åp
)

25 
th•age
 > 
tÙ®·ges
 
th’
h•agğtÙ®·ge 
’d


26 
’d


28 
loÿl
 
´ev·ge
 = 
th•age
 - 1

29 
´ev·ge
 < 1 
th’
…»v·gğ1 
’d


30 
loÿl
 
Ãxage
 = 
th•age
 + 1

31 
Ãxage
 > 
tÙ®·ges
 
th’
‚exagğtÙ®·ge 
’d


34  
	`V›w
('../plugins/paginator/paginator.html') {

35 
htmlcÚ‹Á
 = htmlcontent,

36 
tÙ®·ges
 =Ù®·ges, 
Åp
 =‚µ, 
·geu¾
 =…ageurl,

37 
th•age
 =h•age, 
´ev·ge
 =…»v·ge, 
Ãxage
 =‚extpage

38 
	}
}

40 
	g’d


	@tests/paginator_test/settings.lua

1 
	g´ojeù_Çme
 = "paginator_test"

2 
ho¡
 = "paginator_test"

3 
£nd”_id
 = 'c62c1bda-0816-2205-eef9-811c8e055fd1'

4 
io_th»ads
 = 1

5 
v›ws
 = "views/"

6 
cÚfig_fe
 = 'config.lua'

7 
WHICH_DB
 = 14

9 
debug_Ëv–
 = 1

	@
1
.
0
79
2361
examples/ajaxexample/app/handler_entry.lua
examples/ajaxexample/settings.lua
examples/apptest/app/handler_entry.lua
examples/apptest/settings.lua
examples/formprocess/app/handler_entry.lua
examples/formprocess/settings.lua
examples/pagejump/app/handler_entry.lua
examples/pagejump/settings.lua
examples/workwithdb/app/handler_entry.lua
examples/workwithdb/models/myuser.lua
examples/workwithdb/settings.lua
src/bin/shell.lua
src/cmd_tmpls/admin/admin.lua
src/cmd_tmpls/admin/admin_unlogined.lua
src/cmd_tmpls/createapp/app/handler_entry.lua
src/cmd_tmpls/createapp/monconfig.lua
src/cmd_tmpls/createapp/settings.lua
src/cmd_tmpls/createcontroller/newcontroller.lua
src/cmd_tmpls/createmodel/newmodel.lua
src/cmd_tmpls/createplugin/init.lua
src/errors.lua
src/form.lua
src/init.lua
src/m2.lua
src/model.lua
src/models/group.lua
src/models/image.lua
src/models/menu.lua
src/models/message.lua
src/models/node.lua
src/models/permission.lua
src/models/upload.lua
src/models/user.lua
src/mvm/init.lua
src/mvm/prototype.lua
src/mvm/validate.lua
src/mysql.lua
src/plugin.lua
src/redis.lua
src/redis/fifo.lua
src/redis/hash.lua
src/redis/list.lua
src/redis/set.lua
src/redis/string.lua
src/redis/zfifo.lua
src/redis/zset.lua
src/session.lua
src/task.lua
src/testing.lua
src/util.lua
src/view.lua
src/web.lua
src/widget.lua
tests/ajaxpaginator_test/app/handler_entry.lua
tests/ajaxpaginator_test/cachecall/callbacks.lua
tests/ajaxpaginator_test/models/mymodel.lua
tests/ajaxpaginator_test/models/myuser.lua
tests/ajaxpaginator_test/monconfig.lua
tests/ajaxpaginator_test/plugins/ajaxpaginator/init.lua
tests/ajaxpaginator_test/settings.lua
tests/ajaxpaginator_test/tests/viewbench_tests.lua
tests/cache_test/app/handler_entry.lua
tests/cache_test/cachecall/callbacks.lua
tests/cache_test/models/myuser.lua
tests/cache_test/settings.lua
tests/core_test/app/handler_entry.lua
tests/core_test/cachecall/callbacks.lua
tests/core_test/models/mymodel.lua
tests/core_test/models/myuser.lua
tests/core_test/monconfig.lua
tests/core_test/plugins/ajaxpaginator/init.lua
tests/core_test/settings.lua
tests/core_test/tests/core_tests.lua
tests/paginator_test/app/handler_entry.lua
tests/paginator_test/cachecall/callbacks.lua
tests/paginator_test/models/myuser.lua
tests/paginator_test/monconfig.lua
tests/paginator_test/plugins/paginator/init.lua
tests/paginator_test/settings.lua
